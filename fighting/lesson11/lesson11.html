<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<meta name="GENERATOR" content="Microsoft FrontPage 6.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<title>New Page 1</title>
<style>
<!--
table.MsoTableGrid
	{border:1.0pt solid windowtext;
	font-size:10.0pt;
	font-family:"Times New Roman","serif"}
-->
</style>
</head>

<body>

<div align="center">
  <center>
  <table border="0" width="740" height="350" cellspacing="0" cellpadding="0">
    <!-- MSTableType="nolayout" -->
	<tr>
      <td width="740" height="133" background="Site/top.jpg" colspan="3">&nbsp;</td>
    </tr>
    <tr>
      <td width="127" height="356" background="Site/middle1.jpg" valign="top">
        <p align="left">
        <b><font face="Arial" size="1" color="#505866">&nbsp;&nbsp;&nbsp; 
		<a href="http://www.blitz-school.info"><font color="#FFFF99">Курсы</font></a><br>
        &nbsp;&nbsp;&nbsp; </font><font face="Arial" size="1" color="#FFFF99">
		<a href="http://www.blitz-school.info/reg.html"><font color="#FFFF99">Регистрация</font></a><br>
        &nbsp;&nbsp;&nbsp;
		<a href="http://www.blitz-school.info/study_tech.html">
		<font color="#FFFF99">Методика</font></a><br>
        &nbsp;&nbsp;&nbsp; </font>
		<a href="http://www.blitz-school.info/program.html"><font face="Arial" size="1" color="#FFFF99">Оглавление</font></a><font face="Arial" size="1" color="#FFFF99"><br>
        &nbsp;&nbsp;&nbsp; <a href="http://www.blitz-school.info/login.html">
		<font color="#FFFF99">Для учащихся</font></a><br>
        &nbsp;&nbsp;&nbsp; </font></b>
		<img border="0" src="../navdiv.gif" width="80" height="4"><br>
        <b><font size="1" face="Arial" color="#505866">&nbsp;&nbsp;&nbsp;
        <a href="http://www.blitz-school.info/articles.html">
		<font color="#FFFF99">Статьи</font></a><br>
        &nbsp;&nbsp;&nbsp; </font><font size="1" face="Arial" color="#FFFF99">
		<a href="http://www.blitz-school.info/instrum.html">
		<font color="#FFFF99">Инструменты</font></a><br>
		<span lang="en-us">&nbsp;&nbsp;&nbsp; </span>
		<a href="http://www.blitz-school.info/contacts.html">
		<font color="#FFFF99">Контакты</font></a><br>
		<span lang="en-us">&nbsp;&nbsp;&nbsp; </span></font></b>&nbsp;</td>
      <td width="586" height="356" background="Site/bg.gif" valign="top">

<p align="center"><font color="#008000"><b><font size="5"><span lang="ru">Урок </span>
11<span lang="ru">.</span></font></b><span lang="ru"><font size="5"><b> Создание 
клубного чата</b></font><br>
</span>
</font><b></p>
<p align="justify"><span lang="ru"><font size="2" face="Arial" color="#000080">
11<a name="kopv">.1. 
</a> 
</font></span></b><a name="kopv"><b><font face="Arial" size="2" color="#000080">
Таблицы чата и игровых комнат</font></b></a><span lang="ru"><b><a name="kopv"><font size="2" face="Arial" color="#000080">.</font></a></b><font size="2" face="Arial">
<br>
</font></span><font size="2" face="Arial">
&nbsp;&nbsp;&nbsp;&nbsp; <span lang="ru"><br>
</span>&nbsp;&nbsp; <span lang="ru">Любая онлайновая игра не может обойтись без 
средств общения игроков друг с другом. Выражаясь простым языком - наша с Вами 
игра просто обязана иметь чат.<br>
&nbsp;&nbsp;&nbsp;&nbsp; Для того чтоб сделать чат удобным для восприятия, 
необходимо разделить общение между игровыми объектами. Таким образом, игроки 
которые, к примеру, находятся в магической лавке будут общаться между собой и к 
их общению не будут примешиваться сообщения из кузницы или арены.<br>
&nbsp;&nbsp;&nbsp;&nbsp; Однако следует также предусмотреть возможность посылать 
приватные сообщения игрокам в других комнатах.<br>
&nbsp;&nbsp;&nbsp;&nbsp; Теперь перед нами встала задача наконец-то сделать 
реальное разделение мира нашей с Вами онлайновой игры на игровые комнаты. Мы уже 
создавали таблицу
</span>Buildings <span lang="ru">для описания игровых локаций. Давайте же 
добавим в нее все те объекты, которые мы успели создать до этого и намереваемся&nbsp; 
создать впоследствии.</span></font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table1">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">INSERT INTO 
		Buildings (ID, BuildingName, BuildingType, Town,PHP_File) VALUES(1,'<font color="#008000">Арена</font>',1,1,'char.phtml');<br>
		INSERT INTO Buildings (ID, BuildingName, BuildingType, Town,PHP_File) 
		VALUES(2,'<font color="#008000">Центральная площадь</font>',2,1,'map.phtml');<br>
		INSERT INTO Buildings (ID, BuildingName, BuildingType, Town,PHP_File) 
		VALUES(3,'<font color="#008000">Кузница</font>',3,1,'smith.phtml');<br>
		INSERT INTO Buildings (ID, BuildingName, BuildingType, Town,PHP_File) 
		VALUES(4,'<font color="#008000">Комиссионный магазин</font>',4,1,'comission.phtml');<br>
		INSERT INTO Buildings (ID, BuildingName, BuildingType, Town,PHP_File) 
		VALUES(5,'<font color="#008000">Магическая лавка</font>',5,1,'magicshop.phtml');<br>
		INSERT INTO Buildings (ID, BuildingName, BuildingType, Town,PHP_File) 
		VALUES(6,'<font color="#008000">Центральная площадь 2</font>',6,1,'map2.phtml');<br>
		INSERT INTO Buildings (ID, BuildingName, BuildingType, Town,PHP_File) 
		VALUES(7,'<font color="#008000">Вокзал</font>',7,1,'station.phtml');<br>
		INSERT INTO Buildings (ID, BuildingName, BuildingType, Town,PHP_File) 
		VALUES(8,'<font color="#008000">Рынок</font>',8,1,'market.phtml');<br>
		INSERT INTO Buildings (ID, BuildingName, BuildingType, Town,PHP_File) 
		VALUES(9,'<font color="#008000">Евромагазин</font>',9,1,'euroshop.phtml');<br>
		INSERT INTO Buildings (ID, BuildingName, BuildingType, Town,PHP_File) 
		VALUES(10,'<font color="#008000">Банк</font>',10,1,'bank.phtml');</font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial">
<span lang="ru">&nbsp;&nbsp;&nbsp;&nbsp;
</span>&nbsp;<span lang="ru">Вы наверное заметили, что в таблице
</span><b>Buildings</b> <span lang="ru">появилось еще одно поле
</span><font color="#000080">PHP_File</font>, <span lang="ru">в котором 
содержится название того файла, который описывает данный игровой объект.<br>
</span>&nbsp;&nbsp;&nbsp;&nbsp; <span lang="ru">Теперь нам нужно продумать 
структуру таблицы чата, чтоб он был достаточно простым и предусматривал 
разделение общения на игровые зоны.</span></font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table2">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">
		<font color="#008080">/*Таблица чата*/<br>
		</font>CREATE TABLE `<b>chat</b>` (<br>
		`CH_ID` BIGINT unsigned NOT NULL auto_increment,<br>
		`CH_ROOM` INT unsigned NOT NULL, -- игровая комната<br>
		`USER_ID` bigint(20) unsigned NOT NULL, -- кто написал сообщение<br>
		`USER_ID_TO` bigint(20) unsigned default 0, -- кому сообщение 0 - всем<br>
		`IS_PRIVATE` SMALLINT DEFAULT 0, -- 1 - приватное (видно везде)<br>
		`CH_MSG` CHAR(255) NOT NULL DEFAULT '',<br>
		PRIMARY KEY (`CH_ID`)<br>
		) TYPE=MyISAM;</font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial">
<span lang="ru">&nbsp;&nbsp; Итак поле
</span></font><font face="Courier" size="2" color="#000080">CH_ROOM</font><font size="2" face="Arial"><span lang="ru"> 
- это наш игровой объект, который соответствует полю
</span></font><font face="Courier" size="2"><font color="#000080">ID</font><span lang="ru">
</span></font><font size="2" face="Arial">
<span lang="ru">в таблице
</span><b>Buildings</b>.<span lang="ru">
</span>&nbsp;</font><font face="Courier" size="2"><font color="#000080">USER_ID</font>
</font><font size="2" face="Arial">
- <span lang="ru">идентификатор игрока, который послал сообщение в чат 
(соответствует одноименному полю из таблицы
</span><b>users</b><span lang="ru">)</span>. <span lang="ru">Поле
</span></font><font face="Courier" size="2" color="#000080">USER_ID_TO</font><font size="2" face="Arial"><span lang="ru"> 
- идентификатор игрока, которому направляется сообщение, если оно адресовано 
кому-то лично. Поле
</span></font><font face="Courier" size="2"><font color="#000080">IS_PRIVATE</font>
</font><font size="2" face="Arial">
<span lang="ru">является</span> <span lang="ru">флагом, который определяет. 
является ли сообщение приватным. Сообщение с таким флагом будет получено игроком 
даже если он находится в разных комнатах с тем персонажем, который адресовал ему 
сообщение. Поле&nbsp;
</span></font><font face="Courier" size="2"><font color="#000080">CH_MSG</font><span lang="ru">
</span></font><font size="2" face="Arial">
<span lang="ru">- непосредственно текст сообщения.<br>
&nbsp;&nbsp; Добавления и изменения в
</span>SQL<span lang="ru"> скрипте смотрите <a href="11_1/mmclub.sql">здесь</a>.<br>
&nbsp; 
<br>
</span></font><a name="kopv0"><span lang="ru"><b>
<font face="Arial" size="2" color="#000080">11</font></b></span></a><font size="2" face="Arial"><b><span lang="ru"><font face="Arial" color="#000080"><a name="kopv0"><font size="2">.2. 
</font></a></font></span><font size="2" face="Arial" color="#000080">
<span lang="ru"><a name="kopv0">Нумерация комнат и общий чат</a><a name="kopv1">.</a></span></font></b><span lang="ru"> <br>
<br>
&nbsp;&nbsp;&nbsp; Присвоив нумерацию всем игровым объектам мы можем теперь в 
файлах, которые их описывают, производить идентификацию нахождения игрока 
(изменяя поле </span>Building <span lang="ru">в таблице </span><b>users</b><span lang="ru">)
<br>
&nbsp;&nbsp;&nbsp;&nbsp; Например, как это будет выглядеть для кузницы, которая 
имеет порядковый номер <font color="#000080">3</font> в таблице </span><b>
Buildings</b>.<span lang="ru"> Немного модифицируем файл </span>smith.phtml.</font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table3">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">$OBJECT_TYPE = 3;
		<font color="#008080">// тип данного объекта 3 для всех городов</font><br>
		<br>
		$query = <font color="#008000">&quot;SELECT ID FROM Buildings where Town=$aUserTown 
		and BuildingType=$OBJECT_TYPE&quot;</font>;<br>
		$result = <font color="#0000FF">mysql_query</font>($query) or
		<font color="#0000FF">die</font>(&quot;Query failed : &quot; .
		<font color="#0000FF">mysql_error</font>());<br>
		$aRow = <font color="#0000FF">mysql_fetch_array</font>( $result);<br>
		$aObjectID = $aRow[&quot;ID&quot;];<br>
		<font color="#008080">// меняем комнату у игрока</font><br>
		$query = <font color="#008000">&quot;UPDATE Users SET Building=$aObjectID 
		WHERE Nick_Name='$aNickName'&quot;</font>;<br>
		$result = <font color="#0000FF">mysql_query</font>($query) or
		<font color="#0000FF">die</font>(&quot;Query failed : &quot; .
		<font color="#0000FF">mysql_error</font>());</font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial">&nbsp;&nbsp; <span lang="ru"> Для 
того, чтоб при авторизации в игре сразу попадать в нужный игровой объект, в 
котором был наш игрок перед последним выходом, нам нужно немного изменить файл </span>
char.phtml. <span lang="ru">Этот файл является стартовым куда мы попадаем при 
авторизации и по сути олицетворяет собой объект Арены, где происходят поединки.<br>
&nbsp;&nbsp;&nbsp; В этом файле мы делаем следующее изменение:</span></font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table4">
	<tr>
		<td bgcolor="#FFFFCC"><span lang="ru"><font face="Courier" size="2">...</font></span><font face="Courier" size="2"><br>
		$aBuildingID = $aRow[&quot;Building&quot;]; <br>
		<span lang="ru">...</span><br>
		<font color="#008080">// Проверим, где находится игрок</font><br>
		$query = <font color="#008000">&quot;SELECT * FROM Buildings WHERE ID='$aBuildingID'&quot;</font>;<br>
		$result = <font color="#0000FF">mysql_query</font>($query) or
		<font color="#0000FF">die</font>(&quot;Query failed : &quot; .
		<font color="#0000FF">mysql_error</font>());<br>
		$aRow = <font color="#0000FF">mysql_fetch_array</font>( $result);<br>
		$PHP_File = $aRow[&quot;PHP_File&quot;];<font color="#008080"><span lang="ru">
		</span>//какой скрипт отвечает за данную локацию?</font> <br>
		<font color="#0000FF">if</font> ($aBuildingID &lt;&gt; $OBJECT_TYPE){<br>
		<font color="#0000FF">print</font>('&lt;SCRIPT&gt;location.href=&quot;'.$PHP_File.'?NickName='.$aNickName.'&quot;;&lt;/SCRIPT&gt;');<br>
		}</font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial"><span lang="ru">&nbsp;&nbsp; 
Вначале мы считываем положение игрока (значение поля </span></font>
<font face="Courier" size="2">Building </font><font size="2" face="Arial">
<span lang="ru">из таблицы </span><b>users</b><span lang="ru">)</span>
<span lang="ru">и потом находим соответствующий этому объекту </span>php
<span lang="ru">файл и производим переадресацию на него при помощи </span>
JavaScript (</font><font face="Courier" size="2">location.href = ...</font><font size="2" face="Arial">)<span lang="ru"><br>
&nbsp; Подобные изменения мы произвели во всех файлах, описывающих игровые 
объекты (магическая лавка, комиссионный магазин и т.д. см. <a href="11_2">здесь</a>.)<br>
&nbsp;&nbsp;&nbsp; Теперь, когда положение персонажа в игровом мире четко 
зафиксировано, мы можем приступить к созданию чата. Давайте воспользуемся ранее 
созданным файлом </span><b>buttons.phtml </b><span lang="ru">и добавим 
возможность передавать строку, которую вводит пользователь в таблицу чата и 
затем в окно чата.<br>
<br>
<img border="0" src="ch1.jpg" width="350" height="191"><br>
<br>
&nbsp; Давайте напишем функцию на </span>JavaScript<span lang="ru">, которая 
будет передавать в файл </span><b>chat.phtml</b> <span lang="ru">строку 
сообщения. (Ранее у нас был файл </span>chat.html<span lang="ru">, теперь мы 
должны поменять его на </span>chat.phtml<span lang="ru">) <br>
&nbsp; Кнопка со стрелочкой в файле </span><b>buttons.phtml</b> <span lang="ru">
теперь будет описываться так:</span></font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table5">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">&lt;img src=&quot;img/b_ok.gif&quot; 
		width=&quot;30&quot; height=&quot;30&quot; alt=&quot;<font color="#008000">Добавить текст в чат</font>&quot; 
		style=&quot;cursor: hand&quot; onclick=&quot;<font color="#000080">AddToChat</font>()&quot; 
		/&gt;</font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial">&nbsp;&nbsp; <span lang="ru">
Функция </span></font><font color="#000080" face="Courier" size="2">AddToChat<span lang="ru">
</span></font><font size="2" face="Arial"><span lang="ru">на </span><i>
JavaScript</i> <span lang="ru">теперь будет выглядеть таким образом:</span></font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table6">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">function AddToChat()<br>
		{<br>
		cAdd = top.frames['bottom'].F1.text.value;<br>
		top.frames['chat'].location='chat.phtml?&amp;msg='+cAdd+'&amp;NickName=<b>&lt;?php</b>
		<font color="#000080">echo</font> &quot;$aNickName&quot;; <b>?&gt;</b>';<br>
		RefreshChat();<br>
		top.frames['bottom'].F1.text.value = &quot;&quot;;<br>
		top.frames['chat'].window.scrollBy(0, 65000);<br>
		}</font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial"><span lang="ru">&nbsp;&nbsp;&nbsp; 
Давайте рассмотрим реализацию файла </span>chat.phtml <span lang="ru">для записи 
переданного сообщения в таблицу </span><b>chat</b>.</font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table7">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2" color="#0000FF">....</font><font face="Courier" size="2"><font color="#0000FF"><br>
		if</font> (!<font color="#0000FF">empty</font>($<font color="#0000FF">_GET</font>['NickName'])){<br>
		$aNickName = $<font color="#0000FF">_GET</font>['NickName'];<br>
		}<br>
		<br>
		<font color="#0000FF">if</font> (!<font color="#0000FF">empty</font>($<font color="#0000FF">_GET</font>['msg'])){<br>
		$aMsg = $<font color="#0000FF">_GET</font>['msg'];<br>
		}<br>
		<br>
		.... <br>
		$query = <font color="#008000">&quot;SELECT * FROM users WHERE Nick_Name='$aNickName'&quot;</font>;<br>
		$result = <font color="#0000FF">mysql_query</font>($query) or
		<font color="#0000FF">die</font>(&quot;Query failed : &quot; .
		<font color="#0000FF">mysql_error</font>());<br>
		$aRow = <font color="#0000FF">mysql_fetch_array</font>( $result);<br>
		$aUserFrom = $aRow[&quot;USER_ID&quot;];<br>
		$aBuilding = $aRow[&quot;Building&quot;]; <font color="#008080">// какая комната (строение) 
		?</font><br>
		<font color="#0000FF">if</font> ($aMsg &lt;&gt; ''){<br>
		$query = <font color="#008000">&quot;INSERT INTO chat (CH_MSG,USER_ID,CH_ROOM) 
		values('$aMsg','$aUserFrom','$aBuilding')&quot;</font>;<br>
		$result = <font color="#0000FF">mysql_query</font>($query) or
		<font color="#0000FF">die</font>(&quot;Query failed : &quot; .
		<font color="#0000FF">mysql_error</font>());<br>
		}<br>
		<font color="#008080">// покажем последние 20 сообщений чата</font><br>
		$query = <font color="#008000">&quot;SELECT u.Nick_Name, c.USER_ID_TO, 
		c.CH_MSG FROM chat c inner join users u on u.USER_ID = c.USER_ID where 
		CH_ROOM = '$aBuilding' or c.USER_ID_TO = '$aUserFrom' order by c.CH_ID 
		limit 20&quot;</font>;<br>
		$result = <font color="#0000FF">mysql_query</font>($query) or
		<font color="#0000FF">die</font>(&quot;Query failed : &quot; .
		<font color="#0000FF">mysql_error</font>());<br>
		<font color="#0000FF">while</font> ($aRow = <font color="#0000FF">
		mysql_fetch_array</font>($result)) { <br>
		$aUserName = $aRow[&quot;Nick_Name&quot;];<br>
		$aMsg = $aRow[&quot;CH_MSG&quot;];<br>
		<br>
		$AllMessages .= '&lt;a href=\&quot;javascript:void(0)\&quot;&gt;&lt;SPAN&gt;['.$aUserName.']&lt;/SPAN&gt;&lt;/a&gt; 
		'.$aMsg.'&lt;br&gt;';<br>
		}<br>
		<font color="#0000FF">print</font>( '&lt;script&gt; 
		document.getElementById(&quot;mes&quot;).innerHTML = &quot;'.$AllMessages.'&quot;; 
		&lt;/script&gt;' );<br>
		....</font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial">&nbsp;&nbsp; <span lang="ru">В 
вышеприведенном коде мы узнаем комнату персонажа, который послал сообщение и 
вместе с самими сообщением записываем в новую строку таблицы </span><b>chat</b>.<span lang="ru"> 
Затем мы отображаем последние 20 сообщений чата. Имя персонажа, добавившего 
сообщение помещается в теги </span>&lt;SPAN&gt;<span lang="ru">&lt;</span>/SPAN&gt;<span lang="ru">, 
что нужно для привязки контекстного меню, код которого приведен в файле: </span>
<a href="11_2/ch2.js">ch2.js</a>. <span lang="ru">Теперь мы можем кликать правой 
кнопкой на нике персонажа и выбирать необходимое действие из меню. <br>
&nbsp;&nbsp;&nbsp;&nbsp; В окне браузера это выглядит так:<br>
<br>
<img border="0" src="ch2_menu.jpg" width="297" height="343"><br>
<br>
&nbsp;</span><br>
<a name="kopv2"><span lang="ru"><font color="#000080"><b>11</b></font></span></a><b><span lang="ru"><font face="Arial" color="#000080"><a name="kopv2"><font size="2">.3. </font>
</a></font></span></b><span lang="ru"><b>
<font size="2" face="Arial" color="#000080"><a name="kopv2">Скорость обновления 
чата</a><a name="kopv3">.</a></font></b> <br>
<br>
&nbsp;&nbsp;&nbsp; Так как таблица чата обновляется не только одним игроком, а 
множеством других, мы должны сделать автоматическое обновление окна чата. 
</span><i>JavaScript</i> <span lang="ru">функция 
</span></font><font face="Courier" size="2"><font color="#000080">RefreshChat</font><span lang="ru">
</span></font><font size="2" face="Arial"><span lang="ru">для этих целей 
реализована таким образом:</span></font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table8">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">var ChatTimerID = 
		-1; // id таймера для чата<br>
		var ChatDelay = 15; <span lang="ru">&nbsp; </span>// через сколько сек. 
		рефрешить чат<br>
		<b><br>
		<span lang="ru">.....</span><br>
		<br>
		function</b> <font color="#000080">RefreshChat</font>()<br>
		{ <br>
		if (ChatTimerID&gt;=0) { clearTimeout(ChatTimerID); }<br>
		ChatTimerID = setTimeout('RefreshChat()', ChatDelay*1000);<br>
		top.frames['chat'].location='chat.phtml?NickName=<b>&lt;?php</b>
		<font color="#0000FF">echo</font> $aNickName <b>?&gt;</b>&amp;show='+Math.random();<br>
		// заодно обновим комнату<br>
		top.frames['online'].navigate('room.phtml?NickName=<b>&lt;?php</b>
		<font color="#0000FF">echo</font> $aNickName <b>?&gt;</b>&amp;online='+Math.round(Math.random()*100000));<br>
		}</font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial"><span lang="ru"><br>
&nbsp;&nbsp; Первый раз эта функция вызывается при загрузке страницы, 
</span></font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table9">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2"><b>function</b> strt(){&nbsp; 
		// Начинаем<br>
		ChatTimerID = setTimeout('RefreshChat()', 1000);<br>
		}</font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial"><span lang="ru">а потом начинает 
работать таймер с интервалом в 15 секунд (настраивается в переменной 
</span></font><font face="Courier" size="2" color="#000080">ChatDelay</font><font size="2" face="Arial"><span lang="ru">)
<br>
&nbsp;&nbsp; Кроме вызова обновления окна чата, функция также вызывает 
перерисовку окна показа игроков находящихся в комнате (</span>room.phtml<span lang="ru">)<br>
<br>
&nbsp;&nbsp;<br> 
</span><a name="kopv4"><span lang="ru"><font color="#000080"><b>11</b></font></span></a><b><span lang="ru"><font face="Arial" color="#000080"><a name="kopv4"><font size="2">.4.</font></a></font></span></b><font color="#000080"><b>
<span lang="ru">Общение с персонажами в других комнатах<a name="kopv4"> </a>
</span> </b></font><span lang="ru">&nbsp;<br>
<br>
</span>&nbsp;&nbsp;&nbsp; <span lang="ru">&nbsp;Для того чтоб обращаться к 
персонажам, находящимся в других комнатах, существуют так называемые 
приватные&nbsp;сообщения. Для передачи приватного сообщения перед ником игрока 
ставится ключевое слово
</span>private<span lang="ru">. Так, например, приватное обращение к персонажу
</span>Stranger<span lang="ru"> должно выглядеть так:<br>
<br>
<img border="0" src="private.jpg" width="384" height="188"><br>
<br>
</span>&nbsp;&nbsp; <span lang="ru">Если нужно обратиться к нескольким игрокам, 
то&nbsp; строка будет выглядеть так:<br>
</span>private [<span lang="ru">имя1</span>]<span lang="ru"> </span>private [<span lang="ru">имя2</span>]<span lang="ru">
</span>private [<span lang="ru">имя3</span>]<span lang="ru">&nbsp; сообщение...<br>
&nbsp;&nbsp; Давайте напишем код для проверки присутствия ключевого слова </span>
private <span lang="ru">в файле </span>chat.phtml.</font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table10">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">....<br>
		<font color="#0000FF">if</font> ($aMsg &lt;&gt; ''){<br>
		if( <font color="#000080">AnalyzePrivate</font>( $aMsg,$aUserFrom,$aBuilding) 
		== 0 ){<br>
		$query = <font color="#008000">&quot;INSERT INTO chat (CH_MSG,USER_ID,CH_ROOM) 
		values('$aMsg','$aUserFrom','$aBuilding')&quot;</font>;<br>
		$result = <font color="#0000FF">mysql_query</font>($query) or
		<font color="#0000FF">die</font>(&quot;Query failed : &quot; .
		<font color="#0000FF">mysql_error</font>());<br>
		}<br>
		}<br>
		....</font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial">&nbsp;&nbsp; <span lang="ru">
Функция </span></font><font color="#000080" face="Courier" size="2">
AnalyzePrivate<span lang="ru"> </span></font><font size="2" face="Arial">
<span lang="ru">занимается анализом переданной строки чата и получает в качестве 
аргументов собственно строку сообщения, ник пользователя и комнату чата.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Реализация функции выглядит так:</span></font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table11">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">
		<font color="#008080">// Ищем всех приватных особ </font><br>
		function <font color="#000080">AnalyzePrivate</font>( $Mess,$From,$Room 
		){<br>
		$retv = 0;<br>
		<font color="#0000FF">preg_match_all</font>(&quot;/((private|to)\s\[\w+\])/&quot;, 
		$Mess, $out, PREG_PATTERN_ORDER);<br>
		$rep = sizeof($out[0]);<br>
		<font color="#0000FF">for</font>($i=0;$i&lt;$rep;$i++) {<br>
		$Nick = <font color="#0000FF">preg_replace</font>(&quot;/(private\s\[|\])/&quot;,&quot;&quot;,$out[0][$i]);<br>
		$query = <font color="#008000">&quot;select user_id from users where 
		Nick_Name='&quot;.$Nick.&quot;'&quot;</font>;<br>
		$result = <font color="#0000FF">mysql_query</font>($query) or die(&quot;Query 
		failed : &quot; . mysql_error());<br>
		$aRow = <font color="#0000FF">mysql_fetch_array</font>($result); <br>
		<font color="#0000FF">if</font>( <font color="#0000FF">mysql_num_rows</font>($result) 
		&lt;&gt; 0 ){<br>
		$retv = 1; <font color="#008080">// нашли конструкцию private [....]</font><br>
		$aUserIDTo = $aRow[&quot;user_id&quot;];<br>
		$query = <font color="#008000">&quot;INSERT INTO chat (CH_MSG,USER_ID,USER_ID_TO,CH_ROOM,IS_PRIVATE) 
		values('$Mess','$From','$aUserIDTo','$Room',1)&quot;</font>;<br>
		$result = <font color="#0000FF">mysql_query</font>($query) or
		<font color="#0000FF">die</font>(&quot;Query failed : &quot; .
		<font color="#0000FF">mysql_error</font>());<br>
		<br>
		}<br>
		} <br>
		<font color="#0000FF">return</font> ($retv); <br>
		} </font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial"><span lang="ru">&nbsp;&nbsp; Эта 
функция использует регулярные выражения для определения перечня игроков, которым 
отправляется приватное сообщение в результате выполнения функций
</span><span lang="en-us">PHP ( </span></font>
		<font color="#0000FF" face="Courier" size="2">preg_match_all </font>
<font size="2" face="Arial">и<span lang="en-us"> </span></font> 
<font color="#0000FF" face="Courier" size="2">preg_replace</font><font size="2" face="Arial"><span lang="en-us">)</span> <span lang="ru">
в массив
</span></font><font face="Courier" size="2">
		$out </font><font size="2" face="Arial"><span lang="ru">у нас 
сохраняются ники персонажей, которым нужно создать дополнительные строки 
сообщений в таблице
</span><span lang="en-us"><b>chat</b>.</span> <span lang="ru">Таким образом эти 
персонажи получат сообщение, даже если они находятся в других комнатах.<br>
<br>
</span><a name="kopv6"><span lang="ru"><font color="#000080"><b>11</b></font></span></a><b><span lang="ru"><font face="Arial" color="#000080"><a name="kopv6"><font size="2">.5. 
Использование смайликов</font></a></font></span></b><span lang="ru"><b><font size="2" face="Arial" color="#000080"><a name="kopv7">.</a></font></b>
<br><br>
&nbsp;&nbsp;&nbsp; Для того, чтоб&nbsp; более ярко выразить какую-то эмоцию в 
посылаемом в чат сообщении, обычно используются смайлики. Давайте добавим 
несколько картинок смайликов:<br>
<img border="0" src="11_5/smiles_files/sword.gif" width="49" height="18"><img border="0" src="11_5/smiles_files/smoke.gif" width="20" height="20"><img border="0" src="11_5/smiles_files/smile.gif" width="18" height="18"><img border="0" src="11_5/smiles_files/privet.gif" width="27" height="29"><img border="0" src="11_5/smiles_files/laugh.gif" width="15" height="15"><img border="0" src="11_5/smiles_files/hello.gif" width="25" height="27"><img border="0" src="11_5/smiles_files/grust.gif" width="15" height="15"><img border="0" src="11_5/smiles_files/fingal.gif" width="22" height="15"><img border="0" src="11_5/smiles_files/wink.gif" width="15" height="15"> 
которые будем использовать в нашем чате.<br>
<br>
Давайте по нажатию на кнопку
<img border="0" src="11_5/img/b_smile.gif" width="30" height="30"> вызывать окно 
с отображением вышеперечисленных иконок. Код кнопки на </span>
<span lang="en-us">HTML </span>в<span lang="ru"> файле </span>
<span lang="en-us">buttons.phtml:</span></font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table12">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">&lt;img src=&quot;img/b_smile.gif&quot; 
		width=&quot;30&quot; height=&quot;30&quot; alt=&quot;Смайлики&quot; style=&quot;cursor:hand&quot; onclick=&quot;<font color="#000080">smiles</font>()&quot; 
		/&gt;</font></td>
	</tr>
</table>
<p><font face="Arial" size="2"><span lang="en-us">&nbsp; </span>Функция </font>
<font color="#000080" face="Courier" size="2">smiles</font><font face="Arial" size="2"> 
на <span lang="en-us">JavaScript </span>реализована вот таким образом:</font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table13">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2"><b>function</b>
		<font color="#000080">smiles</font>()<br>
		{<br>
		var x = event.screenX - 200;<br>
		var y = event.screenY - 250;<br>
		var sFeatures = 'dialogLeft:'+x+'px;dialogTop:'+y+'px;dialogHeight:210px; 
		dialogWidth:400px;help:no;status:no;unadorned:yes';<br>
		window.showModelessDialog(&quot;smiles.html&quot;, window, sFeatures);<br>
		}</font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial">&nbsp;&nbsp; Таким образом мы 
показываем файл </font><font face="Courier" size="2">smiles.html </font>
<font size="2" face="Arial"><span lang="en-us">в</span> отдельном всплывающем 
окне<span lang="en-us"> </span>(немодальном диалоге)<span lang="en-us"> </span>с 
заранее заданными размерами и местоположением<span lang="en-us">.<br>
</span>&nbsp;&nbsp;&nbsp; Давайте опишем картинки наших смайликов, которые мы 
расположили в папке <span lang="en-us"><a href="11_5/smiles_files">smiles_files</a>,
</span>в отдельном </font><font face="Courier" size="2" color="#000080">
ch2.91.js</font><font size="2" face="Arial"><span lang="en-us"> </span>файле. 
Вот как это выглядит:</font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table14">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">// Разрешенные 
		смайлики<br>
		var <font color="#000080">sm</font> = new <font color="#000080">Array</font>(&quot;smile&quot;,18,18,
		<br>
		&quot;laugh&quot;,15,15, <br>
		&quot;fingal&quot;,22,15, <br>
		&quot;smoke&quot;,20,20, <br>
		&quot;hello&quot;,25,27, <br>
		&quot;privet&quot;,27,29, <br>
		&quot;grust&quot;,15,15, <br>
		&quot;wink&quot;,15,15);</font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial">&nbsp;&nbsp; Теперь этот файл мы 
можем подключить в<span lang="en-us"> </span></font>
<font face="Courier" size="2">smiles.html</font><font size="2" face="Arial">.</font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table15">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">&lt;SCRIPT language=JavaScript 
		src=&quot;smiles_files/<font color="#000080">ch2.91.js</font>&quot;&gt;&lt;/SCRIPT&gt;</font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial">&nbsp;&nbsp; Массив<span lang="en-us">
<font color="#000080">sm</font> </span>содержит последовательность из имен 
смайликов и их размеров (<span lang="en-us">height </span>и <span lang="en-us">
width</span>). В файле </font><font face="Courier" size="2">smiles.html </font>
<font size="2" face="Arial"><span lang="en-us">э</span>ти картинки<span lang="en-us">
</span>выводятся динамически с помощью следующего кода:</font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table16">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">&lt;SCRIPT&gt;<br>
		var i=0;<br>
		while(i&lt;sm.length) {<br>
		var s = sm[i++];<br>
		document.write('&lt;IMG SRC=smiles_files/'+s+'.gif WIDTH='+sm[i++]+' HEIGHT='+sm[i++]+' 
		BORDER=0 ALT=&quot;&quot; onclick=&quot;<font color="#000080">S</font>(\''+s+'\')&quot;&gt; ');<br>
		}<br>
		&lt;/SCRIPT&gt;</font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial">&nbsp;&nbsp; <span lang="en-us">&nbsp;</span>Функция
<font color="#000080"><span lang="en-us">S</span>,</font><span lang="en-us">
</span>активируемая по клику на соответствующую картинку смайлика<span lang="en-us">
</span>записывает название картинки в вызывающее окно в текстовую строку чата, 
добавляя его к уже имеющейся строке:</font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table17">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">&lt;SCRIPT&gt;<br>
		<b>function</b> <font color="#000080">S</font>(name)<br>
		{<br>
		var sData = dialogArguments;<br>
		sData.F1.text.focus();<br>
		sData.F1.text.value = sData.F1.text.value + ':'+name+': ';<br>
		}<br>
		&lt;/SCRIPT&gt;</font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial">&nbsp;&nbsp; Всплывающее кно со 
смайликами выглядит так:<br>
<br>
<img border="0" src="smiles.jpg" width="406" height="237"><br>
<span lang="en-us"><br>
</span>&nbsp;&nbsp; Если мы нажмем на картинку с трубкой, то в строку чата 
добавится его название, обрамленное двоеточиями:<span lang="en-us"><br>
<img border="0" src="smoke.jpg" width="256" height="70"><br>
<br>
</span>&nbsp; Давайте теперь реализуем отображение этих смайликов в общем окне 
чата. Для этого внесем небольшие изменения в файле <span lang="en-us">chat.phtml.
</span>Вначале добавим туда две строки<span lang="en-us">:</span></font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table18">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">$<font color="#000080">patterns</font> 
		= array (&quot;/\:hello\:/&quot;,&quot;/\:smoke\:/&quot;,&quot;/\:smile\:/&quot;,&quot;/\:privet\:/&quot;, &quot;/\:laugh\:/&quot;,&quot;/\:wink\:/&quot;,&quot;/\:grust\:/&quot;,&quot;/\:fingal\:/&quot;);<br>
		$<font color="#000080">replace</font> = array (&quot;&lt;img src=smiles_files/hello.gif&gt;&quot;,&quot;&lt;img 
		src=smiles_files/smoke.gif&gt;&quot;,&quot;&lt;img src=smiles_files/smile.gif&gt;&quot;,&quot;&lt;img 
		src=smiles_files/privet.gif&gt;&quot;,&quot;&lt;img src=smiles_files/laugh.gif&gt;&quot;,&quot;&lt;img 
		src=smiles_files/wink.gif&gt;&quot;,&quot;&lt;img src=smiles_files/grust.gif&gt;&quot;,&quot;&lt;img src=smiles_files/fingal.gif&gt;&quot;);</font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial">&nbsp;&nbsp; Строка </font>
<font face="Courier" size="2">$<font color="#000080">patterns </font></font>
<font size="2" face="Arial"><span lang="en-us">о</span>пределяет буквенное 
описание картинок смайликов, а строка </font><font face="Courier" size="2">$<font color="#000080">replace</font></font><font size="2" face="Arial"><span lang="en-us">
</span>содержит<span lang="en-us"> </span>соответствующий первой строке<span lang="en-us">
</span>список описания картинок в формате <span lang="en-us">HTML.<br>
&nbsp;&nbsp;&nbsp; </span>Теперь остается сделать так обработать строку чата:</font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table19">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">$aMsg = $aRow[&quot;CH_MSG&quot;];<br>
		$aMsg = <font color="#0000FF">preg_replace</font>($patterns,$replace,$aMsg);</font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial">&nbsp;&nbsp; и в окне чата мы 
будем видеть сами картинки смайликов вместо текстового описания:<span lang="en-us"><br>
<br>
<img border="0" src="sm-chat.jpg" width="279" height="365"><br>
<br>
</span>&nbsp; Смотрите измененный файл <span lang="en-us">chat.phtml&nbsp;
</span><a href="11_5/chat.phtml">здесь</a>. Файл <span lang="en-us">smiles.html
</span>Вы можете взять <a href="11_5/smiles.html">тут</a>.<span lang="en-us">
</span>Или просто скопируйте<span lang="en-us"> </span>все файлы из папки
<a href="11_5">11_5</a> в папку <span lang="en-us">www </span>для тестирования<span lang="en-us">.<br>
</span><span lang="ru"><b><br>
В следующем уроке</b> мы создадим здание вокзала и расписание карет, научимся 
покупать и сдавать билеты, перемещаться в другой город.</span></font></p>
<font size="2" face="Arial">
        <p align="left">&nbsp;</font></td>
      <td width="27" height="356" background="Site/middle2.jpg">&nbsp;</td>
    </tr>
    <tr>
      <td width="740" height="38" background="Site/bottom.jpg" colspan="3">&nbsp;</td>
    </tr>
  </table>
  </center>
</div>

</body>

</html>