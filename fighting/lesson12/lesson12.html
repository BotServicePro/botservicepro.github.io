<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<meta name="GENERATOR" content="Microsoft FrontPage 6.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<title>New Page 1</title>
<style>
<!--
table.MsoTableGrid
	{border:1.0pt solid windowtext;
	font-size:10.0pt;
	font-family:"Times New Roman","serif"}
-->
</style>
</head>

<body>

<div align="center">
  <center>
  <table border="0" width="740" height="350" cellspacing="0" cellpadding="0">
    <!-- MSTableType="nolayout" -->
	<tr>
      <td width="740" height="133" background="Site/top.jpg" colspan="3">&nbsp;</td>
    </tr>
    <tr>
      <td width="127" height="356" background="Site/middle1.jpg" valign="top">
        <p align="left">
        <b><font face="Arial" size="1" color="#505866">&nbsp;&nbsp;&nbsp; 
		<a href="http://www.blitz-school.info"><font color="#FFFF99">Курсы</font></a><br>
        &nbsp;&nbsp;&nbsp; </font><font face="Arial" size="1" color="#FFFF99">
		<a href="http://www.blitz-school.info/reg.html"><font color="#FFFF99">Регистрация</font></a><br>
        &nbsp;&nbsp;&nbsp;
		<a href="http://www.blitz-school.info/study_tech.html">
		<font color="#FFFF99">Методика</font></a><br>
        &nbsp;&nbsp;&nbsp; </font>
		<a href="http://www.blitz-school.info/program.html"><font face="Arial" size="1" color="#FFFF99">Оглавление</font></a><font face="Arial" size="1" color="#FFFF99"><br>
        &nbsp;&nbsp;&nbsp; <a href="http://www.blitz-school.info/login.html">
		<font color="#FFFF99">Для учащихся</font></a><br>
        &nbsp;&nbsp;&nbsp; </font></b>
		<img border="0" src="../navdiv.gif" width="80" height="4"><br>
        <b><font size="1" face="Arial" color="#505866">&nbsp;&nbsp;&nbsp;
        <a href="http://www.blitz-school.info/articles.html">
		<font color="#FFFF99">Статьи</font></a><br>
        &nbsp;&nbsp;&nbsp; </font><font size="1" face="Arial" color="#FFFF99">
		<a href="http://www.blitz-school.info/instrum.html">
		<font color="#FFFF99">Инструменты</font></a><br>
		<span lang="en-us">&nbsp;&nbsp;&nbsp; </span>
		<a href="http://www.blitz-school.info/contacts.html">
		<font color="#FFFF99">Контакты</font></a><br>
		<span lang="en-us">&nbsp;&nbsp;&nbsp; </span></font></b>&nbsp;</td>
      <td width="586" height="356" background="Site/bg.gif" valign="top">

<p align="center"><font color="#008000"><b><font size="5"><span lang="ru">Урок </span>
12<span lang="ru">.</span></font></b><span lang="ru"><font size="5"><b>&nbsp; 
Перемещение по локациям</b></font><br>
</span>
</font><b></p>
<p align="justify"><span lang="ru"><font size="2" face="Arial" color="#000080">
12<a name="kopv">.1. 
Таблица городов</a></font></span></b><span lang="ru"><b><a name="kopv"><font size="2" face="Arial" color="#000080">.</font></a></b><font size="2" face="Arial">
<br>
</font></span><font size="2" face="Arial">
&nbsp;&nbsp;&nbsp;&nbsp; <span lang="ru"><br>
&nbsp;&nbsp; Мир онлайн игры не должен ограничиваться только одним городом. Если 
количество играющих в одном городе вырастет им станет явно тесно и возникнет 
необходимость создать еще несколько городов. <br>
&nbsp;&nbsp;&nbsp; Более того, создание дополнительных городов придает игре еще 
больше интереса. В магазинах других городов могут присутствовать вещи 
отсутствующие в столице. Там могут присутствовать специфические строения, 
которых нет в других местах. Все это будет стимулировать игроков к поездкам 
между городами и затратам на билеты, что может привлечь дополнительные реальные 
деньги в игру (переведенные в игровую валюту)<br>
&nbsp;&nbsp;&nbsp; Давайте создадим таблицу городов, пополнив наш
</span><span lang="en-us">SQL </span>с<span lang="ru">крипт:</span></font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table1">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">/*Таблица городов*/<br>
		CREATE TABLE `<b>Towns</b>` (<br>
		`<font color="#000080">ID</font>` SMALLINT(2) unsigned NOT NULL 
		auto_increment,<br>
		`<font color="#000080">TownName</font>` char(40) default NULL,<br>
		`<font color="#000080">TownStatus</font>` SMALLINT(2) unsigned NOT NULL 
		DEFAULT 1, /*1-обычный,2-столица,3-секретный*/<br>
		PRIMARY KEY (`ID`)<br>
		) TYPE=MyISAM;</font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial">
<span lang="ru">&nbsp;&nbsp; Эта таблица предельно проста и содержит всего три 
поля:
</span></font><font color="#000080" face="Courier" size="2">ID</font><font size="2" face="Arial"><span lang="ru"> 
- идентификатор города,</span></font><font color="#000080" face="Courier" size="2">TownName</font><font size="2" face="Arial"><span lang="ru"> 
- название города и
</span></font><font color="#000080" face="Courier" size="2">TownStatus</font><font size="2" face="Arial"><span lang="ru"> 
- статус города. Теперь заполним таблицу хотя бы парой строчек:</span></font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table2">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">INSERT INTO towns (TownName, 
		TownStatus) VALUES('Силлурия',2);<br>
		INSERT INTO towns (TownName, TownStatus) VALUES('Гринсфилд',1);</font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial">
<span lang="ru">&nbsp;&nbsp; По умолчанию игрок регистрируется в столице 
игрового мира (Силлурии), которая имеет статус 2.&nbsp; Смотрите табличку
<a href="12_2/mmclub.sql">здесь</a>.<br>
</span>&nbsp;&nbsp; <span lang="ru"> <br>
&nbsp; 
<br>
</span></font><a name="kopv0"><span lang="ru"><b>
<font face="Arial" size="2" color="#000080">12</font></b></span></a><font size="2" face="Arial"><b><span lang="ru"><font face="Arial" color="#000080"><a name="kopv0"><font size="2">.2. 
</font></a></font></span><font size="2" face="Arial" color="#000080">
<span lang="ru"><a name="kopv0">План перемещений</a><a name="kopv1">.</a></span></font></b><span lang="ru"> <br>
<br>
&nbsp;&nbsp;&nbsp; Для того, чтоб создать вокзал и расписание карет, нам 
понадобится карта перемещений. В учебных целях мы соединим только два города 
Силлурию и Гринсфилд, остальные маршруты Вы сможете добавить сами.<br>
&nbsp;&nbsp;&nbsp; Карта, отображающая направления движения карет и пассажирских 
судов в нашем исполнении выглядит таким образом:<br>
<br>
&nbsp;<img border="0" src="roads.jpg" width="350" height="256"><br>
&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp; <a href="12_2/Roads/Altriks%20Global%20Road%20map.jpg">Здесь</a> Вы 
можете найти ее в большем формате.<br>
&nbsp;</span><br>
<a name="kopv2"><span lang="ru"><font color="#000080"><b>12</b></font></span></a><b><span lang="ru"><font face="Arial" color="#000080"><a name="kopv2"><font size="2">.3. </font>
</a></font></span></b><span lang="ru"><b>
<font size="2" face="Arial" color="#000080"><a name="kopv2">Создание вокзала, 
расписание карет</a><a name="kopv3">.</a></font></b> <br>
<br>
&nbsp;&nbsp;&nbsp;Основной функцией вокзала служит продажа билетов и организация 
посадки игрока в транспортное средство. Для того чтоб создать механизм продажи 
билетов, давайте придумаем табличку 
</span><span lang="en-us"><b>tickets</b>.&nbsp;&nbsp;&nbsp;&nbsp; </span></font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table3">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">
		<font color="#008080">/* билеты на вокзале */<br>
		</font>CREATE TABLE `tickets`(<br>
		`TK_ID` BIGINT(20) unsigned NOT NULL auto_increment,
		<font color="#008080">/* ID */</font><br>
		`IL_ID` INT(4) unsigned NOT NULL,<font color="#008080">/*ID предмета в 
		справочнике предметов*/</font><br>
		`Town` INT(2) unsigned NOT NULL, <font color="#008080">/* ID Города, где 
		расположен вокзал */</font><br>
		`TownTo` INT(2) unsigned NOT NULL, <font color="#008080">/* ID Города, 
		куда отправляемся */</font><br>
		`DateStart` TIMESTAMP NOT NULL, <font color="#008080">/* дата и время 
		отправления*/</font><br>
		`Price` INT NOT NULL, <font color="#008080">/* цена билета */</font><br>
		`MovingTime` INT NOT NULL, <font color="#008080">/* время переезда 
		(минут) */</font><br>
		`QTY` INT NOT NULL, <font color="#008080">/* количество предметов */</font><br>
		PRIMARY KEY (`TK_ID`),<br>
		KEY (`Town`)<br>
		) TYPE=MyISAM;</font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial"><span lang="en-us">&nbsp; </span>
Чтоб продать билет, нам нужно иметь его описание в <u>справочник предметов</u> 
игры (<b><span lang="en-us">items_list</span></b>)<span lang="en-us"> </span>
Давайте<span lang="en-us"> </span>добавим туда тип предмета - билет.</font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table4">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">INSERT INTO 
		Items_List (IL_ID,ItemType,ItemNo,ItemName,Item_StateCost,Item_Image,ItemSlotName, 
		Item_Level,Item_FullLife,Item_Use) VALUES(17,16,1,'<font color="#008000">Билет 
		на карету</font>',0,'ticket.gif','Ticket',1,1,1);</font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial">&nbsp;&nbsp; В таблицу предметов 
(<b><span lang="en-us">items</span></b>) мы также должны добавить два поля<span lang="en-us">:</span></font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table5">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">`Item_TID` INT 
		DEFAULT 0, <font color="#008080">/*для билетов - ID строки из tickets с 
		записью о времени,пункте отправки и т.д.*/</font><br>
		`Item_DateTime` TIMESTAMP, <font color="#008080">/*для билетов - дата и 
		время отправления*/</font></font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial"><span lang="en-us">&nbsp; </span>
Поле </font><font face="Courier" size="2"><font color="#000080">Item_TID</font>
</font><font size="2" face="Arial">будет<span lang="en-us"> </span>хранить 
идентификатор той строки из таблицы <span lang="en-us">tickets </span>из которой 
мы купили билет. Это нам понадобится, чтоб знать параметры билета и пункт 
назначения.<span lang="en-us"> </span>Поле </font><font face="Courier" size="2">
<font color="#000080">Item_DateTime</font> </font><font size="2" face="Arial">-
<span lang="en-us">б</span>удет содержать дату и время отправления.<span lang="en-us"><br>
</span>&nbsp;&nbsp; <span lang="en-us"><br>
</span>&nbsp;&nbsp; Здание вокзала на Центральной площади у нас выглядит так:</font></p>
<table border="1" width="100%" id="table6">
	<tr>
		<td>
		<img border="0" src="12_5/items/TOWNS/Silluria/bank.gif" width="61" height="59"> 
		Вокзал</td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial">&nbsp;&nbsp; В нашем файле
<span lang="en-us">map.phtml </span>описание вокзала выполнено следующим 
образом:</font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table7">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">&lt;div style=&quot;position:absolute;left:590px;top:190px;width:149px; 
		height:136px; z-index:12;z-index:12&quot;&gt;&lt;IMG SRC=Items/Towns/Silluria/bank.gif 
		CLASS=<font color="#000080">aFilter onmouseover=&quot;imover(this)&quot; 
		onmouseout=&quot;imout(this)&quot; onclick=&quot;gotoStation</font>()&quot; ALT=&quot;<font color="#008000">Вокзал</font>&quot; 
		width=&quot;70&quot; height=&quot;70&quot;&gt;&lt;/div&gt;</font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial">&nbsp;&nbsp; При нажатии на 
картинку вокзала, срабатывает функция </font>
<font color="#000080" face="Courier" size="2">gotoStation </font>
<font size="2" face="Arial">и мы входим непосредственно в здание вокзала (см. 
изменения в файле <span lang="en-us">map.phtml </span><a href="12_3/map.phtml">
тут</a>). Давайте создадим файл <span lang="en-us">station.phtml</span>,<span lang="en-us">
</span>который визуализирует наш с Вами вокзал. <br>
&nbsp;&nbsp;&nbsp;&nbsp; При попадании в здание вокзала, игрок должен видеть 
доступные для продажи билеты. Пока таблица <span lang="en-us"><b>tickets</b>
</span>пуста, но мы должны заполнить ее информацией о билетах:</font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table8">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">INSERT INTO tickets 
		(IL_ID,QTY,DateStart,Town,Townto,Price,MovingTime) VALUES(17,20,'<font color="#000080">2008-06-16 
		09:30</font>',1,2,2,120);<br>
		INSERT INTO tickets (IL_ID,QTY,DateStart,Town,Townto,Price,MovingTime) 
		VALUES(17,40,'<font color="#000080">2008-06-16 12:30</font>',1,2,2,120);<br>
		INSERT INTO tickets (IL_ID,QTY,DateStart,Town,Townto,Price,MovingTime) 
		VALUES(17,30,'<font color="#000080">2008-06-16 14:03</font>',1,2,4,60);</font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial">&nbsp;&nbsp;&nbsp; <b>Внимание!</b> 
В поле </font><font face="Courier" size="2">DateStart </font>
<font size="2" face="Arial">обязательно пропишите Вашу <u>сегодняшнюю</u> дату 
(время можете оставить то же). Как Вы заметили все билеты продаются только до 
Гринсфилда (<span lang="en-us">ID </span>города - 2).&nbsp; <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Теперь напишем код для отображения информации о 
продаваемых билетах:</font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table9">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">$query =
		<font color="#008000">&quot;SELECT Town, Character_Money from users WHERE 
		Nick_Name='$aNickName'&quot;</font>;<br>
		$result = <font color="#0000FF">mysql_query</font>($query) or
		<font color="#0000FF">die</font>(&quot;Query failed : &quot; .
		<font color="#0000FF">mysql_error</font>());<br>
		$aRow = <font color="#0000FF">mysql_fetch_array</font>( $result);<br>
		$aTown = $aRow[&quot;Town&quot;]; <font color="#008080">// узнаем город</font><br>
		$aMoney = $aRow[&quot;Character_Money&quot;]; <br>
		<br>
		$query = <font color="#008000">&quot;select tk.TK_ID, tk.TownTo, tk.DateStart, 
		tk.Price, tk.MovingTime, tk.QTY, tw.TownName from tickets tk inner join 
		towns tw on tk.TownTo = tw.ID where tk.Town = '$aTown'&quot;</font>;<br>
		$result = mysql_query($query) or die(&quot;Query failed : &quot; . mysql_error());<br>
		<font color="#0000FF">print</font>('&lt;table bgcolor=&quot;#DDFAFB&quot;&gt;&lt;tr&gt; &lt;td&gt;&lt;b&gt;Пункт 
		назначения&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;b&gt;Время переезда&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;b&gt;Время 
		отправления&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;b&gt;Кол-во билетов&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;b&gt;Цена&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt; 
		&lt;/tr&gt;&lt;tr&gt;'); <br>
		<font color="#0000FF">while</font> ($aRow = <font color="#0000FF">
		mysql_fetch_array</font>($result)) {<br>
&nbsp;$aTK_ID = $aRow[&quot;TK_ID&quot;]; <br>
&nbsp;$aTownTo = $aRow[&quot;TownTo&quot;];<br>
&nbsp;$aTownToName = $aRow[&quot;TownName&quot;]; <br>
&nbsp;$aQTY = $aRow[&quot;QTY&quot;]; <br>
&nbsp;$aMovingTime = $aRow[&quot;MovingTime&quot;]; <br>
&nbsp;$aPrice = $aRow[&quot;Price&quot;];<br>
&nbsp;$aDateStart = $aRow[&quot;DateStart&quot;]; <br>
&nbsp;<font color="#0000FF">print</font>(&quot;&lt;td&gt;$aTownToName&lt;/td&gt;&lt;td&gt;$aMovingTime&lt;/td&gt;&lt;td&gt;&nbsp; 
		$aDateStart&lt;/td&gt;&lt;td&gt;$aQTY&lt;/td&gt;&lt;td&gt;$aPrice&lt;/td&gt;&quot;);<br>
		<font color="#0000FF">if</font> ( $aQTY &gt; 0 ) {<br>
		<font color="#0000FF">print</font>('&lt;td&gt;&lt;input type=button value=&quot;Купить&quot; 
		onClick=&quot;<font color="#000080">BuyTicket</font>('.$aTK_ID .')&quot;&gt;&lt;/td&gt;');<br>
		}<br>
		<font color="#0000FF">print</font>('&lt;/tr&gt;');<br>
		}<br>
		<font color="#0000FF">print</font>('&lt;/table&gt;');<br>
		};</font></td>
	</tr>
</table>
<p align="justify"><font size="2" face="Arial">&nbsp;&nbsp; Вначале мы определим 
текущий город<span lang="en-us"> </span>из таблицы <span lang="en-us"><b>users</b>.
</span>Затем по нему отберем билеты из таблицы <span lang="en-us"><b>tickets</b>.<br>
&nbsp;&nbsp; </span>В окне браузера это выглядит так:<span lang="en-us"><br>
<br>
<img border="0" src="tickets.jpg" width="522" height="201"><br>
</span><span lang="ru">
<br>
&nbsp;&nbsp; <br> 
</span><a name="kopv4"><span lang="ru"><font color="#000080"><b>12</b></font></span></a><b><span lang="ru"><font face="Arial" color="#000080"><a name="kopv4"><font size="2">.4.</font></a></font></span></b><font color="#000080"><b>
<span lang="ru">Покупка и сдача билетов<a name="kopv4"> </a>
</span> </b></font><span lang="ru">&nbsp;<br>
<br>
&nbsp;&nbsp;&nbsp; Давайте реализуем обработку нажатия кнопки &quot;Купить&quot;. При 
нажатии на нее срабатывает функция ,
</span></font><font color="#000080" face="Courier" size="2">BuyTicket </font>
<font size="2" face="Arial"><span lang="ru">которой в качестве аргумента 
передается идентификатор строки приобретенияя билетов. Сама функция на 
</span><span lang="en-us"><i>JavaScript</i> </span>в<span lang="ru">ыглядит так:</span></font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table10">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2"><b>function</b> 
		BuyTicket( tk_id ){<br>
		location.href = &quot;station.phtml?tk_id=&quot;+tk_id+&quot;&amp;NickName=<b>&lt;?php</b>
		<font color="#0000FF">echo</font> $aNickName <b>?&gt;</b>&quot;;<br>
		}</font></td>
	</tr>
</table>
<p align="justify"><font face="Arial" size="2">&nbsp; В параметре </font>
<font face="Courier" size="2"><font color="#000080">tk_id</font> </font>
<font face="Arial" size="2">нашему скрипту </font><font face="Courier" size="2">
station.phtml </font><font face="Arial" size="2">передается тот же
<span lang="ru">идентификатор строки покупки билетов. Теперь мы можем 
реализовать непосредственно механизм покупки. Прием параметра весьма стандартен:</span></font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table11">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">
		<font color="#0000FF">if</font> (!<font color="#0000FF">empty</font>($<font color="#0000FF">_GET</font>['tk_id'])){<br>
&nbsp; $aTicketId = $_GET['tk_id'];<br>
		}</font></td>
	</tr>
</table>
<p align="justify"><font face="Arial" size="2">Т<span lang="ru">еперь произведем 
покупку:</span></font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table12">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">
		<font color="#008080">// была инициирована покупка билета<br>
		</font><font color="#0000FF">if</font> ($aTicketId &lt;&gt; 0){<br>
		$query = <font color="#008000">&quot;select tk.TK_ID, tk.IL_ID, tk.TownTo, 
		tk.DateStart, tk.Price, tk.MovingTime, tk.QTY from tickets tk where 
		tk.tk_id = '$aTicketId'&quot;</font>;<br>
		$result = <font color="#0000FF">mysql_query</font>($query) or
		<font color="#0000FF">die</font>(&quot;Query failed : &quot; .
		<font color="#0000FF">mysql_error</font>());<br>
		$aRow = <font color="#0000FF">mysql_fetch_array</font>( $result);<br>
		$aTK_ID = $aRow[&quot;TK_ID&quot;];<br>
		$aIL_ID = $aRow[&quot;IL_ID&quot;];<br>
		$aTownTo = $aRow[&quot;TownTo&quot;];<br>
		$aQTY = $aRow[&quot;QTY&quot;];<br>
		$aMovingTime = $aRow[&quot;MovingTime&quot;];<br>
		$aPrice = $aRow[&quot;Price&quot;];<br>
		$aDateStart = $aRow[&quot;DateStart&quot;];<br>
		$lNoMoney=false;<br>
		<font color="#0000FF">if</font> ($aQTY-- &gt; -1){ <font color="#008080">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
		// есть ли вообще билеты?</font><br>
		<font color="#0000FF">if</font> ($aMoney &gt;= $aPrice){
		<font color="#008080">&nbsp; // хватит ли денег купить билет?</font><br>
		$aMoney = $aMoney - $aPrice;<br>
		<font color="#008080">// Засунем в рюкзак купленный билет</font><br>
		$query = <font color="#008000">&quot;INSERT INTO items(IL_ID,Item_Owner,Item_Position,Item_CurrentLife,Item_TID,Item_DateTime)&quot;</font>;<br>
		$query .= &quot;Values ('$aIL_ID','$aUserID','2','1',$aTK_ID,'$aDateStart')&quot;;<br>
		$result = <font color="#0000FF">mysql_query</font>($query,$link) or
		<font color="#0000FF">die</font>(&quot;Query failed : &quot; .
		<font color="#0000FF">mysql_error</font>());<br>
		<br>
		<font color="#008080">// Уменьшим деньги</font><br>
		$query = <font color="#008000">&quot;UPDATE users SET Character_Money='$aMoney' 
		WHERE Nick_Name='$aNickName'&quot;</font>;<br>
		$result = <font color="#0000FF">mysql_query</font>($query) or
		<font color="#0000FF">die</font>(&quot;Query failed : &quot; .
		<font color="#0000FF">mysql_error</font>());<br>
		<br>
		<font color="#008080">// Уменьшим кол-во билетов на вокзале</font><br>
		$query = <font color="#008000">&quot;UPDATE tickets SET QTY='$aQTY',DateStart='$aDateStart' 
		WHERE TK_ID='$aTicketId'&quot;</font>;<br>
		$result = <font color="#0000FF">mysql_query</font>($query) or
		<font color="#0000FF">die</font>(&quot;Query failed : &quot; .
		<font color="#0000FF">mysql_error</font>());<br>
		<br>
		} <font color="#0000FF">else</font> {<br>
		$lNoMoney=true;<br>
		}<br>
		}<br>
		}</font></td>
	</tr>
</table>
<p align="justify"><font face="Arial" size="2"><span lang="ru">&nbsp; Вначале мы 
уточняем все параметры покупаемого билета из таблицы 
</span><b><span lang="en-us">tickets</span></b>,<span lang="ru"> а потом создаем 
его экземпляр в таблице 
</span><span lang="en-us"><b>items</b> </span>в<span lang="ru"> рюкзаке нашего 
персонажа. Естественно потом мы должны уменьшить количество билетов этого типа 
на вокзале и сумму денег у нашего персонажа, совершившего покупку.<br>
&nbsp; <img border="0" src="12_5/items/ticket.gif" width="60" height="60">&nbsp; 
- будет картинкой билета, отображающейся в нашем рюкзаке.<br>
&nbsp;&nbsp; Теперь у нас есть все права на поездку в город Гринсфилд.<br>
&nbsp;&nbsp; Нередко возникает ситуация, когда нужно продать купленный билет. Мы 
могли расхотеть ехать в Гринсфилд или опоздать к началу отъезда транспортного 
средства. Для этих целей нужно предусмотреть возможность продажи билета.<br>
&nbsp;&nbsp;&nbsp; В меню вокзала предусмотрим пункт&nbsp; &quot;Сдать&quot;, который на 
</span><span lang="en-us">HTML </span>в<span lang="ru">ыглядит так:</span></font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table13">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">&lt;a href=&quot;station.phtml?<font color="#000080">sell=1</font>&amp;NickName=<b>&lt;?php</b>
		<font color="#0000FF">echo</font> $aNickName; <b>?&gt;</b>&quot;&gt;
		<font color="#008000">Сдать</font>&lt;/a&gt;&lt;/font&gt;</font></td>
	</tr>
</table>
<p><font face="Courier" size="2">&nbsp;
<img border="0" src="menu.jpg" width="142" height="354"></font></p>
<p align="justify"><font face="Arial" size="2"><span lang="ru">&nbsp;&nbsp;&nbsp; 
При нажатии на ссылку &quot;Сдать&quot; скрипту 
</span></font><font face="Courier" size="2">station.phtml </font>
<font face="Arial" size="2"><span lang="ru">передается параметр 
</span></font><font face="Courier" size="2"><font color="#000080">sell=1</font></font><font face="Arial" size="2"><span lang="ru">, 
который переводит вокзал в режим сдачи билета обратно.</span> <span lang="ru">В 
окне мы должны отобразить только приобретенные билеты, лежащие в рюкзаке. 
Сделаем это следующим образом:</span></font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table14">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">
		<font color="#0000FF"><span lang="ru">....<br>
		</font><font color="#008080">// это уникальный IL_ID для билета (из 
		справочника предметов)<br>
		</font><font color="#000080">$TICKET_IL_ID</font><font color="#0000FF">
		</font>= 17<font color="#0000FF">;<br>
		<br>
		....</font></span><font color="#0000FF"><br>
		<br>
		if</font> ( $aSell == 1 ){<br>
		<font color="#008080">// покажем купленные билеты для сдачи</font><br>
		$query = <font color="#008000">&quot;SELECT i.IT_ID, i.IL_ID, il.Item_Image, 
		il.ItemName, i.Item_DateTime FROM Items i inner join Items_List il on 
		il.il_id=i.il_id WHERE i.Item_Owner='$aUserID' and i.IL_ID = '</font><span lang="ru"><font color="#000080">$TICKET_IL_ID</font></span><font color="#008000">'&quot;</font>;<br>
		$result = <font color="#0000FF">mysql_query</font>($query) or
		<font color="#0000FF">die</font>(&quot;Query failed : &quot; .
		<font color="#0000FF">mysql_error</font>());<br>
		<font color="#0000FF">print</font>('&lt;table&gt;');<br>
		<font color="#0000FF">while</font> ($aRow = <font color="#0000FF">
		mysql_fetch_array</font>($result)) {<br>
		$aSlotItemID = $aRow[&quot;IT_ID&quot;];<br>
		$aIL_ID = $aRow[&quot;IL_ID&quot;];<br>
		$aItemImage = $aRow[&quot;Item_Image&quot;];<br>
		$aItemName = $aRow[&quot;ItemName&quot;];<br>
		$aItem_DateTime = $aRow[&quot;Item_DateTime&quot;];<br>
		echo &quot;&lt;tr&gt;&lt;td&gt;&quot; . &quot;&lt;img border=0 src=Items/&quot;.$aItemImage.&quot; ALT='&quot;.$aItemName.' 
		Время отправления: '.$aItem_DateTime.&quot;'&gt;&quot; . &quot; &lt;a href='station.phtml?it_id=$aTicketItemID&amp;NickName=$aNickName'&gt;Сдать 
		билет (за 1 кр)&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;&quot;;<br>
		}<br>
		<font color="#0000FF">print</font>('&lt;/table&gt;');<br>
		}</font></td>
	</tr>
</table>
<p align="justify"><font face="Arial" size="2"><span lang="ru">&nbsp;&nbsp; 
Вначале мы отбираем все предметы типа &quot;билет&quot; у текущего игрока и выводим их со 
строкой, предлагающей сдать билет за одну кредитку. В окне браузера это выглядит 
так:<br>
<br>
<img border="0" src="sell_t.jpg" width="340" height="163"><br>
<br>
&nbsp;&nbsp; В качестве домашнего упражнения Вы можете вывести рядом с картинкой 
билета полную информацию о нем (время отправления, стоимость, пункт назначения).<br>
&nbsp;&nbsp; При нажатии на ссылку <u>Сдать билет...</u> мы передаем нашему 
скрипту содержащемуся в файле </span>station.phtml <span lang="ru">параметр </span></font>
<font face="Courier" size="2" color="#000080">it_id</font><font face="Arial" size="2"><span lang="ru">, 
который является идентификатором предмета (билета) в таблице билетов </span><b>
items</b><span lang="ru">.</span> <span lang="ru">Теперь мы можем произвести 
процесс сдачи следующим кодом:</span></font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table15">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">
		<font color="#008080">// была инициирована сдача билета<br>
		</font><font color="#0000FF">if</font> ($aItemId &lt;&gt; 0){<br>
		$query = <font color="#008000">&quot;delete from items where it_id='$aItemId'&quot;</font>;<br>
		$result = <font color="#0000FF">mysql_query</font>($query) or
		<font color="#0000FF">die</font>(&quot;Query failed : &quot; .
		<font color="#0000FF">mysql_error</font>());<br>
		<font color="#008080">// добавим 1 кр за сдачу билета</font><br>
		$query = <font color="#008000">&quot;UPDATE users SET Character_Money=Character_Money+1 
		WHERE Nick_Name='$aNickName'&quot;</font>;<br>
		$result = <font color="#0000FF">mysql_query</font>($query) or
		<font color="#0000FF">die</font>(&quot;Query failed : &quot; .
		<font color="#0000FF">mysql_error</font>());<br>
		$aMoney += 1;<br>
		$aSell = 1;<br>
		}</font></td>
	</tr>
</table>
<p align="justify"><font face="Arial" size="2"><span lang="ru">&nbsp;&nbsp; 
Сдаваемый билет мы просто удаляем из таблицы предметов и затем добавляем одну 
кредитку нашему игроку в качестве компенсации.<br>
</span>&nbsp;&nbsp;&nbsp;<span lang="ru"><br>
</span><a name="kopv6"><span lang="ru"><font color="#000080"><b>12</b></font></span></a><b><span lang="ru"><font face="Arial" color="#000080"><a name="kopv6"><font size="2">.5. 
</font></a></font></span></b><span lang="ru"><b>
<font size="2" face="Arial" color="#000080"><a name="kopv6">Перемещение из 
города в город</a><a name="kopv7">.</a></font></b>
<br><br>
&nbsp;&nbsp; Итак, предположим, что у нас есть билет до города Гринсфилд на 
11.30 сегодняшнего дня. Сейчас 11.29 и нам пора отправляться. Естественно, чтоб 
уехать на карете, наш персонаж должен находиться в здании вокзала. Как же нам 
сделать проверку, есть ли у нас билет на нужную карету, отправляющуюся к пункту 
назначения в положенное время?<br>
&nbsp;&nbsp;&nbsp; Давайте создадим функцию на </span>JavaScript <span lang="ru">
работающую по технологии </span>Ajax<span lang="ru">, которая будет опрашивать 
сервер, на предмет возникновения события отправления и присутствия у персонажа 
билета на нужный рейс.<br>
&nbsp;&nbsp;&nbsp;&nbsp; Наша функция </span></font>
<font color="#000080" face="Courier" size="2">CheckReadyToMove</font><font face="Arial" size="2"><span lang="ru">, 
а также еще парочку с которыми она работает, выглядят так:</span></font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table16">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">var StationDelay = 
		15; <br>
		....<br>
		function <font color="#000080">strt</font>(){ // Начинаем<br>
		ChatTimerID = setTimeout('RefreshStation()', 1000);<br>
		}<br>
		<br>
		function <font color="#000080">RefreshStation</font>()<br>
		{<br>
		if (StationTimerID&gt;=0) { clearTimeout(StationTimerID); }<br>
		StationTimerID = setTimeout('RefreshStation()', StationDelay*1000);<br>
		CheckReadyToMove();<br>
		}<br>
		<br>
		function <font color="#000080">CheckReadyToMove</font>() {<br>
		var rval = Math.round(Math.random()*10000000000000000000);<br>
		url = &quot;crtm.php?NickName=&lt;?php echo $aNickName ?&gt;&amp;rv=&quot;+rval;<br>
		if (window.XMLHttpRequest) {<br>
		req = new XMLHttpRequest();<br>
		} else if (window.ActiveXObject) {<br>
		req = new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;);<br>
		}<br>
		req.open(&quot;GET&quot;, url, false);<br>
		req.send(null);<br>
		if ( (req.readyState == 4) &amp;&amp; (req.status == 200) ) {<br>
		it_id = req.responseText;<br>
		if (it_id != 0){<br>
		location.href = &quot;karet.phtml?NickName=&lt;?php echo $aNickName ?&gt;&quot;;<br>
		}<br>
		}<br>
		}</font></td>
	</tr>
</table>
<p align="justify"><font face="Arial" size="2"><span lang="ru">&nbsp;&nbsp; 
Функция </span></font><font face="Courier" size="2"><font color="#000080">strt</font>()<span lang="ru">
</span></font><font face="Arial" size="2"><span lang="ru">вызывается сразу при 
загрузке страницы (в теге </span>&lt;body&gt;<span lang="ru">)</span></font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table17">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">&lt;body bgcolor=&quot;#e2e0e0&quot; 
		onload=&quot;<font color="#000080">strt</font>()&quot;&gt;</font></td>
	</tr>
</table>
<p align="justify"><font face="Arial" size="2">&nbsp; <span lang="ru">В 
соответствии с задержкой определенной в переменной </span></font>
<font face="Courier" size="2">StationDelay</font><font face="Arial" size="2"><span lang="ru">, 
каждые 15 секунд выполняется функция </span></font>
<font color="#000080" face="Courier" size="2">RefreshStation</font><font face="Arial" size="2"><span lang="ru">, 
из которой вызывается наша функция проверки возможности отправления на карете -
</span></font><font color="#000080" face="Courier" size="2">CheckReadyToMove</font><font face="Arial" size="2"><span lang="ru">. 
Эта функция использует технологию </span>Ajax - <span lang="ru">в данном случае 
для получения данных сервера, без перезагрузки страницы. Используется встроенный 
объект </span></font><font face="Courier" size="2" color="#008000">
XMLHttpRequest</font><font face="Arial" size="2"><span lang="ru">, если браузер 
Опера или </span>ActiveXObject </font>
<font face="Courier" size="2" color="#008000">Microsoft.XMLHTTP</font><font face="Arial" size="2"><span lang="ru">,</span>
<span lang="ru">если </span>Internet Explorer.<br>
&nbsp; <span lang="ru">Технология </span>Ajax <span lang="ru">выполняет скрипт
</span></font><font face="Courier" size="2">crtm.php</font><font face="Arial" size="2"><span lang="ru">,</span>
<span lang="ru">который и делает необходимые проверки на стороне сервера. При 
успешном выполнении условий (</span></font><font face="Courier" size="2">req.readyState 
== 4) &amp;&amp; (req.status == 200</font><font face="Arial" size="2"><span lang="ru">) 
мы получаем ответ от сервера в свойстве </span></font>
<font face="Courier" size="2"><font color="#000080">responseText</font><span lang="ru">
</span></font><font face="Arial" size="2"><span lang="ru">объекта </span>
<font color="#000080">req</font>.<span lang="ru"> Если значение этого свойства 
не 0, значит у нашего персонажа есть все предпосылки поехать в данный момент в 
Гринсфилд.<br>
&nbsp;&nbsp; Проверки в файле </span></font><font face="Courier" size="2">
crtm.php<span lang="ru"> </span></font><font face="Arial" size="2">
<span lang="ru">выглядят так:</span></font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table18">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">$query =
		<font color="#008000">&quot;SELECT USER_ID, Town FROM users where Nick_Name='$aNickName'&quot;</font>;<br>
		$result = <font color="#0000FF">mysql_query</font>($query) or
		<font color="#0000FF">die</font>(&quot;Query failed : &quot; .
		<font color="#0000FF">mysql_error</font>());<br>
		$aRow = <font color="#0000FF">mysql_fetch_array</font>( $result);<br>
		$aUSER_ID = $aRow[&quot;USER_ID&quot;];<br>
		$aTown = $aRow[&quot;Town&quot;];<br>
		<br>
		$curdate=<font color="#0000FF">date</font>(&quot;Ymd H:i&quot;);<br>
		<br>
		<font color="#008080">// поищем в билетах у игрока в рюкзаке и узнаем 
		время отправления</font><br>
		$query = <font color="#008000">&quot;SELECT i.Item_DateTime, i.Item_TID, 
		t.Town FROM items i inner join tickets t on i.Item_TID = t.TK_ID where 
		i.Item_Owner='$aUSER_ID' and </font><font color="#000080">date_format</font><font color="#008000">(i.Item_DateTime,'%Y%m%d 
		%H:%i') = '$curdate'&quot;</font>;<br>
		$result = <font color="#0000FF">mysql_query</font>($query) or
		<font color="#0000FF">die</font>(&quot;Query failed : &quot; .
		<font color="#0000FF">mysql_error</font>());<br>
		<font color="#0000FF">while</font> ($aRow = <font color="#0000FF">
		mysql_fetch_array</font>($result)) {<br>
		$aItemTID = $aRow[&quot;Item_TID&quot;];<br>
		$retStatus = $aItemTID;<br>
		}<br>
		<font color="#0000FF">echo</font> $retStatus;</font></td>
	</tr>
</table>
<p align="justify"><font face="Arial" size="2"><span lang="ru">&nbsp;&nbsp;&nbsp; 
Сперва мы формируем текущую дату в виде строки формата &quot;год<font color="#008080">месяц</font><font color="#0000FF">число</font> 
часы:минуты&quot; и сравниваем ее с такой же строкой (</span></font><font face="Courier" size="2"><font color="#000080">date_format</font><font color="#008000">(i.Item_DateTime,'%Y%m%d 
%H:%i')</font></font><font face="Arial" size="2"><span lang="ru">) из поля
</span></font><font color="#008000" face="Courier" size="2">Item_DateTime</font><font face="Arial" size="2"><span lang="ru">, 
таблицы </span><b>items</b> <span lang="ru">для билета, купленного нашим 
персонажем. <br>
&nbsp;&nbsp;&nbsp; В случае совпадения - выводим ненулевое значение (в данном 
случае - идентификатор билета). Этого достаточно чтоб это значение вернулось в 
вызывающей функции </span></font><font color="#000080" face="Courier" size="2">
CheckReadyToMove<span lang="ru"> </span></font><font face="Arial" size="2">
<span lang="ru">в нашем скрипте вокзала.<br>
&nbsp;&nbsp;&nbsp;&nbsp; И последнее, мы должны отобразить картинку, процесса 
езды в карете, после отправления.<br>
Правда перед этим давайте добавим объект кареты в таблицу </span><b>Buildings</b>:</font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table20">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">INSERT INTO 
		Buildings (ID, BuildingName, BuildingType, Town,PHP_File) VALUES(<font color="#0000FF">11</font>,'<font color="#008000">Карета</font>',<font color="#0000FF">11</font>,1,'karet.phtml');</font></td>
	</tr>
</table>
<p align="justify"><font face="Arial" size="2"><span lang="ru">&nbsp;</span>C<span lang="ru">оздадим 
простой файлик </span>karet.phtml, <span lang="ru">основной </span>PHP
<span lang="ru">код которого выглядит так:</span></font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table19">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">$OBJECT_TYPE =
		<font color="#0000FF">11</font>; <font color="#008080">// тип данного 
		объекта (кареты) 11 для всех городов</font><br>
		<span lang="ru">......</span><br>
		$query = <font color="#008000">&quot;SELECT Town, Character_Money, USER_ID 
		from users WHERE Nick_Name='$aNickName'&quot;</font>;<br>
		$result = <font color="#0000FF">mysql_query</font>($query) or
		<font color="#0000FF">die</font>(&quot;Query failed : &quot; .
		<font color="#0000FF">mysql_error</font>());<br>
		$aRow = <font color="#0000FF">mysql_fetch_array</font>( $result);<br>
		$aUserID = $aRow[&quot;USER_ID&quot;]; <font color="#008080">// ID нашего игрока</font><br>
		$aTown = $aRow[&quot;Town&quot;];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<font color="#008080">// узнаем город</font><br>
		$aMoney = $aRow[&quot;Character_Money&quot;];<br>
		<br>
		$query = <font color="#008000">&quot;SELECT ID FROM Buildings where Town=$aTown 
		and BuildingType=$OBJECT_TYPE&quot;</font>;<br>
		$result = <font color="#0000FF">mysql_query</font>($query) or
		<font color="#0000FF">die</font>(&quot;Query failed : &quot; .
		<font color="#0000FF">mysql_error</font>());<br>
		$aRow = <font color="#0000FF">mysql_fetch_array</font>( $result);<br>
		$aObjectID = $aRow[&quot;ID&quot;];<br>
		<font color="#008080">// меняем комнату у игрока</font><br>
		$query = <font color="#008000">&quot;UPDATE users SET Building=$aObjectID 
		WHERE Nick_Name='$aNickName'&quot;</font>;<br>
		$result = <font color="#0000FF">mysql_query</font>($query) or
		<font color="#0000FF">die</font>(&quot;Query failed : &quot; .
		<font color="#0000FF">mysql_error</font>());</font></td>
	</tr>
</table>
<p align="justify"><font face="Arial" size="2"><span lang="ru">&nbsp;&nbsp; И 
отобразим анимационную картинку движущейся кареты:</span></font></p>
<table border="0" width="100%" cellspacing="0" cellpadding="0" id="table21">
	<tr>
		<td bgcolor="#FFFFCC"><font face="Courier" size="2">&lt;img src=&quot;items/horseanim.gif&quot;&gt;</font></td>
	</tr>
</table>
<p align="justify"><font face="Arial" size="2"><span lang="ru">&nbsp; Которая 
выглядит так:
<img border="0" src="12_5/items/HorseAnim.gif" width="229" height="109"><br>
<br>
&nbsp; В качестве домашнего упражнения, Вы можете определить конец движения 
транспортного средства и прибытие в другой город.<br>
&nbsp;&nbsp;&nbsp;<b><br>
В следующем уроке</b> мы займемся торговлей, создадим объект торговых рядов на 
Центральной площади и научимся продавать, покупать и передавать предметы 
непосредственно от персонажа к персонажу.</span></font></p>
<font size="2" face="Arial">
        <p align="left">&nbsp;</font></td>
      <td width="27" height="356" background="Site/middle2.jpg">&nbsp;</td>
    </tr>
    <tr>
      <td width="740" height="38" background="Site/bottom.jpg" colspan="3">&nbsp;</td>
    </tr>
  </table>
  </center>
</div>

</body>

</html>