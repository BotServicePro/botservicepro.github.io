<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head>
  
  <meta http-equiv="Content-Language" content="ru">
  
  <title>Центр обучения созданию компьютерных игр</title>
  <meta name="description" content="Blitz-School - Школа создателей компьютерных игр на языке Blitz3D. Если вы хотите быстро научиться делать компьютерные игры или интересуетесь их созданием, то этот сайт будет вам полезен">
  <meta name="keywords" content="программирование, создание игр, курсы создания игр, школа создателей компьютерных игр, blitzbasic, компьютерные игры, как написать игру, как создать игру, программирование компьютерных игр, Blitz3D, программирование игр, разработка игр, создание 3d игр, аудио, графика, дизайн, 3D">
  <link rel="stylesheet" type="text/css" href="main.css">
  <script language="JavaScript" src="index_files/script.js" type="text/javascript"></script>
  <script type="text/javascript" src="scripts/shCore.js"></script>
  <script type="text/javascript" src="scripts/shBrushBash.js"></script>
  <script type="text/javascript" src="scripts/shBrushCpp.js"></script>
  <script type="text/javascript" src="scripts/shBrushCSharp.js"></script>
  <script type="text/javascript" src="scripts/shBrushCss.js"></script>
  <script type="text/javascript" src="scripts/shBrushDelphi.js"></script>
  <script type="text/javascript" src="scripts/shBrushDiff.js"></script>
  <script type="text/javascript" src="scripts/shBrushGroovy.js"></script>
  <script type="text/javascript" src="scripts/shBrushJava.js"></script>
  <script type="text/javascript" src="scripts/shBrushJScript.js"></script>
  <script type="text/javascript" src="scripts/shBrushPhp.js"></script>
  <script type="text/javascript" src="scripts/shBrushPlain.js"></script>
  <script type="text/javascript" src="scripts/shBrushPython.js"></script>
  <script type="text/javascript" src="scripts/shBrushRuby.js"></script>
  <script type="text/javascript" src="scripts/shBrushScala.js"></script>
  <script type="text/javascript" src="scripts/shBrushSql.js"></script>
  <script type="text/javascript" src="scripts/shBrushVb.js"></script>
  <script type="text/javascript" src="scripts/shBrushXml.js"></script>
  <script type="text/javascript" src="scripts/shBrushBlitz3D.js"></script>
  <link type="text/css" rel="stylesheet" href="styles/shCore.css">
  <link type="text/css" rel="stylesheet" href="styles/shThemeDefault.css">
  <script type="text/javascript">
SyntaxHighlighter.config.clipboardSwf = 'scripts/clipboard.swf';
SyntaxHighlighter.all();
  </script>
  <meta content="MSHTML 6.00.6000.20772" name="GENERATOR"></head>

<body topmargin="0" leftmargin="0" style="BACKGROUND-COLOR: rgb(255,255,255)" marginheight  ="0" marginwidth="0">
<table cellpadding="0" cellspacing="0" width="100%">
  <tbody>
    <tr>
      <td rowspan="2" height="197" width="21"><img height="197" src="index_files/ltoptable.png" width="21" border="0"></td>
      <td colspan="5" valign="top">
      <table cellpadding="0" cellspacing="0" width="100%">
        <tbody>
          <tr>
            <td height="49" width="231"><img height="49" src="index_files/topmenu.png" width="231" usemap="#ImageMap1" border="0"></td>
            <td background="index_files/mtop.gif"><map name="ImageMap1"><area onclick="this.style.behavior='url(#default#homepage)';this.setHomePage('http://www.blitz-school.info'); return false;" shape="RECT" coords="17,26,71,40" href="index.phtml"><area shape="RECT" coords="91,27,149,39" href="javascript:window.external.AddFavorite('http://www.blitz-school.info', 'GameSchool - Центр обучения созданию компьютерных игр!')"></map>
            <div class="searchform" align="right">
            <form method="post"><input value="search" name="do" type="hidden">&nbsp;</form>
            </div>
            </td>
            <td height="49" width="13"><img height="49" src="index_files/mlefttop.png" width="13" border="0"></td>
          </tr>
        </tbody>
      </table>
      </td>
    </tr>
    <tr>
      <td height="148" valign="top" width="225">
      <table cellpadding="0" cellspacing="0" height="148" width="100%">
        <tbody>
          <tr>
            <td height="119" width="225"><a title="Центр обучения созданию компьютерных игр" href="index.phtml"><img height="119" src="index_files/title.png" width="225" border="0"></a></td>
          </tr>
          <tr>
            <td background="index_files/date_b.png" valign="bottom">
            <div class="date" style="FONT-SIZE: 11px; MARGIN-BOTTOM: 10px; MARGIN-LEFT: 12px">
            <script language="JavaScript1.2">
<!-- Begin
var months=new Array(13);
months[1]="января";
months[2]="февраля";
months[3]="марта";
months[4]="апреля";
months[5]="мая";
months[6]="июня";
months[7]="июля";
months[8]="августа";
months[9]="сентября";
months[10]="октября";
months[11]="ноября";
months[12]="декабря";
var time=new Date();
var lmonth=months[time.getMonth() + 1];
var date=time.getDate();
var year=time.getYear();
var hours=time.getHours();
var minutes=time.getMinutes();
if (eval(hours) <10) {hours="0"+hours}
if (eval(minutes) < 10) {minutes="0"+minutes}
if (year < 2000)
year = year + 1900;
document.write("Сейчас: " + date + " ");
document.write(lmonth + " " + year + ", " + hours + ":" + minutes + " ");

// End -->


function updateClock ( )
{
var currentH = ( currentHours < 10 ? "0" : "" ) + currentHours;
var currentM = ( currentMinutes < 10 ? "0" : "" ) + currentMinutes;
var currentS = ( currentSeconds < 10 ? "0" : "" ) + currentSeconds;

currentTimeString = currentH + ":" + currentM + ":" + currentS;

if( currentTimeString == '00:00:00' ){
  location.href = 'res.php';
}
document.getElementById("restimer").innerHTML = currentTimeString;

if( currentSeconds >= 0 ) currentSeconds --;

if( currentSeconds == -1){
  currentMinutes --;
  currentSeconds = 59;
}

if( currentMinutes == -1 ){ 
   if (currentHours > 0) { 
      currentHours --;
      currentMinutes = 59; 
   } else currentMinutes = 0;
}
}



            </script>
            </div>
            </td>
          </tr>
        </tbody>
      </table>
      </td>
      <td width="296"><img height="148" src="index_files/mainleft.jpg" width="296" border="0"></td>
      <td width="205"><img height="148" src="index_files/mainright.jpg" width="205" border="0"></td>
      <td background="index_files/mback.png">&nbsp;</td>
      <td height="148" width="58"><img height="148" src="index_files/mltopr.png" width="58" border="0"></td>
    </tr>
  </tbody>
</table>
<table bordercolordark="black" bordercolorlight="black" cellpadding="0" cellspacing="0" width="100%">
  <tbody>
    <tr>
      <td background="index_files/anek_tb.png" height="27" valign="top" width="254">
      <div class="lefttext"><b>Меню:</b></div>
      </td><?php include 'menu_top.php'; ?> <td background="index_files/nav_back.gif">&nbsp;</td>
      <td width="17"><img height="27" src="index_files/nav_end.png" width="17" border="0"></td>
    </tr>
  </tbody>
</table>
<table cellpadding="0" cellspacing="0" width="100%">
  <tbody>
    <tr>
      <td background="index_files/lefttable.gif" valign="top" width="254"><!-- Menu -------->
      <div style="MARGIN-LEFT: 21px">
      <table cellpadding="0" cellspacing="0">
        <tbody>
          <tr>
            <td background="index_files/tb_back.gif">
            <div class="style3"><img src="index_files/home.gif"><a href="http://www.blitz-school.info/index.phtml">Главная</a><br>

        <img src="index_files/pages.gif"> <b>Перечень курсов</b><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/blitzindex.phtml">Создание 3D игр на Blitz3D</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/ogindex.phtml">Создание браузерной РПГ</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/egindex.phtml">Создание экономической браузерки</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/mgindex.phtml">Создание мобильных игр</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/cppindex.phtml">Создание 3D игр на С++</a><br>
        <img src="index_files/group.gif"> <a href="http://www.blitz-school.info/begin_study.phtml">Как стать слушателем</a><br>
        <img src="index_files/recom.gif"> <a href="http://www.blitz-school.info/study_tech.phtml">Технология обучения</a><br>
        <img src="index_files/loyalty_sm.jpg"> <a href="http://www.blitz-school.info/loyalty.phtml">Программа лояльности</a>
        <br>
&nbsp;&nbsp;&nbsp;&nbsp;
    <img border="0" src="index_files/navdiv.gif" width="80" height="4">
        <br><img src="index_files/newuser.gif"> <b>Регистрация</b><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/reg.phtml">Курс 3D игр на Blitz3D</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/reg2.phtml">Курс браузерной RPG</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/reg3.phtml">Экономическая браузерка</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/reg4.phtml">Курс мобильных игр</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/reg5.phtml">3D игры на С++</a><img src="index_files/new.gif"><br>
        <img src="index_files/admin.gif"> <a href="http://www.blitz-school.info/login.phtml">Вход для слушателей</a><br>
        <img src="index_files/study.gif"> <a href="http://www.blitz-school.info/program.phtml">Учебные программы курсов</a><br>
        <img src="index_files/society.gif"> <a href="http://www.blitz-school.info/response.phtml">Отзывы</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;
    <img border="0" src="index_files/navdiv.gif" width="80" height="4">
        
        <br><img src="index_files/media.gif"> <a href="http://www.blitz-school.info/distant.phtml">О дистанционном образовании</a><br>
        <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/articles.phtml">Статьи</a><br>
        <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/less_ex.phtml">Изложение материала</a><br>
        <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/gallery.phtml">Галерея</a><br> 
        <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/links.phtml">Полезные ссылки</a><br>
        <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/contacts.phtml">Контакты</a><br>
       <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/friends.phtml">Обмен ссылками</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;

            </div>
            </td>
          </tr>
          <tr>
            <td width="222"><img height="8" src="index_files/tb_b.gif" width="222" border="0"></td>
          </tr>
        </tbody>
      </table>
      </div><!-- ------------------ end of menu ------------------- --> </td>
      <td class="news" valign="top">
      <script language="javascript" type="text/javascript">
      </script>
      <div style="MARGIN-TOP: 7px">
      <table cellpadding="0" cellspacing="0" width="100%">
        <tbody>
          <tr>
            <td width="13"><img height="24" src="index_files/m_left.gif" width="13" border="0"></td>
            <td class="newstitle" background="index_files/m_center.gif">
            <b>Занятие
<span lang="en-us">4</span></b></td>
            <td class="newstitle" align="right" background="index_files/m_center.gif">&nbsp;</td>
            <td width="9"><img height="24" src="index_files/m_right.gif" width="9" border="0"></td>
          </tr>
        </tbody>
      </table>
      <table cellpadding="0" cellspacing="0" width="100%">
        <tbody>
          <tr>
            <td background="index_files/m_left_m.gif" width="4">&nbsp;</td>
            <td class="newsbody" bgcolor="#fdfdfd">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <font size="3"><b>Карта полей добычи<br>
			</b></font>
            <br>
            <b><font color="#4775a5"><span lang="en-us">4</span>.1. 
			</font><font color="#4775A5">Ресурсные поля </font><br>
            <br>
&nbsp;</b><span lang="en-us">&nbsp;</span>Здравствуйте, уважаемый коллега и 
			добро пожаловать на наше четвертое занятие, на котором мы вплотную 
			займемся экономикой нашего поселка. Любые военные действия и 
			строительство требуют вложения ресурсов и сегодня мы научимся их 
			производить. Более того, мы узнаем - как увеличивать доходность 
			ресурсных объектов, повышая их уровень.<br>
&nbsp; Какие же ресурсы мы будем добывать? А вот какие:<br>
			<br>
&nbsp;<table border="0" width="1142">
				<tr>
					<td align="center" width="285"><img border="0" src="www/img/res/r_wood.png" width="72" height="72"></td>
					<td align="center" width="285"><img border="0" src="www/img/res/r_clay.png" width="72" height="71"></td>
					<td align="center" width="285">
			<img border="0" src="www/img/res/r_ore.png" width="72" height="72"></td>
					<td align="center" width="285"><img border="0" src="www/img/res/r_grain.png" width="75" height="75"></td>
				</tr>
				<tr>
					<td align="center" width="285">Лесопилка<br>
					(производство древесины)</td>
					<td align="center" width="285">Глиняный карьер<br>
					(добыча глины)</td>
					<td align="center" width="285">Железный рудник<br>
					(добыча руды)</td>
					<td align="center" width="285">Ферма<br>
					(производство зерна)</td>
				</tr>
			</table>
			<p>На текущем занятии мы создадим страничку для отображения всех 
			ресурсных полей, а также страничку детальной информации по каждому 
			полю, на которой сделаем механизм апгрейда этого поля&nbsp; (то есть 
			увеличения его уровня и как следствие - производства 
			соответствующего ресурса)<br>
			<br>
			Мы также будем использовать пиктограммы для выведения сведений о 
			добыче ресурсов :<br>
			<img border="0" src="www/img/res/ore.png" width="18" height="12"> - 
			железо
			<img border="0" src="www/img/res/grain.png" width="18" height="12"> 
			- пшеница (зерно)
			<img border="0" src="www/img/res/clay.png" width="18" height="12"> - 
			глина&nbsp; и&nbsp;
			<img border="0" src="www/img/res/wood.png" width="18" height="12"> - 
			древесина<br>
			<br>
			<br>
			На фермах выращивают пшеницу и перерабатывают ее в зерно для 
			обеспечения продовольствием населения. С развитием фермы 
			увеличивается ее производительность. </p>
			<div id="lmidall">
				<div id="lmidlc">
					<div id="lmid1">
						<div id="lmid2">
							<div class="wholebox">
								На глиняном карьере добывают сырье глину. С 
								развитием глиняного карьера также увеличивается 
								его производительность. <br>
								<br>
								На лесопильном заводе производят древесину. С 
								развитием лесопильного завода увеличивается и 
								производство этого вида ресурса.<br>
								<br>
								На железных рудниках шахтеры добывают ценное 
								сырье – руду и перерабатывают ее в железо. С 
								развитием железного рудника, как Вы догадались, 
								увеличивается его производительность. <br>
								<br>
								Вот как будет выглядеть местность с ресурсными 
								полями вокруг нашего поселка:<br>
								<br>
								<img border="0" src="www/img/res_map.png" width="307" height="269"><br>
								Рисунок 4.1.1<br>
								<br>
&nbsp;Конечно, сразу понятно, где какой ресурс добывается. В специально 
								отведенных кружочках мы будем выводить уровень 
								добычи этого вида ресурса. С ростом уровня 
								ресурсного поля будут увеличиваться и затраты на 
								его апгрейд. Но это стоит того! Ведь тогда 
								ресурсов будет добываться еще больше и мы очень 
								быстро окупим вложения средств в увеличение 
								уровня.<br>
								<br>
								Давайте теперь сделаем в нашей базе
								<span lang="en-us"><b>travgame</b> </span>
								специальную табличку, которая опишет все типы 
								ресурсов, которые будут добываться в нашей игре.<br>
								Назовем эту табличку <b>res_fields_types</b>. 
								Вот она:<br>
<pre class="brush: sql;">-- справочник типов ресурсных полей ---------------
CREATE TABLE `res_fields_types` (
rft_id bigint(20) unsigned NOT NULL auto_increment, /*ID*/
rft_name char(30),
rft_image char(30),
rft_description char(255),
PRIMARY KEY (`rft_id`)
) ENGINE=MyISAM DEFAULT CHARSET=cp1251;
</pre>Фрагмент 4.1.1<br>
								<br>
								<b>rft_id</b> - это идентификатор ресурса.<br>
								<b>rft_name</b> - название ресурса <br>
								<b>rft_image</b>&nbsp; - картинка этого вида 
								ресурса для отображения в браузере<br>
								<b>rft_description</b> - краткое описание 
								ресурса .<br>
								<br>
								Давайте заполним эту таблицу реальными данными:<br>
<pre class="brush: sql;">insert into res_fields_types (rft_id, rft_name, rft_image, rft_description) 
values (1,'Ферма','img/res/r_grain.png',
'На фермах выращивают зерно для обеспечения продовольствием населения...');
insert into res_fields_types (rft_id, rft_name, rft_image, rft_description) 
values (2,'Железный рудник','img/res/r_ore.png',
'На железных рудниках шахтеры добывают ценное сырье – железо.');
insert into res_fields_types (rft_id, rft_name, rft_image, rft_description) 
values (3,'Лесопилка','img/res/r_wood.png',
'На лесопилке идет производство древесины...');
insert into res_fields_types (rft_id, rft_name, rft_image, rft_description) 
values (4,'Глиняный карьер','img/res/r_clay.png',
'На глиняном карьере добывают сырье глину...');
</pre>Фрагмент 4.1.2<p>Таким образом мы добавили четыре строки в нашу таблицу <b>
								res_fields_types </b>, где описали все виды 
								ресурсов, которые будем использовать в нашей с 
								Вами игре.<br>
&nbsp;</div>
						</div>
					</div>
				</div>
			</div>
			<p><b><font color="#4775a5"><span lang="en-us">4</span>.2. 
			Таблица добычи ресурсов</font></b><br>
            <br>
			&nbsp; В прошлом пункте мы создали таблицу описаний ресурсов - то 
			есть, по сути, это справочная информация. Теперь перед нами стоит 
			задача описания отдельных ресурсных полей для каждого поселка в 
			игре. <span lang="en-us">&nbsp;</span>Давайте попробуем это сделать:<br>
			</p>
<pre class="brush: sql;">-- таблица ресурсных полей для каждого поселка ---------------
CREATE TABLE `res_fields` (
rf_id bigint(20) unsigned NOT NULL auto_increment, /*ID ресурсного поля*/
rf_xcoord int,
rf_ycoord int,
rft_id int, /*тип рес.поля: 1-ферма,2-рудник,3-лес,4-глина*/
rf_level int default 0, /* уровень ресурсного поля */
fid int default 0, /*связан с принадлежащим игроку полем общей карты*/
PRIMARY KEY (`rf_id`)
) ENGINE=MyISAM DEFAULT CHARSET=cp1251;
</pre>Фрагмент 4.2.1<p><b>rf_id</b> <span lang="en-us">&nbsp;</span>- просто 
			идентификатор ресурсного поля <span lang="en-us"><br>
			</span><b>rf_xcoord</b> <span lang="en-us">-</span> координата Х - 
			выведения уровня поля на карте ресурсных полей<span lang="en-us"><br>
			</span><b>rf_ycoord</b> <span lang="en-us">-</span> координата У - 
			выведения уровня поля на карте ресурсных полей<span lang="en-us"><br>
			</span><b>rft_id</b> - это идентификатор из справочник типов&nbsp; 
			ресурсных полей (<b>res_fields_types</b>)<span lang="en-us">
			</span>и может принимать значения (1,2,3,4)<span lang="en-us"><br>
			</span><b>rf_level</b> <span lang="en-us">-</span> уровень 
			ресурсного поля (чем выше уровень - тем выше добыча)<span lang="en-us"><br>
			</span><b>fid</b> - идентификатор из таблицы участков на глобальной 
			карте (<b><span lang="en-us">fields</span></b>), т.е. мы закрепляем 
			ресурсные поля за своим поселком<span lang="en-us">.<br>
			<br>
			</span> В нашей учебной игре мы для простоты<span lang="en-us">
			</span> будем считать, что все поселки<span lang="en-us">
			</span> на глобальной карте обладают одинаковым набором<span lang="en-us">
			</span> ресурсных полей (см. рисунок 4.1.1)<span lang="en-us">
			</span> - то есть по 4 поля для глины, руды и леса и 6 полей для 
			зерна.<span lang="en-us"><br>
			<br>
			</span> И сейчас нам осталось<span lang="en-us">
			</span> создать процедуру для генерации всех ресурсных полей для 
			указанного<span lang="en-us">
			</span>поселка, в котором обитает один из зарегистрировавшихся 
			игроков.<span lang="en-us">
			</span>Назовем эту процедуру <b>makeresfields</b>.</p>
<pre class="brush: sql;">-- процедура по генерированию ресурсных полей для поселка ----------
create procedure makeresfields (p_fid int)
BEGIN
 -- Фермы 
 insert into res_fields (rf_xcoord,rf_ycoord,rft_id,fid) values (253,280,1,p_fid);
 insert into res_fields (rf_xcoord,rf_ycoord,rft_id,fid) values (304,273,1,p_fid);
 insert into res_fields (rf_xcoord,rf_ycoord,rft_id,fid) values (262,332,1,p_fid); 
 insert into res_fields (rf_xcoord,rf_ycoord,rft_id,fid) values (315,325,1,p_fid); 
 insert into res_fields (rf_xcoord,rf_ycoord,rft_id,fid) values (461,360,1,p_fid);
 insert into res_fields (rf_xcoord,rf_ycoord,rft_id,fid) values (386,196,1,p_fid); 
 -- Рудники
 insert into res_fields (rf_xcoord,rf_ycoord,rft_id,fid) values (269,228,2,p_fid); 
 insert into res_fields (rf_xcoord,rf_ycoord,rft_id,fid) values (434,305,2,p_fid); 
 insert into res_fields (rf_xcoord,rf_ycoord,rft_id,fid) values (490,306,2,p_fid); 
 insert into res_fields (rf_xcoord,rf_ycoord,rft_id,fid) values (483,249,2,p_fid); 
 -- Лес
 insert into res_fields (rf_xcoord,rf_ycoord,rft_id,fid) values (323,195,3,p_fid);
 insert into res_fields (rf_xcoord,rf_ycoord,rft_id,fid) values (446,210,3,p_fid);
 insert into res_fields (rf_xcoord,rf_ycoord,rft_id,fid) values (362,391,3,p_fid); 
 insert into res_fields (rf_xcoord,rf_ycoord,rft_id,fid) values (381,346,3,p_fid); 
 -- Глина
 insert into res_fields (rf_xcoord,rf_ycoord,rft_id,fid) values (360,236,4,p_fid);
 insert into res_fields (rf_xcoord,rf_ycoord,rft_id,fid) values (425,255,4,p_fid);
 insert into res_fields (rf_xcoord,rf_ycoord,rft_id,fid) values (308,378,4,p_fid);
 insert into res_fields (rf_xcoord,rf_ycoord,rft_id,fid) values (412,394,4,p_fid);
END; 
</pre>Фрагмент 4.2.2<p>Как Вы видите<span lang="en-us">,</span> в нашу процедуру 
			передается один аргумент (p_fid целого типа (<span lang="en-us">int</span>))<span lang="en-us"> 
			-
			</span> и это идентификатор<span lang="en-us">
			</span> поселка.<span lang="en-us"><br>
			</span> Далее мы повторяем <span lang="en-us">sql-</span>оператор
			<span lang="en-us">insert </span>для вставки в таблицу <b>res_fields</b> 
			6 полей зерна, 4 рудников,<span lang="en-us"> </span>4 лесопилок и 4 
			глиняных карьеров<span lang="en-us">.</span> Координаты
			<font color="#3B84D0">rf_xcoord</font> и <font color="#3B84D0">
			rf_ycoord</font><span lang="en-us"> </span>подбираем 
			экспериментально, чтоб уровни <font color="#3B84D0">rf_level</font>
			<span lang="en-us">(</span>который по умолчанию равен нулю)<span lang="en-us">
			</span>попадали в кружочки (рис. 4.1.1)<span lang="en-us">.</span> 
			Поле rft_id<span lang="en-us"> </span>устанавливаем в 1,2,3,4 (для 
			каждого ресурса свой номер - согласно справочнику типов полей <b>
								res_fields_types </b>)<span lang="en-us">,</span> 
			ну и fid устанавливаем в значение, передаваемое в качестве аргумента 
			в нашу процедуру <span lang="en-us">-</span> т.е. в идентификатор 
			поселка.<span lang="en-us"> <br>
			</span>Таким образом, <span lang="en-us">п</span>ри регистрации 
			нового игрока в игре и назначении ему поселка (участка карты в 
			таблице <span lang="en-us"><b>fields</b> </span>мы должны 
			позаботиться и вызвать эту процедуру, передав ей в качестве 
			аргумента идентификатор поселка этого нового игрока)<span lang="en-us"><br>
			</span>Давайте добавим все таблицы, созданные в текущем занятии, а 
			также процедуру <b>makeresfields </b>в наш скрипт <span lang="en-us">
			travgame.sql </span>и также пропишем вызов этой процедуры в нашем 
			скрипте:</p>
<pre class="brush: sql;">CALL makeresfields(49); 
</pre>Фрагмент 4.2.3<p>Число <font color="#3B84D0">49</font> , как вы догадались<span lang="en-us">,</span> 
			это идентификатор поселка для нашего игрока с именем
			<span lang="en-us"><font color="#3B84D0">test</font>.<br>
			</span>Выполните наш расширившийся скрипт <span lang="en-us">
			travgame.sql</span> и Вы увидите как данные добавились в новую 
			созданную таблицу <b>res_fields</b><span lang="en-us">.<br>
			<br>
			<img border="0" src="pics/tab1.png" width="558" height="401"><br>
			<br>
			</span>Рисунок 4.2.1<span lang="en-us"><br>
			<br>
			</span>Давайте теперь сделаем новую страничку <span lang="en-us">в</span> 
			нашей игре, для вывода карты добычи ресурсных полей<span lang="en-us">.</span> 
			Назовем ее<span lang="en-us"> </span>- <span lang="en-us"><b>res.php</b>.<br>
			</span>Для этой странички <span lang="en-us">с</span>делаем секцию 
			проверки авторизации, как ранее для <b><span lang="en-us">game.php</span></b>. 
			(Кстати, <b><span lang="en-us">game.php</span></b> мы переименуем в
			<span lang="en-us"><b>map.php</b> - </span>чтоб ее название четко 
			соответствовало ее назначению - показывать глобальную карту 
			участков)<span lang="en-us">.</span> Кроме этого мы добавим слой, в 
			котором будет находится <span lang="en-us">м</span>еню верхнего 
			уровня (по сути - это пара картинок, чтоб игрок мог переходить между 
			картой, ресурсами и строениями в поселке)<span lang="en-us">.</span>
			<br>
			Вот этот фрагмент на <span lang="en-us">HTML, </span>который мы 
			добавим в файл <b><span lang="en-us">game.php</span></b>. (Кстати, 
			неплохо бы его добавить и в <span lang="en-us"><b>map.php</b></span>)<br>
            </p>
<pre class="brush: html;">&lt;div id=&quot;header&quot;&gt;
&lt;div id=&quot;inheader&quot;&gt;
&lt;a href=&quot;res.php&quot; id=&quot;m1&quot;&gt;&lt;img src=&quot;img/menu_item1.jpg&quot; class=&quot;menu_img&quot; title=&quot;Обзор деревни&quot; /&gt;&lt;/a&gt;
&lt;a href=&quot;&quot; id=&quot;m2&quot;&gt;&lt;img src=&quot;img/menu_item2.jpg&quot; class=&quot;menu_img&quot; title=&quot;Центр деревни&quot; /&gt;&lt;/a&gt;
&lt;a href=&quot;map.php&quot; id=&quot;m3&quot;&gt;&lt;img src=&quot;img/menu_item3.jpg&quot; class=&quot;menu_img&quot; title=&quot;Карта&quot; /&gt;&lt;/a&gt;
&lt;a href=&quot;&quot; id=&quot;m4&quot;&gt;&lt;img src=&quot;img/menu_item4.jpg&quot; class=&quot;menu_img&quot; title=&quot;Статистика&quot; /&gt;&lt;/a&gt;
&lt;a href=&quot;&quot; id=&quot;m5&quot;&gt;&lt;img src=&quot;img/menu_item5.jpg&quot; class=&quot;menu_img&quot; title=&quot;Отчеты&quot; /&gt;&lt;/a&gt;
&lt;/div&gt;
&lt;/div&gt;
</pre>
Фрагмент 4.2.4<p>Вот картинки меню, которые мы используем:<br>
			<br>
			<img border="0" src="www/img/menu_item1.jpg" width="69" height="76"><img border="0" src="www/img/menu_item2.jpg" width="69" height="76"><img border="0" src="www/img/menu_item3.jpg" width="69" height="76"><img border="0" src="www/img/menu_item4.jpg" width="69" height="76"><img border="0" src="www/img/menu_item5.jpg" width="69" height="76"><br>
			<br>
			Как Вы видите из фрагмента 4.2.4 - не все пункты меню пока 
			задействованы<span lang="en-us">,</span> а только первый (ссылка на
			<b>res.php</b> ) и третий<span lang="en-us"> </span>(ссылка на <b>
			map.php</b>)<span lang="en-us">.</span> Теперь давайте сделаем<span lang="en-us">
			</span>вывод в <b>res.php </b>карты ресурсных полей и числа уровней 
			каждого из них.</p>


<pre class="brush: php;">
$fid = $_SESSION['fid'];

$res = mysql_query(&quot;SELECT rf_id, rf_xcoord, rf_ycoord, rf_level, rft_name FROM res_fields rf
inner join res_fields_types rft on rft.rft_id = rf.rft_id
WHERE f.fid = $fid&quot;, $link )
or die(&quot;Query failed : &quot; . mysql_error());

while ($row = mysql_fetch_array( $res )) {
  $rf_x = $row[&quot;rf_xcoord&quot;];
  $rf_y = $row[&quot;rf_ycoord&quot;];
  $rf_level = $row[&quot;rf_level&quot;];
  $rf_id = $row[&quot;rf_id&quot;];
  $rft_name = $row[&quot;rft_name&quot;];
  echo '&lt;div style=&quot;position:absolute;left:'.$rf_x.'px;top:'.$rf_y.'px;z-index:1&quot; title=&quot;'.$rft_name.' Уровень '.$rf_level.'&quot; 
onclick=&quot;res_details('.$rf_id.')&quot; style=&quot;cursor:hand&quot;&gt;'.$rf_level.'&lt;/div&gt;';
}
</pre>
			Фрагмент 4.2.5<br>
			<br>
			В 1 строке фрагмента 4.2.5 мы получаем из сессионной переменной 
			идентификатор поселка, который затем подставляем в
			<span lang="en-us">sql-</span>запрос (строки 3-6). Этот
			<span lang="en-us">sql-</span>запрос объединяет две таблицы (<b>res_fields</b>,
			<b>res_fields_types</b> ), из второй мы узнаем название ресурса 
			(например - Железный рудник (поле <font color="#3B84D0">
			<span lang="en-us">rft_name</span></font>)), а из первой - все 
			остальное (уровень, координаты). Все эти данные нам нужны, чтоб 
			отобразить уровень каждого ресурсного поля и при наведении на него 
			мыши - всплыла подсказка с названием этого поля. Из строк 14-15 Вы 
			видите, что эти данные для каждого поля выводятся в виде слоя (<span lang="en-us">&lt;div&gt;</span>), 
			координаты которого соответствуют координатам из таблицы <b>res_fields</b>. 
			Более того, по клику мышью на этом слое, вызывается некая
			<span lang="en-us">JavaScript </span>функция <font color="#3B84D0">res_details</font> 
			в которую в качестве аргумента передается идентификатор ресурсного 
			поля - <font color="#3B84D0">$rf_id</font>. Это нам понадобится чуть 
			позже для вывода странички подробной информации о каждом ресурсном 
			поле, а сейчас мы просто покажем, что у нас получилось на экране, 
			когда мы откроем в браузере страничку <b>res.php</b>.<br>
			<br>
			<img border="0" src="pics/res1.png" width="359" height="317"><p>
			Рисунок 4.2.2<span lang="en-us"><br>
			</span> <br>
            <br><span lang="en-us"><font color="#4775A5"><b>4</b></font></span><font color="#4775a5"><font ><b>.3. 
			Таблица апгрейдов и затрат
     </b></font><br></font>
            <br>
&nbsp;&nbsp; Ресурсные поля нулевого уровня приносят не очень много ресурсов и 
			вскоре игроку понадобится их развитие - то есть увеличение их уровня 
			и, соответственно - производства. Однако увеличение уровня, как мы 
			уже упоминали ранее - требует вложения ресурсов на апгрейд. 
			Соответственно перед нами стоит задача - создать справочную таблицу, 
			где задать расходы ресурсов на апгрейд ресурсных полей разного типа. 
			Сказано - сделано! Создаем таблицу с названием <b>res_levels_cost</b>. 
			Вот эта таблица:<br>
            </p>
<pre class="brush: sql;">-- справочник уровней, стоимости апгрейдов, потребления ресурсных полей ---------------
CREATE TABLE `res_levels_cost` (
rlc_id bigint(20) unsigned NOT NULL auto_increment, /*ID*/
rft_id int,
rlc_level int, /* уровень ресурсного поля*/ 
rlc_grain int, /* сколько зерна для перехода на этот уровень */ 
rlc_ore int, /* сколько руды для перехода на этот уровень */ 
rlc_wood int, /* сколько леса для перехода на этот уровень */ 
rlc_clay int, /* сколько глины для перехода на этот уровень */ 
rlc_cons int, /* потребление */ 
rlc_prod int, /* производство */
rlc_time_upgrade CHAR(10), /* время апгрейда до след. уровня */
PRIMARY KEY (`rlc_id`)
) ENGINE=MyISAM DEFAULT CHARSET=cp1251;
</pre>Фрагмент 4.<span lang="en-us">3</span>.1<br>
			<br>
			Что же за поля, содержатся в нашей новой таблице и для чего они 
			нужны?<br>
			<b>rlc_id</b>&nbsp; - это просто уникальный идентификатор<br>
			<b>rft_id</b>&nbsp; - поле, которое соответствует одноименному полю 
			из справочной таблицы
			<b>res_fields_types</b> <br>
			<b>rlc_level</b> - уровень ресурсного поля <br>
			<b>rlc_grain</b> - сколько необходимо потратить зерна, для апгрейда 
			ресурсного поля до этого уровня<br>
			<b>rlc_ore</b>&nbsp; - сколько необходимо потратить руды, для 
			апгрейда ресурсного поля до этого уровня<br>
			<b>rlc_wood</b>&nbsp; - сколько необходимо потратить древесины, для 
			апгрейда ресурсного поля до этого уровня<br>
			<b>rlc_clay</b>&nbsp; - сколько необходимо потратить глины, для 
			апгрейда ресурсного поля до этого уровня<br>
			<b>rlc_cons</b> - потребление зерна на этом уровне<br>
			<b>rlc_prod</b> - производство этого ресурса на этом уровне <br>
			<b>rlc_time_upgrade</b> - время в формате часы<span lang="en-us">:</span>минуты<span lang="en-us">:</span>секунды 
			для осуществления апгрейда<br>
			<br>
			Давайте заполним эту таблицу данными хотя бы до 5 уровня для каждого 
			типа (ферма,лес,глина,руда) ресурсного поля. Напишем следующие
			<span lang="en-us">sql-</span>операторы вставки записей в таблицу <b>res_levels_cost</b> 
			для этих целей.<br>
<pre class="brush: sql;">/*--------------------------- первые 5 уровней развития ресурсных полей ----------------------*/
/*ферма*/
insert into res_levels_cost(rft_id,rlc_level,rlc_wood,rlc_clay,rlc_ore,rlc_grain,rlc_cons,rlc_prod,rlc_time_upgrade) 
values (1,0,0,0,0,0,0,3,'0:00:00');
insert into res_levels_cost(rft_id,rlc_level,rlc_wood,rlc_clay,rlc_ore,rlc_grain,rlc_cons,rlc_prod,rlc_time_upgrade) 
values (1,1,70,90,70,20,0,5,'0:01:40');
insert into res_levels_cost(rft_id,rlc_level,rlc_wood,rlc_clay,rlc_ore,rlc_grain,rlc_cons,rlc_prod,rlc_time_upgrade) 
values (1,2,115,150,115,35,0,9,'0:04:50');
insert into res_levels_cost(rft_id,rlc_level,rlc_wood,rlc_clay,rlc_ore,rlc_grain,rlc_cons,rlc_prod,rlc_time_upgrade) 
values (1,3,195,250,195,55,0,15,'0:10:00');
insert into res_levels_cost(rft_id,rlc_level,rlc_wood,rlc_clay,rlc_ore,rlc_grain,rlc_cons,rlc_prod,rlc_time_upgrade) 
values (1,4,325,420,325,95,0,22,'0:18:20');
insert into res_levels_cost(rft_id,rlc_level,rlc_wood,rlc_clay,rlc_ore,rlc_grain,rlc_cons,rlc_prod,rlc_time_upgrade) 
values (1,5,545,700,545,155,0,33,'0:31:30');
/*рудник*/
insert into res_levels_cost(rft_id,rlc_level,rlc_wood,rlc_clay,rlc_ore,rlc_grain,rlc_cons,rlc_prod,rlc_time_upgrade) 
values (2,0,0,0,0,0,1,3,'0:00:00');
insert into res_levels_cost(rft_id,rlc_level,rlc_wood,rlc_clay,rlc_ore,rlc_grain,rlc_cons,rlc_prod,rlc_time_upgrade) 
values (2,1,100,80,30,60,2,5,'0:05:00');
insert into res_levels_cost(rft_id,rlc_level,rlc_wood,rlc_clay,rlc_ore,rlc_grain,rlc_cons,rlc_prod,rlc_time_upgrade) 
values (2,2,165,135,50,100,3,9,'0:10:10');
insert into res_levels_cost(rft_id,rlc_level,rlc_wood,rlc_clay,rlc_ore,rlc_grain,rlc_cons,rlc_prod,rlc_time_upgrade) 
values (2,3,280,225,85,165,4,15,'0:18:40');
insert into res_levels_cost(rft_id,rlc_level,rlc_wood,rlc_clay,rlc_ore,rlc_grain,rlc_cons,rlc_prod,rlc_time_upgrade) 
values (2,4,465,375,140,280,6,22,'0:32:00');
insert into res_levels_cost(rft_id,rlc_level,rlc_wood,rlc_clay,rlc_ore,rlc_grain,rlc_cons,rlc_prod,rlc_time_upgrade) 
values (2,5,780,620,235,465,8,33,'0:53:30');
/*лес*/
insert into res_levels_cost(rft_id,rlc_level,rlc_wood,rlc_clay,rlc_ore,rlc_grain,rlc_cons,rlc_prod,rlc_time_upgrade) 
values (3,0,0,0,0,0,1,3,'0:00:00');
insert into res_levels_cost(rft_id,rlc_level,rlc_wood,rlc_clay,rlc_ore,rlc_grain,rlc_cons,rlc_prod,rlc_time_upgrade) 
values (3,1,40,100,60,50,2,5,'0:02:50');
insert into res_levels_cost(rft_id,rlc_level,rlc_wood,rlc_clay,rlc_ore,rlc_grain,rlc_cons,rlc_prod,rlc_time_upgrade) 
values (3,2,65,165,85,100,3,9,'0:06:50');
insert into res_levels_cost(rft_id,rlc_level,rlc_wood,rlc_clay,rlc_ore,rlc_grain,rlc_cons,rlc_prod,rlc_time_upgrade) 
values (3,3,110,280,140,165,4,15,'0:13:10');
insert into res_levels_cost(rft_id,rlc_level,rlc_wood,rlc_clay,rlc_ore,rlc_grain,rlc_cons,rlc_prod,rlc_time_upgrade) 
values (3,4,185,465,235,280,6,22,'0:23:20');
insert into res_levels_cost(rft_id,rlc_level,rlc_wood,rlc_clay,rlc_ore,rlc_grain,rlc_cons,rlc_prod,rlc_time_upgrade) 
values (3,5,310,780,390,465,8,33,'0:39:40');
/*глина*/
insert into res_levels_cost(rft_id,rlc_level,rlc_wood,rlc_clay,rlc_ore,rlc_grain,rlc_cons,rlc_prod,rlc_time_upgrade) 
values (4,0,0,0,0,0,1,3,'0:00:00');
insert into res_levels_cost(rft_id,rlc_level,rlc_wood,rlc_clay,rlc_ore,rlc_grain,rlc_cons,rlc_prod,rlc_time_upgrade) 
values (4,1,80,40,80,50,2,5,'0:02:50');
insert into res_levels_cost(rft_id,rlc_level,rlc_wood,rlc_clay,rlc_ore,rlc_grain,rlc_cons,rlc_prod,rlc_time_upgrade) 
values (4,2,135,65,135,85,3,9,'0:07:10');
insert into res_levels_cost(rft_id,rlc_level,rlc_wood,rlc_clay,rlc_ore,rlc_grain,rlc_cons,rlc_prod,rlc_time_upgrade) 
values (4,3,225,110,225,140,4,15,'0:14:00');
insert into res_levels_cost(rft_id,rlc_level,rlc_wood,rlc_clay,rlc_ore,rlc_grain,rlc_cons,rlc_prod,rlc_time_upgrade) 
values (4,4,375,185,375,235,6,22,'0:25:00');
insert into res_levels_cost(rft_id,rlc_level,rlc_wood,rlc_clay,rlc_ore,rlc_grain,rlc_cons,rlc_prod,rlc_time_upgrade) 
values (4,5,620,310,620,390,8,33,'0:42:30');

</pre>Фрагмент 4.<span lang="en-us">3</span>.2<p>И Выше приведенного фрагмента 
			видно, что с ростом уровня (поле rlc_level) любого из четырех типов 
			(поле rft_id) ресурсных полей, затраты на апгрейд до этого уровня 
			растут (значения в полях rlc_wood, rlc_clay, rlc_ore, rlc_grain). 
			Кроме этого растет также и время (поле rlc_time_upgrade), 
			затрачиваемое на процедуру этого апгрейда.<br>
			Что ж, давайте сделаем новую страничку нашей с Вами стратегической 
			игры, где будет показывать детальную информацию по выбранному 
			ресурсному полю, в том числе и ресурсы затрачиваемые на апгрейд до 
			следующего уровня этого ресурсного поля. Наш новый файл для этих 
			целей назовем <span lang="en-us"><b>resb.php</b>.<br>
			</span>Кроме знакомой для нас уже проверки авторизации (мы ее помним 
			еще по файлу <span lang="en-us"><b>map.php</b> </span>), давайте в 
			нашем новом файле <b><span lang="en-us">resb.php</span> </b>сделаем 
			показ имеющихся у игрока в текущем поселке ресурсов. Вы помните еще 
			из таблицы <b>fields</b>, что изначально их дается по 700 каждого 
			типа.&nbsp; Давайте выводить их на экран, чтоб игрок всегда видел, 
			чем он располагает. Для этих целей напишем&nbsp; функцию, теперь уже 
			на языке <span lang="en-us">PHP. </span>А так как в дальнейшем
			<span lang="en-us">&nbsp;</span>мы будем выводить количество 
			ресурсов не только в файле <b><span lang="en-us">resb.php</span></b>, 
			но и в некоторых других, предлагается использовать подключаемый 
			файл, где мы будем держать все наши необходимые функции в одном 
			месте. Этот файл - <span lang="en-us"><b>functions.inc.php</b></span> 
			и<span lang="en-us"> </span>мы уже использовали его во втором уроке.<span lang="en-us">
			</span>Этот файл мы подключаем к другим разным файлам (<b><span lang="en-us">resb.php</span>,
			</b><b><span lang="en-us">resb.php</span>, <span lang="en-us">
			map.php </span></b>и т.д.) и будем многократно использовать 
			хранящиеся в нем функции. Директива подключения Вам известна:</p>


<pre class="brush: php;">
@include(&quot;functions.inc.php&quot;);
</pre>
			Фрагмент 4.3.3<br>
			<br>
			Вначале создадим в файле <b><span lang="en-us">functions.inc.php</span>
			</b>функцию <font color="#3B84D0">get_res</font>, которая считывает 
			количество ресурсов из таблицы <span lang="en-us"><b>fields</b>.</span><pre class="brush: php;">
function get_res( $p_fid ){
$result = mysql_query(&quot;SELECT f_grain, f_ore, f_wood, f_clay FROM fields where fid = $p_fid&quot;) 
or die(&quot;Query failed : &quot; . mysql_error());
$row = mysql_fetch_array( $result );
$a_res['grain'] = $row[&quot;f_grain&quot;];
$a_res['ore'] = $row[&quot;f_ore&quot;];
$a_res['wood'] = $row[&quot;f_wood&quot;];
$a_res['clay'] = $row[&quot;f_clay&quot;];
return ( $a_res );
}
</pre>
			Фрагмент 4.3.4.<br>
			<br>
			Здесь все предельно просто - функция получает в качестве аргумента 
			идентификатор поселка ($p_fid)&nbsp; и использует его в
			<span lang="en-us">sql</span>-запросе для извлечения количества 
			каждого из ресурсов из таблицы <b>fields</b>. Затем все эти значения 
			помещаются в массив $a_res, который возвращается оператором
			<span lang="en-us">return.</span><p>Сейчас мы сразу проверим ее в 
			действии, так как теперь добавим функцию <font color="#3B84D0">
			show_res</font>, которая выведет на страницу в браузере количество 
			ресурсов, которыми располагает игрок:</p>


<pre class="brush: php;">
// показываем ресурсы для поля
function show_res( $p_fid ){
global $f_grain;
global $f_ore;
global $f_wood;
global $f_clay;
$warehouse_capacity = 700; // вместимость склада
$barn_capacity = 700; // вместимость амбара

$a_res = get_res( $p_fid );

$f_grain = $a_res[&quot;grain&quot;];
$f_ore = $a_res[&quot;ore&quot;];
$f_wood = $a_res[&quot;wood&quot;];
$f_clay = $a_res[&quot;clay&quot;];

echo '&lt;div style=&quot;position:absolute left:200px; top:50px&quot;&gt;'.'&lt;img src=&quot;img/res/grain.png&quot;&gt;'.$f_grain.'/'.$barn_capacity.
' &lt;img src=&quot;img/res/ore.png&quot;&gt;'
.$f_ore.'/'.$warehouse_capacity.' &lt;img src=&quot;img/res/wood.png&quot;&gt;'.$f_wood.'/'.$warehouse_capacity.
' &lt;img src=&quot;img/res/clay.png&quot;&gt;'.$f_clay.'/'
.$warehouse_capacity.' &lt;img src=&quot;img/res/cons.png&quot;&gt;'.get_res_cons( $p_fid ).'/'.get_prod( $p_fid, 1 ).'&lt;/div&gt;';
}
</pre>
			Фрагмент 4.3.<span lang="en-us">5</span>.<p>Эта функция основывается 
			на данных, получаемых от функции <font color="#3B84D0">get_res</font> 
			и использует, пока что вручную прописанные в коде функции значения 
			вместимости амбара и склада. Когда мы перейдем к созданию зданий в 
			нашем поселке и построим склад и амбар - нам уже это не понадобится. 
			Далее функция <font color="#3B84D0">show_res </font>выводит все эти 
			значения в виде слоя (<span lang="en-us">&lt;div&gt;</span>)<span lang="en-us">
			</span>Вот как это выглядит:<br>
			<br>
			<img border="0" src="pics/info1.png" width="348" height="35"><br>
			Рисунок 4.3.1<br>
			<br>
			И если с с первыми четырьмя парами числе все понятно (это количество 
			ресурса/вместимость объекта), то что же такое 12/18 ? Конечно же Вы 
			в фрагменте 4.3.5 увидели еще две незнакомые функции
			<font color="#3B84D0">get_res_cons</font> и <font color="#3B84D0">
			get_prod</font>, которые судя по всему и выводят эти числа 12/18 на 
			экран. Рассмотрим это в следующем пункте.<br>
			<br>
			<strong><span lang="en-us"><font color="#4775A5"><br>
			<br>
			4</font></span></strong><font color="#4775a5"><strong>.4. 
			Производство и потребление</strong>
      
            </font><br>
			<br>
			Начнем с функции <font color="#3B84D0">get_prod</font>. Она 
			подсчитывает общее количество ресурсов выбранного типа в единицу 
			времени (а именно - в час). Поэтому первый ее аргумент - 
			идентификатор поселка, а второй - тип ресурса. Вот эта функция:</p>


<pre class="brush: php;">
// какова продукция выбранного ресурса в час в поселке
function get_prod( $p_fid, $p_res_type ){
global $link;
$res = mysql_query(&quot;SELECT 
sum(rlc_prod) AS sum_prod,
rlc.rft_id,
rlc.rlc_level
FROM
res_levels_cost rlc
INNER JOIN res_fields rf ON (rf.rft_id = rlc.rft_id)
AND (rf.rf_level = rlc.rlc_level)
WHERE
fid = $p_fid and rf.rft_id = $p_res_type
GROUP BY
rlc.rft_id, rlc.rlc_level&quot;, $link )
or die(&quot;Query failed : &quot; . mysql_error()); 
$row = mysql_fetch_array( $res );
return( $row[&quot;sum_prod&quot;] );
}

</pre>
			Фрагмент 4.4.<span lang="en-us">1</span>.<p><span lang="en-us">Sql-</span>запрос 
			в этой функции объединяет две таблицы res_fields&nbsp; и 
			res_levels_cost. Связываются эти таблицы по двум параметрам - типу 
			ресурсов (rf.rft_id = rlc.rft_id) и уровню ресурсного поля (rf.rf_level 
			= rlc.rlc_level). <span lang="en-us">SQL</span>-функция
			<span lang="en-us">sum </span>суммирует количество выработки 
			ресурса, содержащееся в поле <b>rlc_prod</b>. В итоге функция
			<font color="#3B84D0">get_prod </font>возвращает величину этой 
			суммы. Понятно, что во фрагменте 4.3.5 мы используем эту функцию для 
			отображения общего производства зерна в час (<font color="#3B84D0">get_prod</font>( 
			$p_fid, 1 ) - 1 это тип ресурса - зерно (помните справочную таблицу
			<b>res_fields_types</b> ?))<br>
			Теперь, что касается функции <font color="#3B84D0">get_res_cons</font>. 
			Эта функция показывает общее потребление зерна. Потребляет зерно и 
			ресурсные постройки и здания в поселке, которыми мы будем заниматься 
			на следующих занятиях. <br>
			Вот эта функция:</p>


<pre class="brush: php;">
// какое потребление зерна ресурсными полями? (без построек в городе)
function get_res_cons( $p_fid ){
global $link;
$res = mysql_query(&quot;SELECT 
sum(rlc_cons) AS sum_cons,
rlc.rft_id,
rlc.rlc_level
FROM
res_levels_cost rlc
INNER JOIN res_fields rf ON (rf.rft_id = rlc.rft_id)
AND (rf.rf_level = rlc.rlc_level)
WHERE fid = $p_fid&quot;, $link )
or die(&quot;Query failed : &quot; . mysql_error()); 
$row = mysql_fetch_array( $res );
return( $row[&quot;sum_cons&quot;] );
}

</pre>
			Фрагмент 4.4.<span lang="en-us">2</span>.<p>Эта функция идентична 
			предыдущей, только суммирует не поле <b>rlc_prod</b>, а поле <b>
			rlc_cons</b> (то есть - потребление, а не производство). И в этой 
			функции нет проверки по типу ресурса - так как все ресурсные поля 
			(даже те, которые сами производят зерно, т.е. фермы) потребляют 
			зерно, и чем выше уровень этого поля, тем выше потребление. Переводя 
			на простой язык - работники, занятые на сельхозработах, в шахтах, 
			лесопилках и карьерах - хотят есть!<br>
			<br>
			Что ж, наступило время доделать файл <b><span lang="en-us">resb.php</span></b>, 
			который, если Вы не забыли должен, по нашему с Вами замыслу, 
			выводить детальную информацию по выбранному ресурсному полю, и 
			показывать, в том числе и ресурсы, затрачиваемые на апгрейд до 
			следующего уровня этого ресурсного поля. <br>
			Далее мы приведем фрагмент этого файла, который выводит на экран эту 
			информацию:</p>


<pre class="brush: php;">
$fid = $_SESSION['fid']; // поселок
show_res( $fid );

// Узнаем сколько производство для этого ресурсного поля текущего левела
$res = mysql_query(&quot;SELECT rlc_cons, rlc_prod, rf_level from res_fields rf inner join res_levels_cost rlc 
on rf.rft_id=rlc.rft_id 
and rf.rf_level = rlc.rlc_level where fid=$fid and rf_id=$rf_id&quot;, $link )
or die(&quot;Query failed : &quot; . mysql_error());
$row = mysql_fetch_array( $res );
$rlc_cons = $row[&quot;rlc_cons&quot;];
$rlc_prod = $row[&quot;rlc_prod&quot;];
$rf_level = $row[&quot;rf_level&quot;];

// Узнаем сколько ресурсов нужно для след.левела этого ресурсного поля
$res = mysql_query(&quot;SELECT rlc_cons, rlc_prod, rf.rf_id, rf.rf_level+1 new_level, rlc_grain, rlc_ore, rlc_wood, rlc_clay, rlc_time_upgrade,
rft_image, rft_description,rft_name 
from res_fields rf
inner join res_levels_cost rlc on rf.rft_id=rlc.rft_id 
inner join res_fields_types rft on rft.rft_id=rf.rft_id
and (rf.rf_level+1) = rlc.rlc_level where fid=$fid and rf_id=$rf_id&quot;, $link )
or die(&quot;Query failed : &quot; . mysql_error());

$row = mysql_fetch_array( $res );
$new_level = $row[&quot;new_level&quot;];
$rlc_grain = $row[&quot;rlc_grain&quot;];
$rlc_ore = $row[&quot;rlc_ore&quot;];
$rlc_wood = $row[&quot;rlc_wood&quot;];
$rlc_clay = $row[&quot;rlc_clay&quot;];
$rlc_cons_new = $row[&quot;rlc_cons&quot;];
$rlc_prod_new = $row[&quot;rlc_prod&quot;];
$rft_name = $row[&quot;rft_name&quot;];
$rft_image = $row[&quot;rft_image&quot;];
$rft_description = $row[&quot;rft_description&quot;];
$rlc_time_upgrade = $row[&quot;rlc_time_upgrade&quot;];
$rf_id = $row[&quot;rf_id&quot;];


echo '&lt;br&gt;&lt;img src=&quot;'.$rft_image.'&quot; align=&quot;right&quot;&gt;'; 
echo &quot;&lt;span class='res_header'&gt;&quot;.$rft_name.&quot; Уровень &quot;.$rf_level.&quot;&lt;/span&gt;&lt;br&gt;&lt;br&gt;&quot;;
echo $rft_description.&quot;&lt;br&gt;&lt;br&gt;&quot;;

echo '&lt;table cellpadding=&quot;5&quot; cellspacing=&quot;1&quot; id=&quot;build_value&quot;&gt;&lt;tr&gt;
&lt;td &gt;Производство:&lt;/td&gt;
&lt;td &gt;&lt;b&gt;'.$rlc_prod.'&lt;/b&gt; в час&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td &gt;Производство на уровне '.($rf_level+1).':&lt;/td&gt;
&lt;td &gt;&lt;b&gt;'.$rlc_prod_new.'&lt;/b&gt; в час&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;';

echo &quot;&lt;br&gt;Расходы на строительство до уровня $new_level:&lt;br&gt;&quot;;
echo '&lt;img src=&quot;img/res/grain.png&quot;&gt;'.$rlc_grain.' | &lt;img src=&quot;img/res/ore.png&quot;&gt;'.$rlc_ore.' | 
&lt;img src=&quot;img/res/wood.png&quot;&gt;'.$rlc_wood.' | 
&lt;img src=&quot;img/res/clay.png&quot;&gt;'.$rlc_clay.' | &lt;img src=&quot;img/res/cons.png&quot;&gt;'.$rlc_cons_new.' | 
&lt;img src=&quot;img/res/time.png&quot;&gt; '
.$rlc_time_upgrade.'&lt;br&gt;&lt;br&gt;';
//echo 'Улучшить до уровня '.($rf_level+1);
if( allow_upgrade_res_field( $rf_id ) ){
if( !res_upgrade_in_progress( $fid ) )
echo '&lt;a class=&quot;build&quot; href=&quot;res.php?p_rf_id='.$rf_id.'&quot;&gt;Улучшить до уровня '.($rf_level+1).'&lt;/a&gt;'; 
else echo '&lt;font color=&quot;#CCCCCC&quot;&gt;Строители сейчас заняты!&lt;/color&gt;';
} else {
echo 'Не хватает ресурсов!';
}

</pre>
			Фрагмент 4.4.<span lang="en-us">3</span><p>Во строке 2 фрагмента 
			4.3.<span lang="en-us">8</span> мы как раз выводим сведения о 
			количестве ресурсов. В запросе (строки 5-8) мы узнаем производство 
			этого вида ресурса на текущем уровне (знакомая связка между 
			таблицами rf.rf_level = rlc.rlc_level) а вот во втором запросе 
			узнаем затраты ресурсов на апгрейд, а также потребление, 
			производство и время на этот апгрейд для следующего уровня ( 
			(rf.rf_level+1) = rlc.rlc_level ). Всю полученную информацию из этих 
			запросов мы аккуратненько выводим на экран в виде таблички или 
			просто в виде строчек. Более того, мы создаем ссылку, нажав на 
			которую игрок может приступить к апгрейду этого поля (строка 58). Но 
			перед этим проводятся несколько проверок функциями
			<font color="#3B84D0">allow_upgrade_res_field</font> и
			<font color="#3B84D0">res_upgrade_in_progress</font>. Первую функцию 
			мы рассмотрим сейчас, а вторую чуть позже, так как она связана с 
			необходимости создания еще одной таблицы в базе данных - таблицы 
			очереди апгрейдов!.<br>
			<br>
			А вот функция <font color="#3B84D0">allow_upgrade_res_field</font>&nbsp; 
			просто проверяет, достаточно ли у игрока ресурсов в поселке, чтоб 
			провести апгрейд? Вот как она выглядит:</p>


<pre class="brush: php;">
function allow_upgrade_res_field( $rf_id ){
global $link;
$fid = $_SESSION['fid'];
$retv = false;
// Узнаем сколько ресурсов нужно для след.левела этого ресурсного поля
$query = &quot;SELECT rlc_grain, 
rlc_ore, 
rlc_wood, 
rlc_clay
from res_fields rf
inner join res_levels_cost rlc on rf.rft_id=rlc.rft_id 
and (rf.rf_level+1) = rlc.rlc_level 
where fid=$fid and rf_id=$rf_id&quot;;
$res = mysql_query( $query, $link ) or die(&quot;Query failed : &quot; .mysql_error());

// это - сколько нужно ресов, чтоб сделать апгрейд 
$row = mysql_fetch_array( $res );

$rlc_grain = $row[&quot;rlc_grain&quot;];
$rlc_ore = $row[&quot;rlc_ore&quot;];
$rlc_wood = $row[&quot;rlc_wood&quot;];
$rlc_clay = $row[&quot;rlc_clay&quot;];

// А это - сколько у нас есть в наличии
$a_res = get_res( $fid );

$f_grain = $a_res[&quot;grain&quot;];
$f_ore = $a_res[&quot;ore&quot;];
$f_wood = $a_res[&quot;wood&quot;];
$f_clay = $a_res[&quot;clay&quot;];

if ( ($rlc_grain &lt;= $f_grain) &amp;&amp;
($rlc_ore &lt;= $f_ore) &amp;&amp;
($rlc_wood &lt;= $f_wood) &amp;&amp; 
($rlc_clay &lt;= $f_clay) ) {

$retv = true; // всех типов ресурсов достаточно для апгрейда

} else {
$retv = false; // не хватает одного или более видов ресурсов....
}

return ( $retv );
}
</pre>
			Фрагмент 4.4.4<p>Функция получает на входе идентификатор ресурсного 
			поля из таблицы res_fields. И по нему в запросе (строки 6-14) мы 
			узнаем затраты ресурсов на апгрейд этого поля до следующего уровня. 
			В строках с 19-22 мы для удобства сохраняем эти значения в 
			соответствующие переменные. Далее уже знакомая нам функция
			<font color="#3B84D0">get_res</font> возвращает количество доступных 
			игроку ресурсов в текущем поселке. В строках 32-35 фрагмента 4.3.9 
			мы сравниваем значения необходимых и имеющихся ресурсов и если 
			имеющихся ресурсов хватает возвращаем <b><span lang="en-us">true</span></b>,&nbsp; 
			если нет - <span lang="en-us"><b>false</b>.<br>
			</span>Так вот, если <font color="#3B84D0">allow_upgrade_res_field</font> 
			в фрагменте 4.3.9 вернет <span lang="en-us"><b>false</b> </span>мы 
			выведем на экран надпись - &quot;Не хватает ресурсов&quot;. Давайте посмотрим 
			на страничку <span lang="en-us">resb.php</span>, как она выглядит в 
			браузере (мы нажали на ресурсное поле с лесопилкой).<span lang="en-us"><br>
			<br>
			<img border="0" src="pics/les.png" width="484" height="317"><br>
&nbsp;</span>Рисунок 4.4.2<br>
			<br>
<br><font color="#4775A5"><b><span lang="en-us">4</span>.5. 
			Очередь строительства и улучшений </b></font> <br>
            <br>
            &nbsp;&nbsp; Как Вы уже наверно догадались, апгрейд ресурсного поля 
			занимает определенное время. Эти временные интервалы хранятся в 
			таблице <b>res_levels_cost</b>. Посему, чтоб зарезервировать время 
			для апгрейда создадим новую табличку в нашей базе, которую назовем
			<b>job_res_upgrade</b>. Вот как выглядит скрипт для ее создания:<br>
			</p>
<pre class="brush: sql;">/*Таблица очереди апгрейдов ресурсных полей */
CREATE TABLE `job_res_upgrade` (
jr_id bigint(20) unsigned NOT NULL auto_increment, /*ID задания на апгрейд*/
rf_id bigint(20) unsigned NOT NULL, /*ID поля из таблицы res_fields*/ 
time_s bigint DEFAULT 0, /*время начала апгрейда в сек. Эпохи. (php time) */
time_e bigint DEFAULT 0, /*расссчитанное время завершения апгрейда в сек. Эпохи. (php time) */
PRIMARY KEY (`jr_id`)
) ENGINE=MyISAM DEFAULT CHARSET=cp1251;
</pre>Фрагмент 4.5.1<br>
			<br>
			<b>jr_id</b> - идентификатор задания на апгрейд ресурсного поля<br>
			<b>rf_id</b>&nbsp; - это поле из таблицы res_fields , то есть 
			идентификатор выбранного для апгрейда ресурсного поля<br>
			<b>time_s</b> - время начала апгрейда ресурсного поля <br>
			<b>time_e</b> - время завершения апгрейда ресурсного поля.<br>
			<br>
			Вспомните строку 58 из фрагмента 4.3.8. В ней сформирована ссылка 
			для инициализации апгрейда (Улучшить до уровня <span lang="en-us">&lt;</span>номер 
			уровня<span lang="en-us">&gt;</span>). Куда же передается управление 
			при нажатии игроком на эту ссылку? Как Вы видите управление 
			передается в файл <span lang="en-us"><b>res.php</b> </span>и 
			передается ему&nbsp; идентификатор ресурсного поля, которое мы 
			собираемся апгрейдить! Что ж придется добавить немного строк когда в 
			наш файл <span lang="en-us"><b>res.php</b></span>. Вот эти строки:<pre class="brush: php;">
 // задали апгрейд
if( isset( $_GET['p_rf_id'] ) ){

// проверим принадлежит ли этот ресурс деревне игрока?
$p_rf_id = $_GET['p_rf_id'];
$res = mysql_query(&quot;SELECT rf_id FROM res_fields rf
inner join fields f on f.fid = rf.fid
WHERE f.fid=$fid and rf_id=$p_rf_id&quot;, $link )
or die(&quot;Query failed : &quot; . mysql_error());

$num_rows = mysql_num_rows($res);
if( $num_rows &gt; 0 ){ // есть такое ресурсное поле в деревне

 $a_res = res_field_upgrade_cost( $p_rf_id );
 $a_grain = $a_res['grain'];
 $a_ore = $a_res['ore'];
 $a_wood = $a_res['wood'];
 $a_clay = $a_res['clay'];
 $a_time_up = $a_res['time_upgrade'];

 // Изменим кол-во ресурсов в связи с апгрейдом
 $query = &quot;update fields set f_grain=f_grain-$a_grain,
 f_ore=f_ore-$a_ore, 
 f_wood=f_wood-$a_wood,
 f_clay=f_clay-$a_clay where fid=$fid&quot;;
 $result = mysql_query($query) or die(&quot;Query failed : &quot; . mysql_error());

 // запишем в очередь апгрейдов ресурсных полей
 $time_e = time()+h2s( $a_time_up );
 $query = &quot;insert into job_res_upgrade(rf_id,time_s,time_e) values($p_rf_id, &quot;.time().&quot;,$time_e)&quot;;
 $result = mysql_query($query) or die(&quot;Query failed : &quot; . mysql_error());

} else { echo 'Ошибка апгрейда поля!'; }

}

</pre>
			Фрагмент 4.5.<span lang="en-us">2</span>.<p>В строке 2, мы 
			проверяем, передали ли мы параметр <b>p_rf_id</b> нашему скрипту
			<span lang="en-us"><b>res.php</b>. </span>Далее в запросе (строки 
			5-9) мы узнаем, действительно ли этот идентификатор поля принадлежит 
			поселку данного игрока (условие: WHERE f.fid=$fid and rf_id=$p_rf_id) 
			и если запрос вернет строк больше нуля (строки 11-12), значит 
			используем функцию <font color="#3B84D0">res_field_upgrade_cost</font>, 
			чтоб узнать какие затраты нас ожидают для выполнения этого апгрейда. 
			Теперь нам нужно уменьшить количество ресурсов у поселка (Запрос 
			описанный в строках 22-26). В нем мы вычитаем ресурсы на апгрейд из 
			ресурсов, находящихся в поселке игрока. Затем в строке 29 мы узнаем 
			время завершения апгрейда, но сперва создадим функцию, которая будет 
			переводить время записанное в строковом формате часы:минуты:секунды 
			- в числовой формат секунд. Назовем ее <span lang="en-us"><b>h2s</b>:</span></p><pre class="brush: php;">
function h2s( $timestr ){
 $hms = explode(':', $timestr);
 $sec = $hms[0] * 3600 + $hms[1] * 60 + $hms[2];
 return ( $sec );
}
</pre>
			Фрагмент 4.5.<span lang="en-us">3</span>.<p>Здесь мы разбиваем 
			строку в формате часы:минуты:секунды (например 1<span lang="en-us">:40:30</span>)<span lang="en-us">
			</span>на три числа и производим вычисление секунд по формуле часы<span lang="en-us">*3600 
			+ </span>минуты<span lang="en-us"> </span>* 60 + секунды.<br>
			Тогда далее в фрагменте 4.5.2 мы пользуемся рассчитанной с помощью 
			функции <b> <span lang="en-us">h2s</span> </b>величиной завершения 
			времени апгрейда для записи в таблицу <b>job_res_upgrade</b> (строки 
			30-31). Таким образом, когда игрок нажимает на ссылку &quot;Улучшить до 
			уровня 1&quot; например на какой-нибудь лесопилке, то в таблице <b>job_res_upgrade</b>&nbsp; 
			появится строка:<br>
			<br>
			<img border="0" src="pics/jru.png" width="507" height="297"><br>
			<br>
			Рисунок 4.5.1<br>
			<br>
			Конечно же у Вас значения в полях <span lang="en-us">time_s (</span>время 
			начала апгрейда<span lang="en-us">) </span>и <span lang="en-us">
			time_e</span> (время окончания апгрейда) будут совершенно другими.<br>
			Итак очередь на апгрейд задана, но нам бы очень хотелось, чтоб 
			процесс апгрейда как-то визуализировался на страничке, чтоб игрок 
			мог видеть - сколько еще осталось времени до его завершения и в 
			какое время произойдет это завершение.<br>
			Пока Вы думаете, как это реализовать мы запасемся еще одной функцией 
			для обратного перевода секунд в строковый формат часы:минуты:секунды. 
			Назовем эту функцию <span lang="en-us"><b>s2h</b>. </span>Вот она:</p><pre class="brush: php;">
/////////////////////////////////////////////////////////////////
//////////// перевод секунд в формат времени 00:00:00 /////////
/////////////////////////////////////////////////////////////////
function s2h( $p_secs ){
$a_hrs = 0;
$a_mnts = 0;
$a_secs = 0;

$a_hrs = floor($p_secs/3600);

if( $a_hrs &gt; 0 ){
$a_mnts = floor(($p_secs-3600*$a_hrs)/60);
} else {
$a_mnts = floor($p_secs/60);
}
$a_secs = $p_secs - ( 3600*$a_hrs + 60*$a_mnts );
if( strlen($a_hrs.'') ==1 ) $a_hrs = '0'.$a_hrs;
if( strlen($a_mnts.'') ==1 ) $a_mnts = '0'.$a_mnts;
if( strlen($a_secs.'') ==1 ) $a_secs = '0'.$a_secs;
return( $a_hrs.':'.$a_mnts.':'.$a_secs );
}
</pre>
			Фрагмент 4.5.<span lang="en-us">4</span>.<p>В этой функции мы 
			последовательно узнаем часы, минуты и секунды и формируем строку 
			(например 1:20:40)<span lang="en-us"> </span>для вывода на экран 
			очереди<span lang="en-us"> </span>апгрейда.<span lang="en-us"><br>
			</span>Итак, если Вы не придумали, как сделать, чтоб на экране 
			тикали часики и возвещали о скором завершении апгрейда какого-нибудь 
			ресурсного поля, давайте сделаем это вместе.<span lang="en-us">
			</span>И для этого нам понадобится <span lang="en-us">PHP </span>
			функция, которая сформирует строку, в которой будет информация, что 
			апгрейдится в данный момент<span lang="en-us">,</span> когда 
			завершится апгрейд и место под часики с обратным отсчетом. А уже 
			самим отсчетом будет заниматься <span lang="en-us">JavaScript </span>
			функция, которая по таймеру с интервалом в 1 секунду будет обновлять 
			информацию о том<span lang="en-us">,</span> сколько времени осталось 
			до конца<span lang="en-us"> </span>апгрейда.<span lang="en-us">
			</span>Сперва сделаем <span lang="en-us">PHP </span>функцию
			<span lang="en-us">и</span> назовем ее <font color="#3B84D0">
			show_res_upgrade</font><span lang="en-us">.</span></p><pre class="brush: php;">
function show_res_upgrade( $p_fid ){
$result = mysql_query(&quot;SELECT jru.time_s, jru.time_e, rft.rft_name, rf.rf_level from job_res_upgrade jru
inner join res_fields rf on rf.rf_id=jru.rf_id
inner join res_fields_types rft on rft.rft_id = rf.rft_id
where rf.fid=$p_fid&quot; ) 
or die(&quot;Query failed : &quot; . mysql_error());
$num_rows = mysql_num_rows( $result );
if( $num_rows &gt; 0 ){
$row = mysql_fetch_array( $result );
$time_s = $row[&quot;time_s&quot;];
$time_e = $row[&quot;time_e&quot;];
$rft_name = $row[&quot;rft_name&quot;];
$rf_level = $row[&quot;rf_level&quot;];
echo '&lt;b&gt;Строительство:&lt;/b&gt; &lt;img src=&quot;img/res/time.png&quot;&gt;&lt;br&gt;'.$rft_name.' ( Уровень '.($rf_level+1).' ) &amp;nbsp;&amp;nbsp;
&lt;span id=&quot;restimer&quot;&gt;&lt;/span&gt; &amp;nbsp;&amp;nbsp;Готово в '.date('H:i',$time_e);
echo '
&lt;script&gt;
var currentTimeString = &quot;'.s2h($time_e-time()).'&quot;;
var aTime = currentTimeString.split(&quot;:&quot;);
var currentHours = parseInt(aTime[0]);
var currentMinutes = parseInt(aTime[1]); 
var currentSeconds = parseInt(aTime[2]);
updateClock(); setInterval(&quot;updateClock()&quot;, 1000 );
&lt;/script&gt; ';
}
}

</pre>
			Фрагмент 4.5.5.<p>Эта функция получает в качестве&nbsp; аргумента
			<span lang="en-us">и</span>идентификатор поселка<span lang="en-us">
			</span>и в запросе (строки 2-5)<span lang="en-us"> </span>узнает все 
			необходимые параметры из <span lang="en-us">с</span>вязки таблиц 
			job_res_upgrade <span lang="en-us">&nbsp;</span>и <span lang="en-us">&nbsp;</span>res_fields_types. 
			А именно время завершения, название ресурсного поля, которое 
			апгрейдится и т.д. Если в очереди апгрейдов для данного поселка 
			что-то есть, то запрос вернет строк больше чем 0 (эта проверка в 
			строке 8 фрагмента 4.5.5 )<span lang="en-us">.</span> Если что-то 
			апгрейдится, то мы выводим информацию <span lang="en-us">(</span>строка 
			14)<span lang="en-us"> </span>о название ресурсного поля<span lang="en-us">
			</span>- уровне до которого оно апгрейдится и времени завершения. 
			Интересным в этой строке есть следующее - &lt;span id=&quot;restimer&quot;&gt;&lt;/span&gt;<span lang="en-us">.</span> 
			Этот элемент мы будем заполнять функцией <span lang="en-us">
			JavaScript </span>updateClock, которая как Вы уже знаете будет 
			выполняться 1 раз в секунду в браузере.<span lang="en-us"> </span>
			Интересно так же то, что мы создаем фрагмент <span lang="en-us">
			JavaScript </span>кода непосредственно в файле <span lang="en-us">
			PHP (</span>строки<span lang="en-us"> 16-24).</span> В этом
			<span lang="en-us">JavaScript </span>фрагменте мы создаем переменную
			<font color="#3B84D0">currentTimeString</font> <span lang="en-us">,</span> 
			которую при обновлении страницы<span lang="en-us"> </span>
			инициализируем как разницу между временем окончания апгрейда и 
			текущим временем в секундах, преобразуя эту разницу к строке в 
			формате&nbsp; часы:минуты:секунды функцией <span lang="en-us"><b>s2h</b>.</span> 
			Затем уже средствами <span lang="en-us">JavaScript </span>мы делим 
			эту строку на три части (часы, минуты и секунды)<span lang="en-us">
			</span>сохраняя их в соответствующих переменных <span lang="en-us">(</span>currentHours 
			, currentMinutes и currentSeconds )<span lang="en-us"> </span>и
			<span lang="en-us">д</span>алее инициализируем таймер (в
			<span lang="en-us">JavaScript </span>&nbsp;это стандартная функция - 
			setInterval, которая принимает два аргумента, первый - имя функции, 
			которую нужно вызывать и второй - интервал в секундах, как часто 
			осуществлять этот вызов)<span lang="en-us">.</span> <br>
&nbsp;&nbsp;&nbsp; И теперь наступил черед показать, как выглядит наша
			<span lang="en-us">JavaScript </span>&nbsp;функция 
			<font color="#3B84D0">updateClock</font>(). А 
			вот как:<br>
            </p>
<pre class="brush: js;">function updateClock ( )
{
var currentH = ( currentHours &lt; 10 ? &quot;0&quot; : &quot;&quot; ) + currentHours;
var currentM = ( currentMinutes &lt; 10 ? &quot;0&quot; : &quot;&quot; ) + currentMinutes;
var currentS = ( currentSeconds &lt; 10 ? &quot;0&quot; : &quot;&quot; ) + currentSeconds;

currentTimeString = currentH + &quot;:&quot; + currentM + &quot;:&quot; + currentS;

if( currentTimeString == '00:00:00' ){
  location.href = 'res.php';
}
document.getElementById(&quot;restimer&quot;).innerHTML = currentTimeString;

if( currentSeconds &gt;= 0 ) currentSeconds --;

if( currentSeconds == -1){
  currentMinutes --;
  currentSeconds = 59;
}

if( currentMinutes == -1 ){ 
   if (currentHours &gt; 0) { 
      currentHours --;
      currentMinutes = 59; 
   } else currentMinutes = 0;
}
}
</pre>Фрагмент 4.<span lang="en-us">5</span>.<span lang="en-us">6<br>
			<br>
			</span>Вы помните, что эта функция вызывается по событию таймера в 
			браузере игрока раз в 1 секунду<span lang="en-us">.</span> По сути 
			она занимается тем, что осуществляет обратный отсчет оставшегося 
			времени. То есть - она пытается вычитать секунду от секунд, если 
			секунды равны нулю, то отнимается минута и снова <span lang="en-us">
			н</span>ачинают отниматься секунды<span lang="en-us"> </span>от 59 
			до нуля. То же касается и часов. В общем<span lang="en-us">,</span> 
			все это происходит до тех пора, пока <font color="#3B84D0">currentTimeString</font>&nbsp; не 
			становится равным '00:00:00'. После этого страница принудительно 
			перегружается. И еще - каждую секунду <font color="#3B84D0">currentTimeString</font> пишется в 
			объект <span lang="en-us">&lt;span&gt; </span>с идентификатором
			<font color="#3B84D0">restimer</font>. Вы помните это из фрагмента
			4.5.5, в котором этот <span lang="en-us"><font color="#4974A3">&lt;span&gt;</font> </span>был 
			определен.<span lang="en-us"> <br>
			</span>Выглядит это примерно так:&nbsp; <span id="restimer"></span><br>
			<br>
			Тут возникает вопрос, а зачем нам просто так перегружать страницу. 
			Ведь от этого сам по себе уровень ресурсного поля не повысится! И 
			это - правда. Нам осталось сделать последнюю <span lang="en-us">в</span> 
			сегодняшнем занятии <span lang="en-us">PHP
			</span>функцию, которая будет отслеживать завершение времени 
			апгрейда и присваивать ресурсному полю новый более высокий уровень. 
			Назовем эту функцию <font color="#3B84D0">check_end_upgrade</font>. 
			Вот как она выглядит: </span><pre class="brush: php;">
////////// Проверим, не пора ли заканчивать апгрейды? ////////
function check_end_upgrade( $p_fid ){
$result = mysql_query(&quot;SELECT jru.jr_id, rf.rf_id, jru.time_s, jru.time_e, rf.rf_level from job_res_upgrade jru
inner join res_fields rf on rf.rf_id=jru.rf_id
where rf.fid=$p_fid&quot; ) 
or die(&quot;Query failed : &quot; . mysql_error());
$num_rows = mysql_num_rows( $result );
if( $num_rows &gt; 0 ){
  $row = mysql_fetch_array( $result );
  $jr_id = $row[&quot;jr_id&quot;];
  $rf_id = $row[&quot;rf_id&quot;];
  $time_e = $row[&quot;time_e&quot;];
  $rf_level = $row[&quot;rf_level&quot;];

  $curtime = time();
  if( $time_e &lt;= $curtime ){ // Если время апгрейда завершилось ...
    $result = mysql_query(&quot;DELETE from job_res_upgrade where jr_id=$jr_id&quot; ) 
       or die(&quot;Query failed : &quot; . mysql_error());
    $result = mysql_query(&quot;update res_fields set rf_level=rf_level+1 where rf_id=$rf_id&quot; ) 
       or die(&quot;Query failed : &quot; . mysql_error());
  } 
}
}
</pre>
			Фрагмент 4.5.7<p><span id="restimer">Эта функция, как Вы можете 
			догадаться принимает один аргумент - идентификатор поселка. Затем в 
			запросе (3-5 строки фрагмента 4.5.7) мы ищем - есть ли какие-то 
			текущие апгрейды по этому поселку - то есть есть ли записи в таблице </span>job_res_upgrade
			<span id="restimer">с </span>полем fid <span id="restimer">равным 
			идентификатору, переданному в качестве аргумента функции </span>
			<font color="#3B84D0">check_end_upgrade</font>.<span id="restimer"> 
			Если строк больше чем ноль, значит нужно проверить - не завершились 
			ли эти апгрейды. Проверяется это просто - сравнением текущего 
			времени ( функция </span><font color="#3B84D0"><span lang="en-us">t</span>ime</font>()<span id="restimer">)<span lang="en-us">
			</span>и значения в поле </span><font color="#3B84D0">time_e</font>.<span id="restimer"> 
			Если текущее время больше этого значения, значит время апгрейда 
			исчерпалось и пора поднять уровень ресурсного поля на единицу, что 
			мы и делаем в строке 19 фрагмента 4.5.7</span></p>
			<p>Вызовы функций <font color="#3B84D0">show_res_upgrade</font> и
			<font color="#3B84D0">check_end_upgrade</font> можно вставить в 
			страницу <b><span lang="en-us">res.php</span></b>.<br>
			Выглядит очередь апгрейда на странице примерно так :<br>
			<br>
			<img border="0" src="pics/upgr.png" width="422" height="153"><br>
			Рисунок 4.5.2<br>
			<br>
			Функцию
			<font color="#3B84D0">res_upgrade_in_progress </font>посмотрите сами 
			(конечно же она тоже находится в файле <b><span lang="en-us">
			functions.inc.php</span></b>) и Вы, думается, должны догадаться, чем 
			она занимается и почему может возникнуть сообщение - &quot;Строители 
			сейчас заняты!&quot; Пусть это будет для Вас маленьким домашним заданием!</p>
			<p>На этом сегодняшнее занятие завершено, как всегда все файлы и 
			картинки, которые мы применили на нем Вы можете найти в папке
			<span lang="en-us"><a href="www">www</a></span>, а скрипт базы - в 
			папке <span lang="en-us"><a href="sql">sql</a></span>.<br>
			<br>
			<br>
			<b>В следующем уроке</b> мы <span lang="ru">с Вами займемся 
			возведением построек непосредственно в нашем поселке</span>.&nbsp;Склад, 
			амбар и другие объекты поддадутся нашему строительному гению и будут 
			возведены на строительных площадках!<br>
            <br>
            </p>
            <p></p>
            <p></p></font>
            </td>
            <td background="index_files/m_right_m.gif" width="9"><img height="4" src="index_files/m_right_m.gif" width="9" border="0"></td>
          </tr>
        </tbody>
      </table>
      <table cellpadding="0" cellspacing="0" width="100%">
        <tbody>
          <tr>
            <td background="index_files/m_left_m.gif" width="9"></td>
            <td class="newsbody" bgcolor="#fdfdfd">&nbsp;</td>
            <td class="newsbody" bgcolor="#fdfdfd">
            <div class="nav" align="right">Blitz-School© </div>
            </td>
            <td background="index_files/m_right_m.gif" width="9"><img height="4" src="index_files/m_right_m.gif" width="9" border="0"></td>
          </tr>
        </tbody>
      </table>
      <table cellpadding="0" cellspacing="0" height="7" width="100%">
        <tbody>
          <tr>
            <td background="index_files/m_left_b.gif" width="13"><img height="7" src="index_files/m_left_b.gif" width="13" border="0"></td>
            <td background="index_files/m_center_b.gif"><img height="1" src="index_files/spacer.gif" width="1"></td>
            <td width="13"><img height="7" src="index_files/m_right_b.gif" width="13" border="0"></td>
          </tr>
        </tbody>
      </table>
      </div>
      </td>
      <td background="index_files/right_back.gif" valign="top" width="13">&nbsp;</td>
    </tr>
  </tbody>
</table>
<table cellpadding="0" cellspacing="0" width="100%">
  <tbody>
    <tr>
      <td background="index_files/bottom_left.png" height="51" valign="top" width="254">
      <div class="date" style="MARGIN-TOP: 12px; FONT-SIZE: 10px; MARGIN-LEFT: 45px; COLOR: white"><a style="COLOR: rgb(255,255,255)" href  ="index.phtml">Copyright</a>©
2005-2009.
GameSchool</div>
      </td>
      <td background="index_files/bottom.gif" valign="top">
      <div class="date" style="MARGIN-TOP: 12px; FONT-SIZE: 10px; MARGIN-LEFT: 20px; COLOR: rgb(143,145,147)" 
      ><!-- Bottom menu --><a title="Главная страница" style="COLOR: rgb(143,145,147)" href  ="http://www.blitz-school.info/index.phtml">Главная</a><img height="1" src="index_files/spacer.gif" width="22" align="middle">:<img height="1" src="index_files/spacer.gif" width="22" align="middle"><a href="http://www.blitz-school.info/login.phtml"><span style="COLOR: rgb(143,145,147)"  >Вход</span></a><img height="1" src="index_files/spacer.gif" width="22" align="middle">:<img height="1" src="index_files/spacer.gif" width="22" align="middle"><a href="http://www.blitz-school.info/response.phtml"><span style="COLOR: rgb(143,145,147)" 
      >Отзывы</span></a><img height="1" src="index_files/spacer.gif" width="22" align="middle">:<img height="1" src="index_files/spacer.gif" width="22" align="middle"><a href="http://www.blitz-school.info/contacts.phtml"><span style="COLOR: rgb(143,145,147)" 
      >Контакты</span></a><img height="1" src="index_files/spacer.gif" width="22" align="middle">:<img height="1" src="index_files/spacer.gif" width="22" align="middle"><a href="http://www.blitz-school.info/friends.phtml"><span style="COLOR: rgb(143,145,147)" 
      >Обмен ссылками</span></a> </div>
      </td>
      <td width="19"><img height="51" src="index_files/bottom_right.png" width="19" border="0"></td>
    </tr>
  </tbody>
</table>
<div id="menu" onmouseover="showLayer('menu'); Change('products', 'menu2')" onmouseout="hiddenLayer('menu'); Change('products', 'menu1')">
<table border="0" cellpadding="0" cellspacing="0">
  <tbody>
    <tr>
      <td style="WIDTH: 7px; HEIGHT: 7px"><img height="7" alt="" src="index_files/corner1.gif" width="7"></td>
      <td class="top"></td>
      <td style="WIDTH: 7px; HEIGHT: 7px"><img height="7" alt="" src="index_files/corner2.gif" width="7"></td>
    </tr>
    <tr>
      <td class="left"></td>
      <td class="text"><a href="reg.phtml">Курс обучения созданию игр
на Blitz3D</a><br>
      <a href="reg2.phtml">Курс
обучения созданию браузерных онлайновых игр</a> </td>
      <td class="right"></td>
    </tr>
    <tr>
      <td style="BACKGROUND: 0% 50%; WIDTH: 7px; HEIGHT: 7px; -moz-background-clip: initial; -moz-background-origin: initial; -moz-background-inline-policy: initial" 
      ><img height="7" alt="" src="index_files/corner4.gif" width="7"></td>
      <td class="bottom"></td>
      <td style="WIDTH: 7px; HEIGHT: 7px"><img height="7" alt="" src="index_files/corner3.gif" width="7"></td>
    </tr>
  </tbody>
</table>
</div>

<script>
 var currentTimeString = "01:30:50";
 var aTime = currentTimeString.split(":");
 var currentHours = parseInt(aTime[0]);
 var currentMinutes = parseInt(aTime[1]);  
 var currentSeconds = parseInt(aTime[2]);
 updateClock(); setInterval("updateClock()", 1000 );

</script>

</body></html>
