<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head>
  
  <meta http-equiv="Content-Language" content="ru">
  
  <title>Центр обучения созданию компьютерных игр</title>
  <meta name="description" content="Blitz-School - Школа создателей компьютерных игр на языке Blitz3D. Если вы хотите быстро научиться делать компьютерные игры или интересуетесь их созданием, то этот сайт будет вам полезен">
  <meta name="keywords" content="программирование, создание игр, курсы создания игр, школа создателей компьютерных игр, blitzbasic, компьютерные игры, как написать игру, как создать игру, программирование компьютерных игр, Blitz3D, программирование игр, разработка игр, создание 3d игр, аудио, графика, дизайн, 3D">
  <link rel="stylesheet" type="text/css" href="main.css">
  <script language="JavaScript" src="index_files/script.js" type="text/javascript"></script>
  <script type="text/javascript" src="scripts/shCore.js"></script>
  <script type="text/javascript" src="scripts/shBrushBash.js"></script>
  <script type="text/javascript" src="scripts/shBrushCpp.js"></script>
  <script type="text/javascript" src="scripts/shBrushCSharp.js"></script>
  <script type="text/javascript" src="scripts/shBrushCss.js"></script>
  <script type="text/javascript" src="scripts/shBrushDelphi.js"></script>
  <script type="text/javascript" src="scripts/shBrushDiff.js"></script>
  <script type="text/javascript" src="scripts/shBrushGroovy.js"></script>
  <script type="text/javascript" src="scripts/shBrushJava.js"></script>
  <script type="text/javascript" src="scripts/shBrushJScript.js"></script>
  <script type="text/javascript" src="scripts/shBrushPhp.js"></script>
  <script type="text/javascript" src="scripts/shBrushPlain.js"></script>
  <script type="text/javascript" src="scripts/shBrushPython.js"></script>
  <script type="text/javascript" src="scripts/shBrushRuby.js"></script>
  <script type="text/javascript" src="scripts/shBrushScala.js"></script>
  <script type="text/javascript" src="scripts/shBrushSql.js"></script>
  <script type="text/javascript" src="scripts/shBrushVb.js"></script>
  <script type="text/javascript" src="scripts/shBrushXml.js"></script>
  <script type="text/javascript" src="scripts/shBrushBlitz3D.js"></script>
  <link type="text/css" rel="stylesheet" href="styles/shCore.css">
  <link type="text/css" rel="stylesheet" href="styles/shThemeDefault.css">
  <script type="text/javascript">
SyntaxHighlighter.config.clipboardSwf = 'scripts/clipboard.swf';
SyntaxHighlighter.all();
  </script>
  <meta content="MSHTML 6.00.6000.20772" name="GENERATOR"></head>

<body topmargin="0" leftmargin="0" style="BACKGROUND-COLOR: rgb(255,255,255)" marginheight  ="0" marginwidth="0">
<table cellpadding="0" cellspacing="0" width="100%">
  <tbody>
    <tr>
      <td rowspan="2" height="197" width="21"><img height="197" src="index_files/ltoptable.png" width="21" border="0"></td>
      <td colspan="5" valign="top">
      <table cellpadding="0" cellspacing="0" width="100%">
        <tbody>
          <tr>
            <td height="49" width="231"><img height="49" src="index_files/topmenu.png" width="231" usemap="#ImageMap1" border="0"></td>
            <td background="index_files/mtop.gif"><map name="ImageMap1"><area onclick="this.style.behavior='url(#default#homepage)';this.setHomePage('http://www.blitz-school.info'); return false;" shape="RECT" coords="17,26,71,40" href="index.phtml"><area shape="RECT" coords="91,27,149,39" href="javascript:window.external.AddFavorite('http://www.blitz-school.info', 'GameSchool - Центр обучения созданию компьютерных игр!')"></map>
            <div class="searchform" align="right">
            <form method="post"><input value="search" name="do" type="hidden">&nbsp;</form>
            </div>
            </td>
            <td height="49" width="13"><img height="49" src="index_files/mlefttop.png" width="13" border="0"></td>
          </tr>
        </tbody>
      </table>
      </td>
    </tr>
    <tr>
      <td height="148" valign="top" width="225">
      <table cellpadding="0" cellspacing="0" height="148" width="100%">
        <tbody>
          <tr>
            <td height="119" width="225"><a title="Центр обучения созданию компьютерных игр" href="index.phtml"><img height="119" src="index_files/title.png" width="225" border="0"></a></td>
          </tr>
          <tr>
            <td background="index_files/date_b.png" valign="bottom">
            <div class="date" style="FONT-SIZE: 11px; MARGIN-BOTTOM: 10px; MARGIN-LEFT: 12px">
            <script language="JavaScript1.2">
<!-- Begin
var months=new Array(13);
months[1]="января";
months[2]="февраля";
months[3]="марта";
months[4]="апреля";
months[5]="мая";
months[6]="июня";
months[7]="июля";
months[8]="августа";
months[9]="сентября";
months[10]="октября";
months[11]="ноября";
months[12]="декабря";
var time=new Date();
var lmonth=months[time.getMonth() + 1];
var date=time.getDate();
var year=time.getYear();
var hours=time.getHours();
var minutes=time.getMinutes();
if (eval(hours) <10) {hours="0"+hours}
if (eval(minutes) < 10) {minutes="0"+minutes}
if (year < 2000)
year = year + 1900;
document.write("Сейчас: " + date + " ");
document.write(lmonth + " " + year + ", " + hours + ":" + minutes + " ");

// End -->

           </script>
            </div>
            </td>
          </tr>
        </tbody>
      </table>
      </td>
      <td width="296"><img height="148" src="index_files/mainleft.jpg" width="296" border="0"></td>
      <td width="205"><img height="148" src="index_files/mainright.jpg" width="205" border="0"></td>
      <td background="index_files/mback.png">&nbsp;</td>
      <td height="148" width="58"><img height="148" src="index_files/mltopr.png" width="58" border="0"></td>
    </tr>
  </tbody>
</table>
<table bordercolordark="black" bordercolorlight="black" cellpadding="0" cellspacing="0" width="100%">
  <tbody>
    <tr>
      <td background="index_files/anek_tb.png" height="27" valign="top" width="254">
      <div class="lefttext"><b>Меню:</b></div>
      </td><?php include 'menu_top.php'; ?> <td background="index_files/nav_back.gif">&nbsp;</td>
      <td width="17"><img height="27" src="index_files/nav_end.png" width="17" border="0"></td>
    </tr>
  </tbody>
</table>
<table cellpadding="0" cellspacing="0" width="100%">
  <tbody>
    <tr>
      <td background="index_files/lefttable.gif" valign="top" width="254"><!-- Menu -------->
      <div style="MARGIN-LEFT: 21px">
      <table cellpadding="0" cellspacing="0">
        <tbody>
          <tr>
            <td background="index_files/tb_back.gif">
            <div class="style3"><img src="index_files/home.gif"><a href="http://www.blitz-school.info/index.phtml">Главная</a><br>

        <img src="index_files/pages.gif"> <b>Перечень курсов</b><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/blitzindex.phtml">Создание 3D игр на Blitz3D</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/ogindex.phtml">Создание браузерной РПГ</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/egindex.phtml">Создание экономической браузерки</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/mgindex.phtml">Создание мобильных игр</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/cppindex.phtml">Создание 3D игр на С++</a><br>
        <img src="index_files/group.gif"> <a href="http://www.blitz-school.info/begin_study.phtml">Как стать слушателем</a><br>
        <img src="index_files/recom.gif"> <a href="http://www.blitz-school.info/study_tech.phtml">Технология обучения</a><br>
        <img src="index_files/loyalty_sm.jpg"> <a href="http://www.blitz-school.info/loyalty.phtml">Программа лояльности</a>
        <br>
&nbsp;&nbsp;&nbsp;&nbsp;
    <img border="0" src="index_files/navdiv.gif" width="80" height="4">
        <br><img src="index_files/newuser.gif"> <b>Регистрация</b><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/reg.phtml">Курс 3D игр на Blitz3D</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/reg2.phtml">Курс браузерной RPG</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/reg3.phtml">Экономическая браузерка</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/reg4.phtml">Курс мобильных игр</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/reg5.phtml">3D игры на С++</a><img src="index_files/new.gif"><br>
        <img src="index_files/admin.gif"> <a href="http://www.blitz-school.info/login.phtml">Вход для слушателей</a><br>
        <img src="index_files/study.gif"> <a href="http://www.blitz-school.info/program.phtml">Учебные программы курсов</a><br>
        <img src="index_files/society.gif"> <a href="http://www.blitz-school.info/response.phtml">Отзывы</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;
    <img border="0" src="index_files/navdiv.gif" width="80" height="4">
        
        <br><img src="index_files/media.gif"> <a href="http://www.blitz-school.info/distant.phtml">О дистанционном образовании</a><br>
        <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/articles.phtml">Статьи</a><br>
        <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/less_ex.phtml">Изложение материала</a><br>
        <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/gallery.phtml">Галерея</a><br> 
        <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/links.phtml">Полезные ссылки</a><br>
        <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/contacts.phtml">Контакты</a><br>
       <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/friends.phtml">Обмен ссылками</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;

            </div>
            </td>
          </tr>
          <tr>
            <td width="222"><img height="8" src="index_files/tb_b.gif" width="222" border="0"></td>
          </tr>
        </tbody>
      </table>
      </div><!-- ------------------ end of menu ------------------- --> </td>
      <td class="news" valign="top">
      <script language="javascript" type="text/javascript">
      </script>
      <div style="MARGIN-TOP: 7px">
      <table cellpadding="0" cellspacing="0" width="100%">
        <tbody>
          <tr>
            <td width="13"><img height="24" src="index_files/m_left.gif" width="13" border="0"></td>
            <td class="newstitle" background="index_files/m_center.gif">
            <b>Занятие
<span lang="en-us">6</span></b></td>
            <td class="newstitle" align="right" background="index_files/m_center.gif">&nbsp;</td>
            <td width="9"><img height="24" src="index_files/m_right.gif" width="9" border="0"></td>
          </tr>
        </tbody>
      </table>
      <table cellpadding="0" cellspacing="0" width="100%">
        <tbody>
          <tr>
            <td background="index_files/m_left_m.gif" width="4">&nbsp;</td>
            <td class="newsbody" bgcolor="#fdfdfd">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <font size="3"><b>Поселок ч.2. Военные здания<br>
			</b></font>
            <br>
            <span lang="en-us"><font color="#4775A5"><b>6</b></font></span><b><font color="#4775a5">.1. 
			</font><font color="#4775A5">Казарма, тренировка пехоты </font><br>
            <br>
&nbsp;</b><span lang="en-us">&nbsp;</span>Добрый день, уважаемый учащийся&nbsp; 
			и сегодня мы перейдем к изучению темы строительства военных зданий в 
			которых будем тренировать наши боевые юниты, совершенствовать их 
			характеристики, а также исследовать новые виды войск.<br>
			Первым военным зданием, которое мы построим в поселке будет казарма. 
			Картинка ее выглядит так:<br>
			<img border="0" src="www/img/vill/g19.gif" width="75" height="57"><br>
			<br>
			На прошлом занятии мы уже научились строить новые здания на 
			предназначенных для них стройплощадках, поэтому не будем затягивать 
			с постройкой казармы, а сразу создадим ее <span lang="en-us">SQL</span> 
			функцией <font color="#0000FF">makebuildplaces</font>.<span lang="en-us">
			</span>Но для начала мы должны добавить несколько описаний в наш 
			скрипт <span lang="en-us">travgame.sql. </span>Во первых мы добавим 
			новый тип здания - казарма в нашу справочную таблицу <b>
			building_types</b>.<br>
<pre class="brush: sql;">insert into building_types (bt_id,bt_name,bt_image,bt_image_not_ready,bt_description,bt_ycoord_dif,bt_template) 
values (5,'Казарма','img/vill/g19.gif','img/vill/g19b.gif','В казарме могут быть обучены пехотные войска...',22,'tpl_g19.php');
</pre>Фрагмент 6.1.1<p>Затем мы добавляем несколько уровней апгрейдов в таблицу
			<b>build_levels_cost</b>.<br>
			</p>
<pre class="brush: sql;">/*казарма*/
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (5,0,0,0,0,0,0,'0:00:00');
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (5,1,70,40,160,20,2,'0:27:50');
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (5,2,90,50,75,25,1,'0:35:20');
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (5,3,115,65,100,35,1,'0:43:00');
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (5,4,145,85,125,40,1,'0:53:50');
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (5,5,190,105,160,55,1,'1:06:20');
</pre>Фрагмент 6.1.2<p>Теперь в функции <font color="#0000FF">makebuildplaces
			</font>мы с Вами поменяем одну стройплощадку на уже готовую казарму 
			первого уровня:<br>
			</p>
<pre class="brush: sql;">insert into `buildings` (bnum,bt_id,b_xcoord,b_ycoord,b_level,fid) VALUES (2,5,210,89,1,p_fid);
</pre>Фрагмент 6.1.3<p>Вы видите что для стройплощадки под номером 2 (bnum=2) мы 
			изменили тип bt_id=1 на тип bt_id=5 (где 5 - идентификатор казармы 
			из справочника <b>building_types</b> ) и также присвоили ей уровень 
			равный единице. Казарма готова! Можно выполнить скрипт
			<span lang="en-us">travgame.sql.<br>
			</span>Войдя в игру, на странице<span lang="en-us"> <b>village.php</b></span>,<span lang="en-us">
			</span>кроме главного здания, можно увидеть<span lang="en-us">
			</span>и нашу казарму.<span lang="en-us"><br>
			<br>
			<img border="0" src="pics/bldk.png" width="556" height="469"><br>
			</span><br>
			Рисунок 6.1.1<br>
			<br>
			Как Вы понимаете, казарма потребуется нам для тренировки пехоты. Мы 
			сознательно в учебных целях выбрали только одну расу - римляне и 
			потому в качестве пехоты у нас будут выступать легионеры, 
			преторианцы и империанцы.<br>
			<img border="0" src="pics/u2.gif" width="150" height="120"><img border="0" src="pics/u1.gif" width="150" height="120"><img border="0" src="pics/u3.gif" width="150" height="120"><br>
			<br>
			И сейчас мы должны создать справочную таблицу типов войск, которые 
			будут использоваться в создаваемой нами игре. Назовем мы эту таблицу
			<b>spr_army</b> и вот как она выглядит:<br>
			</p>
<pre class="brush: sql;">/* справочник видов войск */
CREATE TABLE `spr_army` (
sa_id bigint(20) unsigned NOT NULL auto_increment, /*ID*/
sa_name char(50), /*название военного юнита*/ 
sa_image CHAR(50) , 
sa_attack int, /* атака */ 
sa_inf_defence int, /* защита от пехоты*/ 
sa_cav_defence int, /* защита от конницы*/
sa_grain INT, /*зерно*/
sa_ore INT, /*руда*/
sa_wood INT, /*дерево*/
sa_clay INT, /*глина*/
sa_speed INT, /*скорость, полей в час*/
sa_capacity INT, /*грузоподъемность*/
sa_cons INT, /*потребление зерна*/ 
sa_training_time CHAR(20), /*время обучения (для здания 1 уровня)*/
sa_description CHAR(255), /*описание*/
bt_id int, /*принадлежность зданию*/

PRIMARY KEY (`sa_id`)
) ENGINE=MyISAM DEFAULT CHARSET=cp1251;
</pre>Фрагмент 6.1.4 <br>
			<br>
			<b>sa_id</b> - уникальный идентификатор типа войск<br>
			<b>sa_name</b> -&nbsp; название типа войск (легионеры, 
			преторианцы....)<br>
			<b>sa_image</b> - картинка этого типа войск <br>
			<b>sa_attack</b> - сила атаки (для каждого типа войск отличается)
			<br>
			<b>sa_inf_defence</b>&nbsp; - защита от пехоты<br>
			<b>sa_cav_defence</b> - защита от кавалерии (конных войск) <br>
			<b>sa_grain</b> - сколько нужно зерна для тренировки одного солдата 
			этого типа войск <br>
			<b>sa_ore</b> - сколько нужно руды для тренировки одного солдата 
			этого типа войск <br>
			<b>sa_clay</b> - сколько нужно глины для тренировки одного солдата 
			этого типа войск <br>
			<b>sa_wood</b> - сколько нужно древесины для тренировки одного 
			солдата этого типа войск <br>
			<b>sa_speed</b> - скорость перемещения по участкам (полям) 
			глобальной карты (полей в час)<br>
			<b>sa_capacity</b> - сколько ресурсов, захваченных у врага может 
			переносить один воин&nbsp; <br>
			<b>sa_cons</b>&nbsp; - сколько зерна потребляет воин этого типа в 
			час<br>
			<b>sa_training_time</b> - сколько нужно времени для тренировки 
			одного воина этого типа<br>
			<b>sa_description</b> - описание этого типа войск <br>
			<b>bt_id</b> - в здании какого типа этот тип войск производится ( 
			для казармы-5 справочник <b>building_types</b> ) <br>
			<br>
			И теперь нам остается добавить несколько типов войск в наш 
			справочник.<br>
<pre class="brush: sql;">/*для казармы*/
insert into spr_army(sa_id,sa_name,sa_image,sa_attack,sa_inf_defence,sa_cav_defence,sa_wood,sa_clay,sa_ore,sa_grain,
sa_speed,sa_capacity,sa_cons,sa_training_time,bt_id,sa_description) 
values (1,'Легионер','img/army/1.gif',40,35,50,120,100,150,30,6,50,1,'0:00:20',5,'Легионеры — простая и универсальная пехота римлян....');
insert into spr_army(sa_id,sa_name,sa_image,sa_attack,sa_inf_defence,sa_cav_defence,sa_wood,sa_clay,sa_ore,sa_grain,
sa_speed,sa_capacity,sa_cons,sa_training_time,bt_id,sa_description) 
values (2,'Преторианец','img/army/2.gif',30,65,35,100,130,160,70,5,20,1,'0:29:20',5,'Преторианцы проходят продолжительное обучение навыкам ...');
insert into spr_army(sa_id,sa_name,sa_image,sa_attack,sa_inf_defence,sa_cav_defence,sa_wood,sa_clay,sa_ore,sa_grain,
sa_speed,sa_capacity,sa_cons,sa_training_time,bt_id,sa_description) 
values (3,'Империанец','img/army/3.gif',70,40,25,150,160,210,80,7,50,1,'0:32:00',5,'Империанцы — единица атакующих войск Рима. Они быстры....');
</pre>Фрагмент 6.1.5
			<p>Думается здесь пояснений никаких не нужно и сейчас мы перейдем 
			непосредственно от справочных данных к формированию армии отдельных 
			игроков. Для того, чтоб учесть, какие войска есть у каждого 
			отдельного игрока, зарегистрировавшегося в нашей игре, нам 
			понадобится таблица с названием <span lang="en-us"><b>army</b>.<br>
			</span>Ват она:<br>
			</p>
<pre class="brush: sql;">/* таблица видов войск у игрока */
CREATE TABLE `army` (
ar_id bigint(20) unsigned NOT NULL auto_increment, /*ID*/
sa_id bigint(20), /*ID из spr_army*/
sr_qty int default 0, /* кол-во войск */ 
sr_enable int default 0, /* доступность */ 
sr_attack_upgrade int default 0, /* апгрейд к атаке*/
sr_defence_upgrade int default 0, /* апгрейд к защите*/ 
fid int, /*принадлежность поселку*/
PRIMARY KEY (`ar_id`)
) ENGINE=MyISAM DEFAULT CHARSET=cp1251;
</pre>Фрагмент 6.1.6 <br>
			<br>
			<b>ar_id</b> - уникальный идентификатор войска данного типа<br>
			<b>sa_id</b> - тип этого войска (связь с <b>spr_army</b>) <br>
			<b>sr_qty</b> - количество воинов этого типа<br>
			<b>sr_enable</b>- доступен ли этот тип войск (некоторые типы войск 
			сперва нужно исследовать в Академии) <br>
			<b>sr_attack_upgrade</b> - апгрейд к атаке (делается в кузнице 
			оружия) <br>
			<b>sr_defence_upgrade</b> - апгрейд к защите (делается в кузнице 
			доспехов) <br>
			<b>fid</b> - идентификатор поселка, к которому принадлежат эти 
			войска <br>
			<br>
			Давайте сделаем сразу простенькую <span lang="en-us">SQL </span>
			процедуру <font color="#0000FF">makearmy</font>, которая будет 
			создавать армию для выбранного поселка.<br>
<pre class="brush: sql;">/*------- процедура по генерированию войск игрока ----------*/
create procedure makearmy (p_fid int)
BEGIN
 insert into army (sa_id,sr_qty,sr_enable,fid) VALUES (1,0,1,p_fid); /*легионеры доступны*/
 insert into army (sa_id,sr_qty,sr_enable,fid) VALUES (2,0,0,p_fid); /*преторианцы недоступны*/
 insert into army (sa_id,sr_qty,sr_enable,fid) VALUES (3,0,0,p_fid); /*империанцы недоступны*/
 insert into army (sa_id,sr_qty,sr_enable,fid) VALUES (4,0,0,p_fid); /*Конный разведчик недоступен*/
 insert into army (sa_id,sr_qty,sr_enable,fid) VALUES (5,0,0,p_fid); /*Конница императора недоступна*/
END;

call makearmy( 49 ); /* армия для нашего игрока &quot;test&quot;, т.е. для его поселка с id=49 */
</pre>Фрагмент 6.1.7
			<p>Видите, мы создали процедуру и тут же вызвали ее, если вы 
			добавите эти строки, а также все создаваемые ранее таблицы из нашего 
			текущего занятия в скрипт <span lang="en-us">travgame.sql </span>и 
			выполните его, то в таблице <b>army</b>, в результате работы 
			процедуры&nbsp; <font color="#0000FF">makearmy</font> , появятся 
			такие записи:<br>
			<br>
			<img border="0" src="pics/armytab.png" width="734" height="215"><br>
			<br>
			Рисунок 6.1.2</p>
			<p>Вы видите, что поле <span lang="en-us"><font color="#0000FF">
			sr_enable</font> </span>установлено в 1 только для типа войск
			<span lang="en-us">sa_id = 1</span>, то есть для легионеров, значит 
			в казарме мы пока можем производить только их.<br>
			<br>
			Вы помните, что для &quot;входа&quot; в какое-то здание&nbsp; из карты поселка 
			служит скрипт <span lang="en-us">build.php</span>, а к нему 
			подключаются шаблоны, характерные для каждого здания. Не исключение 
			и казарма. Как Вы видели из справочника <b>building_types</b> 
			<span lang="en-us">&nbsp;</span>для казармы название шаблона - <b>
			tpl_g19.php.</b> Давайте рассмотрим, что в нем интересного.</p>


<pre class="brush: php;">
// Казарма
echo '&lt;form name=&quot;training&quot; method=&quot;POST&quot; action=&quot;build.php?'.$_SERVER[&quot;QUERY_STRING&quot;].'&quot;&gt;
&lt;table style=&quot;border-collapse: collapse;&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; id=&quot;army&quot;&gt;&lt;tr&gt;
&lt;td width=&quot;250&quot; class=&quot;tabhead&quot;&gt;Название&lt;/td&gt;
&lt;td class=&quot;tabhead&quot;&gt;Количество&lt;/td&gt;
&lt;td class=&quot;tabhead&quot;&gt;Макс&lt;/td&gt;
&lt;/tr&gt;';

$res = mysql_query(&quot;SELECT sa.sa_id, sa_name, sa_image, sa_grain, sa_ore, sa_wood, sa_clay, sa_cons, sa_training_time, sr_qty 
from spr_army sa
inner join army ar on ar.sa_id = sa.sa_id
where bt_id = 5 and fid=$fid&quot; )
or die(&quot;Query failed : &quot; . mysql_error());

while ($row = mysql_fetch_array( $res )) {
$btype = $row[&quot;bt_id&quot;]; // какой тип здания?
$sa_id = $row[&quot;sa_id&quot;]; // какой тип войска
$max_army = max_army_type( $fid, $row[&quot;sa_id&quot;]);
echo '&lt;tr&gt;&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;'.$row[&quot;sa_image&quot;].'&quot;&gt;&lt;a href=&quot;#&quot;&gt;'.$row[&quot;sa_name&quot;].'&lt;/a&gt; (Имеется: '.$row[&quot;sr_qty&quot;].') &lt;br&gt;';
echo '&lt;img src=&quot;img/res/grain.png&quot;&gt;'.$row[&quot;sa_grain&quot;].' &lt;img src=&quot;img/res/ore.png&quot;&gt;'.$row[&quot;sa_ore&quot;].' &lt;img src=&quot;img/res/wood.png&quot;&gt;'.
$row[&quot;sa_wood&quot;].' &lt;img src=&quot;img/res/clay.png&quot;&gt;'.$row[&quot;sa_clay&quot;].' &lt;img src=&quot;img/res/cons.png&quot;&gt;'.$row[&quot;sa_cons&quot;].' &lt;img src=&quot;img/res/time.png&quot;&gt; '.
$row[&quot;sa_training_time&quot;].'&lt;/td&gt;'; 
echo '&lt;td class=&quot;armyinfo&quot;&gt; &lt;input type=&quot;text&quot; size=5 class=&quot;text&quot; name=&quot;t'.$sa_id.'&quot; value=&quot;0&quot; maxlength=&quot;4&quot;&gt; &lt;/td&gt;';
echo '&lt;td class=&quot;armyinfo&quot;&gt; &lt;a href=&quot;#&quot; onClick=&quot;set_qty('.$sa_id.','.$max_army.')&quot;&gt;('.$max_army.')&lt;/a&gt;&lt;/td&gt;';
echo '&lt;/tr&gt;';
}
echo '&lt;/table&gt;';
echo '&lt;br&gt;&lt;img src=&quot;img/army/train.png&quot; onclick=&quot;init_training()&quot; style=&quot;cursor:hand&quot;&gt;&lt;/br&gt;
&lt;input type=&quot;hidden&quot; name=&quot;train&quot;&gt;
&lt;/form&gt;';

</pre>
			Фрагмент 6.1.<span lang="en-us">8</span>.<p>В казарме тренируются 
			войска и мы внутри здания должны сделать механизм этой тренировки, 
			как Вы видите шаблон начинается с создания формы с именем training, 
			которая что-то отправляет в скриптовый файл <b>build.php </b>( 
			системная переменная $_SERVER[&quot;QUERY_STRING&quot;] хранит аргументы 
			адресной строки, в нашем случае это номер здания, куда мы зашли). 
			Далее мы создаем <span lang="en-us">HTML </span>табличку с 
			заголовком Названия, количества и максимального количества создания 
			войск разных типов. В запросе (строки 9-13) мы получаем данные от 
			двух таблиц (соединенных по типу армии ar.sa_id = sa.sa_id) с 
			условием (where bt_id = 5 ), то есть, все войска, которые 
			производятся в казарме. (Для конюшни bt_id=6, мы ее создадим в 
			следующем пункте). Вы заметили что мы пока не ставим условие 
			sr_enable=1, то есть показывать для тренировки доступные войска. Это 
			делается в учебных целях, чтоб видеть всю пехоту и тренировать любые 
			войска. Позднее мы исправим это. Получив данные из запроса мы 
			выводим их в табличной форме, с картинками и данными по затратам 
			ресурсов и времени на производство отдельно взятого солдата. В конце 
			формы мы добавляем кнопку
			<img border="0" src="www/img/army/train.png" width="100" height="22">, 
			нажав которую игрок может запустить механизм производства выбранных 
			им типов войск. При выборе количества войск для тренировки, это 
			количество можно вручную прописывать в текстовое поле (имя этого 
			поля создается динамически name=&quot;t'.$sa_id.' т.е. для легионера это 
			будет <span lang="en-us">t1, </span>преторианца <span lang="en-us">
			t2 </span>и т.д.), а может щелкать на цифру максимально возможного 
			количества войск этого типа, которое можно сейчас создать. Откуда же 
			мы знаем это максимальное количество? Ну конечно же нам его сообщит 
			функция max_army_type (строка 18) и вот эта функция:</p>


<pre class="brush: php;">
////// функция находит MAX кол-во воинов, которых можно произвести ///////
function max_army_type( $fid, $atype ){
 $a_res = get_res( $fid );
 $query = &quot;SELECT sa_grain, sa_ore, sa_wood, sa_clay from spr_army where sa_id = $atype&quot;;
 $res = mysql_query( $query ) or die(&quot;Query failed : &quot; .$query);
 $row = mysql_fetch_array( $res );
 $arr = array( floor($a_res[&quot;grain&quot;] / $row[&quot;sa_grain&quot;]),floor($a_res[&quot;ore&quot;] / $row[&quot;sa_ore&quot;]),floor($a_res[&quot;wood&quot;] / $row[&quot;sa_wood&quot;]),
floor($a_res[&quot;clay&quot;] / $row[&quot;sa_clay&quot;]) );
 sort($arr,SORT_NUMERIC);
return( $arr[0]);
}
</pre>
			Фрагмент 6.1.<span lang="en-us">9</span>.<br>
			<br>
			Эта функция получает на входе два аргумента - идентификатор поселка 
			и тип армии. Вначале она узнает, сколько ресурсов есть у игрока 
			(строка 3), затем из таблицы выясняет - сколько же нужно для 
			тренировки одного солдата указанного типа ($atype). Потом в массив $arr 
			помещается информация&nbsp; - частное от деления имеющихся ресурсов 
			на нужные для тренировки 1 солдата, после чего массив сортируется 
			стандартной в <span lang="en-us">PHP </span>функцией sort (с опцией 
			сортировки чисел - SORT_NUMERIC), так мы в массиве с элементом
			<span lang="en-us">[0] </span>получим наименьшее число - это и будет 
			минимальное число солдат, которое можно создать на имеющиеся в 
			распоряжении игрока ресурсы.<br>
			<br>
			В Фрагменте 6.1.8 Вы также можете видеть вызов <span lang="en-us">
			JavaScript </span>функции <font color="#0000FF">set_qty</font> 
			которая по щелчку на максимальном числе доступных войск для 
			тренировки помещает его в текстовое поле количества :<br>
<pre class="brush: js;">function set_qty( elem, qty ){
document.getElementById(&quot;t&quot;+elem).value = qty;
}
</pre>Фрагмент 6.<span lang="en-us">1</span>.10<p>В общем, у нас должно 
			получиться нечто следующее:<br>
			<br>
			<img border="0" src="pics/kbld.png" width="509" height="448"><br>
			<br>
			Рисунок 6.1.3<br>
			<br>
			Вы заметили, что время тренировки легионера всего 20 секунд, мы 
			специально сделали это так, установив время тренировки легионеров в 
			таблице spr_army маленьким, чтоб видеть как она происходит и 
			завершается как можно быстрее. Но для проведения тренировки нам 
			понадобится таблица очереди тренировок и мы создадим ее, назвав ее -
			<b>job_training_army</b>.</p>
<pre class="brush: sql;">/* таблица очереди тренировки солдат */
CREATE TABLE `job_training_army` (
jt_id bigint(20) unsigned NOT NULL auto_increment, /*ID*/
sa_id bigint(20), /*ID из spr_army*/
fid int, /*принадлежность поселку*/
jt_start_time bigint DEFAULT 0, /*начало тренировки*/ 
jt_end_time bigint DEFAULT 0, /*завешение времени тренировки*/ 
jt_qty int default 0, /* сколько солдат в очереди */ 
PRIMARY KEY (`jt_id`) 
) ENGINE=MyISAM DEFAULT CHARSET=cp1251;
</pre>Фрагмент 6.1.11
			<p>Эта таблица слегка напоминает таблицу очереди апгрейдов зданий 
			или ресурсных полей, но в ней есть поле jt_qty, которое указывает - 
			сколько воинов тренируется в данный момент и суммарное время на 
			тренировку, к примеру 10 солдат будет равно количеству времени на 
			тренировку одного солдата умножить на 10.<br>
			Как Вы помните из фрагмента 6.1.8 при нажатии на кнопку
			<img border="0" src="www/img/army/train.png" width="100" height="22"> 
			(имя этой кнопки - <span lang="en-us">train</span>) 
			вызывается <span lang="en-us">JavaScript </span>функция
			<font color="#3B84D0">init_training()</font>. Что же она делает? 
			Заглянем в наш файл <span lang="en-us"><b>main.js</b> </span>для 
			текущего занятия:<br>
			</p>
<pre class="brush: js;">function init_training(){
training.submit();
}
</pre>Фрагмент 6.<span lang="en-us">1</span>.12<p>Ничего сложного не делает - 
			запускает на выполнение (<span lang="en-us">submit</span>)<span lang="en-us">
			</span>форму training из фрагмента 6.1.8 и та отправляет данные в 
			скрипт <span lang="en-us"><b>build.php</b>. </span>Что же происходит 
			дальше с этими отправленными данными в файле <span lang="en-us"><b>
			build.php</b></span>. А вот что:</p>


<pre class="brush: php;">
// задали тренировку войск
if( isset( $_POST[&quot;train&quot;] ) ){
 for( $i=1; $i&lt;10; $i++ ){
    if( isset( $_POST[&quot;t&quot;.$i])){
       begin_training( $fid, $_POST[&quot;t&quot;.$i], $i );
    }
 }
}
</pre>
			Фрагмент 6.1.13<p>Вы видите, что по если мы обнаружили что значение 
			переменной train, в массиве $_POST установлено, значит предпринята 
			попытка тренировки войск и мы должны перебрать все типы войск (в 
			дальнейшем их будет 10, поэтому переберем все 10). Однако мы 
			проверяем установлены ли переменные <span lang="en-us">t1, t2</span>,
			<span lang="en-us">t3 </span>и т.д. чтоб не возникло ошибок и только 
			для установленных вызываем функцию <font color="#3B84D0">begin_training</font>, 
			куда передает идентификатор поселка, количество (в
			<span lang="en-us">t1,t2</span>...хранится именно количество, 
			указанное в форме отправки данных в <b>
			tpl_g19.php</b>) и номер (тип войска). Давайте рассмотрим эту 
			функцию <font color="#3B84D0">begin_training</font>.</p>


<pre class="brush: php;">
////// функция засовывает в очередь тренировки армии ////////////
function begin_training( $fid, $qty, $army_type ){

if( $qty &gt; 0 ){
// проверим максимум возможного кол-ва воинов?
if( $qty &lt;= max_army_type( $fid, $army_type ) ){

// израсходуем положенные ресурсы
$query = &quot;SELECT sa_grain, sa_ore, sa_wood, sa_clay, sa_training_time from spr_army where sa_id = $army_type&quot;;
$res = mysql_query( $query ) or die(&quot;Query failed : &quot; .$query);
$row = mysql_fetch_array( $res );

$grain_all = $row[&quot;sa_grain&quot;] * $qty;
$ore_all = $row[&quot;sa_ore&quot;] * $qty; 
$wood_all = $row[&quot;sa_wood&quot;] * $qty;
$clay_all = $row[&quot;sa_clay&quot;] * $qty;
$training_time = $row[&quot;sa_training_time&quot;];

$query = &quot;update fields set f_grain=f_grain-$grain_all,
f_ore=f_ore-$ore_all, 
f_wood=f_wood-$wood_all,
f_clay=f_clay-$clay_all where fid=$fid&quot;;
$result = mysql_query($query) or die(&quot;Query failed : &quot; . mysql_error());

$ltet = get_last_train_end_time( $fid );
$start_time = time() + $ltet ;
$end_time = $start_time+h2s( $training_time )*$qty;
// поместим в очередь тренировки воинов
$query = &quot;insert into job_training_army(sa_id,fid,jt_start_time,jt_end_time,jt_qty) 
values($army_type,$fid,$start_time,$end_time,$qty)&quot;;
$result = mysql_query($query) or die(&quot;Query failed : &quot; . mysql_error());
}
}
}

</pre>
			Фрагмент 6.1.14<p>В этой функции мы еще раз проверим возможность 
			постройки указанного количества воинов (а вдруг игрок сам ввел 
			вручную какое-то нереальное значение) при помощи
			<font color="#3B84D0">max_army_type</font>. Затем узнаем, сколько 
			требуется времени и ресурсов на 1 воина этого типа из таблицы <b>
			spr_army</b> . Перемножим эти значения на количество воинов. В 
			строках 19-23 мы отнимем эти значения от имеющихся ресурсов в наем 
			поселке (таблица <b>fields</b> ), расчитаем время начала и 
			завершения тренировки каждого воина, так как тренировка идет 
			последовательно, завершилась одна - началась следующая и засунем все 
			эти данные в таблицу <b>job_training_army</b>. Как Вы заметили у нас 
			еще задействована функция <font color="#3B84D0">
			get_last_train_end_time</font>. В чем ее роль? Дело в том, что игрок 
			мог сперва задать тренировку двух легионеров, а потом вдруг решил 
			тренировать еще двух легионеров. Эти очереди тренировок не могут 
			идти параллельно, поэтому мы должны узнать время завершения 
			тренировки двух первых легионеров и уже это время будет стартовым 
			для следующей группы войск. Изучите эту функцию сами. Она как и все 
			остальные находится в файле <span lang="en-us"><b>functions.inc.php</b>
			</span><a href="www">здесь</a>.<br>
			<br>
			А сейчас мы должны показать процесс тренировки, чтоб игрок видел на 
			какое время ему рассчитывать! И показом этой тренировки у нас 
			займется функция с названием <font color="#3B84D0">
			show_training_progess</font>.</p>


<pre class="brush: php;">
/////////// показывает - что в данный момент апгрейдится //////////
function show_training_progess( $p_fid ){
$cnt = 0;
$result = mysql_query(&quot;SELECT sa_name, sa_image, jt_start_time, jt_end_time, jt_qty from job_training_army jta 
inner join spr_army a on a.sa_id = jta.sa_id
where jta.fid=$p_fid&quot; ) 
or die(&quot;Query failed : &quot; . mysql_error());
$num_rows = mysql_num_rows( $result );
if( $num_rows &gt; 0 ){

$script = &quot;&quot;;
echo '&lt;table style=&quot;border-collapse: collapse;&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; id=&quot;army&quot;&gt;&lt;tr&gt;
&lt;td width=&quot;262&quot; class=&quot;tabhead&quot;&gt;Обучение&lt;/td&gt;
&lt;td class=&quot;tabhead&quot;&gt;Осталось&lt;/td&gt;
&lt;td class=&quot;tabhead&quot;&gt;Готово в&lt;/td&gt;
&lt;/tr&gt;';

while ($row = mysql_fetch_array( $result )) {
$time_s = $row[&quot;jt_start_time&quot;];
$time_e = $row[&quot;jt_end_time&quot;];
$sa_name = $row[&quot;sa_name&quot;];
$sa_image = $row[&quot;sa_image&quot;];
$qty = $row[&quot;jt_qty&quot;];
echo '&lt;tr&gt;&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;'.$sa_image.'&quot;&gt;'.$qty.' '.$sa_name.' &lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;span id=&quot;restimer'.$cnt.'&quot;&gt;&lt;/span&gt; &lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt; '.date('H:i',$time_e).'&lt;/td&gt;&lt;/tr&gt;';
$rest = s2h($time_e-time());
$hms = explode(':', $rest); 
$script .= &quot;atimers[$cnt] = [ $hms[0], $hms[1], $hms[2] ]; &quot;; 
$cnt ++;

}
echo '&lt;/table&gt;';
echo '&lt;script&gt;';
echo $script;
echo 'updateClock(); setInterval(&quot;updateClock()&quot;, 1000 );';
echo '&lt;/script&gt;';
}
}
</pre>
			Фрагмент 6.1.15<p>Конечно же эта функция очень похожа на аналогичные 
			для показа очереди апгрейдов ресурсных полей и строительства зданий. 
			Ну разве что в запросах используются другие таблицы <b>spr_army</b> 
			и <b>job_training_army</b>. Здесь мы также из этих таблиц получаем 
			данные о времени начала и завершения, которые используем для 
			создания строки очереди с таймерами обратного отсчета, которые 
			засовываем в массив <font color="#339966">atimers</font>. Все это 
			Вам уже должно быть знакомо.<br>
			<br>
			Таким образом, если мы поместим вызов функции в шаблоне <b>
			tpl_g19.php</b> то при нажатии на кнопку
			<img border="0" src="www/img/army/train.png" width="100" height="22"> 
			увидим следующую картину:<br>
			<br>
			<br>
			<img border="0" src="pics/train.png" width="517" height="496"><br>
			<br>
			Рисунок 6.1.4<br>
			<br>
			Нам осталось только сделать функцию, которая будет отслеживать - 
			закончилась ли тренировка какого-нибудь солдата. Вот эта функция, 
			которую мы назвали <font color="#3B84D0">check_end_training</font>:</p>


<pre class="brush: php;">
///////////////// проверка - сколько воинов уже готово //////////////
function check_end_training( $fid ){
// что у нас в очереди строительства? 
$res = mysql_query(&quot;SELECT sa.sa_id, sa_training_time, jt_id, jt_start_time, jt_end_time, jt_qty from job_training_army jta 
inner join spr_army sa on sa.sa_id = jta.sa_id
where jta.fid=$fid&quot; ) 
or die(&quot;Query failed : &quot; . mysql_error());
$num_rows = mysql_num_rows( $res );
if( $num_rows &gt; 0 ){

  $cur_time = time();

  while ($row = mysql_fetch_array( $res )) {
  $army_type = $row[&quot;sa_id&quot;] ;
  $jt_id = $row[&quot;jt_id&quot;];
  $qty = $row[&quot;jt_qty&quot;];
  $time_s = $row[&quot;jt_start_time&quot;];
  $time_e = $row[&quot;jt_end_time&quot;];
  $training_time = $row[&quot;sa_training_time&quot;];

  if( $time_e &lt;= $cur_time ){ // эта очередь завершена
    // убираем из очереди 
    $result = mysql_query(&quot;delete from job_training_army 
              where jt_id=$jt_id&quot; ) 
              or die(&quot;Query failed : &quot; . mysql_error());
    // добавляем в готовую армию
    $result = mysql_query(&quot;update army set sr_qty = sr_qty + $qty
              where sa_id=$army_type and fid=$fid&quot; )
              or die(&quot;Query failed : &quot; . mysql_error()); 

  } elseif( ($time_e &gt; $cur_time) &amp;&amp; ($time_s &lt; $cur_time) ){

    if( $qty &gt; 1 ){ // несколько воинов одного типа
       $units_ready = floor( ($cur_time - $time_s) / h2s($training_time) );
       // добавляем в готовую армию
       $result = mysql_query(&quot;update army set sr_qty = sr_qty + $units_ready
                 where sa_id=$army_type and fid=$fid&quot; )
                 or die(&quot;Query failed : &quot; . mysql_error()); 
       // обновим очередь
       $new_start_time = $time_s + $units_ready*h2s( $training_time );
       $result = mysql_query(&quot;update job_training_army 
                 set jt_start_time = $new_start_time,
                 jt_qty = jt_qty - $units_ready
                 where sa_id=$army_type and fid=$fid&quot; )
                 or die(&quot;Query failed : &quot; . mysql_error()); 
    }

  } 
  }
}
}
</pre>
			Фрагмент 6.1.16<br>
			<br>
			В этой функции есть интересный момент, отличающий ее от подобных 
			функций, которые отслеживали завершение очереди строительства или 
			апгрейдов ресурсных полей. И этот момент состоит в том, что может 
			быть задано количество тренируемых войск. Таким образом при проверке 
			- сколько воинов уже построилось мы должны анализировать, а сколько 
			же вообще воинов в этой очереди? Очереди тренировок (если они есть) 
			выбираются в запросе (строки 4-6). Затем считываются данные, 
			возвращаемые запросом - время старта, окончания тренировки, кол-во и 
			т.д. В условии (строки 21-31) все просто - текущее время больше 
			времен завершения - значит все войска уже построены и мы засовываем 
			их в таблицу <span lang="en-us"><b>army</b> (</span>соответствующего 
			типа, конечно!<span lang="en-us">)</span> и удаляем очередь из 
			таблицы <b>job_training_army</b>. А Вот с условием (строки 31-46) 
			сложнее, текущее время меньше времени завершения всей очереди 
			тренировки, но так как в очереди к примеру 4 легионера, то возможно 
			пару солдат уже успело построиться. Чтоб узнать, сколько юнитов уже 
			готовы мы просто разницу между текущим временем и временем старта 
			тренировки делим на время тренировки одного солдата. А потом 
			обновляем очередь с этого момента. Новое время старта будет равно 
			прошлому времени старта плюс количество солдат умноженное на время 
			тренировки одного солдата. Может это не совсем математически 
			корректно (так как тут может теряться еще кусочек времени на 
			тренировку текущего воина), но для наших учебных целей вполне 
			сгодится.<br>
			Итак после завершения тренировки мы увидим следующее:<br>
			<br>
			<img border="0" src="pics/end_train.png" width="510" height="456"><br>
			Рисунок 6.1.5<br>
			<br>
			Вы видите что легионеров показывается (Имеется: 4), стало быть 
			тренировка завершена!<span lang="en-us"><font color="#4775A5"><b><br>
			<br>
			<br>
			<br>
			6</b></font></span><b><font color="#4775a5">.2. 
			</font></b><font color="#4775A5"><b>Конюшня, тренировка конницы<br>
			<br>
			</b></font>&nbsp;&nbsp; Мы так все подробно расписали для казармы, 
			что тут практически нечего нового показывать. Скрипты практически 
			идентичны, как в случае с казармой. И все таки сделаем кое что. Для 
			начала добавим описание типа конюшни&nbsp; в справочник с 
			постройками <b>
			building_types</b>:<br>
<pre class="brush: sql;">insert into building_types (bt_id,bt_name,bt_image,bt_image_not_ready,bt_description,bt_ycoord_dif,bt_template) 
values (6,'Конюшня','img/vill/g20.gif','img/vill/g20b.gif','В конюшне могут быть обучены все войска кавалерии...',22,'tpl_g20.php');
</pre>Фрагмент 6.2.1<p>И затем сразу же добавляем несколько уровней апгрейдов 
			конюшни в таблицу
			<b>build_levels_cost</b>.<br>
			</p>
<pre class="brush: sql;">/*конюшня*/
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (6,0,0,0,0,0,0,'0:00:00');
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (6,1,260,140,220,100,5,'0:28:20');
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (6,2,335,180,280,130,3,'0:36:50');
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (6,3,425,230,360,165,3,'0:46:30');
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (6,4,545,295,460,210,3,'0:57:50');
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (6,5,700,375,590,270,3,'1:11:00');
</pre>Фрагмент 6.2.2<p>На апгрейды конюшни как Вы видите требуется ресурсов 
			больше чем для казармы, но и войска которые создаются в конюшне 
			посильнее чем пехота, так что затраты эти правомочны.<br>
			Для отображения конюшни на карте поселка нам понадобится картинка:<br>
			<img border="0" src="www/img/vill/g20.gif" width="75" height="70"><br>
			<br>
			Давайте поступим как с казармой и сразу добавим конюшню первого 
			уровня к нам в поселок, то есть в функции <font color="#0000FF">makebuildplaces
			</font>мы с Вами поменяем одну стройплощадку на уже готовую конюшню 
			первого уровня:<br>
			</p>
<pre class="brush: sql;">insert into `buildings` (bnum,bt_id,b_xcoord,b_ycoord,b_level,fid) VALUES (4,6,345,94,1,p_fid);
</pre>Фрагмент 6.2.3<p>
			<img border="0" src="pics/bldcav.png" width="557" height="493"><br>
			Рисунок 6.2.1<br>
			<br>
			Еще нам понадобится добавить типы войск, которые создаются в конюшне:<br>
			</p>
<pre class="brush: sql;">/*для конюшни*/
insert into spr_army(sa_id,sa_name,sa_image,sa_attack,sa_inf_defence,sa_cav_defence,sa_wood,sa_clay,sa_ore,sa_grain,sa_speed,sa_capacity,
sa_cons,sa_training_time,bt_id,sa_description) 
values (4,'Конный разведчик','img/army/4.gif',0,20,10,20,140,160,40,7,0,2,'0:22:40',6,'Конные разведчики - разведывательная единица Рима....');
insert into spr_army(sa_id,sa_name,sa_image,sa_attack,sa_inf_defence,sa_cav_defence,sa_wood,sa_clay,sa_ore,sa_grain,sa_speed,sa_capacity,
sa_cons,sa_training_time,bt_id,sa_description) 
values (5,'Конница императора','img/army/5.gif',180,80,105,800,550,640,180,10,70,4,'0:58:40',6,'Конница Цезаря - это элитные войска римлян...');
</pre>Фрагмент 6.2.4<p>Пока добавили два типа,&nbsp; в следующих занятиях 
			добавим еще один тип - Конницу Цезаря, а сейчас достаточно и этого.<br>
			<br>
			После пересоздания базы из скрипта с обновленной функцией <font color="#0000FF">makebuildplaces
			</font>и авторизации в игре мы можем лицезреть появление конюшни в 
			нашем поселке. Чтоб войти в нее будем использовать шаблон <b>
			tpl_g20.php</b>, Который идентичен шаблону для казармы, единственное 
			в запросе вместо bt_id = 5 нужно указать bt_id = 6 (так как тип 
			конюшни в справочнике <b><span lang="en-us">spr_army</span></b> 
			равен 6)<br>
			<br>
			Вот&nbsp; как выглядит детальная информация оп конюшне, после 
			&quot;входа&quot; в нее:<br>
			<br>
			<img border="0" src="pics/cav_train.png" width="514" height="406"><br>
			<br>
			Рисунок 6.2.2<br>
			<br>
			Все тренировки войск в конюшне осуществляются также как и для 
			казармы.<br>
			<br>
            <br><span lang="en-us"><font color="#4775A5"><b>6</b></font></span><font color="#4775a5"><font ><b>.3. 
			Академия&nbsp;
     </b></font><br></font>
            <br>
&nbsp;&nbsp; Мы уже упоминали, что некоторые типы войск сперва нужно 
			исследовать. В предыдущих пунктах мы пренебрегли этим условием и 
			потому могли создавать в казарме и конюшне кого попало. А ведь 
			вначале нам доступны для тренировки только легионеры! Как же нам 
			научиться создавать другие войска? Для этих целей нам будет служить 
			Академия, где будут исследоваться новые типы войск. Вот картинка 
			Академии:<br>
			<br>
			<img border="0" src="www/img/vill/g22.gif" width="75" height="80"><br>
			<br>
			Для начала добавим описание типа Академии&nbsp; в справочник с 
			постройками <b>
			building_types</b>:<br>
            </p>
<pre class="brush: sql;">insert into building_types (bt_id,bt_name,bt_image,bt_image_not_ready,bt_description,bt_ycoord_dif,bt_template) 
values (7,'Академия','img/vill/g22.gif','img/vill/g22b.gif','В академии могут быть исследованы новые типы войск...',22,'tpl_g22.php');
</pre>Фрагмент 6.3.1<p>И затем сразу же добавляем несколько уровней апгрейдов 
			Академии в таблицу
			<b>build_levels_cost</b>.<br>
			</p>
<pre class="brush: sql;">/*академия*/
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (7,0,0,0,0,0,0,'0:00:00');
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (7,1,220,10,90,40,4,'0:25:50');
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (7,2,280,205,115,50,2,'0:33:50');
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (7,3,360,260,145,65,2,'0:43:00');
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (7,4,460,335,190,85,2,'0:53:50');
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (7,5,590,430,240,105,2,'1:06:20');
</pre>Фрагмент 6.3.2<p>Давайте поступим с Академией также как поступали с 
			казармой и конюшней и сразу добавим это здание первого уровня к нам 
			в поселок, то есть в функции <font color="#0000FF">makebuildplaces
			</font>мы с Вами поменяем одну стройплощадку на уже готовую Академию 
			первого уровня:<br>
			</p>
<pre class="brush: sql;">insert into `buildings` (bnum,bt_id,b_xcoord,b_ycoord,b_level,fid) VALUES (9,7,172,303,1,p_fid);
</pre>Фрагмент 6.3.3<br>
			<br>
			Для того чтоб знать время и расходы ресурсов на исследования нужных 
			нам типов войск, нам понадобится соответствующая справочная таблица 
			с именем <b>army_research_cost</b>:<br>
<pre class="brush: sql;">/* таблица затрат на исследования */
CREATE TABLE `army_research_cost` (
arc_id int unsigned NOT NULL auto_increment, /*ID*/
sa_id bigint(20), /*ID из spr_army*/
arc_grain int DEFAULT 0, 
arc_ore int DEFAULT 0, 
arc_wood int DEFAULT 0, 
arc_clay int DEFAULT 0, 
arc_research_time CHAR(20), 
PRIMARY KEY (`arc_id`) 
) ENGINE=MyISAM DEFAULT CHARSET=cp1251;

insert into army_research_cost (sa_id,arc_wood,arc_clay,arc_ore,arc_grain,arc_research_time) 
values (2,700,620,670,580,'1:58:00'); /*преторинец*/
insert into army_research_cost (sa_id,arc_wood,arc_clay,arc_ore,arc_grain,arc_research_time) 
values (3,1000,740,1880,640,'2:06:00'); /*империанец*/
insert into army_research_cost (sa_id,arc_wood,arc_clay,arc_ore,arc_grain,arc_research_time) 
values (4,940,740,360,400,'1:38:00'); /*разведчик*/
insert into army_research_cost (sa_id,arc_wood,arc_clay,arc_ore,arc_grain,arc_research_time) 
values (5,3400,1860,2760,760,'2:42:00'); /*конница императора*/
</pre>Фрагмент 6.3.4<p>Как видите, мы создали ее и тут де добавили необходимые 
			данные для пока что неисследованных типов войск.<br>
			И сейчас настало время для исследований,&nbsp; то есть пора создать 
			шаблон <b>tpl_g22.php</b>, который нам даст механизм исследований 
			для разных типов войск.<br>
			Вот как он выглядит:</p>


<pre class="brush: php;">
&lt;?
// Академия
echo '&lt;table style=&quot;border-collapse: collapse;&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; id=&quot;army&quot;&gt;&lt;tr&gt;
&lt;td width=&quot;300&quot; class=&quot;tabhead&quot;&gt;Акдемия&lt;/td&gt;
&lt;td class=&quot;tabhead&quot;&gt;Действие&lt;/td&gt;
&lt;/tr&gt;';

$res = mysql_query(&quot;SELECT sa.sa_id, sa_name, sa_image,
arc_grain, arc_ore, arc_wood, arc_clay, arc_research_time
from spr_army sa
inner join army ar on ar.sa_id = sa.sa_id
inner join army_research_cost arc on arc.sa_id = ar.sa_id
where sr_enable = 0 and fid=$fid&quot; )
or die(&quot;Query failed : &quot; . mysql_error());

while ($row = mysql_fetch_array( $res )) {
  $atype = $row[&quot;sa_id&quot;]; // какой тип войска
  echo '&lt;tr&gt;&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;'.$row[&quot;sa_image&quot;].'&quot;&gt;&lt;a href=&quot;#&quot;&gt;'.$row[&quot;sa_name&quot;].'&lt;/a&gt;&lt;br&gt;';
  echo '&lt;img src=&quot;img/res/grain.png&quot;&gt;'.$row[&quot;arc_grain&quot;].' &lt;img src=&quot;img/res/ore.png&quot;&gt;'.$row[&quot;arc_ore&quot;].' &lt;img src=&quot;img/res/wood.png&quot;&gt;'.
$row[&quot;arc_wood&quot;].' &lt;img src=&quot;img/res/clay.png&quot;&gt;'.$row[&quot;arc_clay&quot;].' &lt;img src=&quot;img/res/time.png&quot;&gt; '.$row[&quot;arc_research_time&quot;].'&lt;/td&gt;'; 
  echo '&lt;td class=&quot;armyinfo&quot;&gt;'; 
  if( !any_research( $fid ) ){
    if( allow_research( $fid, $atype ) ){
       echo '&lt;a href=&quot;#&quot; onClick=&quot;do_research('.$atype.')&quot;&gt;Исследовать&lt;/a&gt;';
    } else {
       echo '&lt;font color=&quot;#CCCCCC&quot;&gt;Не хватает сырья&lt;/font&gt;';
    }
  } else echo '&lt;font color=&quot;#CCCCCC&quot;&gt;Проводятся исследования&lt;/font&gt;';
  echo '&lt;/td&gt;';
  echo '&lt;/tr&gt;';
}
echo '&lt;/table&gt;';
echo '&lt;br&gt;';
show_research_progess( $fid );
?&gt;
</pre>
			Фрагмент 6.3.5<br>
			<br>
			Вот как выглядит работа этого шаблона:<p>
			<img border="0" src="pics/academ.png" width="514" height="466"><br>
			<br>
			Рисунок 6.3.1<br>
			<br>
			Изучите код фрагмента 6.3.5 самостоятельно. Он очень напоминает 
			шаблоны зданий рассматриваемые ранее и поэтому нам нет смысла 
			рассматривать его столь подробно. Давайте остановимся только на том, 
			что же произойдет если мы нажмем ссылку исследовать. Как Вы видите 
			из фрагмента&nbsp; 6.3.5 это приведет к выполнению
			<span lang="en-us">JavaScript </span>функции <font color="#3B84D0">do_research</font>, 
			получающей в качестве аргумента тип исследуемого войска.<br>
			<br>
			Вот как выглядит эта функция:<br>
            </p>
<pre class="brush: js;">function do_research( atype ){
 url=window.location.href;
 if(url.indexOf('?')!=-1){
   newurl = url.split('?')
   params = newurl[1];
}
location.href=&quot;build.php?&quot;+params+&quot;&amp;research=&quot;+atype; 
}
</pre>Фрагмент 6.<span lang="en-us">3</span>.6<p>Эта функция сохраняет текущие 
			параметры адресной строки браузера и еще добавляет один &amp;research, 
			которому присваивается тип исследуемого войска, переданный этой 
			функции как аргумент. Ну а исследованиями опять же занимается наш 
			скрипт<b> build.php</b>. Вот как он с этим справляется:</p>


<pre class="brush: php;">
// задали исследование в академии
if( isset( $_GET[&quot;research&quot;] ) ){
  if( !any_research( $fid ) ){
    begin_research( $fid, $_GET[&quot;research&quot;] );
  }
}
</pre>
			Фрагмент 6.3.7<br>
			<br>
			Получив методом GET тип исследуемого войска мы вызываем функцию
			<font color="#3B84D0">begin_research</font>, которой передаем 
			идентификатор поселка и этот тип войска для исследования. Что же 
			происходит в кулуарах этой функции мы рассмотрим далее:<pre class="brush: php;">
////// функция засовывает в очередь исследований ////////////
function begin_research( $fid, $atype ){
// израсходуем положенные ресурсы
$query = &quot;SELECT arc_grain, 
arc_ore, 
arc_wood, 
arc_clay,
arc_research_time
from army_research_cost
where sa_id=$atype&quot;;
$res = mysql_query( $query ) or die(&quot;Query failed 1: &quot; .mysql_error());

$row = mysql_fetch_array( $res );
$arc_grain = $row[&quot;arc_grain&quot;];
$arc_ore = $row[&quot;arc_ore&quot;];
$arc_wood = $row[&quot;arc_wood&quot;];
$arc_clay = $row[&quot;arc_clay&quot;];
$arc_research_time = $row[&quot;arc_research_time&quot;];

$query = &quot;update fields set f_grain=f_grain-$arc_grain,
f_ore=f_ore-$arc_ore, 
f_wood=f_wood-$arc_wood,
f_clay=f_clay-$arc_clay where fid=$fid&quot;;
$result = mysql_query($query) or die(&quot;Query failed : &quot; . mysql_error());

$start_time = time();
$end_time = $start_time+h2s( $arc_research_time );
// поместим в очередь тренировки воинов
$query = &quot;insert into job_research_army(sa_id,fid,jra_start_time,jra_end_time) 
values($atype,$fid,$start_time,$end_time)&quot;;
$result = mysql_query($query) or die(&quot;Query failed : &quot; . mysql_error());
}

</pre>
			Фрагмент 6.3.8<p>Подобные функции мы уже разрабатывали. Действие ее 
			стандартно - узнать ресурсы, которые мы должны затратить на 
			исследования (из таблицы <b>army_research_cost</b>) отнять эти 
			ресурсы из наших запасов ( таблица <b>fields</b> ). Вычислить время 
			начала и завершения очереди исследования и собственно создать запись 
			в таблице очереди <b>job_research_army</b>, которая выглядит тоже 
			весьма стандартно:<br>
            </p>
<pre class="brush: sql;">/* таблица очереди исследования новых видов войск */
CREATE TABLE `job_research_army` (
jra_id bigint(20) unsigned NOT NULL auto_increment, /*ID*/
sa_id bigint(20), /*ID из spr_army - это тип войска*/
fid int, /*принадлежность поселку*/
jra_start_time bigint DEFAULT 0, /*начало исследования*/ 
jra_end_time bigint DEFAULT 0, /*завешение времени исследования*/ 
PRIMARY KEY (`jra_id`) 
) ENGINE=MyISAM DEFAULT CHARSET=cp1251;
</pre>Фрагмент 6.3.9<br>
			<br>
			Как показать очередь исследования рассмотрите самостоятельно - для 
			этого в файле <span lang="en-us"><b>functions.inc.php</b> </span>
			есть функция <font color="#3B84D0">show_research_progess</font><span lang="en-us">.
			</span>А результат ее работы выглядит так:<br>
			<br>
			<img border="0" src="pics/ac_issl.png" width="512" height="532"><p>
			Рисунок 6.3.2<br>
			<strong><span lang="en-us"><font color="#4775A5"><br>
			</font></span></strong>Проверка завершения исследования проверяется 
			функцией <font color="#3B84D0">check_end_research</font>, которая 
			также присутствует в файле <span lang="en-us"><b>functions.inc.php</b></span> 
			и весь смысл ее работы заключается в том, чтоб присвоить значение 
			sr_enable = 1 тому типу войск, которые завершили исследование в 
			академии (текущее время стало больше времени завершения 
			исследований)<br>
			<font color="#4775A5"><span lang="en-us"><strong>
			<br>
			<br>
			6</strong></span></font><font color="#4775a5"><strong>.4. 
			</strong>
      
            </font><strong><font color="#4775A5">Кузница оружия/доспехов</font></strong><br>
			<br>
			&nbsp;&nbsp; Мы уже создали несколько типов войск и немаловажным 
			фактором их успешного поведения в бою будет улучшение их 
			характеристик. Характеристики эти - усиление атаки и защиты, то есть 
			оружия и доспехов. Посему мы сейчас создадим еще два здания в нашем 
			поселке - кузницу оружия и кузницу доспехов. Картинки этих зданий 
			выглядят так:<br>
			<br>
			<img border="0" src="www/img/vill/g12.gif" width="75" height="70"><img border="0" src="www/img/vill/g13.gif" width="75" height="70"><br>
			<br>
			Сейчас мы добавим оба типа здания в нашу справочную таблицу
			<span lang="en-us"><b>spr_army</b>.</span><br>
			</p>
<pre class="brush: sql;">insert into building_types (bt_id,bt_name,bt_image,bt_image_not_ready,bt_description,bt_ycoord_dif,bt_template) 
values (8,'Кузница оружия','img/vill/g12.gif','img/vill/g12b.gif','В плавильной печи кузницы можно улучшить оружие воинов.',22,'tpl_g12.php');
insert into building_types (bt_id,bt_name,bt_image,bt_image_not_ready,bt_description,bt_ycoord_dif,bt_template) 
values (9,'Кузница доспехов','img/vill/g13.gif','img/vill/g13b.gif','В кузнице можно улучшить характеристики доспехов воинов.',22,'tpl_g13.php');
</pre>Фрагмент 6.<span lang="en-us">4</span>.1<p>Уровни апгрейдов этих зданий:<br>
			</p>
<pre class="brush: sql;">/*кузница оружия*/
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (8,0,0,0,0,0,0,'0:00:00');
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (8,1,170,200,380,130,4,'0:25:50');
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (8,2,220,225,485,165,2,'0:33:50');
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (8,3,280,330,625,215,2,'0:43:00');
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (8,4,355,420,795,275,2,'0:53:50');
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (8,5,455,535,1020,350,2,'1:06:20');
/*кузница доспехов*/
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (9,0,0,0,0,0,0,'0:00:00');
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (9,1,130,210,410,130,4,'0:25:50');
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (9,2,165,270,525,165,2,'0:33:50');
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (9,3,215,345,670,215,2,'0:43:00');
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (9,4,275,440,860,275,2,'0:53:50');
insert into `build_levels_cost`(bt_id, blc_level, blc_wood, blc_clay, blc_ore, blc_grain, blc_cons, blc_time_upgrade) 
values (9,5,350,565,1100,350,2,'1:06:20');
</pre>Фрагмент 6.<span lang="en-us">4</span>.2<p>В функции <font color="#0000FF">makebuildplaces&nbsp;
			</font>сде<span lang="en-us">л</span>аем необходимые изменения, чтоб 
			сразу добавить эти здания к нам в поселок:<br>
			</p>
<pre class="brush: sql;">insert into `buildings` (bnum,bt_id,b_xcoord,b_ycoord,b_level,fid) VALUES (17,8,235,260,1,p_fid);
insert into `buildings` (bnum,bt_id,b_xcoord,b_ycoord,b_level,fid) VALUES (20,9,176,161,1,p_fid);
</pre>Фрагмент 6.<span lang="en-us">4</span>.3<br>
			<br>
			Вот они на карте поселка:<p>
			<img border="0" src="pics/2c.png" width="561" height="492"></p>
			<p>Рисунок 6.4.1<br>
			<span lang="en-us"><br>
			</span>Для апгрейдов войск нам нужны данные по затратам и времени 
			апгрейдов, каждого из этих типов<span lang="en-us"> </span>войск и 
			назовем мы таблицу, где все это будет храниться <b>army_upgrade_cost</b><span lang="en-us">.</span> 
			Попутно введем сразу в нее данные хотя бы по два уровня апгрейдов 
			для каждого типа войск.<br>
			</p>
<pre class="brush: sql;">/*--------- справочник уровней апгрейдов оружия и доспехов в кузницах ---------------*/
/* для простоты - одна таблица и для доспехов и для оружия */
CREATE TABLE `army_upgrade_cost` (
auc_id bigint(20) unsigned NOT NULL auto_increment, /* ID*/
sa_id int, /* тип войска */
auc_level int, /* уровень*/ 
auc_grain int, /* колько зерна для перехода на этот уровень */ 
auc_ore int, /* колько руды для перехода на этот уровень */ 
auc_wood int, /* колько леса для перехода на этот уровень */ 
auc_clay int, /* колько глины для перехода на этот уровень */ 
auc_time_upgrade CHAR(10), /* время апгрейда оружия или брони до след. уровня */
PRIMARY KEY (`auc_id`)
) ENGINE=MyISAM DEFAULT CHARSET=cp1251;

/*добавим по 2 уровня апгрейда каждому типу войск*/
/*легионер*/
insert into army_upgrade_cost (sa_id,auc_level,auc_wood,auc_clay,auc_ore,auc_grain,auc_time_upgrade) values (1,1,560,620,680,370,'1:42:20');
insert into army_upgrade_cost (sa_id,auc_level,auc_wood,auc_clay,auc_ore,auc_grain,auc_time_upgrade) values (1,2,670,730,800,450,'2:32:00');
/*преторианец*/
insert into army_upgrade_cost (sa_id,auc_level,auc_wood,auc_clay,auc_ore,auc_grain,auc_time_upgrade) values (2,1,580,640,690,350,'1:45:20');
insert into army_upgrade_cost (sa_id,auc_level,auc_wood,auc_clay,auc_ore,auc_grain,auc_time_upgrade) values (2,2,560,620,680,370,'2:25:00');
/*империанец*/
insert into army_upgrade_cost (sa_id,auc_level,auc_wood,auc_clay,auc_ore,auc_grain,auc_time_upgrade) values (3,1,630,690,880,390,'1:42:20');
insert into army_upgrade_cost (sa_id,auc_level,auc_wood,auc_clay,auc_ore,auc_grain,auc_time_upgrade) values (3,2,740,850,1020,450,'2:52:00');
/*разведчик*/
insert into army_upgrade_cost (sa_id,auc_level,auc_wood,auc_clay,auc_ore,auc_grain,auc_time_upgrade) values (4,1,350,420,480,270,'1:22:20');
insert into army_upgrade_cost (sa_id,auc_level,auc_wood,auc_clay,auc_ore,auc_grain,auc_time_upgrade) values (4,2,520,610,640,350,'1:45:50');
/*конница императора*/
insert into army_upgrade_cost (sa_id,auc_level,auc_wood,auc_clay,auc_ore,auc_grain,auc_time_upgrade) values (5,1,800,1200,1680,870,'1:50:20');
insert into army_upgrade_cost (sa_id,auc_level,auc_wood,auc_clay,auc_ore,auc_grain,auc_time_upgrade) values (5,2,980,1450,1830,950,'2:45:00');
</pre>Фрагмент 6.4.4<p>Давайте на примере<span lang="en-us"> </span>кузницы 
			оружия рассмотрим, как<span lang="en-us"> </span>же происходят эти 
			апгрейды наших войск и к чему это все приводит<span lang="en-us">.</span> 
			Как Вы догадались нам понадобится шаблон <b>tpl_g12.php</b><span lang="en-us">,</span> 
			где будет создаваться вся<span lang="en-us"> </span>эта кухня с 
			апгрейдами солдат.<span lang="en-us"> </span>Вот как выглядит 
			содержимое этого шаблона:</p>


<pre class="brush: php;">
&lt;?
// Кузница оружия
$url = $_SERVER[&quot;QUERY_STRING&quot;];
$btype = 8; /* Тип - кузница оружия */

echo '&lt;table style=&quot;border-collapse: collapse;&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; id=&quot;army&quot;&gt;&lt;tr&gt;
&lt;td width=&quot;300&quot; class=&quot;tabhead&quot;&gt;Кузница оружия&lt;/td&gt;
&lt;td class=&quot;tabhead&quot;&gt;Действие&lt;/td&gt;
&lt;/tr&gt;';

$res = mysql_query(&quot;SELECT sa.sa_id, sa_name, sa_image,
auc_grain, auc_ore, auc_wood, auc_clay, auc_time_upgrade,
sr_attack_upgrade
from spr_army sa
inner join army ar on ar.sa_id = sa.sa_id
inner join army_upgrade_cost auc on auc.sa_id = ar.sa_id and auc.auc_level = ar.sr_attack_upgrade+1
where sr_enable = 1 and fid=$fid&quot; )
or die(&quot;Query failed : &quot; . mysql_error());

while ($row = mysql_fetch_array( $res )) {
$atype = $row[&quot;sa_id&quot;]; // какой тип войска
echo '&lt;tr&gt;&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;'.$row[&quot;sa_image&quot;].'&quot;&gt;&lt;a href=&quot;#&quot;&gt;'.$row[&quot;sa_name&quot;].'&lt;/a&gt; Уровень атаки('.$row[sr_attack_upgrade].')&lt;br&gt;';
echo '&lt;img src=&quot;img/res/grain.png&quot;&gt;'.$row[&quot;auc_grain&quot;].' &lt;img src=&quot;img/res/ore.png&quot;&gt;'.$row[&quot;auc_ore&quot;].' &lt;img src=&quot;img/res/wood.png&quot;&gt;'
.$row[&quot;auc_wood&quot;].' &lt;img src=&quot;img/res/clay.png&quot;&gt;'.$row[&quot;auc_clay&quot;].' &lt;img src=&quot;img/res/time.png&quot;&gt; '.$row[&quot;auc_time_upgrade&quot;].'&lt;/td&gt;'; 
echo '&lt;td class=&quot;armyinfo&quot;&gt;'; 
if( !any_upgrade( $fid, $btype ) ){
if( allow_upgrade( $fid, $atype ) ){
echo '&lt;a href=&quot;#&quot; onClick=&quot;do_upgrade('.$atype.','.$btype.')&quot;&gt;Улучшить&lt;/a&gt;';
} else {
echo '&lt;font color=&quot;#CCCCCC&quot;&gt;Не хватает сырья&lt;/font&gt;';
}
} else echo '&lt;font color=&quot;#CCCCCC&quot;&gt;Проводится совершенствование&lt;/font&gt;';
echo '&lt;/td&gt;';
echo '&lt;/tr&gt;';
}
echo '&lt;/table&gt;';
echo '&lt;br&gt;';
show_upgrade_progess( $fid, $btype );
?&gt;

</pre>
			Фрагмент 6.4.5<p>Не правда ли очень похоже на содержимое шаблона для 
			академии. Но заметьте, мы уже <span lang="en-us">в</span> запросе 
			(строки 11-17)<span lang="en-us"> </span>используем условие (sr_enable 
			= 1)<span lang="en-us">,</span> чтоб можно было улучшать только те 
			войска которые нам доступны. Для остальных - вперед, сперва 
			исследуйте в Академии!<span lang="en-us"><br>
			</span>Результат работы скрипта из шаблона <b>tpl_g12.php</b><span lang="en-us"> 
			В</span>ы можете увидеть на рисунке 6.4.2.<span lang="en-us"><br>
			<br>
			<img border="0" src="pics/co.png" width="516" height="372"><br>
			</span>Рисунок 6.4.2<span lang="en-us"><br>
			<br>
			</span>Что<span lang="en-us"> </span>же будет если нажать на кнопку 
			&quot;Улучшить&quot;<span lang="en-us">.</span> Как Вы видите, 
			срабатывает <span lang="en-us">JavaScript
			</span>функция <font color="#3B84D0">do_upgrade</font>, аргументами 
			которой являются тип войска для улучшения и тип здания (чтоб не 
			путать кузницу доспехов с кузницей оружия)<span lang="en-us">.</span> 
			Вот как выглядит эта функция:<br>
            </p>
<pre class="brush: js;">// Инициировать улучшение в кузнице
function do_upgrade( atype, btype ){
 url=window.location.href;
 if(url.indexOf('?')!=-1){
  newurl = url.split('?')
  params = newurl[1];
 }
location.href=&quot;build.php?&quot;+params+&quot;&amp;upgrade=&quot;+atype+&quot;&amp;bt=&quot;+btype; 
}
</pre>Фрагмент 6.<span lang="en-us">4</span>.6<br>
			<br>
			А собственно улучшениями, снова займется скрипт <b>build.php</b>, ну 
			по крайней мере туда передается управление.<span lang="en-us">
			</span>А он, в свою очередь принимает эти данные следующим образом:<pre class="brush: php;">
// задали улучшение в кузнице 
if( ( isset( $_GET[&quot;upgrade&quot;] )) &amp;&amp; (isset( $_GET[&quot;bt&quot;]) ) ){
 if( !any_upgrade( $fid, $_GET[&quot;bt&quot;]) ) {
   begin_upgrade( $fid, $_GET[&quot;upgrade&quot;], $_GET[&quot;bt&quot;] );
 }
}
</pre>
			Фрагмент 6.4.7<p>Конечно, же не составляет сложности догадаться что<span lang="en-us">
			</span>улучшениями займется функция <font color="#3B84D0">begin_upgrade</font>, в которую 
			передаются аргументы: идентификатор поселка, тип войска для 
			улучшения и тип здания (какая из кузниц и соответственно что 
			улучшаем оружие или доспехи?) Приведем, содержащийся в ней код:</p><pre class="brush: php;">
// добавляем в очередь улучшений войск
function begin_upgrade( $fid, $atype, $btype ){
// израсходуем положенные ресурсы
$query = &quot;SELECT auc_grain, 
auc_ore, 
auc_wood, 
auc_clay,
auc_time_upgrade
from army_upgrade_cost
where sa_id=$atype&quot;;
$res = mysql_query( $query ) or die(&quot;Query failed 1: &quot; .mysql_error());

$row = mysql_fetch_array( $res );
$auc_grain = $row[&quot;auc_grain&quot;];
$auc_ore = $row[&quot;auc_ore&quot;];
$auc_wood = $row[&quot;auc_wood&quot;];
$auc_clay = $row[&quot;auc_clay&quot;];
$auc_time_upgrade = $row[&quot;auc_time_upgrade&quot;];

$query = &quot;update fields set f_grain=f_grain-$auc_grain,
f_ore=f_ore-$auc_ore, 
f_wood=f_wood-$auc_wood,
f_clay=f_clay-$auc_clay where fid=$fid&quot;;
$result = mysql_query($query) or die(&quot;Query failed : &quot; . mysql_error());

$start_time = time();
$end_time = $start_time+h2s( $auc_time_upgrade );
// поместим в очередь тренировки воинов
$query = &quot;insert into job_upgrade_army(sa_id,fid,jua_start_time,jua_end_time,jua_type) 
values($atype,$fid,$start_time,$end_time,$btype)&quot;;
$result = mysql_query($query) or die(&quot;Query failed : &quot; . mysql_error());
}

</pre>Фрагмент 6.4.8<br>
			<br>
			В этой функции мы определяем затраты на улучшения и вычитаем их из 
			наших имеющихся ресурсов (из таблицы <b>fields</b> ) и рассчитав 
			время улучшения, засовываем все данные в таблицу job_upgrade_army 
			(не забывайте про $btype (тип здания),&nbsp; так как от него 
			зависит, что мы улучшаем доспехи или оружие)<br>
			<br>
			Функции показа хода улучшения войска <font color="#3B84D0">
			show_upgrade_progess</font> и проверки завершения этого апгрейда
			<font color="#3B84D0">check_end_army_upgrade</font>, Вы можете 
			рассмотреть сами, так как они практически ничем не отличаются от 
			подобных функций для апгрейдов зданий и ресурсных полей.<p>
<br><span lang="en-us"><font color="#4775A5"><b>6</b></font></span><font color="#4775A5"><b>.5. 
			Пункт сбора </b></font> <br>
            <br>
            &nbsp;&nbsp; Очень важной постройкой в поселке игрока является Пункт 
			Сбора. Это место сосредоточения всех готовых к атаке или обороне 
			войск, содержащихся в поселке. Выглядят картинки этого объекта так:<br>
			<img border="0" src="www/img/vill/g16e.gif" width="68" height="120"><img border="0" src="www/img/vill/g16b.gif" width="68" height="120"><img border="0" src="www/img/vill/g16.gif" width="68" height="120"><br>
			<br>
			Вы не ошиблись тут находятся именно 3 картинки, а не две, как было 
			присуще всем остальным нашим постройкам. Все дело в том, что пункт 
			сбора строится не на любой стройплощадке, а в специально отведенном 
			месте поселке. Первая из трех картинок как раз отображает это место. 
			Вторая картинка - это строящийся пункт сбора и третья картинка - уже 
			построенный и готовый к использованию пункт сбора.<br>
			Таким образом у нас будет как бы два объекта - пункт сбора и место 
			под&nbsp; него.<br>
            </p>
<pre class="brush: sql;">/*пункт сбора*/
insert into building_types (bt_id,bt_name,bt_image,bt_image_not_ready,bt_description,bt_ycoord_dif,bt_template) 
values (99,'Место под пункт сбора','img/vill/g16e.gif','img/vill/g16e.gif','',0,'tpl_g16e.php'); 
insert into building_types (bt_id,bt_name,bt_image,bt_image_not_ready,bt_description,bt_ycoord_dif,bt_template) 
values (10,'Пункт сбора','img/vill/g16.gif','img/vill/g16b.gif','',0,'tpl_g16.php'); 
</pre>Фрагмент 6.5.1<br>
			<br>
			И в <span lang="en-us">SQL </span>функции <font color="#3B84D0">
			makebuildplaces</font> у нас место под пункт сбора будет вынесен в 
			отдельную строку:<br>
<pre class="brush: sql;">/* отдельно площадка для пункта сбора */
insert into `buildings` (bnum,bt_id,b_xcoord,b_ycoord,b_level,fid) VALUES (21,99,326,162,0,p_fid);
</pre>Фрагмент 6.5.<span lang="en-us">2</span><p>Рассмотрим шаблон <b>
			tpl_g16e.php</b> для места под пункт сбора:</p>
			<pre class="brush: php;">
 // Место под пункт сбора

$res = mysql_query(&quot;SELECT bt.bt_id,bt.bt_name,bt.bt_image,bt_description,
blc_grain, blc_ore, blc_wood, blc_clay, blc_cons, blc_time_upgrade
FROM building_types bt
inner join build_levels_cost blc on blc.bt_id = bt.bt_id
WHERE blc_level = 1 and bt.bt_id = 10&quot;, $link )
or die(&quot;Query failed : &quot; . mysql_error());

$row = mysql_fetch_array( $res );

$btype = $row[&quot;bt_id&quot;]; // какой тип здания?
$bt_name = $row[&quot;bt_name&quot;];
$bt_image = $row[&quot;bt_image&quot;];
$bt_description = $row[&quot;bt_description&quot;];
$a_grain = $row[&quot;blc_grain&quot;];
$a_ore = $row[&quot;blc_ore&quot;];
$a_wood = $row[&quot;blc_gwood&quot;];
$a_clay = $row[&quot;blc_clay&quot;];
$a_cons = $row[&quot;blc_cons&quot;];
$a_time_up = $row[&quot;blc_time_upgrade&quot;];

echo '&lt;br&gt;&lt;img src=&quot;../'.$bt_image.'&quot; align=&quot;right&quot;&gt;'; 
echo &quot;&lt;span class='res_header'&gt;&quot;.$bt_name.&quot; &lt;/span&gt;&lt;br&gt;&lt;br&gt;&quot;;
echo $bt_description.&quot;&lt;br&gt;&lt;br&gt;&quot;;

echo '&lt;img src=&quot;img/res/grain.png&quot;&gt;'.$a_grain.' | &lt;img src=&quot;img/res/ore.png&quot;&gt;'.$a_ore.' | &lt;img src=&quot;img/res/wood.png&quot;&gt;'.$a_wood.' |
 &lt;img src=&quot;img/res/clay.png&quot;&gt;'.$a_clay.' | &lt;img src=&quot;img/res/cons.png&quot;&gt;'.$a_cons.' | &lt;img src=&quot;img/res/time.png&quot;&gt; '.$a_time_up.'&lt;br&gt;';
if( !build_upgrade_in_progress( $fid ) )
echo '&lt;a class=&quot;build&quot; href=&quot;village.php?bnum='.$bnum.'&amp;bt='.$btype.'&quot;&gt;Построить здание &lt;/a&gt;&lt;br&gt;&lt;br&gt;'; 
else echo '&lt;font color=&quot;#CCCCCC&quot;&gt;Строители заняты&lt;/font&gt;'; 
</pre>
			Фрагмент 6.5.3<p>В запросе к таблицам <b>building_types</b> и <b>
			build_levels_cost</b> (строки 3-8) мы узнаем ресурсы и затраты 
			времени, которые нужны для постройки пункта сбора войск, чтоб 
			вывести эту информацию на страничку в браузер для игрока, а также 
			формируем ссылку, нажав на которую игрок приступил бы к 
			строительству данного здания 29 по<span lang="en-us">c</span>ле проверки<span lang="en-us">
			</span>отсутствия какого-нибудь другого задания в очереди построек 
			при помощи функции <font color="#3B84D0">build_upgrade_in_progress</font>. 
			Не забудьте проверить - достаточно ли ресурсов для этой операции 
			самостоятельно!<br>
			На этом мы говорим Вам - до свидания, до следующей нашей лекции! А 
			все файлы, которые мы создали или поменяли в течении сегодняшнего 
			занятия Вы можете обнаружить <a href="www">здесь</a>. Скрипт 
			актуальной базы <span lang="en-us">travgame </span>из этого урока 
			находится <a href="sql">здесь</a>.<br>
			<b><br>
			В следующем уроке</b> мы <span lang="ru">с Вами займемся 
			возведением еще нескольких типов зданий - тайника, таверны, 
			резиденции, а также разработаем механизм очередности строительства, 
			зависящей от уровня и присутствия в поселке родительских объектов.</span><br>
            </p>
            <p></p>
            <p></p></font>
            </td>
            <td background="index_files/m_right_m.gif" width="9"><img height="4" src="index_files/m_right_m.gif" width="9" border="0"></td>
          </tr>
        </tbody>
      </table>
      <table cellpadding="0" cellspacing="0" width="100%">
        <tbody>
          <tr>
            <td background="index_files/m_left_m.gif" width="9"></td>
            <td class="newsbody" bgcolor="#fdfdfd">&nbsp;</td>
            <td class="newsbody" bgcolor="#fdfdfd">
            <div class="nav" align="right">Blitz-School© </div>
            </td>
            <td background="index_files/m_right_m.gif" width="9"><img height="4" src="index_files/m_right_m.gif" width="9" border="0"></td>
          </tr>
        </tbody>
      </table>
      <table cellpadding="0" cellspacing="0" height="7" width="100%">
        <tbody>
          <tr>
            <td background="index_files/m_left_b.gif" width="13"><img height="7" src="index_files/m_left_b.gif" width="13" border="0"></td>
            <td background="index_files/m_center_b.gif"><img height="1" src="index_files/spacer.gif" width="1"></td>
            <td width="13"><img height="7" src="index_files/m_right_b.gif" width="13" border="0"></td>
          </tr>
        </tbody>
      </table>
      </div>
      </td>
      <td background="index_files/right_back.gif" valign="top" width="13">&nbsp;</td>
    </tr>
  </tbody>
</table>
<table cellpadding="0" cellspacing="0" width="100%">
  <tbody>
    <tr>
      <td background="index_files/bottom_left.png" height="51" valign="top" width="254">
      <div class="date" style="MARGIN-TOP: 12px; FONT-SIZE: 10px; MARGIN-LEFT: 45px; COLOR: white"><a style="COLOR: rgb(255,255,255)" href  ="index.phtml">Copyright</a>©
2005-2009.
GameSchool</div>
      </td>
      <td background="index_files/bottom.gif" valign="top">
      <div class="date" style="MARGIN-TOP: 12px; FONT-SIZE: 10px; MARGIN-LEFT: 20px; COLOR: rgb(143,145,147)" 
      ><!-- Bottom menu --><a title="Главная страница" style="COLOR: rgb(143,145,147)" href  ="http://www.blitz-school.info/index.phtml">Главная</a><img height="1" src="index_files/spacer.gif" width="22" align="middle">:<img height="1" src="index_files/spacer.gif" width="22" align="middle"><a href="http://www.blitz-school.info/login.phtml"><span style="COLOR: rgb(143,145,147)"  >Вход</span></a><img height="1" src="index_files/spacer.gif" width="22" align="middle">:<img height="1" src="index_files/spacer.gif" width="22" align="middle"><a href="http://www.blitz-school.info/response.phtml"><span style="COLOR: rgb(143,145,147)" 
      >Отзывы</span></a><img height="1" src="index_files/spacer.gif" width="22" align="middle">:<img height="1" src="index_files/spacer.gif" width="22" align="middle"><a href="http://www.blitz-school.info/contacts.phtml"><span style="COLOR: rgb(143,145,147)" 
      >Контакты</span></a><img height="1" src="index_files/spacer.gif" width="22" align="middle">:<img height="1" src="index_files/spacer.gif" width="22" align="middle"><a href="http://www.blitz-school.info/friends.phtml"><span style="COLOR: rgb(143,145,147)" 
      >Обмен ссылками</span></a> </div>
      </td>
      <td width="19"><img height="51" src="index_files/bottom_right.png" width="19" border="0"></td>
    </tr>
  </tbody>
</table>
<div id="menu" onmouseover="showLayer('menu'); Change('products', 'menu2')" onmouseout="hiddenLayer('menu'); Change('products', 'menu1')">
<table border="0" cellpadding="0" cellspacing="0">
  <tbody>
    <tr>
      <td style="WIDTH: 7px; HEIGHT: 7px"><img height="7" alt="" src="index_files/corner1.gif" width="7"></td>
      <td class="top"></td>
      <td style="WIDTH: 7px; HEIGHT: 7px"><img height="7" alt="" src="index_files/corner2.gif" width="7"></td>
    </tr>
    <tr>
      <td class="left"></td>
      <td class="text"><a href="reg.phtml">Курс обучения созданию игр
на Blitz3D</a><br>
      <a href="reg2.phtml">Курс
обучения созданию браузерных онлайновых игр</a> </td>
      <td class="right"></td>
    </tr>
    <tr>
      <td style="BACKGROUND: 0% 50%; WIDTH: 7px; HEIGHT: 7px; -moz-background-clip: initial; -moz-background-origin: initial; -moz-background-inline-policy: initial" 
      ><img height="7" alt="" src="index_files/corner4.gif" width="7"></td>
      <td class="bottom"></td>
      <td style="WIDTH: 7px; HEIGHT: 7px"><img height="7" alt="" src="index_files/corner3.gif" width="7"></td>
    </tr>
  </tbody>
</table>
</div>

</body></html>
