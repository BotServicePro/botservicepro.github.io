<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head>
  
  <meta http-equiv="Content-Language" content="ru">
  
  <title>Центр обучения созданию компьютерных игр</title>
  <meta name="description" content="Blitz-School - Школа создателей компьютерных игр на языке Blitz3D. Если вы хотите быстро научиться делать компьютерные игры или интересуетесь их созданием, то этот сайт будет вам полезен">
  <meta name="keywords" content="программирование, создание игр, курсы создания игр, школа создателей компьютерных игр, blitzbasic, компьютерные игры, как написать игру, как создать игру, программирование компьютерных игр, Blitz3D, программирование игр, разработка игр, создание 3d игр, аудио, графика, дизайн, 3D">
  <link rel="stylesheet" type="text/css" href="main.css">
  <script language="JavaScript" src="index_files/script.js" type="text/javascript"></script>
  <script type="text/javascript" src="scripts/shCore.js"></script>
  <script type="text/javascript" src="scripts/shBrushBash.js"></script>
  <script type="text/javascript" src="scripts/shBrushCpp.js"></script>
  <script type="text/javascript" src="scripts/shBrushCSharp.js"></script>
  <script type="text/javascript" src="scripts/shBrushCss.js"></script>
  <script type="text/javascript" src="scripts/shBrushDelphi.js"></script>
  <script type="text/javascript" src="scripts/shBrushDiff.js"></script>
  <script type="text/javascript" src="scripts/shBrushGroovy.js"></script>
  <script type="text/javascript" src="scripts/shBrushJava.js"></script>
  <script type="text/javascript" src="scripts/shBrushJScript.js"></script>
  <script type="text/javascript" src="scripts/shBrushPhp.js"></script>
  <script type="text/javascript" src="scripts/shBrushPlain.js"></script>
  <script type="text/javascript" src="scripts/shBrushPython.js"></script>
  <script type="text/javascript" src="scripts/shBrushRuby.js"></script>
  <script type="text/javascript" src="scripts/shBrushScala.js"></script>
  <script type="text/javascript" src="scripts/shBrushSql.js"></script>
  <script type="text/javascript" src="scripts/shBrushVb.js"></script>
  <script type="text/javascript" src="scripts/shBrushXml.js"></script>
  <script type="text/javascript" src="scripts/shBrushBlitz3D.js"></script>
  <link type="text/css" rel="stylesheet" href="styles/shCore.css">
  <link type="text/css" rel="stylesheet" href="styles/shThemeDefault.css">
  <script type="text/javascript">
SyntaxHighlighter.config.clipboardSwf = 'scripts/clipboard.swf';
SyntaxHighlighter.all();
  </script>
  <meta content="MSHTML 6.00.6000.20772" name="GENERATOR">
	<style>
<!--
	.SYN_ROW {background:silver;}
	.SYN_TXT {border-left:1px solid;position:relative;left:4.5em;background:white;font-family:monospace;margin-right:4.5em;}
	.HTML_TXT {color:#000000;}
	.HTML_TAG {color:#0000ff;}
	.HTML_ELM {color:#800000;}
	.HTML_ATR {color:#ff0000;}
	.HTML_VAL {color:#0000ff;}
-->
</style>
</head>

<body topmargin="0" leftmargin="0" style="BACKGROUND-COLOR: rgb(255,255,255)" marginheight  ="0" marginwidth="0">
<table cellpadding="0" cellspacing="0" width="100%">
  <tbody>
    <tr>
      <td rowspan="2" height="197" width="21"><img height="197" src="index_files/ltoptable.png" width="21" border="0"></td>
      <td colspan="5" valign="top">
      <table cellpadding="0" cellspacing="0" width="100%">
        <tbody>
          <tr>
            <td height="49" width="231"><img height="49" src="index_files/topmenu.png" width="231" usemap="#ImageMap1" border="0"></td>
            <td background="index_files/mtop.gif"><map name="ImageMap1"><area onclick="this.style.behavior='url(#default#homepage)';this.setHomePage('http://www.blitz-school.info'); return false;" shape="RECT" coords="17,26,71,40" href="index.phtml"><area shape="RECT" coords="91,27,149,39" href="javascript:window.external.AddFavorite('http://www.blitz-school.info', 'GameSchool - Центр обучения созданию компьютерных игр!')"></map>
            <div class="searchform" align="right">
            <form method="post"><input value="search" name="do" type="hidden">&nbsp;</form>
            </div>
            </td>
            <td height="49" width="13"><img height="49" src="index_files/mlefttop.png" width="13" border="0"></td>
          </tr>
        </tbody>
      </table>
      </td>
    </tr>
    <tr>
      <td height="148" valign="top" width="225">
      <table cellpadding="0" cellspacing="0" height="148" width="100%">
        <tbody>
          <tr>
            <td height="119" width="225"><a title="Центр обучения созданию компьютерных игр" href="index.phtml"><img height="119" src="index_files/title.png" width="225" border="0"></a></td>
          </tr>
          <tr>
            <td background="index_files/date_b.png" valign="bottom">
            <div class="date" style="FONT-SIZE: 11px; MARGIN-BOTTOM: 10px; MARGIN-LEFT: 12px">
            <script language="JavaScript1.2">
<!-- Begin
var months=new Array(13);
months[1]="января";
months[2]="февраля";
months[3]="марта";
months[4]="апреля";
months[5]="мая";
months[6]="июня";
months[7]="июля";
months[8]="августа";
months[9]="сентября";
months[10]="октября";
months[11]="ноября";
months[12]="декабря";
var time=new Date();
var lmonth=months[time.getMonth() + 1];
var date=time.getDate();
var year=time.getYear();
var hours=time.getHours();
var minutes=time.getMinutes();
if (eval(hours) <10) {hours="0"+hours}
if (eval(minutes) < 10) {minutes="0"+minutes}
if (year < 2000)
year = year + 1900;
document.write("Сейчас: " + date + " ");
document.write(lmonth + " " + year + ", " + hours + ":" + minutes + " ");

// End -->

           </script>
            </div>
            </td>
          </tr>
        </tbody>
      </table>
      </td>
      <td width="296"><img height="148" src="index_files/mainleft.jpg" width="296" border="0"></td>
      <td width="205"><img height="148" src="index_files/mainright.jpg" width="205" border="0"></td>
      <td background="index_files/mback.png">&nbsp;</td>
      <td height="148" width="58"><img height="148" src="index_files/mltopr.png" width="58" border="0"></td>
    </tr>
  </tbody>
</table>
<table bordercolordark="black" bordercolorlight="black" cellpadding="0" cellspacing="0" width="100%">
  <tbody>
    <tr>
      <td background="index_files/anek_tb.png" height="27" valign="top" width="254">
      <div class="lefttext"><b>Меню:</b></div>
      </td><?php include 'menu_top.php'; ?> <td background="index_files/nav_back.gif">&nbsp;</td>
      <td width="17"><img height="27" src="index_files/nav_end.png" width="17" border="0"></td>
    </tr>
  </tbody>
</table>
<table cellpadding="0" cellspacing="0" width="100%">
  <tbody>
    <tr>
      <td background="index_files/lefttable.gif" valign="top" width="254"><!-- Menu -------->
      <div style="MARGIN-LEFT: 21px">
      <table cellpadding="0" cellspacing="0">
        <tbody>
          <tr>
            <td background="index_files/tb_back.gif">
            <div class="style3"><img src="index_files/home.gif"><a href="http://www.blitz-school.info/index.phtml">Главная</a><br>

        <img src="index_files/pages.gif"> <b>Перечень курсов</b><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/blitzindex.phtml">Создание 3D игр на Blitz3D</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/ogindex.phtml">Создание браузерной РПГ</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/egindex.phtml">Создание экономической браузерки</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/mgindex.phtml">Создание мобильных игр</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/cppindex.phtml">Создание 3D игр на С++</a><br>
        <img src="index_files/group.gif"> <a href="http://www.blitz-school.info/begin_study.phtml">Как стать слушателем</a><br>
        <img src="index_files/recom.gif"> <a href="http://www.blitz-school.info/study_tech.phtml">Технология обучения</a><br>
        <img src="index_files/loyalty_sm.jpg"> <a href="http://www.blitz-school.info/loyalty.phtml">Программа лояльности</a>
        <br>
&nbsp;&nbsp;&nbsp;&nbsp;
    <img border="0" src="index_files/navdiv.gif" width="80" height="4">
        <br><img src="index_files/newuser.gif"> <b>Регистрация</b><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/reg.phtml">Курс 3D игр на Blitz3D</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/reg2.phtml">Курс браузерной RPG</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/reg3.phtml">Экономическая браузерка</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/reg4.phtml">Курс мобильных игр</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/reg5.phtml">3D игры на С++</a><img src="index_files/new.gif"><br>
        <img src="index_files/admin.gif"> <a href="http://www.blitz-school.info/login.phtml">Вход для слушателей</a><br>
        <img src="index_files/study.gif"> <a href="http://www.blitz-school.info/program.phtml">Учебные программы курсов</a><br>
        <img src="index_files/society.gif"> <a href="http://www.blitz-school.info/response.phtml">Отзывы</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;
    <img border="0" src="index_files/navdiv.gif" width="80" height="4">
        
        <br><img src="index_files/media.gif"> <a href="http://www.blitz-school.info/distant.phtml">О дистанционном образовании</a><br>
        <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/articles.phtml">Статьи</a><br>
        <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/less_ex.phtml">Изложение материала</a><br>
        <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/gallery.phtml">Галерея</a><br> 
        <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/links.phtml">Полезные ссылки</a><br>
        <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/contacts.phtml">Контакты</a><br>
       <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/friends.phtml">Обмен ссылками</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;

            </div>
            </td>
          </tr>
          <tr>
            <td width="222"><img height="8" src="index_files/tb_b.gif" width="222" border="0"></td>
          </tr>
        </tbody>
      </table>
      </div><!-- ------------------ end of menu ------------------- --> </td>
      <td class="news" valign="top">
      <script language="javascript" type="text/javascript">
      </script>
      <div style="MARGIN-TOP: 7px">
      <table cellpadding="0" cellspacing="0" width="100%">
        <tbody>
          <tr>
            <td width="13"><img height="24" src="index_files/m_left.gif" width="13" border="0"></td>
            <td class="newstitle" background="index_files/m_center.gif">
            <b>Занятие
<span lang="en-us">8</span></b></td>
            <td class="newstitle" align="right" background="index_files/m_center.gif">&nbsp;</td>
            <td width="9"><img height="24" src="index_files/m_right.gif" width="9" border="0"></td>
          </tr>
        </tbody>
      </table>
      <table cellpadding="0" cellspacing="0" width="100%">
        <tbody>
          <tr>
            <td background="index_files/m_left_m.gif" width="4">&nbsp;</td>
            <td class="newsbody" bgcolor="#fdfdfd">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <font size="3"><b>Торговля ресурсами<br>
			</b></font>
            <br>
            <font color="#4775A5"><b>8</b></font><b><font color="#4775a5">.1. 
			Количество торговцев</font><br>
            <br>
&nbsp;</b><span lang="en-us">&nbsp;</span>Добрый день, уважаемый коллега! На 
			сегодняшнем занятии мы продолжим тему Рынка, здание которого мы 
			научились строить в нашем поселке. Сегодня мы рассмотрим все 
			возможные торговые операции и мероприятия, связанные с 
			перераспределением имеющихся ресурсов. Напомним, что рынок в нашей 
			игре имеет картинку:<br>
			<br>
			<img border="0" src="www/img/vill/g17.gif" width="75" height="60"><br>
			<br>
			и в учебных целях создается сразу <span lang="en-us">SQL </span>
			процедурой <font color="#3B84D0">makebuildplaces</font>, а именно 
			этой строкой в ней:<br>
<pre class="brush: sql;">insert into `buildings` (bnum,bt_id,b_xcoord,b_ycoord,b_level,fid) VALUES (4,12,345,94,1,p_fid);;
</pre>Фрагмент 8.1.1<br>
			<br>
			Вы помните, что bt_id=12 - это тип постройки - рынок (из таблицы <b>
			building_types</b>).<br>
			Как Вы понимаете, чтоб осуществлять торговые операции, нам 
			понадобятся торговцы, которые будет перемещаться между поселками&nbsp; 
			и носить ресурсы в своих котомках, а может быть это будут телеги 
			запряженные лошадьми? В общем, не важно каким способом они будут 
			доставлять товар, главное, договоримся об их грузоподъемности. 
			Давайте предположим, что один торговец может переносить 500 единиц 
			какого-либо ресурса одного типа. Сколько же у нас будет торговцев? 
			Можно поступить следующим образом - количество торговцев будет равно 
			уровню здания Рынок. К примеру у нас Рынок второго уровня, значит 
			количество торговцев у нас - два и одновременно они смогут доставит 
			в какой-нибудь поселок 1000 единиц ресурса.<br>
			Давайте сделаем простую функцию, которая будет выдавать нам 
			количество торговцев, которым мы располагаем. Назовем эту функцию -
			<font color="#3B84D0">num_traders</font>. 


<pre class="brush: php;">
// узнаем сколько у нас торговцев (кол-во торговцев = уровню рынка)?
function num_traders( $fid ){
$btype = 12; // Идентификатор рынка из таблицы building_types
$res = mysql_query(&quot;SELECT b_level from buildings where fid=$fid and bt_id=$btype&quot; ) 
or die(&quot;Query failed : &quot; . mysql_error());
$row = mysql_fetch_array( $res );
return ( $row[&quot;b_level&quot;] );
} 
</pre>
			Фрагмент 8.1.<span lang="en-us">2</span><p>Тут все просто - по типу 
			здания (12 для рынка) и идентификатору поселка мы узнаем уровень 
			Рынка в этом поселке игрока b_level в таблице <b>buildings</b> и 
			возвращаем это значение, так как уровень Рынка = количеству 
			торговцев.<br>
			И сейчас нам нужно научиться пользоваться услугами наших торговцев 
			на примере отправки какого-нибудь ресурса в соседний поселок.<br>
			<font color="#4775A5"><b><span lang="en-us"><br>
			<br>
			</span>8</b></font><b><font color="#4775a5">.2. 
			</font></b><font color="#4775A5"><b>Отправка ресурсов<br>
			<br>
			</b></font>&nbsp;&nbsp; Вы помните, что у нас в нашей тестовой 
			учебной игре существует пока что два игрока - <span lang="en-us"><b>
			<font color="#3B84D0">test</font></b> </span>и <b>
			<font color="#3B84D0">Суперигрок</font></b>. Поселки их находятся не 
			так далеко друг от друга и мы вполне можем поэкспериментировать с 
			перемещениями ресурсов между ними. Но перед этим договоримся, что 
			скорость наших торговцев будет составлять, ну, к примеру - <b>10</b> 
			полей в час. Чтоб рассчитать время, которое понадобится торговцам&nbsp; 
			для путешествия из поселка в поселок, нам понадобится вычислить 
			расстояние между ними, по координатам их размещения на глобальной 
			карте (таблица <b><span lang="en-us">fields</span></b>)<span lang="en-us">.
			</span>Вспомнив школьный курс геометрии ил покопавшись в
			<span lang="en-us">google</span>, мы решили воспользоваться формулой 
			длины отрезка:<br>
			Длина отрезка = корень квадратный из квадратов разности координат 
			вершин отрезка, то есть что-то типа этого:&nbsp;&nbsp; sqrt(&nbsp; (x<sub>1</sub>-x<sub>2</sub>)<sup>2</sup>+(y<sub>1</sub>-y<sub>2</sub>)<sup>2
			</sup>)<br>
			<br>
			Давайте напишем функцию, которую назовем <font color="#3B84D0">
			distance_btw_villages</font> и она нам как раз и будет вычислять это 
			расстояние:</p>


<pre class="brush: php;">
// расстояние между поселками
function distance_btw_villages( $fid, $dest_x, $dest_y ){

$res = mysql_query(&quot;SELECT xcoord, ycoord from fields where fid=$fid&quot; ) 
or die(&quot;Query failed : &quot; . mysql_error());
$row = mysql_fetch_array( $res );
$x_s = $row[&quot;xcoord&quot;];
$y_s = $row[&quot;ycoord&quot;];

$distance = sqrt( pow(($x_s-$dest_x),2)+pow(($y_s-$dest_y),2) );
return( $distance );
}
</pre>
			Фрагмент 8.2.<span lang="en-us">1</span><p>Мы будем передавать в эту 
			функцию координаты поселка назначения ( $dest_x, $dest_y) и 
			идентификатор поселка из которого производится отправка
			<span lang="en-us">$</span>fid.<span lang="en-us"> </span>По этому 
			идентификатору <span lang="en-us">SQL</span> запрос найдет и 
			координаты поселка отправки, а располагая всеми четырьмя 
			координатами, мы может определить все расстояние <span lang="en-us">
			$</span>distance<span lang="en-us">.<br>
			<br>
			</span>Теперь давайте немного модифицируем шаблон <b>
			<span lang="en-us">tpl_g17.php</span></b>, который теперь будет 
			давать возможность отправлять ресурсы (нужно будет ввести сколько 
			ресурсов) в указанный поселок (нужно будет ввести его координаты, 
			посмотрев из на глобальной карте)<br>
			Но чтоб отправить торговца в путь, нам понадобится таблица в которой 
			мы будем хранить информацию о его начальной и конечной точке 
			перемещения, времени доставки и т.д. По сути - это та же очередь 
			каких-то действий (мы уже делали подобные на предыдущих занятиях)<br>
			Назовем таблицу, которая будет хранить информацию о перемещении 
			торговцев <b>job_traders_move</b>. Вот эта таблица:<br>
			</p>
<pre class="brush: sql;">/* таблица очереди движения торговцев */
CREATE TABLE `job_traders_move` (
jtm_id bigint(20) unsigned NOT NULL auto_increment, /*ID*/
fid bigint(20), /*откуда? и принадлежность поселку*/
fid_to bigint(20), /*куда?*/ 
jtm_start_time bigint DEFAULT 0, /*начало движения*/ 
jtm_end_time1 bigint DEFAULT 0, /*время достижения пункта назначения*/ 
jtm_end_time2 bigint DEFAULT 0, /*время возврата в свой поселок*/ 
jtm_direction int default 1, /* 1-с грузом, 2-пустые назад*/
jtm_hash char(50),
jtm_wood INT DEFAULT 0, /* ресурсы, переносимые торговцами */
jtm_clay INT DEFAULT 0,
jtm_ore INT DEFAULT 0, 
jtm_grain INT DEFAULT 0,
jtm_traders_num int, /* сколько торговцев задействовано */
PRIMARY KEY (`jtm_id`) 
) ENGINE=MyISAM DEFAULT CHARSET=cp1251;
</pre>Фрагмент <span lang="en-us">8</span>.2.2<p><b>jtm_id</b> - уникальный 
			идентификатор в таблице job_traders_move.<br>
			<b>fid</b> - идентификатор поселка, из которого отправились торговцы<br>
			<b>fid_to</b> - идентификатор поселка, куда отправились торговцы<br>
			<b>jtm_start_time</b> - время начала движения <br>
			<b>jtm_end_time1</b> - время доставки ресурсов <br>
			<b>jtm_end_time2</b> - время возвращения обратно в свой поселок <br>
			<b>jtm_direction</b> - направление движения (1-туда, 2-обратно) <br>
			<b>jtm_hash</b> - некая служебная информация <br>
			<b>jtm_wood</b> - сколько несут древесины <br>
			<b>jtm_clay</b> - сколько несут глины <br>
			<b>jtm_ore</b> - сколько несут руды <br>
			<b>jtm_grain</b> - сколько несут зерна <br>
			<b>jtm_traders_num</b> - количество задействованных торговцев в 
			доставке<br>
			<br>
			<br>
			Что ж, пора отправлять торговцев в путь:<br>
			<br>
			<img border="0" src="pics/fld.png" width="594" height="329">
			<br>
			<br>
			Рисунок 8.2.1<br>
			<br>
			Шаблон отправки <b>
			<span lang="en-us">tpl_g17.php</span> </b>мы переделаем так:</p>


<pre class="brush: php;">
// Рынок
echo &quot;&lt;div id='textmenu'&gt;
&lt;a href='build.php?bnum=$bnum' class='selected '&gt;Отправить&lt;/a&gt;
| &lt;a href='build.php?bnum=$bnum&amp;amp;p=2'&gt;Покупка&lt;/a&gt;
| &lt;a href='build.php?bnum=$bnum&amp;amp;p=3'&gt;Продажа&lt;/a&gt;
| &lt;a href='build.php?bnum=$bnum&amp;amp;p=4'&gt;NPC-торговец&lt;/a&gt;
&lt;/div&gt;&quot;;

echo '&lt;form name=&quot;sending&quot; method=&quot;POST&quot; action=&quot;build.php?'.$_SERVER[&quot;QUERY_STRING&quot;].'&quot;&gt;
&lt;table style=&quot;border-collapse: collapse;&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; id=&quot;army&quot;&gt;&lt;tr&gt;

&lt;td class=&quot;resinfo&quot;&gt;&lt;img src=&quot;img/res/wood.png&quot;&gt; Древесина: &lt;/td&gt;
&lt;td class=&quot;resinfo&quot;&gt;&lt;input type=&quot;text&quot; size=5 class=&quot;text&quot; id=&quot;r1&quot; name=&quot;r1&quot; value=&quot;0&quot; maxlength=&quot;4&quot; onKeyUp=&quot;upd_res(1)&quot; &gt;&lt;/td&gt;
&lt;td class=&quot;resinfo&quot;&gt;&lt;a href=&quot;#&quot; onClick=&quot;set_res_qty(1,500)&quot;&gt;(500)&lt;/a&gt;&lt;/td&gt;
&lt;td class=&quot;resinfo&quot;&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td class=&quot;resinfo&quot;&gt;&lt;img src=&quot;img/res/clay.png&quot;&gt; Глина: &lt;/td&gt;
&lt;td class=&quot;resinfo&quot;&gt;&lt;input type=&quot;text&quot; size=5 class=&quot;text&quot; id=&quot;r2&quot; name=&quot;r2&quot; value=&quot;0&quot; maxlength=&quot;4&quot; onKeyUp=&quot;upd_res(2)&quot; &gt;&lt;/td&gt;
&lt;td class=&quot;resinfo&quot;&gt;&lt;a href=&quot;#&quot; onClick=&quot;set_res_qty(2,500)&quot;&gt;(500)&lt;/a&gt;&lt;/td&gt;
&lt;td class=&quot;resinfo&quot;&gt;Координаты отправки:&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td class=&quot;resinfo&quot;&gt;&lt;img src=&quot;img/res/ore.png&quot;&gt; Железо: &lt;/td&gt;
&lt;td class=&quot;resinfo&quot;&gt;&lt;input type=&quot;text&quot; size=5 class=&quot;text&quot; id=&quot;r3&quot; name=&quot;r3&quot; value=&quot;0&quot; maxlength=&quot;4&quot; onKeyUp=&quot;upd_res(3)&quot; &gt;&lt;/td&gt;
&lt;td class=&quot;resinfo&quot;&gt;&lt;a href=&quot;#&quot; onClick=&quot;set_res_qty(3,500)&quot;&gt;(500)&lt;/a&gt;&lt;/td&gt;
&lt;td class=&quot;resinfo&quot;&gt;
X:&lt;input type=&quot;text&quot; size=5 class=&quot;text&quot; id=&quot;x&quot; name=&quot;x&quot; value=&quot;0&quot; maxlength=&quot;4&quot;&gt;&amp;nbsp; 
Y:&lt;input type=&quot;text&quot; size=5 class=&quot;text&quot; id=&quot;y&quot; name=&quot;y&quot; value=&quot;0&quot; maxlength=&quot;4&quot;&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;
&lt;td class=&quot;resinfo&quot;&gt;&lt;img src=&quot;img/res/grain.png&quot;&gt; Зерно: &lt;/td&gt;
&lt;td class=&quot;resinfo&quot;&gt;&lt;input type=&quot;text&quot; size=5 class=&quot;text&quot; id=&quot;r4&quot; name=&quot;r4&quot; value=&quot;0&quot; maxlength=&quot;4&quot; onKeyUp=&quot;upd_res(4)&quot; &gt;&lt;/td&gt;
&lt;td class=&quot;resinfo&quot;&gt;&lt;a href=&quot;#&quot; onClick=&quot;set_res_qty(4,500)&quot;&gt;(500)&lt;/a&gt;&lt;/td&gt;
&lt;td class=&quot;resinfo&quot;&gt;&lt;/td&gt;
&lt;/tr&gt;';
echo '&lt;/table&gt;';
echo '&lt;br&gt;&lt;img src=&quot;img/vill/ok.png&quot; onclick=&quot;init_send()&quot; style=&quot;cursor:hand&quot;&gt;&lt;/br&gt;
&lt;input type=&quot;hidden&quot; name=&quot;send&quot;&gt;
&lt;input type=&quot;hidden&quot; name=&quot;hash&quot; value=&quot;'.md5(mktime()).'&quot; &gt;
&lt;/form&gt;';

echo '&lt;br&gt;Каждый Ваш торговец может переносить до 500 единиц сырья.&lt;br&gt;';
echo 'Сейчас у Вас есть: &lt;b&gt;'.traders_ready($fid).'/'.num_traders($fid).'&lt;/b&gt; торговцев. &lt;br&gt;&lt;br&gt;';

update_traders_moving( $fid );
show_traders_moving( $fid );
</pre>Фрагмент 8.2.<span lang="en-us">3</span><p>Из вышеприведенного фрагмента 
			видно, что сразу после меню (строки 2-7) мы создаем форму и таблицу 
			для ввода необходимых для отправки торговцев данных. Тут есть и поля 
			ввода количества ресурсов каждого типа с идентификаторами (<span lang="en-us">r1,r2,r3,r4</span>)<span lang="en-us">
			</span>и поля для ввода координат поселка, куда мы хотим отправить 
			груз с идентификаторами (<span lang="en-us">x,y</span>)<span lang="en-us">
			</span>и непосредственно кнопка отправки
			<img border="0" src="www/img/vill/ok.png" width="48" height="21">. 
			Здесь есть и <span lang="en-us">JavaScript </span>функции для 
			проверки вводимого количества ресурсов - <font color="#3B84D0">
			upd_res</font> и их отправки - <font color="#3B84D0">init_send</font>. 
			Кроме того в этом фрагменте есть механизм от повторных отправок 
			(вдруг игрок отправит торговцев, а потом еще раз сделает
			<span lang="en-us">Refresh </span>страницы). Этот механизм 
			начинается здесь, в форме заполнением невидимого поля с именем
			<span lang="en-us">hash</span><br>
			<span lang="en-us">(</span>строка<span lang="en-us"> 38)</span> 
			специальным уникальной хэш-строкой, которая запишется в таблицу <b>job_traders_move</b>.<br>
			Вот как выглядит эта форма в окне браузера:<br>
			<br>
			<img border="0" src="pics/otpr.png" width="542" height="485"><br>
			<br>
			Рисунок 8.2.2<br>
			<br>
			При щелчке на количестве ресурсов (500) - это количество переносится 
			в поле соответствующего типа ресурса. Также количество можно вручную 
			вносить в это поле. <span lang="en-us">JavaScript </span>функция
			<font color="#3B84D0">upd_res</font>&nbsp; следит, чтоб это 
			количество было не больше имеющегося в наличии количества этого типа 
			ресурсов при ручном вводе. А функция&nbsp; <font color="#3B84D0">set_res_qty</font> 
			занимается тем же самом при клике на (500). Вот как выглядят эта 
			функции:<br>
            </p>
<pre class="brush: js;">// проверка при добавлении по 500 ресурсов
function set_res_qty( elem, qty ){
resvalue = parseInt( document.getElementById(&quot;r&quot;+elem).value );
maxvalue = document.getElementById(&quot;dr&quot;+elem).innerHTML;

if ( (resvalue+qty) &lt;= maxvalue ) 
document.getElementById(&quot;r&quot;+elem).value = resvalue+qty;
else 
document.getElementById(&quot;r&quot;+elem).value = maxvalue;
}


// проверка при вводе вручную кол-ва ресурсов
function upd_res( elem ){
resvalue = parseInt( document.getElementById(&quot;r&quot;+elem).value );
maxvalue = document.getElementById(&quot;dr&quot;+elem).innerHTML;
if (resvalue &gt; maxvalue) document.getElementById(&quot;r&quot;+elem).value = 
document.getElementById(&quot;dr&quot;+elem).innerHTML;
}

</pre>Фрагмент 8.<span lang="en-us">2</span>.4<p>Вы видите, что обе функции 
			сравнивают вводимые тем или иным способом данные о количестве 
			ресурсов с имеющимися в наличии. Для древесины это количество 
			хранится на странице в элементе <span class="HTML_TXT">
			<span class="HTML_TAG">&lt;<span class="HTML_ELM">span</span>
			<span class="HTML_ATR">id</span>=<span class="HTML_VAL">&quot;dr1&quot;</span>&gt;&lt;/<span class="HTML_ELM">span</span>&gt;</span>,
			<font color="#666666">для глины </font>- <span class="HTML_TAG">&lt;<span class="HTML_ELM">span</span>
			<span class="HTML_ATR">id</span>=<span class="HTML_VAL">&quot;dr2&quot;</span>&gt;</span>140<span class="HTML_TAG">&lt;/<span class="HTML_ELM">span</span>&gt;</span>
			</span>&nbsp;вот отсюда и берутся эти данные для сравнения с 
			вводимым. При вводе недопустимого числа, оно тут же меняется на 
			максимальное значение для этого ресурса.<br>
			<br>
			После заполнения необходимых полей ресурсов, выбора координат 
			поселка, куда будут отправлены ресурсы (для поселка персонажа
			<font color="#3B84D0"><b>Суперигрок</b></font> это будут
			<span lang="en-us">X=7 Y=5</span>,<span lang="en-us"> </span>
			смотрите рисунок 8.2.1) и нажатия кнопки
			<img border="0" src="www/img/vill/ok.png" width="48" height="21"> с 
			именем <span lang="en-us"><b><font color="#339966">send</font></b>
			</span>сработает <span lang="en-us">JavaScript </span>функция <font color="#3B84D0">init_send</font>, 
			которая выглядит так:<br>
            </p>
<pre class="brush: js;">function init_send(){
sending.submit();
}
</pre>Фрагмент 8.<span lang="en-us">2</span>.5<p>То есть она только и делает, 
			что отправляет данные введенные в форму с именем <b>
			<font color="#339966">sending</font></b> в файл <b>build.php</b>. 
			Что же происходит там, в этом файле. Мы предусмотрительно в этом 
			занятии добавили в него пару строк, чтоб обработать эту ситуацию:</p>


<pre class="brush: php;">
// задали отправку ресурсов в другой поселок
if( isset( $_POST[&quot;send&quot;] ) ){
 $p_wood = $_POST[&quot;r1&quot;];
 $p_clay = $_POST[&quot;r2&quot;];
 $p_ore = $_POST[&quot;r3&quot;];
 $p_grain = $_POST[&quot;r4&quot;];
 $p_x = $_POST[&quot;x&quot;];
 $p_y = $_POST[&quot;y&quot;];
 $hash = $_POST[&quot;hash&quot;];
 init_send_res( $fid, $p_wood, $p_clay, $p_ore, $p_grain, $p_x, $p_y, $hash );
}

</pre>
			Фрагмент 8.2.<span lang="en-us">6</span><p>Тут считываются данные, 
			переданные формой и передаются в <span lang="en-us">PHP </span>
			функцию <font color="#3B84D0">init_send_res</font>, которую мы 
			должны сейчас сделать:</p>


<pre class="brush: php;">
// засовываем торговцев в очередь с разными проверками
function init_send_res( $fid, $p_wood, $p_clay, $p_ore, $p_grain, $p_x, $p_y, $hash ){
if( !is_trade_hash( $fid, $hash ) ){
 $max_traders_capacity = num_traders( $fid )*500;
 $max_res = $p_wood+$p_clay+$p_ore+$p_grain;
 $traders_needed = ceil( $max_res/500 );
 if( $max_traders_capacity &gt;= $max_res ){
   // проверим существование поселка, куда отправляются торговцы!
   $res = mysql_query(&quot;SELECT fid, usr_id, fid_name from fields where xcoord=$p_x and ycoord=$p_y and usr_id&lt;&gt;0&quot; ) 
   or die(&quot;Query failed : &quot; . mysql_error());
   if (mysql_num_rows( $res ) &gt; 0){
     $row = mysql_fetch_array( $res );
     $fid_to = $row[&quot;fid&quot;];

     $distance = distance_btw_villages( $fid, $p_x, $p_y );
     $speed = 10/3600; // 10 полей в час
     $sec = floor( $distance / $speed );

     $start_time = time();
     $end_time1 = $start_time + $sec; 
     $end_time2 = $end_time1 + $sec; 

     $res = mysql_query(&quot;insert into job_traders_move(fid,fid_to,jtm_start_time,jtm_end_time1,jtm_end_time2,jtm_direction,jtm_hash,jtm_wood,
jtm_clay,jtm_ore,jtm_grain,jtm_traders_num)
     values ($fid,$fid_to,$start_time,$end_time1,$end_time2,1,'$hash',$p_wood, $p_clay, $p_ore, $p_grain, $traders_needed)&quot;) 
or die(&quot;Query failed : &quot; . mysql_error());
     // уменьшим наши ресурсы (т.к. торговцы забрали их)
     $result = mysql_query(&quot;update fields set f_wood=f_wood-$p_wood,
     f_clay=f_clay-$p_clay,
     f_ore=f_ore-$p_ore,
     f_grain=f_grain-$p_grain
     where fid = $fid&quot; ) 
     or die(&quot;Query failed : &quot; . mysql_error());
   } else echo &quot;&lt;br&gt;Поселка с такими координатами не существует!&lt;br&gt;&quot;;
 } else echo &quot;&lt;br&gt;Не хватает торговцев!&lt;br&gt;&quot;;
}
}
</pre>
			Фрагмент 8.2.<span lang="en-us">7</span><p>В строке 3 
			вышеприведенного фрагмента мы проверяем нет ли в таблице<span lang="en-us">
			</span><b>job_traders_move</b><span lang="en-us"> </span>уже такой 
			записи при помощи функции <font color="#3B84D0">is_trade_hash</font>. 
			Это проверка - на отправку одних и тех же данных из формы. 
			Рассмотрите ее самостоятельно. В строках 4-6 мы определяем 
			максимально количество торговцев и их грузоподъемность, которые 
			могут переносить этот груз и в строке 7 проверяем есть ли у нас 
			достаточное количество этих торговцев, если нет - выдаем сообщение 
			(строка 35). Если торговцев хватает - проверим существование 
			поселка, куда мы направляем торговцев по координатам, введенным в 
			форме (строки 9-10). Если такой поселок существует (<span lang="en-us"><b>usr_id</b>
			</span>в нем не равен 0, то есть это поле занято каким-то игроком) 
			то мы определяем расстояние до него, а также время доставки (строки 
			15-17). В строках 19-21 мы определяем время начала движения, время 
			доставки груза и время возвращения в свой поселок. Далее нам 
			остается вставить рассчитанные данные в таблицу <b>job_traders_move</b>. 
			Ну и в итоге уменьшим количество ресурсов в нашем поселке на ту 
			величину, которую забрали торговцы.<br>
			<br>
			Теперь нам нужно визуализировать очередь движения торговцев, чтоб 
			игрок всегда был в курсе времени доставки груза и возвращения 
			торговцев обратно в поселок. Этим займется функция
			<font color="#3B84D0">show_traders_moving</font>. Вот как она 
			выглядит:</p>


<pre class="brush: php;">
function show_traders_moving( $fid ){
$cnt = 0;
// Это наши торговцы
$result = mysql_query(&quot;SELECT f.fid_name,jtm_start_time,jtm_end_time1,jtm_end_time2, 
jtm_direction, jtm_wood,jtm_clay,jtm_ore,jtm_grain
from job_traders_move jtm
inner join fields f on f.fid = jtm.fid_to
where jtm.fid=$fid&quot; ) 
or die(&quot;Query failed : &quot; . mysql_error());
$num_rows = mysql_num_rows( $result );
if( $num_rows &gt; 0 ){

  $script = &quot;&quot;;

  while( $row = mysql_fetch_array( $result )){
    $time_s = $row[&quot;jtm_start_time&quot;];
    $time_e1 = $row[&quot;jtm_end_time1&quot;];
    $time_e2 = $row[&quot;jtm_end_time2&quot;];
    $fid_name = $row[&quot;fid_name&quot;];
    $direction = $row[&quot;jtm_direction&quot;];

    echo '&lt;table style=&quot;border-collapse: collapse;&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; id=&quot;army&quot;&gt;&lt;tr&gt;
    &lt;td class=&quot;tabhead&quot;&gt;&lt;/td&gt;
    &lt;td width=&quot;300&quot; class=&quot;tabhead&quot;&gt;'.($direction==1 ? &quot;Транспортировка в &quot;:&quot;Возвращение из &quot;).$fid_name.'&lt;/td&gt;
    &lt;td class=&quot;tabhead&quot;&gt;Прибытие&lt;/td&gt;
    &lt;/tr&gt;';

    // туда или обратно?
    $time_e = ($direction==1 ? $time_e1 : $time_e2 );

    echo '&lt;tr&gt;&lt;td class=&quot;armyinfo&quot;&gt;Прибытие&lt;/td&gt;
    &lt;td class=&quot;armyinfo&quot;&gt;&lt;span id=&quot;restimer'.$cnt.'&quot;&gt;&lt;/span&gt; &lt;/td&gt;
    &lt;td class=&quot;armyinfo&quot;&gt; '.date('H:i',$time_e).'&lt;/td&gt;&lt;/tr&gt;';
    $rest = s2h($time_e-time());
    $hms = explode(':', $rest); 
    $script .= &quot;atimers[$cnt] = [ $hms[0], $hms[1], $hms[2] ]; &quot;; 
    $cnt ++;
    echo '&lt;tr&gt;&lt;td class=&quot;armyinfo&quot;&gt;Сырье&lt;/td&gt;
    &lt;td class=&quot;armyinfo&quot;&gt;
    &lt;img src=&quot;img/res/wood.png&quot;&gt;'.$row[&quot;jtm_wood&quot;].' | 
    &lt;img src=&quot;img/res/clay.png&quot;&gt;'.$row[&quot;jtm_clay&quot;].' |
    &lt;img src=&quot;img/res/ore.png&quot;&gt;'.$row[&quot;jtm_ore&quot;].' |
    &lt;img src=&quot;img/res/grain.png&quot;&gt;'.$row[&quot;jtm_grain&quot;].'
    &lt;/td&gt;
    &lt;td class=&quot;armyinfo&quot;&gt;&lt;/td&gt;&lt;/tr&gt;';

    echo '&lt;/table&gt;';
  }
}

echo '&lt;script&gt;';
echo $script;
echo 'updateClock(); setInterval(&quot;updateClock()&quot;, 1000 );';
echo '&lt;/script&gt;';

}
</pre>
			Фрагмент 8.2.8<p>Здесь все стандартно. Мы уже не раз визуализировали 
			очереди каких-либо событий. Единственный интерес вызывает такой 
			момент - так как торговцы доставляют товар и возвращаются обратно, 
			то мы должны ориентироваться на поле jtm_direction и&nbsp; в 
			зависимости от его значения выводить надпись &quot;Транспортировка в&quot; или 
			&quot;Возвращение из&quot;. Процесс визуализации, показываемый функцией
			<font color="#3B84D0">show_traders_moving</font> после отправки 80 
			единиц глины в поселок игрока <b><font color="#3B84D0">Суперигрок</font></b> 
			примерно выглядит так:<br>
			<br>
			<br>
			<img border="0" src="pics/torg_go.png" width="532" height="564"><br>
			Рисунок 8.2.3<br>
			<br>
			Чуть позже мы расширим эту функцию и добавим сюда перемещения чужих 
			торговцев в наш поселок.<br>
			Вы видите надпись &quot;Сейчас у Вас торговцев 0/1&quot;, то есть все заняты и 
			больше мы послать никого не сможем. Количество имеющихся в наличии 
			свободных торговцев возвращает функция <font color="#3B84D0">
			traders_ready</font>.</p>


<pre class="brush: php;">
///// Сколько у нас свободно торговцев?
function traders_ready( $fid ){
// Узнаем, есть ли у нас торговцы в пути?
$total_traders = 0;
$result = mysql_query(&quot;SELECT jtm_traders_num
from job_traders_move jtm
where jtm.fid=$fid&quot; ) 
or die(&quot;Query failed : &quot; . mysql_error());
$num_rows = mysql_num_rows( $result );
if( $num_rows &gt; 0 ){
  while ($row = mysql_fetch_array( $result )) {
    $total_traders += $row[&quot;jtm_traders_num&quot;];
  }
  return( num_traders( $fid ) - $total_traders );
} else {
  return ( num_traders( $fid ) ); 
} 
}
</pre>
			Фрагмент 8.2.<span lang="en-us">9<br>
			<br>
			</span>Эта функция проверяет, есть ли для указанного поселка 
			какие-то очереди перемещения торговцев и если есть - находит общее 
			количество торговцев задействованных в этих операциях ( из таблицы
			<b>job_traders_move</b> ) и затем вычитает это число из имеющегося 
			числа торговцев в этом поселке.<br>
			<br>
			Последнее, что нам осталось - это определять моменты доставки товара 
			и возвращения торговцев в родной поселок. Для этого мы с Вами 
			разработаем функцию <font color="#3B84D0">update_traders_moving</font>. 
			Посмотрите как она выглядит чуть ниже:<pre class="brush: php;">
///////// проверка перемещения торговцев //////////////
function update_traders_moving( $fid ){
// что у нас в очереди перемещений торговцев? 
$res = mysql_query(&quot;SELECT jtm_id, fid_to,jtm_start_time,jtm_end_time1,jtm_end_time2, 
jtm_direction, jtm_wood,jtm_clay,jtm_ore,jtm_grain
from job_traders_move jtm
where jtm.fid=$fid&quot;)
or die(&quot;Query failed : &quot; . mysql_error());
$num_rows = mysql_num_rows( $res );
if( $num_rows &gt; 0 ){

 $cur_time = time();

 while ($row = mysql_fetch_array( $res )) {
  $jtm_id = $row[&quot;jtm_id&quot;];
  $fid_to = $row[&quot;fid_to&quot;];
  $time_s = $row[&quot;jtm_start_time&quot;];
  $time_e1 = $row[&quot;jtm_end_time1&quot;];
  $time_e2 = $row[&quot;jtm_end_time2&quot;];
  $direction = $row[&quot;jtm_direction&quot;];
  $a_wood = $row[&quot;jtm_wood&quot;];
  $a_clay = $row[&quot;jtm_clay&quot;];
  $a_ore = $row[&quot;jtm_ore&quot;];
  $a_grain = $row[&quot;jtm_grain&quot;];

  if( $time_e2 &lt;= $cur_time ){ // уже прибыли и вернулись!
    if( $direction == 1 ){ // еще не обработали прибытие
       // добавим ресов тому кому несли 
       $result = mysql_query(&quot;update fields set f_wood=f_wood+$a_wood,
       f_clay=f_clay+$a_clay,
       f_ore=f_ore+$a_ore,
       f_grain=f_grain+$a_grain
       where fid = $fid_to&quot; ) 
       or die(&quot;Query failed : &quot; . mysql_error());
       // убираем из очереди 
       $result = mysql_query(&quot;delete from job_traders_move 
       where jtm_id=$jtm_id&quot; ) 
       or die(&quot;Query failed : &quot; . mysql_error());
    } else {
       // убираем из очереди 
       $result = mysql_query(&quot;delete from job_traders_move 
       where jtm_id=$jtm_id&quot; ) 
       or die(&quot;Query failed : &quot; . mysql_error());
    } 
  } else {
    if( $time_e1 &lt;= $cur_time ){
      // уже прибыли но пока не возвращались
      // добавим ресов тому кому несли 
      $result = mysql_query(&quot;update fields set f_wood=f_wood+$a_wood,
      f_clay=f_clay+$a_clay,
      f_ore=f_ore+$a_ore,
      f_grain=f_grain+$a_grain
      where fid = $fid_to&quot; ) 
      or die(&quot;Query failed : &quot; . mysql_error());
      // поменяем статус перемещения - на возврат
      $result = mysql_query(&quot;update job_traders_move 
      set jtm_direction=2, jtm_wood=0,jtm_clay=0,jtm_ore=0,jtm_grain=0
      where jtm_id=$jtm_id&quot; ) 
      or die(&quot;Query failed : &quot; . mysql_error()); 
    }
  }
 }
}
}
</pre>
			Фрагмент 8.2.10<p>В этой функции мы получаем необходимые данные из 
			запроса к таблице <b>job_traders_move</b> и затем осуществляем 
			простые проверки по времени и направлению движения торговцев. Так 
			если время возвращения меньше текущего (строка 26), то мы проверяем 
			направление (<span lang="en-us">$</span>direction ) и если оно равно 
			1, то еще не было обработки доставки ресурсов, что мы и делаем в 
			строках 28-34, добавляя ресурсы в поселок, куда направлялись наши 
			торговцы,&nbsp; затем удаляем очередь из <b>job_traders_move</b> 
			(строки 35-38). Если доставка уже осуществлялась (<span lang="en-us">$</span>direction 
			не равен 1 ) , значит просто удалим из очереди (строки 40-43). Если 
			же время возвращения еще не наступило, то мы проверяем, а прошло ли 
			время доставки (строка 46), и если да - добавляем ресурсов в пункт 
			назначения, а в очереди в таблице <b>job_traders_move</b> меняем 
			статус в поле <b><font color="#339966">jtm_direction</font></b> на 2 
			и обнуляем ресурсы.<br>
			<br>
			Как Вы помните из фрагмента 8.2.<span lang="en-us">3</span> эти 
			функции <font color="#3B84D0">show_traders_moving</font> и
			<font color="#3B84D0">update_traders_moving</font> вызываются в 
			шаблоне Рынка. Таким образом, игрок, заходя в здание рынка в своем 
			поселке будет всегда в курсе событий, связанных с перемещениями 
			торговцев.<br>
            <br><span lang="en-us"><font color="#4775A5"><b>8</b></font></span><font color="#4775a5"><font ><b>.3. 
			Покупка ресурсов
     </b></font><br></font>
            <br>
&nbsp;&nbsp; Иногда у игрока возникает потребность обменять один вид ресурса, 
			которого у него в избытке на другой, более нужный ему в процессе 
			игры ресурс. Конечно же мы должны дать ему такую возможность. На 
			этом же рынке, но в шаблоне <span lang="en-us"><b>tpl_g17_2.php</b>
			</span>мы должны выводить информацию о предложениях по обмену одного 
			ресурса на другой остальных игроков на рынке. Для этих целей нам 
			понадобится таблица предложений. Назовем мы эту таблицу - <b>
			res_offers</b>. Вот она:<br>
            </p>
<pre class="brush: sql;">/* Таблица предложений продажи ресурсов */
CREATE TABLE `res_offers` (
ro_id bigint(20) unsigned NOT NULL auto_increment, /*ID*/
fid bigint(20), /*откуда? и принадлежность поселку*/
rft_id_offer INT, /* тип ресурса из res_fields_types предложение*/
ro_qty_offer int DEFAULT 0, /* количество предлагаемого ресурса предложение*/ 
rft_id_need INT, /* тип ресурса из res_fields_types требуется*/
ro_qty_need int DEFAULT 0, /* количество предлагаемого ресурса требуется*/ 
ro_max_time int default 0, /* максимальное время транспортировки */ 
ro_hash char(50), 
PRIMARY KEY (`ro_id`) 
) ENGINE=MyISAM DEFAULT CHARSET=cp1251;
</pre>Фрагмент <span lang="en-us">8</span>.3.1<br>
			<br>
			<b>ro_id</b>&nbsp; - уникальный идентификатор в таблице res_offers<br>
			<b>fid</b> - идентификатор поселка из таблицы <span lang="en-us"><b>
			fields</b>.</span><br>
			<b>rft_id_offer</b> <span lang="en-us">- </span>идентификатор (тип 
			из таблицы <b>res_fields_types</b> ) ресурса который предлагается 
			игроком<br>
			<b>ro_qty_offer</b> - количество предлагаемого ресурса <br>
			<b>rft_id_need</b> <span lang="en-us">- </span>идентификатор (тип из 
			таблицы <b>res_fields_types</b> ) ресурса который требуется игроку<br>
			<b>ro_qty_need</b> - количество требуемого ресурса <br>
			<b>ro_max_time</b> - максимальное время транспортировки<br>
			<b>ro_hash</b> - служебная информация 
			<p>Давайте сразу добавим в эту таблицу немного данных, как будто 
			игрок <font color="#3B84D0"><b>Суперигрок</b></font> выставил 
			некоторые ресурсы для обмена.<br>
            </p>
<pre class="brush: sql;">insert into res_offers (fid, rft_id_offer, ro_qty_offer, rft_id_need, ro_qty_need) values (67, 1, 500, 2, 500);
insert into res_offers (fid, rft_id_offer, ro_qty_offer, rft_id_need, ro_qty_need) values (67, 3, 500, 4, 500);
</pre>Фрагмент <span lang="en-us">8</span>.3.2<p>Теперь у нас есть все 
			необходимое, чтоб модифицировать шаблон <b><span lang="en-us">
			tpl_g17_2.php</span> </b>для показа рыночных предложений обмена 
			ресурсов от других игроков.</p>


<pre class="brush: php;">
 // Рынок
$ta = false; // заключена ли сделка?

echo &quot;&lt;div id='textmenu'&gt;
&lt;a href='build.php?bnum=$bnum'&gt;Отправить&lt;/a&gt;
| &lt;a href='build.php?bnum=$bnum&amp;amp;p=2' class='selected'&gt;Покупка&lt;/a&gt;
| &lt;a href='build.php?bnum=$bnum&amp;amp;p=3'&gt;Продажа&lt;/a&gt;
| &lt;a href='build.php?bnum=$bnum&amp;amp;p=4'&gt;NPC-торговец&lt;/a&gt;
&lt;/div&gt;&quot;;

// приняли предложение на рынке
if( isset( $_GET[&quot;ri&quot;] ) ){
$ta = init_trade_accept( $fid, $_GET[&quot;ri&quot;] );
}

echo ' &lt;br&gt;
&lt;table width=&quot;450&quot; style=&quot;border-collapse: collapse;&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; id=&quot;army&quot;&gt;
&lt;tr&gt;
&lt;td colspan=&quot;5&quot; class=&quot;trade_bg&quot;&gt;Предложения на рынке&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&quot;tabhead&quot;&gt;Предлагает&lt;/td&gt;
&lt;td class=&quot;tabhead&quot;&gt;Ищет&lt;/td&gt;
&lt;td class=&quot;tabhead&quot;&gt;Игрок&lt;/td&gt;
&lt;td class=&quot;tabhead&quot;&gt;Время&lt;/td&gt;
&lt;td class=&quot;tabhead&quot;&gt;Действие&lt;/td&gt;
&lt;/tr&gt;';

$res = mysql_query(&quot;SELECT ro_id, ro.fid, u.nick, f.xcoord, f.ycoord,
rft1.rft_sm_image im1,
rft2.rft_sm_image im2, 
rft_id_offer, ro_qty_offer, rft_id_need, ro_qty_need
from res_offers ro
inner join fields f on f.fid = ro.fid
inner join users u on u.usr_id = f.usr_id
inner join res_fields_types rft1 on rft1.rft_id = ro.rft_id_offer
inner join res_fields_types rft2 on rft2.rft_id = ro.rft_id_need
where ro.fid &lt;&gt; $fid&quot; )
or die(&quot;Query failed : &quot; . mysql_error());

while ($row = mysql_fetch_array( $res )) {
 $ro_id = $row[&quot;ro_id&quot;]; 
 $nick = $row[&quot;nick&quot;]; 
 $im1 = $row[&quot;im1&quot;]; 
 $im2 = $row[&quot;im2&quot;];
 $qty_offer = $row[&quot;ro_qty_offer&quot;];
 $qty_need = $row[&quot;ro_qty_need&quot;];
 $p_x = $row[&quot;xcoord&quot;];
 $p_y = $row[&quot;ycoord&quot;];

 $distance = distance_btw_villages( $fid, $p_x, $p_y );
 $speed = 10/3600; // торговцы идут 10 полей в час
 $sec = floor( $distance / $speed );
 $time = s2h( $sec );

 echo '&lt;tr&gt;&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;'.$im1.'&quot;&gt;'.$qty_offer.'&lt;/td&gt;
 &lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;'.$im2.'&quot;&gt;'.$qty_need.'&lt;/td&gt;
 &lt;td class=&quot;armyinfo&quot;&gt;'.$nick.'&lt;/td&gt;
 &lt;td class=&quot;armyinfo&quot;&gt;'.$time.'&lt;/td&gt;
 &lt;td class=&quot;armyinfo&quot;&gt;
 &lt;a href=&quot;build.php?bnum='.$bnum.'&amp;amp;p=2&amp;ri='.$ro_id.'&quot;&gt;Принять&lt;/a&gt;
 &lt;/td&gt;&lt;tr&gt;';
}

echo '&lt;/table&gt;';

</pre>
			Фрагмент 8.3.3<p>Выглядит, формируемая этим фрагментом страница в 
			браузере следующим образом:<br>
			<br>
			<img border="0" src="pics/trade_off.png" width="530" height="418"><br>
			Рисунок 8.3.1<br>
			<br>
			Как Вы видите из фрагмента 8.3.3, этот шаблон на основании
			<span lang="en-us">SQL </span>запроса (строки <span lang="en-us">&nbsp;29-39</span>)<span lang="en-us">
			</span>сразу к трем таблицам ( <b>res_offers</b>, <b>users</b> и <b>res_fields_types</b>&nbsp; 
			) формирует <span lang="en-us">HTML </span>табличку<span lang="en-us">
			</span>со списком всех предложений, где выводятся типы предлагаемых 
			и требуемых ресурсов, а также их количество, ник игрока и время 
			доставки в строках 51-54 на основании расстояния между поселками, 
			того кто предлагает обмен и того, кто сейчас рассматривает это 
			предложение. Так, если мы примем первое предложение от игрока 
			Суперигрок, то наши торговцы и его торговцы доставят товары (мы - 
			железо, а они - зерно) в течении 18 минут и 58 секунд. <br>
			Что же произойдет, если мы нажмем ссылку &quot;Принять&quot;. А вот что - 
			управление снова передастся в эту же страницу и кроме номера 
			постройки <span lang="en-us">bnum </span>будет также передан 
			параметр <span lang="en-us"><b>ri</b>, </span>который хранит в себе 
			идентификатор строки предложения (поле <font color="#339966"><b>
			ro_id</b></font> из таблицы <b>res_offers</b>) Вы видите, что в 
			строках 12-14 этого же фрагмента и происходит обработка приема этого 
			идентификатора и вызов функции <font color="#3B84D0">init_trade_accept</font>, 
			в которую кроме поселка, передается и этот идентификатор сделки из 
			таблицы <b>res_offers</b>.<br>
			Чем же занимается функция <font color="#3B84D0">init_trade_accept</font>? 
			Ниже приведено тело этой функции:</p>


<pre class="brush: php;">
// заключаем торговую сделку - принимая чье-то предложение
function init_trade_accept( $fid, $ro_id ){

// покажем табличку принятого предложения
echo '&lt;br&gt;
&lt;table width=&quot;450&quot; style=&quot;border-collapse: collapse;&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; id=&quot;army&quot;&gt;
&lt;tr&gt;
&lt;td colspan=&quot;2&quot; class=&quot;trade_bg&quot;&gt;Рынок&lt;/td&gt;
&lt;/tr&gt;';

$res = mysql_query(&quot;SELECT ro_id, ro.fid, u.nick, f.xcoord, f.ycoord,
rft1.rft_sm_image im1,
rft2.rft_sm_image im2, 
rft_id_offer, ro_qty_offer, rft_id_need, ro_qty_need
from res_offers ro
inner join fields f on f.fid = ro.fid
inner join users u on u.usr_id = f.usr_id
inner join res_fields_types rft1 on rft1.rft_id = ro.rft_id_offer
inner join res_fields_types rft2 on rft2.rft_id = ro.rft_id_need
where ro.ro_id = $ro_id&quot; )
or die(&quot;Query failed : &quot; . mysql_error());

$row = mysql_fetch_array( $res );
$fid_from = $row[&quot;fid&quot;]; // от кого принимаем
$nick = $row[&quot;nick&quot;]; 
$im1 = $row[&quot;im1&quot;]; 
$im2 = $row[&quot;im2&quot;];

$rft_id_offer = $row[&quot;rft_id_offer&quot;];
$qty_offer = $row[&quot;ro_qty_offer&quot;];

$rft_id_need = $row[&quot;rft_id_need&quot;];
$qty_need = $row[&quot;ro_qty_need&quot;];

$p_x = $row[&quot;xcoord&quot;];
$p_y = $row[&quot;ycoord&quot;];

echo '&lt;tr&gt;
&lt;td colspan=&quot;2&quot; class=&quot;tabhead&quot;&gt;Предложение от '.$nick.' принято&lt;/td&gt;
&lt;/tr&gt;';

echo '&lt;tr&gt;&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;'.$im1.'&quot;&gt;'.$qty_need.'&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;отправлено Вам&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;'.$im2.'&quot;&gt;'.$qty_offer.'&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;отправили Ваши торговцы&lt;/td&gt;&lt;tr&gt;';
echo '&lt;/table&gt;';


// создаем движение торговцев к нам и от нас!
init_trades_moving($fid_from, $fid, $rft_id_offer, $qty_offer );
init_trades_moving($fid, $fid_from, $rft_id_need, $qty_need );

// а теперь удалим это предложение
$res = mysql_query(&quot;DELETE from res_offers 
where ro_id = $ro_id&quot; )
or die(&quot;Query failed : &quot; . mysql_error());

}
</pre>
			Фрагмент 8.3.4<p>Смысл этой функции - показать на экране табличку 
			принятого предложения (строки 5-46) и запустить механизм движения 
			торговцев вызов функции <font color="#3B84D0">init_trades_moving</font> для наших и чужих 
			торговцев. Затем это торговое предложение уже теряет силу и должно 
			быть удалено, что мы и делаем в строках 54-56. В функцию
			<font color="#3B84D0">init_trades_moving</font> передаются 
			идентификаторы поселка откуда и куда движутся торговцы и данные по 
			типам ресурсов и их количеству.<br>
			<br>
			Вот как выглядит функция <font color="#3B84D0">init_trades_moving</font>.</p>


<pre class="brush: php;">
// функция создает движение торговцев 
function init_trades_moving( $fid_from, $fid_to, $rft_id, $qty ){
// координаты куда отправка:
$res = mysql_query(&quot;SELECT xcoord, ycoord from fields where fid=$fid_to&quot; ) 
or die(&quot;Query failed : &quot; . mysql_error());
$row = mysql_fetch_array( $res );
$p_x = $row[&quot;xcoord&quot;];
$p_y = $row[&quot;ycoord&quot;];

// на основе res_fields_types
$p_wood = ( $rft_id == 3 ? $qty : 0 );
$p_clay = ( $rft_id == 4 ? $qty : 0 );
$p_ore = ( $rft_id == 2 ? $qty : 0 );
$p_grain = ( $rft_id == 1 ? $qty : 0 );

// hash
$hash = md5(mktime());

init_send_res( $fid_from, $p_wood, $p_clay, $p_ore, $p_grain, $p_x, $p_y, $hash );

}
</pre>
			Фрагмент 8.3.5<p>Эта функция, получает координаты поселка назначения 
			из запроса в строках (4-5), уточняет сколько и какого типа ресурсы 
			отправляются (строки 11-14) и вызывает уже знакомую Вам функцию 
			отправки ресурсов <font color="#3B84D0">init_send_res</font> 
			(которая подробно описывалась во фрагменте 8.2.<span lang="en-us">7</span>)<br>
			<br>
			Собственно дальше все идет по накатанной схеме - только кроме наших 
			торговцев еще двигаются и чужие по направлению к нашему поселку. 
			Чтоб показать еще и движение чужих торговцев нужно добавить немного 
			кода в функцию <font color="#3B84D0">show_traders_moving</font>. 
			Посмотрите, что мы добавили в нее, по сравнению с фрагментом&nbsp; 
			8.2.8 самостоятельно в файле <span lang="en-us">functions.inc.php</span>, 
			который как обычно Вы можете найти <a href="www">здесь</a>.<br>
			Таким образом приняв на рынке одно из предложений, мы увидим 
			следующую картинку в браузере:<br>
			<br>
			<img border="0" src="pics/pr_prin.png" width="557" height="441"><br>
			<br>
			Рисунок 8.3.2<br>
			<br>
			А перейдя на страничку <u>Отправить</u> , увидите в очереди движение 
			торговцев к Вам и от Вас:<br>
			<br>
			<img border="0" src="pics/2_traders.png" width="548" height="639"><br>
			Рисунок 8.3.3<br>
			<br>
			Вы можете наблюдать, что количество железа в поселке в верхней 
			строке уменьшилось до 200 (было 700 и ваши торговцы отправились в
			<span lang="en-us">supertown </span>с 500 единицами железа), а в 
			ответ к Вам в <span lang="en-us">testtown </span>выдвинулись 
			торговцы Суперигрока с грузом 500 единиц зерна.<br>
			Чтоб быстрее отследить доставку ресурсов Вы можете временно поменять 
			скорость движения торговцев с 10 полей в час, например на 100 полей 
			в час. Конечно же Вы догадались что это можно сделаеть в функции
			<font color="#3B84D0">init_send_res</font>.<font color="#4775A5"><strong><span lang="en-us"><br>
			<br>
			<br>
			</span>8</strong></font><font color="#4775a5"><strong>.4. 
			Продажа ресурсов </strong></font><br>
			<br>
			&nbsp;&nbsp; <span lang="en-us">Н</span>аконец мы<span lang="en-us">
			</span>
			добрались до момента, когда научимся сами задавать обмен ресурсов на 
			рынке<span lang="en-us">.</span>
			Это пункт &quot;Продажа&quot;<span lang="en-us">
			</span>
			и сейчас, как Вы поняли, мы займемся модификацией отвечающего за 
			этот пункт шаблона&nbsp; <b><span lang="en-us">
			tpl_g17_</span>3<span lang="en-us">.php</span></b>.<span lang="en-us">
			</span>
			Тут все будет довольно просто - нам нужно создать форму, в которой 
			игрок выберет какой ресурс на какой он хочет поменять и указать 
			нужные количества<span lang="en-us">
			</span>
			того и другого ресурса. Чуть ниже показан фрагмент 8.4.1, который 
			как раз показывает ту часть шаблона <b><span lang="en-us">
			tpl_g17_</span>3<span lang="en-us">.php</span></b>, где расположена 
			форма:</p>


<pre class="brush: php;">
&lt;form name=&quot;selling&quot; method=&quot;POST&quot; action=&quot;build.php?bnum=&lt;? echo $bnum ?&gt;&amp;amp;p=3&quot;&gt;
&lt;table id=&quot;sell&quot; cellpadding=&quot;1&quot; cellspacing=&quot;1&quot;&gt;
&lt;tr&gt;&lt;td class=&quot;resinfo&quot;&gt;Предлагаю&lt;/td&gt;
&lt;td class=&quot;resinfo&quot;&gt;
&lt;input class=&quot;text&quot; tabindex=&quot;1&quot; size=&quot;6&quot; name=&quot;m1&quot; value=&quot;&quot; maxlength=&quot;6&quot;&gt;
&lt;/td&gt;
&lt;td class=&quot;resinfo&quot;&gt;
&lt;select name=&quot;res1&quot; tabindex=&quot;2&quot; class=&quot;dropdown&quot;&gt;
&lt;option value=&quot;3&quot; selected=&quot;selected&quot;&gt;Древесина&lt;/option&gt;
&lt;option value=&quot;4&quot;&gt;Глина&lt;/option&gt;
&lt;option value=&quot;2&quot;&gt;Железо&lt;/option&gt;
&lt;option value=&quot;1&quot;&gt;Зерно&lt;/option&gt;
&lt;/select&gt;
&lt;/td&gt;
&lt;td class=&quot;resinfo&quot;&gt;
&lt;input class=&quot;check&quot; type=&quot;checkbox&quot; tabindex=&quot;5&quot; name=&quot;d1&quot; value=&quot;1&quot;&gt;
Макс. время трансп.: &lt;input class=&quot;text&quot; tabindex=&quot;6&quot; size=&quot;1&quot; name=&quot;d2&quot; value=&quot;2&quot; maxlength=&quot;2&quot; /&gt; ч. 
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td class=&quot;resinfo&quot;&gt;Ищу&lt;/td&gt;
&lt;td class=&quot;resinfo&quot;&gt;
&lt;input class=&quot;text&quot; tabindex=&quot;3&quot; size=&quot;6&quot; name=&quot;m2&quot; value=&quot;&quot; maxlength=&quot;6&quot;&gt;
&lt;/td&gt;
&lt;td class=&quot;resinfo&quot;&gt;
&lt;select name=&quot;res2&quot; tabindex=&quot;4&quot; class=&quot;dropdown&quot;&gt;
&lt;option value=&quot;3&quot;&gt;Древесина&lt;/option&gt;
&lt;option value=&quot;4&quot; selected=&quot;selected&quot;&gt;Глина&lt;/option&gt;
&lt;option value=&quot;2&quot;&gt;Железо&lt;/option&gt;
&lt;option value=&quot;1&quot;&gt;Зерно&lt;/option&gt; 
&lt;/select&gt;
&lt;/td&gt;
&lt;td class=&quot;resinfo&quot;&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;br&gt;&lt;img src=&quot;img/vill/ok.png&quot; onclick=&quot;init_sell()&quot; style=&quot;cursor:hand&quot;&gt;&lt;/br&gt;
&lt;input type=&quot;hidden&quot; name=&quot;sell&quot;&gt;
&lt;input type=&quot;hidden&quot; name=&quot;hash&quot; value=&quot;&lt;? echo md5(mktime()) ?&gt;&quot; &gt;
&lt;/form&gt;
</pre>Фрагмент 8.4.1<p>Выглядит она так:<span lang="en-us"><br>
			<br>
			<img border="0" src="pics/torg.png" width="502" height="114"><br>
			<br>
			</span>
			Рисунок 8.4.1<span lang="en-us"><br>
			<br>
			</span>
			Здесь никаких проверок не производится и по нажатию на кнопку
			<span lang="en-us">
			<img border="0" src="www/img/vill/ok.png" width="48" height="21"></span>
			с<span lang="en-us"> </span>именем <span lang="en-us">
			<font color="#3B84D0"><b>sell</b></font> </span>срабатывает
			<span lang="en-us">JavaScript </span>функция <font color="#3B84D0">
			init_sell</font>, которая кроме отправки формы ничем более не 
			занимается.<span lang="en-us">
			</span>
			В этом же шаблоне <b><span lang="en-us">
			tpl_g17_</span>3<span lang="en-us">.php</span> </b>есть<span lang="en-us">
			</span>
			строки для обработки данных, получаемых от этой формы.<span lang="en-us">
			</span>
			Вот эти строки:</p>


<pre class="brush: php;">
// задали предложение об обмене ресурсов
if( isset( $_POST[&quot;sell&quot;] ) ){
 $res1 = $_POST[&quot;res1&quot;];
 $res2 = $_POST[&quot;res2&quot;];
 $qty1 = $_POST[&quot;m1&quot;];
 $qty2 = $_POST[&quot;m2&quot;];
 $tmchk = $_POST[&quot;d1&quot;];
 $tm = $_POST[&quot;d2&quot;];
 $hash = $_POST[&quot;hash&quot;];
 $time = ( $tmchk &lt;&gt; &quot;&quot; ? $tm : 0 );

 create_trade_offer( $fid, $res1, $qty1, $res2, $qty2, $time, $hash );
}
</pre>
			Фрагмент 8.4.<span lang="en-us">2</span><p>Как Вы видите, все данные 
			из формы описанной во фрагменте <span lang="en-us">8</span>.4.1 
			принимаются методом <span lang="en-us">POST </span>и передаются в 
			функцию <font color="#3B84D0">create_trade_offer</font>.<span lang="en-us">
			</span>Вот как выглядит эта функция:</p>


<pre class="brush: php;">
//////////// подаем заявку на обмен ресурсов ////////////////
function create_trade_offer( $fid, $res1, $qty1, $res2, $qty2, $time, $hash ){

if( !is_offer_hash( $fid, $hash )){

  // сперва узнем, хватает ли ресурсов для предложения?
  // на основе res_fields_types
  $p_wood = ( $res1 == 3 ? $qty1 : 0 );
  $p_clay = ( $res1 == 4 ? $qty1 : 0 );
  $p_ore = ( $res1 == 2 ? $qty1 : 0 );
  $p_grain = ( $res1 == 1 ? $qty1 : 0 );

  // А сколько у нас есть в наличии
  $a_res = get_res( $fid );

  $f_grain = $a_res[&quot;grain&quot;] - how_offer_res( $fid, 1 );
  $f_ore = $a_res[&quot;ore&quot;] - how_offer_res( $fid, 2 );
  $f_wood = $a_res[&quot;wood&quot;] - how_offer_res( $fid, 3 );
  $f_clay = $a_res[&quot;clay&quot;] - how_offer_res( $fid, 4 );

  if ( ($p_grain &lt;= $f_grain) &amp;&amp;
    ($p_ore &lt;= $f_ore) &amp;&amp;
    ($p_wood &lt;= $f_wood) &amp;&amp; 
    ($p_clay &lt;= $f_clay) ) {

    $res = mysql_query( &quot;insert into res_offers (fid, rft_id_offer, ro_qty_offer, rft_id_need, ro_qty_need, ro_max_time, ro_hash) 
    values ( $fid, $res1, $qty1, $res2, $qty2, $time, '$hash') &quot; )
    or die(&quot;Query failed : &quot; . mysql_error()); 

  } else {
    echo '&lt;font color=&quot;#FF0000&quot;&gt;Для этого предложения у Вас не хватает ресурсов!&lt;/font&gt;';
  }
}

}
</pre>
			Фрагмент 8.4.3<p>Эта функция проверяет, есть ли у нас в наличие 
			столько ресурсов, сколько мы хотим заявить для обмена. Тут даже 
			учитываются ресурсы, зарезервированные ранее (то есть еще могут быть 
			ранее созданные предложения об обмене)<span lang="en-us">.</span>
			Функция <font color="#3B84D0">how_offer_res</font> проверяет нет ли<span lang="en-us">
			</span>
			чего зарезервированного <span lang="en-us">п</span>о указанному типу 
			ресурса?<span lang="en-us">
			</span>
			И если игроку достаточно ресурсов для подачи такой заявки на обмен - 
			в таблице <b>res_offers</b> создается еще одна строка с<span lang="en-us">
			</span>
			выбранным игроком вариантом обмена. После чего другие игроки могут 
			видеть предложения этого игрока на рынке<span lang="en-us">
			</span>
			и заключать эти сделки.<span lang="en-us"><br>
			<br>
			</span>
			Завершающим штрихом этого пункта нашей лекции станет еще один 
			фрагмент из <span lang="en-us">ш</span>аблона <b><span lang="en-us">
			tpl_g17_</span>3<span lang="en-us">.php</span></b>,
			<span lang="en-us">г</span>де мы покажем предложения текущего игрока 
			и дадим ему возможность отменить свое предложение.<span lang="en-us">
			</span>
			Сперва покажем предложения игрока:</p>


<pre class="brush: php;">
$res = mysql_query(&quot;SELECT ro_id, ro.fid, ro_hash, 
rft_id_offer, ro_qty_offer, rft_id_need, ro_qty_need,
ro_hash, ro_max_time,
rft1.rft_sm_image im1,
rft2.rft_sm_image im2 
from res_offers ro
inner join res_fields_types rft1 on rft1.rft_id = ro.rft_id_offer
inner join res_fields_types rft2 on rft2.rft_id = ro.rft_id_need
where ro.fid = $fid&quot; )
or die(&quot;Query failed : &quot; . mysql_error());

$num_rows = mysql_num_rows( $result );
if( $num_rows &gt; 0 ){

 echo ' &lt;br&gt;
 &lt;table width=&quot;450&quot; style=&quot;border-collapse: collapse;&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; id=&quot;army&quot;&gt;
 &lt;tr&gt;
 &lt;td colspan=&quot;5&quot; class=&quot;trade_bg&quot;&gt;Собственные предложения&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td class=&quot;tabhead&quot;&gt;&lt;/td&gt;
 &lt;td class=&quot;tabhead&quot;&gt;Предлагаю&lt;/td&gt;
 &lt;td class=&quot;tabhead&quot;&gt;Ищу&lt;/td&gt;
 &lt;td class=&quot;tabhead&quot;&gt;Торговцы&lt;/td&gt;
 &lt;td class=&quot;tabhead&quot;&gt;Время&lt;/td&gt;
 &lt;/tr&gt;';

 while ($row = mysql_fetch_array( $res )) {
  $ro_id = $row[&quot;ro_id&quot;]; 
  $hash = $row[&quot;ro_hash&quot;];
  $rft_id_offer = $row[&quot;rft_id_offer&quot;];
  $qty_offer = $row[&quot;ro_qty_offer&quot;];
  $rft_id_need = $row[&quot;rft_id_need&quot;];
  $qty_need = $row[&quot;ro_qty_need&quot;];
  $im1 = $row[&quot;im1&quot;]; 
  $im2 = $row[&quot;im2&quot;];
  $time = ( $row[&quot;ro_max_time&quot;] == 0 ? '-' : $row[&quot;ro_max_time&quot;].' ч.' );

  $num_traders = ceil( $qty_offer/500 );

  echo '&lt;tr&gt;&lt;td class=&quot;armyinfo&quot;&gt;&lt;a href=&quot;build.php?bnum='.$bnum.'&amp;amp;p=3&amp;amp;d='.$hash.'&quot;&gt;&lt;img src=&quot;img/delete.gif&quot; border=&quot;0&quot; title=&quot;Удалить?&quot;&gt;&lt;/a&gt;&lt;/td&gt;
  &lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;'.$im1.'&quot;&gt;'.$qty_offer.'&lt;/td&gt;
  &lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;'.$im2.'&quot;&gt;'.$qty_need.'&lt;/td&gt;
  &lt;td class=&quot;armyinfo&quot;&gt;'.$num_traders.'&lt;/td&gt;
  &lt;td class=&quot;armyinfo&quot;&gt;'.$time.'&lt;/td&gt;&lt;tr&gt;'; 
 }
}
echo '&lt;/table&gt;';
}
</pre>
			Фрагмент 8.4.4<p>Этот фрагмент изобразит в окне браузера следующее:<span lang="en-us"><br>
			<br>
			<img border="0" src="pics/so_pr.png" width="459" height="87"><br>
			<br>
			</span>
			Рисунок 8.4.2<span lang="en-us"><br>
			<br>
			</span>
			Отмена заявки на обмен осуществляется нажатием на значок <span lang="en-us">
			<img border="0" src="www/img/delete.gif" width="16" height="16"></span>, 
			при этом, как Вы видите из <span lang="en-us">с</span>троки 41 
			фрагмента 8.4.4 <span lang="en-us">д</span>ля удаления вызывается 
			тот же файл <span lang="en-us"><b>build.php</b>
			</span>
			и кроме номера постройки ему передается параметр <span lang="en-us">
			&amp;d
			</span>
			куда передается значение $hash<span lang="en-us"> </span>этой сделки<span lang="en-us">.</span> 
			Обработка отмены<span lang="en-us"> </span>заявки на обмен ресурсов 
			осуществляется так:</p>


<pre class="brush: php;">
if( isset( $_GET[&quot;d&quot;] ) ){
$del = $_GET[&quot;d&quot;];
$res = mysql_query(&quot;DELETE from res_offers
where fid = $fid and ro_hash = '$del'&quot; )
or die(&quot;Query failed : &quot; . mysql_error());
}
</pre>
			Фрагмент 8.4.5<p>По значению хэш и идентификатору поселка мы находим 
			такое предложение <span lang="en-us">и</span> удаляем его
			<span lang="en-us">sql </span>запросом.<span lang="en-us"><br>
			</span>
			<br>
<br><font color="#4775A5"><b>8.5. 
			NPC-торговец</b></font><br>
            <br>
            &nbsp;&nbsp; В завершающем пункте нашей торговой (не побоимся этого 
			слова) лекции мы с Вами создадим несложный шаблон для того же рынка, 
			который поможет нам моментально перераспределять ресурсы игрока. 
			Вообще такая операция в реальной игре <span lang="en-us">travian
			</span>стоит реальных денег (золота, которое покупается за реальные 
			деньги), но мы с Вами люди не жадные и сделаем ее бесплатно. Как Вы 
			догадались - сейчас некоторым изменениям подвергнется последний для 
			Рынка шаблон, содержащийся в файле <b><span lang="en-us">
			tpl_g17_</span>4<span lang="en-us">.php</span></b>. Для начала мы 
			создадим форм, где будут в браузере производится действия по 
			распределению ресурсов:</p>


<pre class="brush: php;">
&lt;br&gt;
&lt;form name=&quot;portions&quot; method=&quot;POST&quot; action=&quot;build.php?bnum=&lt;? echo $bnum ?&gt;&amp;amp;p=4&quot;&gt;
&lt;table width=&quot;450&quot; style=&quot;border-collapse: collapse;&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; id=&quot;army&quot;&gt;
&lt;tr&gt;
&lt;td colspan=&quot;5&quot; class=&quot;trade_bg&quot;&gt;NPC-торговец&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&quot;tabhead&quot;&gt;&lt;img src=&quot;img/res/1.gif&quot; title=&quot;Древесина&quot;&gt;&lt;? echo $f_wood; ?&gt;&lt;/td&gt;
&lt;td class=&quot;tabhead&quot;&gt;&lt;img src=&quot;img/res/2.gif&quot; title=&quot;Глина&quot;&gt;&lt;? echo $f_clay; ?&gt;&lt;/td&gt;
&lt;td class=&quot;tabhead&quot;&gt;&lt;img src=&quot;img/res/3.gif&quot; title=&quot;Желео&quot;&gt;&lt;? echo $f_ore; ?&gt;&lt;/td&gt;
&lt;td class=&quot;tabhead&quot;&gt;&lt;img src=&quot;img/res/4.gif&quot; title=&quot;Зерно&quot;&gt;&lt;? echo $f_grain; ?&gt;&lt;/td&gt;
&lt;td class=&quot;tabhead&quot;&gt;Сумма : &lt;span id=&quot;summ&quot;&gt;&lt;? echo $summ; ?&gt;&lt;/span&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;input type=&quot;text&quot; size=5 class=&quot;text&quot; id=&quot;r3&quot; name=&quot;r3&quot; value=&quot;0&quot; maxlength=&quot;4&quot; onKeyUp=&quot;upd_res_npc(3)&quot; &gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;input type=&quot;text&quot; size=5 class=&quot;text&quot; id=&quot;r4&quot; name=&quot;r4&quot; value=&quot;0&quot; maxlength=&quot;4&quot; onKeyUp=&quot;upd_res_npc(4)&quot; &gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;input type=&quot;text&quot; size=5 class=&quot;text&quot; id=&quot;r2&quot; name=&quot;r2&quot; value=&quot;0&quot; maxlength=&quot;4&quot; onKeyUp=&quot;upd_res_npc(2)&quot; &gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;input type=&quot;text&quot; size=5 class=&quot;text&quot; id=&quot;r1&quot; name=&quot;r1&quot; value=&quot;0&quot; maxlength=&quot;4&quot; onKeyUp=&quot;upd_res_npc(1)&quot; &gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;Сумма : &lt;span id=&quot;summ2&quot;&gt;0&lt;/span&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;span id=&quot;s3&quot;&gt;&lt;? echo -$f_wood; ?&gt;&lt;/span&gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;span id=&quot;s4&quot;&gt;&lt;? echo -$f_clay; ?&gt;&lt;/span&gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;span id=&quot;s2&quot;&gt;&lt;? echo -$f_ore; ?&gt;&lt;/span&gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;span id=&quot;s1&quot;&gt;&lt;? echo -$f_grain; ?&gt;&lt;/span&gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;Остаток : &lt;span id=&quot;rest&quot;&gt;&lt;? echo $summ;?&gt;&lt;/span&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt; 

&lt;input type=&quot;hidden&quot; name=&quot;port&quot;&gt;
&lt;/form&gt;

&lt;br&gt;&lt;span id=&quot;action&quot;&gt;&lt;font color=&quot;#CCCCCC&quot;&gt;Применить распределение&lt;/font&gt;&lt;/span&gt;&lt;/br&gt;

&lt;br&gt;Здесь Вы можете вручную распределить ресурсы (Распределение считатся завершенным, когда остаток станет равным нулю).&lt;br&gt; &lt;br&gt;
Первая строка отражает содержимое Вашего хранилища. Во второй строке Вы можете 
указать нужное Вам распределение. Третья строка показывает разницу между двумя 
первыми строками. &lt;br&gt;
</pre>
			Фрагмент 8.5.1<p>А для инициализации некоторых значений в этой 
			форме, сперва идет следующий фрагмент:</p>


<pre class="brush: php;">
&lt;?
$a_res = get_res( $fid );

$f_grain = $a_res[&quot;grain&quot;] - how_offer_res( $fid, 1 );
$f_ore = $a_res[&quot;ore&quot;] - how_offer_res( $fid, 2 );
$f_wood = $a_res[&quot;wood&quot;] - how_offer_res( $fid, 3 );
$f_clay = $a_res[&quot;clay&quot;] - how_offer_res( $fid, 4 );
$summ = $f_grain + $f_ore + $f_wood + $f_clay;

echo &quot;&lt;script&gt;&quot;;
echo &quot;res1 = &quot;.$f_grain.&quot;;&quot;;
echo &quot;res2 = &quot;.$f_ore.&quot;;&quot;;
echo &quot;res3 = &quot;.$f_wood.&quot;;&quot;;
echo &quot;res4 = &quot;.$f_clay.&quot;;&quot;;
echo &quot;summ = &quot;.$summ.&quot;;&quot;;
echo &quot;cur_summ = 0;&quot;;
echo &quot;rest = &quot;.$summ.&quot;;&quot;;
?&gt;
action1 = '&lt;font color=&quot;#CCCCCC&quot;&gt;Применить распределение&lt;/font&gt;';
action2 = '&lt;a href=&quot;#&quot; onClick=&quot;acceptPortions()&quot;&gt;Применить распределение&lt;/a&gt;'; 
&lt;/script&gt;
</pre>
			Фрагмент 8.<span lang="en-us">5</span>.<span lang="en-us">2<br>
			<br>
			</span>В нем мы узнаем, сколько в поселке есть каких типов ресурсов 
			и динамически создаем переменные и значения к ним для
			<span lang="en-us">JavaScript (</span>строки<span lang="en-us"> c 
			10-21)</span>, чтоб ими можно было манипулировать на стороне 
			браузера.<br>
			<br>
			Таким образом, форма из фрагмента 8.5.1 будет выглядеть так:<br>
			<br>
			<img border="0" src="pics/raspr.png" width="538" height="255"><br>
&nbsp;<p>Рисунок 8.5.1<br>
			<br>
			Ссылка &quot;Применить распределение&quot; по -умолчанию не активна. Давайте 
			рассмотрим <span lang="en-us">JavaScript </span>функцию
			<font color="#3B84D0">upd_res_npc</font>, которую Вы видите во 
			фрагменте 8.5.1 и которая срабатывает, когда мы начинаем менять 
			значения в полях второй строки таблицы (поля с зелеными рамочками). 
			Вот эта функция:<br>
            </p>
<pre class="brush: js;">function upd_res_npc( elem ){
  resvalue = parseInt( document.getElementById(&quot;r&quot;+elem).value );
  totalSumm = 0; 
  if (resvalue &gt; summ ) document.getElementById(&quot;r&quot;+elem).value = summ;
  rest = resvalue - eval(&quot;res&quot;+elem);
  rest = rest &lt;= 0 ? rest : '+'+rest;
  document.getElementById(&quot;s&quot;+elem).innerHTML = rest;
  for(i=1;i&lt;=4;i++) totalSumm += parseInt( document.getElementById(&quot;r&quot;+i).value );
  document.getElementById(&quot;summ2&quot;).innerHTML = totalSumm; 
  document.getElementById(&quot;rest&quot;).innerHTML = summ -totalSumm; 
  if ( (summ - totalSumm) == 0 )
     document.getElementById(&quot;action&quot;).innerHTML = action2;
  else document.getElementById(&quot;action&quot;).innerHTML = action1;
} 
</pre>Фрагмент 8.5.3<p>Как Вы догадались, во второй строке этой таблицы Вы 
			должны сформировать нужное Вам распределение ресурсов. К примеру у 
			Вас сейчас всех ресурсов по 700 единиц, а вы&nbsp; хотите 
			500,500,900,900. При вводе желаемых значений распределения функция upd_res_npc 
			пересчитывает остаток, который доступен для распределения и как 
			только он становится равным нулю - становится активной ссылка &quot;Применить распределение&quot; 
			. Выглядит это так:<br>
			<br>
			<img border="0" src="pics/raspr2.png" width="531" height="261"><br>
			Рисунок 8.5.2<br>
			<br>
			Нажав на ссылку &quot;Применить распределение&quot; игрок вызывает
			<span lang="en-us">JavaScript </span>функцию <font color="#3B84D0">acceptPortions</font>, 
			которая приведена ниже:<br>
            </p>
<pre class="brush: js;">function acceptPortions(){
portions.submit(); 
}
</pre>Фрагмент 8.5.4<p>Эта функция попросту отправляет данные из формы <b>
			<font color="#008080">portions</font></b> в наш шаблон, где мы их 
			обрабатываем следующим образом:</p>


<pre class="brush: php;">
// задали распределение ресурсов
if( isset( $_POST[&quot;port&quot;] ) ){
$wood = $_POST[&quot;r3&quot;];
$clay = $_POST[&quot;r4&quot;];
$ore = $_POST[&quot;r2&quot;];
$grain = $_POST[&quot;r1&quot;];

create_portions( $fid, $wood, $clay, $ore, $grain );
}
</pre>
			Фрагмент 8.5.5<p>Получив на входе методом <span lang="en-us">POST
			</span>данные о желаемом распределении (т.е количестве ресурсов 
			соответствующего типа в каждом поле) этот кусочек кода передает их 
			функции <font color="#3B84D0">create_portions</font>, которая 
			выглядит так:</p>


<pre class="brush: php;">
/////// делаем распределение ресурсов в таблице fields //////////
function create_portions( $fid, $wood, $clay, $ore, $grain ){
$res = mysql_query(&quot;UPDATE fields set f_grain=$grain,
f_ore=$ore,
f_wood=$wood,
f_clay=$clay where fid=$fid&quot; ) 
or die(&quot;Query failed : &quot; . mysql_error());

}
</pre>
			Фрагмент 8.5.6<p>Думается, не самая сложная функция в сегодняшней 
			лекции! В ней мы просто записываем новые значения количества 
			ресурсов в таблицу <b>fields</b><span lang="en-us"> - </span>все как 
			пожелал игрок, который провел их распределение в форме созданной 
			шаблоном <b><span lang="en-us">
			tpl_g17_</span>4<span lang="en-us">.php</span></b>.<br>
			Вроде все на сегодня. Встретимся на следующей лекции.<b><br>
			<br>
			<br>
			В следующем уроке</b> мы <span lang="ru">с Вами наконец-то перейдем 
			к военным действиям и научимся производить набеги на соседние 
			поселки, захватывая чужие ресурсы и походу дела - уничтожая армию 
			противника.</span><br>
            <br>
            </p>
            <p></p>
            <p></p></font>
            </td>
            <td background="index_files/m_right_m.gif" width="9"><img height="4" src="index_files/m_right_m.gif" width="9" border="0"></td>
          </tr>
        </tbody>
      </table>
      <table cellpadding="0" cellspacing="0" width="100%">
        <tbody>
          <tr>
            <td background="index_files/m_left_m.gif" width="9"></td>
            <td class="newsbody" bgcolor="#fdfdfd">&nbsp;</td>
            <td class="newsbody" bgcolor="#fdfdfd">
            <div class="nav" align="right">Blitz-School© </div>
            </td>
            <td background="index_files/m_right_m.gif" width="9"><img height="4" src="index_files/m_right_m.gif" width="9" border="0"></td>
          </tr>
        </tbody>
      </table>
      <table cellpadding="0" cellspacing="0" height="7" width="100%">
        <tbody>
          <tr>
            <td background="index_files/m_left_b.gif" width="13"><img height="7" src="index_files/m_left_b.gif" width="13" border="0"></td>
            <td background="index_files/m_center_b.gif"><img height="1" src="index_files/spacer.gif" width="1"></td>
            <td width="13"><img height="7" src="index_files/m_right_b.gif" width="13" border="0"></td>
          </tr>
        </tbody>
      </table>
      </div>
      </td>
      <td background="index_files/right_back.gif" valign="top" width="13">&nbsp;</td>
    </tr>
  </tbody>
</table>
<table cellpadding="0" cellspacing="0" width="100%">
  <tbody>
    <tr>
      <td background="index_files/bottom_left.png" height="51" valign="top" width="254">
      <div class="date" style="MARGIN-TOP: 12px; FONT-SIZE: 10px; MARGIN-LEFT: 45px; COLOR: white"><a style="COLOR: rgb(255,255,255)" href  ="index.phtml">Copyright</a>©
2005-2009.
GameSchool</div>
      </td>
      <td background="index_files/bottom.gif" valign="top">
      <div class="date" style="MARGIN-TOP: 12px; FONT-SIZE: 10px; MARGIN-LEFT: 20px; COLOR: rgb(143,145,147)" 
      ><!-- Bottom menu --><a title="Главная страница" style="COLOR: rgb(143,145,147)" href  ="http://www.blitz-school.info/index.phtml">Главная</a><img height="1" src="index_files/spacer.gif" width="22" align="middle">:<img height="1" src="index_files/spacer.gif" width="22" align="middle"><a href="http://www.blitz-school.info/login.phtml"><span style="COLOR: rgb(143,145,147)"  >Вход</span></a><img height="1" src="index_files/spacer.gif" width="22" align="middle">:<img height="1" src="index_files/spacer.gif" width="22" align="middle"><a href="http://www.blitz-school.info/response.phtml"><span style="COLOR: rgb(143,145,147)" 
      >Отзывы</span></a><img height="1" src="index_files/spacer.gif" width="22" align="middle">:<img height="1" src="index_files/spacer.gif" width="22" align="middle"><a href="http://www.blitz-school.info/contacts.phtml"><span style="COLOR: rgb(143,145,147)" 
      >Контакты</span></a><img height="1" src="index_files/spacer.gif" width="22" align="middle">:<img height="1" src="index_files/spacer.gif" width="22" align="middle"><a href="http://www.blitz-school.info/friends.phtml"><span style="COLOR: rgb(143,145,147)" 
      >Обмен ссылками</span></a> </div>
      </td>
      <td width="19"><img height="51" src="index_files/bottom_right.png" width="19" border="0"></td>
    </tr>
  </tbody>
</table>
<div id="menu" onmouseover="showLayer('menu'); Change('products', 'menu2')" onmouseout="hiddenLayer('menu'); Change('products', 'menu1')">
<table border="0" cellpadding="0" cellspacing="0">
  <tbody>
    <tr>
      <td style="WIDTH: 7px; HEIGHT: 7px"><img height="7" alt="" src="index_files/corner1.gif" width="7"></td>
      <td class="top"></td>
      <td style="WIDTH: 7px; HEIGHT: 7px"><img height="7" alt="" src="index_files/corner2.gif" width="7"></td>
    </tr>
    <tr>
      <td class="left"></td>
      <td class="text"><a href="reg.phtml">Курс обучения созданию игр
на Blitz3D</a><br>
      <a href="reg2.phtml">Курс
обучения созданию браузерных онлайновых игр</a> </td>
      <td class="right"></td>
    </tr>
    <tr>
      <td style="BACKGROUND: 0% 50%; WIDTH: 7px; HEIGHT: 7px; -moz-background-clip: initial; -moz-background-origin: initial; -moz-background-inline-policy: initial" 
      ><img height="7" alt="" src="index_files/corner4.gif" width="7"></td>
      <td class="bottom"></td>
      <td style="WIDTH: 7px; HEIGHT: 7px"><img height="7" alt="" src="index_files/corner3.gif" width="7"></td>
    </tr>
  </tbody>
</table>
</div>

</body></html>
