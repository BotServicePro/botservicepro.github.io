<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head>
  
  <meta http-equiv="Content-Language" content="ru">
  
  <title>Центр обучения созданию компьютерных игр</title>
  <meta name="description" content="Blitz-School - Школа создателей компьютерных игр на языке Blitz3D. Если вы хотите быстро научиться делать компьютерные игры или интересуетесь их созданием, то этот сайт будет вам полезен">
  <meta name="keywords" content="программирование, создание игр, курсы создания игр, школа создателей компьютерных игр, blitzbasic, компьютерные игры, как написать игру, как создать игру, программирование компьютерных игр, Blitz3D, программирование игр, разработка игр, создание 3d игр, аудио, графика, дизайн, 3D">
  <link rel="stylesheet" type="text/css" href="main.css">
  <script language="JavaScript" src="index_files/script.js" type="text/javascript"></script>
  <script type="text/javascript" src="scripts/shCore.js"></script>
  <script type="text/javascript" src="scripts/shBrushBash.js"></script>
  <script type="text/javascript" src="scripts/shBrushCpp.js"></script>
  <script type="text/javascript" src="scripts/shBrushCSharp.js"></script>
  <script type="text/javascript" src="scripts/shBrushCss.js"></script>
  <script type="text/javascript" src="scripts/shBrushDelphi.js"></script>
  <script type="text/javascript" src="scripts/shBrushDiff.js"></script>
  <script type="text/javascript" src="scripts/shBrushGroovy.js"></script>
  <script type="text/javascript" src="scripts/shBrushJava.js"></script>
  <script type="text/javascript" src="scripts/shBrushJScript.js"></script>
  <script type="text/javascript" src="scripts/shBrushPhp.js"></script>
  <script type="text/javascript" src="scripts/shBrushPlain.js"></script>
  <script type="text/javascript" src="scripts/shBrushPython.js"></script>
  <script type="text/javascript" src="scripts/shBrushRuby.js"></script>
  <script type="text/javascript" src="scripts/shBrushScala.js"></script>
  <script type="text/javascript" src="scripts/shBrushSql.js"></script>
  <script type="text/javascript" src="scripts/shBrushVb.js"></script>
  <script type="text/javascript" src="scripts/shBrushXml.js"></script>
  <script type="text/javascript" src="scripts/shBrushBlitz3D.js"></script>
  <link type="text/css" rel="stylesheet" href="styles/shCore.css">
  <link type="text/css" rel="stylesheet" href="styles/shThemeDefault.css">
  <script type="text/javascript">
SyntaxHighlighter.config.clipboardSwf = 'scripts/clipboard.swf';
SyntaxHighlighter.all();
  </script>
  <meta content="MSHTML 6.00.6000.20772" name="GENERATOR">
	<style>
<!--
	.SYN_ROW {background:silver;}
	.SYN_TXT {border-left:1px solid;position:relative;left:4.5em;background:white;font-family:monospace;margin-right:4.5em;}
	.HTML_TXT {color:#000000;}
	.HTML_TAG {color:#0000ff;}
	.HTML_ELM {color:#800000;}
	.HTML_ATR {color:#ff0000;}
	.HTML_VAL {color:#0000ff;}
-->
</style>
</head>

<body topmargin="0" leftmargin="0" style="BACKGROUND-COLOR: rgb(255,255,255)" marginheight  ="0" marginwidth="0">
<table cellpadding="0" cellspacing="0" width="100%">
  <tbody>
    <tr>
      <td rowspan="2" height="197" width="21"><img height="197" src="index_files/ltoptable.png" width="21" border="0"></td>
      <td colspan="5" valign="top">
      <table cellpadding="0" cellspacing="0" width="100%">
        <tbody>
          <tr>
            <td height="49" width="231"><img height="49" src="index_files/topmenu.png" width="231" usemap="#ImageMap1" border="0"></td>
            <td background="index_files/mtop.gif"><map name="ImageMap1"><area onclick="this.style.behavior='url(#default#homepage)';this.setHomePage('http://www.blitz-school.info'); return false;" shape="RECT" coords="17,26,71,40" href="index.phtml"><area shape="RECT" coords="91,27,149,39" href="javascript:window.external.AddFavorite('http://www.blitz-school.info', 'GameSchool - Центр обучения созданию компьютерных игр!')"></map>
            <div class="searchform" align="right">
            <form method="post"><input value="search" name="do" type="hidden">&nbsp;</form>
            </div>
            </td>
            <td height="49" width="13"><img height="49" src="index_files/mlefttop.png" width="13" border="0"></td>
          </tr>
        </tbody>
      </table>
      </td>
    </tr>
    <tr>
      <td height="148" valign="top" width="225">
      <table cellpadding="0" cellspacing="0" height="148" width="100%">
        <tbody>
          <tr>
            <td height="119" width="225"><a title="Центр обучения созданию компьютерных игр" href="index.phtml"><img height="119" src="index_files/title.png" width="225" border="0"></a></td>
          </tr>
          <tr>
            <td background="index_files/date_b.png" valign="bottom">
            <div class="date" style="FONT-SIZE: 11px; MARGIN-BOTTOM: 10px; MARGIN-LEFT: 12px">
            <script language="JavaScript1.2">
<!-- Begin
var months=new Array(13);
months[1]="января";
months[2]="февраля";
months[3]="марта";
months[4]="апреля";
months[5]="мая";
months[6]="июня";
months[7]="июля";
months[8]="августа";
months[9]="сентября";
months[10]="октября";
months[11]="ноября";
months[12]="декабря";
var time=new Date();
var lmonth=months[time.getMonth() + 1];
var date=time.getDate();
var year=time.getYear();
var hours=time.getHours();
var minutes=time.getMinutes();
if (eval(hours) <10) {hours="0"+hours}
if (eval(minutes) < 10) {minutes="0"+minutes}
if (year < 2000)
year = year + 1900;
document.write("Сейчас: " + date + " ");
document.write(lmonth + " " + year + ", " + hours + ":" + minutes + " ");

// End -->

           </script>
            </div>
            </td>
          </tr>
        </tbody>
      </table>
      </td>
      <td width="296"><img height="148" src="index_files/mainleft.jpg" width="296" border="0"></td>
      <td width="205"><img height="148" src="index_files/mainright.jpg" width="205" border="0"></td>
      <td background="index_files/mback.png">&nbsp;</td>
      <td height="148" width="58"><img height="148" src="index_files/mltopr.png" width="58" border="0"></td>
    </tr>
  </tbody>
</table>
<table bordercolordark="black" bordercolorlight="black" cellpadding="0" cellspacing="0" width="100%">
  <tbody>
    <tr>
      <td background="index_files/anek_tb.png" height="27" valign="top" width="254">
      <div class="lefttext"><b>Меню:</b></div>
      </td><?php include 'menu_top.php'; ?> <td background="index_files/nav_back.gif">&nbsp;</td>
      <td width="17"><img height="27" src="index_files/nav_end.png" width="17" border="0"></td>
    </tr>
  </tbody>
</table>
<table cellpadding="0" cellspacing="0" width="100%">
  <tbody>
    <tr>
      <td background="index_files/lefttable.gif" valign="top" width="254"><!-- Menu -------->
      <div style="MARGIN-LEFT: 21px">
      <table cellpadding="0" cellspacing="0">
        <tbody>
          <tr>
            <td background="index_files/tb_back.gif">
            <div class="style3"><img src="index_files/home.gif"><a href="http://www.blitz-school.info/index.phtml">Главная</a><br>

        <img src="index_files/pages.gif"> <b>Перечень курсов</b><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/blitzindex.phtml">Создание 3D игр на Blitz3D</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/ogindex.phtml">Создание браузерной РПГ</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/egindex.phtml">Создание экономической браузерки</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/mgindex.phtml">Создание мобильных игр</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/cppindex.phtml">Создание 3D игр на С++</a><br>
        <img src="index_files/group.gif"> <a href="http://www.blitz-school.info/begin_study.phtml">Как стать слушателем</a><br>
        <img src="index_files/recom.gif"> <a href="http://www.blitz-school.info/study_tech.phtml">Технология обучения</a><br>
        <img src="index_files/loyalty_sm.jpg"> <a href="http://www.blitz-school.info/loyalty.phtml">Программа лояльности</a>
        <br>
&nbsp;&nbsp;&nbsp;&nbsp;
    <img border="0" src="index_files/navdiv.gif" width="80" height="4">
        <br><img src="index_files/newuser.gif"> <b>Регистрация</b><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/reg.phtml">Курс 3D игр на Blitz3D</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/reg2.phtml">Курс браузерной RPG</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/reg3.phtml">Экономическая браузерка</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/reg4.phtml">Курс мобильных игр</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/reg5.phtml">3D игры на С++</a><img src="index_files/new.gif"><br>
        <img src="index_files/admin.gif"> <a href="http://www.blitz-school.info/login.phtml">Вход для слушателей</a><br>
        <img src="index_files/study.gif"> <a href="http://www.blitz-school.info/program.phtml">Учебные программы курсов</a><br>
        <img src="index_files/society.gif"> <a href="http://www.blitz-school.info/response.phtml">Отзывы</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;
    <img border="0" src="index_files/navdiv.gif" width="80" height="4">
        
        <br><img src="index_files/media.gif"> <a href="http://www.blitz-school.info/distant.phtml">О дистанционном образовании</a><br>
        <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/articles.phtml">Статьи</a><br>
        <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/less_ex.phtml">Изложение материала</a><br>
        <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/gallery.phtml">Галерея</a><br> 
        <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/links.phtml">Полезные ссылки</a><br>
        <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/contacts.phtml">Контакты</a><br>
       <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/friends.phtml">Обмен ссылками</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;

            </div>
            </td>
          </tr>
          <tr>
            <td width="222"><img height="8" src="index_files/tb_b.gif" width="222" border="0"></td>
          </tr>
        </tbody>
      </table>
      </div><!-- ------------------ end of menu ------------------- --> </td>
      <td class="news" valign="top">
      <script language="javascript" type="text/javascript">
      </script>
      <div style="MARGIN-TOP: 7px">
      <table cellpadding="0" cellspacing="0" width="100%">
        <tbody>
          <tr>
            <td width="13"><img height="24" src="index_files/m_left.gif" width="13" border="0"></td>
            <td class="newstitle" background="index_files/m_center.gif">
            <b>Занятие
			10</b></td>
            <td class="newstitle" align="right" background="index_files/m_center.gif">&nbsp;</td>
            <td width="9"><img height="24" src="index_files/m_right.gif" width="9" border="0"></td>
          </tr>
        </tbody>
      </table>
      <table cellpadding="0" cellspacing="0" width="100%">
        <tbody>
          <tr>
            <td background="index_files/m_left_m.gif" width="4">&nbsp;</td>
            <td class="newsbody" bgcolor="#fdfdfd">
			<p>
            <font size="3"><b><br>
			Герои и оазисы<br>
			</b></font>
            <br>
            <font color="#4775A5">
            <span lang="en-us"><b>1</b></span><b>0</b></font><b><font color="#4775a5">.1. 
			</font><font color="#4775A5">Таблица героев</font><br>
            <br>
&nbsp;</b><span lang="en-us">&nbsp;</span>Доброго дня, уважаемый коллега и мы 
			сегодня приступает к завершающей лекции нашего курса. Настало время 
			поговорить о героях. Конечно же во всех сражениях есть свои герои и 
			шанс стать героем есть у каждого, даже самого рядового воина! 
			Поэтому в нашей игре (как, собственно и в реальной игре
			<span lang="en-us"><a href="http://travian.ru/" target="_blank">Travian</a></span>)<span lang="en-us">
			</span>герои создаются из обычных регулярных войск. Мы можем создать 
			героя из солдата легионера или из Кавалериста конницы Цезаря - никто 
			нам не помешает это сделать. И конечно же делать мы это будем в 
			Таверне:<br>
			<br>
			<img border="0" src="www/img/vill/g37.gif" width="75" height="80"><br>
			<br>
			Но, для начала, нам с Вами нужно обзавестись таблицей в базе
			<span lang="en-us">travgame</span>, где мы будем вести учет всех 
			героев, если таковые будут создаваться игроками в своих поселках. 
			Назовем мы эту таблицу <b>heroes</b>.<br>
			</p>
<pre class="brush: sql;">/*----------- Таблица героев --------------*/
/* будем хранить и очки к параметрам героя и сами парметры */
CREATE TABLE `heroes` (
hr_id bigint(20) unsigned NOT NULL auto_increment, /*ID*/
fid bigint(20), /*откуда? и принадлежность поселку*/
sa_id INT, /* тип героя из spr_army */ 

sa_attack int, /* атака героя*/ 
sa_inf_defence int, /* защита от пехоты */ 
sa_cav_defence int, /* защита от конницы */
hr_attack_bonus int default 0, /* % к атаке всей армии*/
hr_defence_bonus int default 0, /* % к защите всей армии*/
hr_regeneration INT default 0, /* скорость восстановление героя*/

sa_attack_pts int default 0, /* очки к атаке героя*/ 
sa_defence_pts int default 0, /* очки к любой защита */ 
hr_attack_bonus_pts int default 0, /* очки к атаке всей армии*/
hr_defence_bonus_pts int default 0, /* очки к защите всей армии*/
hr_regeneration_pts INT default 0, /* очки к скорости восстановление героя*/

hr_points int default 5, /* очки распределения */
hr_start_time bigint DEFAULT 0, /*начало создания/восстановления героя*/ 
hr_end_time bigint DEFAULT 0, /*начало создания/восстановления героя*/ 
hr_level int default 0, /* уровень героя */ 
hr_experience int default 0, /* текущий опыт, за убитых врагов */ 
hr_state int DEFAULT 1, /* живой ли герой? 1-да, 0-нет*/ 
hr_health int default 100, /* здоровье героя */ 
PRIMARY KEY (`hr_id`) 
) ENGINE=MyISAM DEFAULT CHARSET=cp1251;
</pre>Фрагмент 10.1.1<p>
            <b>hr_id</b> - уникальный идентификатор героя в таблице <b>heroes</b>
			<br>
			<b>fid</b> - принадлежность героя к поселку игрока (таблица <b>
			<span lang="en-us">fields</span></b>)<br>
			<b>sa_id</b> <span lang="en-us">- </span>тип войска из которого 
			сделан герой (например - легионер)<br>
			<b>sa_attack</b> - сила атаки героя <br>
			<b>sa_inf_defence</b> - сила защиты героя от пехоты (можно повышать 
			в таверне)<br>
			<b>sa_cav_defence</b> -&nbsp; сила защиты героя от кавалерии (можно 
			повышать в таверне) <br>
			<b>hr_attack_bonus</b> - бонус к атаке всей армии, в которой 
			находится герой <br>
			<b>hr_defence_bonus</b> - бонус к защите всей армии, в которой 
			находится герой <br>
			<b>hr_regeneration</b>&nbsp; - скорость регенерации здоровья героя<br>
			<b>sa_attack_pts</b> - очки,, вложенные в характеристику атаки<br>
			<b>sa_defence_pts</b> - очки,&nbsp; вложенные в характеристику 
			защиты<br>
			<b>hr_attack_bonus_pts</b> - очки, вложенные в характеристику бонуса 
			к атаке всей армии <br>
			<b>hr_defence_bonus_pts</b> - очки, вложенные в характеристику 
			бонуса к защите всей армии <br>
			<b>hr_regeneration_pts</b> - очки, вложенные в скорость регенерации 
			героя <br>
			<b>hr_points</b> - нераспределенные очки <br>
			<b>hr_start_time</b> - время начала тренировки или восстановления 
			героя после гибели <br>
			<b>hr_end_time</b> - время завершения&nbsp; тренировки или 
			восстановления героя после гибели <br>
			<b>hr_level</b> - уровень героя<br>
			<b>hr_experience</b> - текущий опыт героя<br>
			<b>hr_state</b> - состояние героя (живой 1-да, 0-нет) <br>
			<b>hr_health</b> - % здоровья героя (если 100% - герой полностью 
			здоров) <br>
			<br>
			<br>
			Как же герой зарабатывает себе опыт! Все очень просто. Если героя 
			присоединить к армии, то во время сражения он получает опыт исходя 
			из формулы: количество убитых врагов армией, в которой состоит герой 
			умножить на 2. При достижении определенного количества очков опыта, 
			герой переходит на следующий уровень и ему дается 5 очков для 
			распределения в характеристики. Кто-то захочет распределить их в 
			атаку, кто-то в защиту - это уже дело самого игрока. <br>
			<br>
			Кроме выше представленной таблицы у нас с Вами должна быть 
			справочная таблица по затратам ресурсов и времени на создание или 
			восстановление героя для разных типов войск. Назовем ее <b>
			hero_resurection</b>. Вот она:<br>
			</p>
<pre class="brush: sql;">-- Стоимость и время создания/восстановления героя определенного типа --
CREATE TABLE `hero_resurection` (
hrs_id bigint(20) unsigned NOT NULL auto_increment, /*ID*/
sa_id bigint(20), /* тип армии */
hrs_level INT, /*уровень этого типа войск*/
hrs_wood INT default 0, /* ресурсы .... */
hrs_clay INT default 0,
hrs_ore INT default 0, 
hrs_grain INT default 0,
hrs_training_time CHAR(20), /*время создания/восстановления*/
PRIMARY KEY (`hrs_id`) 
) ENGINE=MyISAM DEFAULT CHARSET=cp1251;
</pre>Фрагмент 10.1.2<p>
            Структура этой таблицы проста и понятна и мы сейчас заполним ее 
			данными хотя бы частично:<br>
			</p>
<pre class="brush: sql;">-- добавим в качестве примера по 2 уровня для всех возможных стать героями типов войск
/*легионер*/
insert into hero_resurection(sa_id,hrs_level,hrs_wood,hrs_clay,hrs_ore,hrs_grain,hrs_training_time) values (1,0,240,200,360,80,'0:00:10');
insert into hero_resurection(sa_id,hrs_level,hrs_wood,hrs_clay,hrs_ore,hrs_grain,hrs_training_time) values (1,1,640,550,930,260,'1:46:00');
insert into hero_resurection(sa_id,hrs_level,hrs_wood,hrs_clay,hrs_ore,hrs_grain,hrs_training_time) values (1,2,1100,910,1500,430,'2:40:00');
/*преторианец*/
insert into hero_resurection(sa_id,hrs_level,hrs_wood,hrs_clay,hrs_ore,hrs_grain,hrs_training_time) values (2,0,200,260,320,140,'0:58:40');
insert into hero_resurection(sa_id,hrs_level,hrs_wood,hrs_clay,hrs_ore,hrs_grain,hrs_training_time) values (2,1,550,690,830,400,'1:57:00');
insert into hero_resurection(sa_id,hrs_level,hrs_wood,hrs_clay,hrs_ore,hrs_grain,hrs_training_time) values (2,2,910,1100,1400,670,'2:56:00');
/*Империанец*/
insert into hero_resurection(sa_id,hrs_level,hrs_wood,hrs_clay,hrs_ore,hrs_grain,hrs_training_time) values (3,0,300,320,420,160,'1:04:00');
insert into hero_resurection(sa_id,hrs_level,hrs_wood,hrs_clay,hrs_ore,hrs_grain,hrs_training_time) values (3,1,780,830,1100,450,'2:08:00');
insert into hero_resurection(sa_id,hrs_level,hrs_wood,hrs_clay,hrs_ore,hrs_grain,hrs_training_time) values (3,2,1300,1400,1800,750,'3:12:00');
/*Конница императора*/
insert into hero_resurection(sa_id,hrs_level,hrs_wood,hrs_clay,hrs_ore,hrs_grain,hrs_training_time) values (5,0,1100,880,640,200,'1:28:00');
insert into hero_resurection(sa_id,hrs_level,hrs_wood,hrs_clay,hrs_ore,hrs_grain,hrs_training_time) values (5,1,2700,2200,1600,550,'2:56:00');
insert into hero_resurection(sa_id,hrs_level,hrs_wood,hrs_clay,hrs_ore,hrs_grain,hrs_training_time) values (5,2,4500,3600,2600,910,'4:24:00');
/*Конница Цезаря*/
insert into hero_resurection(sa_id,hrs_level,hrs_wood,hrs_clay,hrs_ore,hrs_grain,hrs_training_time) values (6,0,1100,1300,1600,360,'1:57:20');
insert into hero_resurection(sa_id,hrs_level,hrs_wood,hrs_clay,hrs_ore,hrs_grain,hrs_training_time) values (6,1,2700,3100,3900,930,'3:54:40');
insert into hero_resurection(sa_id,hrs_level,hrs_wood,hrs_clay,hrs_ore,hrs_grain,hrs_training_time) values (6,2,4500,5200,6400,1500,'5:52:00');

</pre>Фрагмент 10.1.3<p>
            Теперь у нас есть возможность создавать героя из любых доступных 
			типов войск, к чему мы и приступим в следующем пункте. Но в начале 
			давайте сделаем функцию проверки, есть ли у нас герой в поселке или 
			нет?</p>


<pre class="brush: php;">
////// а есть ли герой в поселке? ////////////
function hero_exists( $fid ){
 $result = mysql_query(&quot;SELECT hr_id from heroes
 where fid=$fid&quot; ) 
 or die(&quot;Query failed : &quot; . mysql_error());
 $num_rows = mysql_num_rows( $result );
 return( $num_rows &gt; 0 );
}
</pre>
			Фрагмент 10.1.4<p>
            В этой функции мы просто обращаемся к таблице <b>heroes</b> и если в 
			ней есть данные для героя в указанном поселке (fid), значит вернем
			<span lang="en-us">true</span>, иначе - вернем <span lang="en-us">
			false. </span>Так как у нас нет героев и потому эта функция будет 
			возвращать нам <span lang="en-us">false.</span><br>
			<br>
			<font color="#4775A5"><b><span lang="en-us"><br>
			</span>10</b></font><b><font color="#4775a5">.2. 
			</font></b><font color="#4775A5"><b>Таверна 10 уровня<br>
			<br>
			</b></font>&nbsp;&nbsp; Помнится на прошлых занятиях, когда мы 
			построили Таверну, то заходя в нее игрок видел лишь унылую надпись 
			&quot;В настоящий момент в деревне нет воинов, которые могли бы стать 
			героями&quot;. Сейчас мы расширим функционал шаблона <b>
			<span lang="en-us">tpl_g37.php</span></b>, который отвечает за 
			&quot;вход&quot; в здание Таверны. И это расширения функционала мы опишем в 
			нескольких фрагментах кода, потому что он довольно объемен. Для 
			начала мы должны выбрать из кого создавать героя. Согласно нашему 
			скрипту <span lang="en-us"><b><font color="#16616B">travgame.sql</font></b>
			</span>у нас в поселке есть легионеры, поэтому, давайте из них и 
			создавать. В принципе, нет разницы из какого типа войск делать героя 
			- у игрока должна быть возможность создавать героя из любого типа 
			войск. Итак, вот фрагмент шаблона <b><span lang="en-us">tpl_g37.php</span></b>, 
			который отвечает за выбор игроком типа войска для тренировки героя:</p>


<pre class="brush: php;">
// Таверна

if( !hero_exists( $fid ) ){
$res = mysql_query(&quot;SELECT sa.sa_id, sa_name, sa_image,
hrs_grain, hrs_ore, hrs_wood, hrs_clay, hrs_training_time
from spr_army sa
inner join army ar on ar.sa_id = sa.sa_id
inner join hero_resurection hrs on hrs.sa_id = ar.sa_id 
where sr_qty &gt; 0 and sr_enable = 1 and hrs.hrs_level = 0 and fid=$fid&quot; )
or die(&quot;Query failed : &quot; . mysql_error());

$num_rows = mysql_num_rows( $res );
if( $num_rows &gt; 0 ){
echo '&lt;table style=&quot;border-collapse: collapse;&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; id=&quot;army&quot;&gt;&lt;tr&gt;
&lt;td width=&quot;300&quot; class=&quot;tabhead&quot;&gt;Список возможных героев&lt;/td&gt;
&lt;td class=&quot;tabhead&quot;&gt;Действие&lt;/td&gt;
&lt;/tr&gt;';

while ($row = mysql_fetch_array( $res )) {
 $atype = $row[&quot;sa_id&quot;]; // какой тип войска
 echo '&lt;tr&gt;&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;'.$row[&quot;sa_image&quot;].'&quot;&gt;&lt;a href=&quot;#&quot;&gt;'.$row[&quot;sa_name&quot;].'&lt;/a&gt; &lt;br&gt;';
 echo '&lt;img src=&quot;img/res/grain.png&quot;&gt;'.$row[&quot;hrs_grain&quot;].' &lt;img src=&quot;img/res/ore.png&quot;&gt;'.$row[&quot;hrs_ore&quot;].' &lt;img src=&quot;img/res/wood.png&quot;&gt;'.
$row[&quot;hrs_wood&quot;].' &lt;img src=&quot;img/res/clay.png&quot;&gt;'.$row[&quot;hrs_clay&quot;].' &lt;img src=&quot;img/res/time.png&quot;&gt; '.$row[&quot;hrs_training_time&quot;].'&lt;/td&gt;'; 
 echo '&lt;td class=&quot;armyinfo&quot;&gt;'; 
 if( allow_resurect( $fid, $atype ) ){
  echo '&lt;a href=&quot;#&quot; onClick=&quot;do_resurect('.$atype.')&quot;&gt;Подготовить&lt;/a&gt;';
 } else {
  echo '&lt;font color=&quot;#CCCCCC&quot;&gt;Не хватает сырья&lt;/font&gt;';
 }
 echo '&lt;/td&gt;';
 echo '&lt;/tr&gt;';
}
echo '&lt;/table&gt;';
echo '&lt;br&gt;';
} else {
 echo '&lt;table style=&quot;border-collapse: collapse;&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; id=&quot;army&quot;&gt;&lt;tr&gt;
 &lt;td width=&quot;450&quot; class=&quot;tabhead&quot;&gt;Герой&lt;/td&gt;
 &lt;tr&gt;
 &lt;td width=&quot;450&quot; class=&quot;armyinfo&quot;&gt;&lt;font color=&quot;#CCCCCC&quot;&gt;В настоящий момент в деревне нет воинов, которые могли бы стать героями.&lt;/font&gt;&lt;/td&gt;
 &lt;tr&gt;
 &lt;/table&gt;';
}

} else {   
// если герой есть - рассмотрим чуть ниже
}
</pre>
    
    
			Фрагмент 10.2.1<p>
            Как Вы видите из этого фрагмента - в строке 3 мы сразу узнаем, есть 
			ли герой. Пока его нет и далее в запросе к таблицам <b>army</b> , <b>spr_army</b> 
			и <b>hero_resurection</b> мы извлекаем данные по войскам, которые 
			есть у нас в поселке. Для создания героя нужен хотя бы один 
			представитель какого-либо типа войск. Еще этот запрос возвращает нам 
			данные по затратам на создание героя 0 уровня по имеющимся в поселке 
			типам войск. Если у нас есть из кого подготовить героя, мы создаем 
			ссылку &quot;Подготовить&quot; с вызовом <span lang="en-us">JavaScript </span>
			функции <font color="#3B84D0">do_resurect</font> (строка 26). Если 
			не из кого - выдаем уже знакомое Вам сообщение - &quot;В настоящий момент в деревне нет воинов, которые могли бы стать героями.&quot; 
			(строка 39). Всю эту информацию мы старательно выводим в виде
			<span lang="en-us">HTML </span>таблицы<span lang="en-us"> </span>в 
			окно браузера и получается у нас следующее:<br>
			<br>
			<img border="0" src="pics/tav.png" width="529" height="349"><br>
			Рисунок 10.2.1<br>
			<br>
			Итак у нас есть легионеры, значит из них и будем создавать нашего 
			героя в следующем пункте занятия.<br>
			<br>
            <br><font color="#4775A5"><b>10</b></font><font color="#4775a5"><font ><b>.3. 
			Тренировка героя
     </b></font><br></font>
            <br>
&nbsp;&nbsp; В принципе подготовка героя ничем не должна отличаться от его 
			восстановления после гибели - те же затраты, которые мы определяем 
			исходя из уровня героя по таблице <b>hero_resurection</b>. Итак, 
			игрок нажимает на ссылку &quot;Подготовить&quot; (рисунок 10.2.1) и у нас 
			срабатывает <span lang="en-us">JavaScript </span>функция
			<font color="#3B84D0">do_resurect</font><span lang="en-us">, </span>
			которая приведена ниже:</p>
<pre class="brush: js;">// Создаем или восстанавливаем героя
function do_resurect( atype ){
url=window.location.href;
if(url.indexOf('?')!=-1){
newurl = url.split('?')
params = newurl[1];
}
location.href=&quot;build.php?&quot;+params+&quot;&amp;hero=&quot;+atype; 
}

</pre>Фрагмент 10.3.1<p>
            Эта функция, кроме параметров, которые еже были в адресной 
			<span lang="en-us">c</span>троке<span lang="en-us"> </span>браузера 
			и которые она заботливо сохранила в переменной params , передает 
			также тип войска создаваемого героя&nbsp; в параметре
			<span lang="en-us">&amp;</span>hero в файл <b>build.php</b>.<span lang="en-us">
			</span>А<span lang="en-us"> </span><b>build.php </b>не долго думая, 
			обрабатывает эти данные следующим образом:</p>


<pre class="brush: php;">
// задали создание или востановление героя
if( isset( $_GET[&quot;hero&quot;] ) ){
init_resurect_hero( $fid, $_GET[&quot;hero&quot;] );
}
</pre>
			Фрагмент 10.3.2<p>
            В этом фрагменте, при условии передачи параметра <span lang="en-us">
			&amp;</span>hero осуществляется вызов <span lang="en-us">PHP </span>
			функции <font color="#3B84D0">init_resurect_hero</font>, которую мы 
			должны с Вами создать. Вот эта функция<span lang="en-us">:</span></p>


<pre class="brush: php;">
////////////// Создаем или восстанавливаем героя //////////////////
function init_resurect_hero( $fid, $atype ){
      $result = mysql_query("SELECT hr_id, hr_level, hrs_training_time,
                             hrs_wood, hrs_clay, hrs_ore, hrs_grain,
                             hr_end_time
                             from heroes h
                             inner join hero_resurection hrs on hrs.sa_id=h.sa_id and hrs.hrs_level=h.hr_level
                             where fid=$fid" ) 
                             or die("Query failed : " . mysql_error());
      $num_rows = mysql_num_rows( $result );

      if( $num_rows > 0 ) {  // герой есть и его нужно восстановить
          $row = mysql_fetch_array( $result );
          $hr_id = $row["hr_id"];
          $hrs_wood = $row["hrs_wood"];
          $hrs_clay = $row["hrs_clay"];
          $hrs_ore = $row["hrs_ore"];
          $hrs_grain = $row["hrs_grain"];
          $training_time = $row["hrs_training_time"];

          $end_time = $row["hr_end_time"];  // а вдруг герой уже создается/восстанавливается?

      } else {    // героя нет и его нужно создать!
                  // и попутно узнать характиристики 
      $result = mysql_query("SELECT hrs_training_time,
                             hrs_wood, hrs_clay, hrs_ore, hrs_grain,
                             sa_attack, sa_inf_defence, sa_cav_defence
                             from hero_resurection hrs
                             inner join spr_army sa on sa.sa_id=hrs.sa_id
                             where hrs.sa_id=$atype and hrs.hrs_level=0" ) 
                             or die("Query failed : " . mysql_error());
          $row = mysql_fetch_array( $result );
          $hrs_wood = $row["hrs_wood"];
          $hrs_clay = $row["hrs_clay"];
          $hrs_ore = $row["hrs_ore"];
          $hrs_grain = $row["hrs_grain"];
          $training_time = $row["hrs_training_time"];
          $sa_attack = $row["sa_attack"];
          $sa_inf_defence = $row["sa_inf_defence"];
          $sa_cav_defence = $row["sa_cav_defence"];

          // создадим героя!
          $result = mysql_query( "insert into heroes(fid,sa_id,sa_attack,sa_inf_defence,sa_cav_defence,hr_state) 
                      values($fid,$atype,$sa_attack,$sa_inf_defence,$sa_cav_defence,0)" ) 
                             or die("Query failed : " . mysql_error());
          $hr_id = mysql_insert_id();

      }

     // проверим повторный запрос создания/восстановления героя?
     $cur_time = time();
     if( $cur_time > $end_time ){

         // уменьшим ресы у игрока заказавшего создание/восстановление героя
         $res = mysql_query("UPDATE fields 
                       set f_wood=f_wood-$hrs_wood, f_clay=f_clay-$hrs_clay, 
                       f_ore=f_ore-$hrs_ore, f_grain=f_grain-$hrs_grain
                       where fid=$fid"  )
                or die("Query failed : " . mysql_error());


         // Зададим временные точки создания/восстановления героя
         $start_time = time();
         $end_time = $start_time+h2s( $training_time );
         $res = mysql_query("UPDATE heroes 
                   set hr_start_time=$start_time, hr_end_time=$end_time
                   where hr_id=$hr_id"  )
           or die("Query failed : " . mysql_error());
     }
     // теперь остается ждать :) 
}

</pre>
			Фрагмент 10.3.<span lang="en-us">3</span><p>Для упрощения нашей с 
			Вами задачи, мы будем иметь возможность создавать только одного 
			героя для поселка. В выше представленном фрагменте в запросе к 
			таблицам <b>heroes</b> и <b>hero_resurection</b> (строки 3-8) мы 
			узнаем факт существования героя у нас в поселке. Если запрос вернет 
			строк больше чем 0 (строка 12) значит герой есть и нужно его 
			восстановить. Попутно мы сохраняем в переменные все необходимые 
			данные по затратам на этот процесс ресурсов и времени (строки 
			13-21).<br>
			Если же героя нет (условие в строке 23), мы делаем запрос к таблицам
			<b>hero_resurection</b> и <b>spr_army</b> (строки 25-30), чтоб, 
			кроме ресурсных и временных затрат на подготовку героя (строки 
			33-37), мы также знали его стартовые характеристики (атака и 2 вида 
			защиты), которые мы унаследуем от его типа войска. То есть, тренируя 
			героя из легионера, в качестве базовых мы берем атаку и защиту (от 
			пехоты и кавалерии) у типа войска- легионер (строки 38-40). Вот для 
			чего нам нужна была в этом запросе таблица <b>spr_army</b>. В 
			строках 43-46 мы создаем героя и сохраняем его идентификатор, 
			который ему присвоился в<span lang="en-us"> </span>базе данных в 
			таблице <span lang="en-us"><b>heroes</b>.</span> Конечно же мы его 
			создаем со статусом hr_state=0, то есть пока что герой еще не 
			активен. В строках 50-69 мы уменьшаем количество ресурсов на 
			величину затрачиваемых на подготовку героя ресурсов и задаем время 
			начала подготовки и время его окончания. Как Вы видите, ранее у нас 
			были отдельные таблицы для всякого рода апгрейдов, улучшений и т.д., 
			а так как герой у нас один для одного поселка - то можно обойтись 
			только таблицей <span lang="en-us"><b>heroes</b></span> (поля hr_start_time 
			и hr_end_time).<br>
			Как водится в этих случаях, игроку неплохо было бы показать, сколько 
			времени осталось до конца подготовки героя и мы сделаем это в 
			функции <font color="#3B84D0">show_resurect_progress</font>. Вот как 
			выглядит эта функция:</p>


<pre class="brush: php;">
/////////// показывает таймер создания/восстановления героя //////////
function show_resurect_progress( $fid ){
Global $bnum;
$cnt = 0;
$result = mysql_query(&quot;SELECT hr_start_time, hr_end_time from heroes
where fid=$fid and hr_state=0&quot; ) 
or die(&quot;Query failed : &quot; . mysql_error());
$num_rows = mysql_num_rows( $result );
if( $num_rows &gt; 0 ){
$script = &quot;&quot;;
$row = mysql_fetch_array( $result );
$time_s = $row[&quot;hr_start_time&quot;];
$time_e = $row[&quot;hr_end_time&quot;];

echo '&lt;b&gt;Герой поступит в Ваше распоряжение через: &lt;span id=&quot;restimer'.$cnt.'&quot;&gt;&lt;/span&gt; в '.date('H:i',$time_e).'&lt;/b&gt;&lt;br&gt;';
$rest = s2h($time_e-time());
$hms = explode(':', $rest); 
$script .= &quot;atimers[$cnt] = [ $hms[0], $hms[1], $hms[2] ]; &quot;; 

echo '&lt;script&gt;';
echo 'url_reload = &quot;?bnum='.$bnum.'&quot;;';
echo $script;
echo 'updateClock(); setInterval(&quot;updateClock()&quot;, 1000 );';
echo '&lt;/script&gt;';
}
}
</pre>
			Фрагмент 10.3.4<p>Что-то подобное мы уже&nbsp; Вами делали и не раз. 
			Вот как выглядит результат:<br>
			<br>
			<img border="0" src="pics/hpkv.png" width="544" height="280"><br>
			Рисунок 10.3.1<br>
			<br>Последнее, что мы должны сделать - отследить, когда наступит 
			событие завершения подготовки героя и поступление его к нам в 
			распоряжение. Для этих целей мы сделаем функцию с именем
			<font color="#3B84D0">update_hero_resurect</font>. Ее листинг 
			представлен чуть ниже:</p>


<pre class="brush: php;">
///////// проверка восстановления героя //////////////
function update_hero_resurect( $fid ){
// что у нас с героем?
$res = mysql_query(&quot;SELECT hr_id, hr_start_time, hr_end_time from heroes
where fid=$fid&quot;)
or die(&quot;Query failed : &quot; . mysql_error());
$num_rows = mysql_num_rows( $res );
 if( $num_rows &gt; 0 ){

  $cur_time = time();
  $row = mysql_fetch_array( $res );
  $hr_id = $row[&quot;hr_id&quot;];
  $time_e = $row[&quot;hr_end_time&quot;];

  if( $time_e &lt;= $cur_time ){ 
   $result = mysql_query(&quot;update heroes
   set hr_state=1
   where hr_id=$hr_id&quot; ) 
   or die(&quot;Query failed : &quot; . mysql_error()); 
   // и кроме этого засунем его в армию 
   $result = mysql_query(&quot;UPDATE army set sr_qty=1 where sa_id=11 and fid=$fid&quot; ) 
   or die(&quot;Query failed : &quot; . mysql_error());
  }
 }
}

</pre>
			Фрагмент 10.3.5<br>
			<br>
			Из запроса к таблице <b>heroes</b> (строки 4-5) мы получаем данные 
			по времени завершения подготовки героя (если таковой имеется) и если 
			время завершения меньше текущего - в строках 16-18 мы установим&nbsp; 
			ему статус <b><font color="#4775A5">hr_state=1</font></b> (активен), 
			а в запросе (строки 21-22) мы добавим его в нашу армию. Но для этого 
			мы чуть модифицируем <span lang="en-us">SQL</span> процедуру
			<font color="#3B84D0">makearmy</font>, добавив в нее еще одну 
			строку:<br>
<pre class="brush: sql;">insert into army (sa_id,sr_qty,sr_enable,fid) VALUES (11,0,1,p_fid); /*тип 11-герой (не имеет соотв. в spr_army)*/;
</pre>Фрагмент 10.1.2<br>
			<br>
			Теперь нам будет ясно, что если sr_qty для типа войска - sa_id=11 
			больше нуля, значит в армии есть герой и уже дальше о нем можно 
			получить информацию из таблицы <span lang="en-us"><b>heroes</b>.</span><br>
			<br>
			Как Вы помните, в этой таблице <b><span lang="en-us">heroes</span>
			</b>есть множество полей, описывающих нашего героя и теперь нам 
			необходимо научиться распределять очки в какие-нибудь параметры 
			героя, чтоб делать его сильнее и полезнее для нашей армии. Сейчас мы 
			приведем еще одну часть шаблона <b>
			<span lang="en-us">tpl_g37.php</span></b>, которая выведет на 
			страницу браузера таблицу с характеристиками героя (если герой есть) 
			и даст возможность распределять имеющиеся очки (hr_points<span lang="en-us">
			</span>в таблице <b><span lang="en-us">heroes</span> </b>) в нужные 
			параметры героя.<pre class="brush: php;">
 } else { // герой уже есть!

$result = mysql_query(&quot;SELECT sa.sa_name, h.sa_attack, h.sa_inf_defence, h.sa_cav_defence, 
hr_attack_bonus, hr_defence_bonus, hr_regeneration, hr_points,
hr_level, hr_experience, hr_state, hr_points, hr_health,
sa_attack_pts, sa_defence_pts, hr_attack_bonus_pts, hr_defence_bonus_pts, hr_regeneration_pts
from heroes h
inner join spr_army sa on sa.sa_id=h.sa_id
where fid=$fid&quot; ) 
or die(&quot;Query failed : &quot; . mysql_error());
$row = mysql_fetch_array( $result );
$sa_name = $row[&quot;sa_name&quot;]; // какого типа герой?
$sa_attack = $row[&quot;sa_attack&quot;]; // атака
$sa_inf_defence = $row[&quot;sa_inf_defence&quot;]; // защита от пехоты
$sa_cav_defence = $row[&quot;sa_cav_defence&quot;]; // защита от кавалерии
$hr_attack_bonus = $row[&quot;hr_attack_bonus&quot;]; // бонус атаки армии
$hr_defence_bonus = $row[&quot;hr_defence_bonus&quot;]; // бонус защиты армии
$hr_regeneration = $row[&quot;hr_regeneration&quot;]; // восстановление в сутки
$hr_level = $row[&quot;hr_level&quot;]; // уровень героя
$hr_experience = $row[&quot;hr_experience&quot;]; // очки опыта
$hr_state = $row[&quot;hr_state&quot;]; // жив? 0-нет,1-да
$hr_health = $row[&quot;hr_health&quot;]; // здоровье героя

// очки
$hr_points = $row[&quot;hr_points&quot;]; // нераспределенные очки

$sa_attack_pts = $row[&quot;sa_attack_pts&quot;]; // очки атаки
$sa_defence_pts = $row[&quot;sa_defence_pts&quot;]; // очки защиты
$hr_attack_bonus_pts = $row[&quot;hr_attack_bonus_pts&quot;]; // очки к бонусу атаки армии
$hr_defence_bonus_pts = $row[&quot;hr_defence_bonus_pts&quot;]; // очки к бонусу защиты армии
$hr_regeneration_pts = $row[&quot;hr_regeneration_pts&quot;]; // очки к восстановлению в сутки

if( $hr_state == 1 ){
// посчитаем пиксели для progress-bar (168px - max длина)
$sa_attack_pb = 1+(168*($sa_attack_pts-($hr_level*5))*20)/100;
$sa_defence_pb = 1+(168*($sa_defence_pts-($hr_level*5))*20)/100;
$hr_attack_bonus_pb = 1+(168*($hr_attack_bonus_pts-($hr_level*5))*20)/100;
$hr_defence_bonus_pb = 1+(168*($hr_defence_bonus_pts-($hr_level*5))*20)/100;
$hr_regeneration_pb = 1+(168*($hr_regeneration_pts-($hr_level*5))*20)/100;
$exp_pb = 1+168/100*$hr_experience * get_hero_exp_level( $hr_level+1 ) / 100;
?&gt;

&lt;table id=&quot;distribution&quot; class=&quot;distr&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot;&gt;
&lt;tr&gt;
&lt;td class=&quot;trade_bg&quot; colspan=&quot;5&quot;&gt;Герой Уровень &lt;? echo $hr_level.' ('. $sa_name.')'; ?&gt;&lt;/span&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;?
echo '&lt;tr&gt;
&lt;td class=&quot;armyinfo&quot;&gt;Нападение:&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;'.$sa_attack.'&lt;/td&gt;
&lt;td class=&quot;xp&quot;&gt;&lt;img class=&quot;bar&quot; src=&quot;img/x.gif&quot; style=&quot;width:'.$sa_attack_pb.'px;&quot; title=&quot;&lt;? echo $sa_attack; ?&gt;&quot; /&gt;&lt;/td&gt;';
if($hr_points&gt;0)
echo '&lt;td class=&quot;armyinfo&quot;&gt;&lt;a href=&quot;build.php?bnum='.$bnum.'&amp;up=1&quot;&gt;(&lt;b&gt;+&lt;/b&gt;)&lt;/a&gt;&lt;/td&gt;';
else
echo '&lt;td class=&quot;armyinfo&quot;&gt;&lt;span class=&quot;none&quot;&gt;(&lt;b&gt;+&lt;/b&gt;)&lt;/span&gt;&lt;/td&gt;';
echo '&lt;td class=&quot;armyinfo&quot;&gt;'.$sa_attack_pts.'&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&quot;armyinfo&quot;&gt;Защита:&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;'.$sa_inf_defence.&quot;/&quot;.$sa_cav_defence.'&lt;/td&gt;
&lt;td class=&quot;xp&quot;&gt;&lt;img class=&quot;bar&quot; src=&quot;img/x.gif&quot; style=&quot;width:'.$sa_defence_pb.'px;&quot; title=&quot;&quot; /&gt;&lt;/td&gt;';
if($hr_points&gt;0)
echo '&lt;td class=&quot;armyinfo&quot;&gt;&lt;a href=&quot;build.php?bnum='.$bnum.'&amp;up=2&quot;&gt;(&lt;b&gt;+&lt;/b&gt;)&lt;/a&gt;&lt;/td&gt;';
else
echo '&lt;td class=&quot;armyinfo&quot;&gt;&lt;span class=&quot;none&quot;&gt;(&lt;b&gt;+&lt;/b&gt;)&lt;/span&gt;&lt;/td&gt;';
echo '&lt;td class=&quot;armyinfo&quot;&gt;'.$sa_defence_pts.'&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&quot;armyinfo&quot;&gt;Напад.-бонус:&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;'.$hr_attack_bonus.'%&lt;/td&gt;
&lt;td class=&quot;xp&quot;&gt;&lt;img class=&quot;bar&quot; src=&quot;img/x.gif&quot; style=&quot;width:'.$hr_attack_bonus_pb.'px;&quot; title=&quot;&quot; /&gt;&lt;/td&gt;';
if($hr_points&gt;0)
echo '&lt;td class=&quot;armyinfo&quot;&gt;&lt;a href=&quot;build.php?bnum='.$bnum.'&amp;up=3&quot;&gt;(&lt;b&gt;+&lt;/b&gt;)&lt;/a&gt;&lt;/td&gt;';
else
echo '&lt;td class=&quot;armyinfo&quot;&gt;&lt;span class=&quot;none&quot;&gt;(&lt;b&gt;+&lt;/b&gt;)&lt;/span&gt;&lt;/td&gt;';
echo '&lt;td class=&quot;armyinfo&quot;&gt;'.$hr_attack_bonus_pts.'&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&quot;armyinfo&quot;&gt;Защ.-бонус:&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;'.$hr_defence_bonus.'%&lt;/td&gt;
&lt;td class=&quot;xp&quot;&gt;&lt;img class=&quot;bar&quot; src=&quot;img/x.gif&quot; style=&quot;width:'.$hr_defence_bonus_pb.'px;&quot; title=&quot;&quot; /&gt;&lt;/td&gt;';
if($hr_points&gt;0)
echo '&lt;td class=&quot;armyinfo&quot;&gt;&lt;a href=&quot;build.php?bnum='.$bnum.'&amp;up=4&quot;&gt;(&lt;b&gt;+&lt;/b&gt;)&lt;/a&gt;&lt;/td&gt;';
else
echo '&lt;td class=&quot;armyinfo&quot;&gt;&lt;span class=&quot;none&quot;&gt;(&lt;b&gt;+&lt;/b&gt;)&lt;/span&gt;&lt;/td&gt;';
echo '&lt;td class=&quot;armyinfo&quot;&gt;'.$hr_defence_bonus_pts.'&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&quot;armyinfo&quot;&gt;Восстановление:&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;'.$hr_regeneration.'/сутки&lt;/td&gt;
&lt;td class=&quot;xp&quot;&gt;&lt;img class=&quot;bar&quot; src=&quot;img/x.gif&quot; style=&quot;width:'.$hr_regeneration_pb.'px;&quot; title=&quot;&quot; /&gt;&lt;/td&gt;';
if($hr_points&gt;0)
echo '&lt;td class=&quot;armyinfo&quot;&gt;&lt;a href=&quot;build.php?bnum='.$bnum.'&amp;up=5&quot;&gt;(&lt;b&gt;+&lt;/b&gt;)&lt;/a&gt;&lt;/td&gt;';
else
echo '&lt;td class=&quot;armyinfo&quot;&gt;&lt;span class=&quot;none&quot;&gt;(&lt;b&gt;+&lt;/b&gt;)&lt;/span&gt;&lt;/td&gt;';
echo '&lt;td class=&quot;armyinfo&quot;&gt;'.$hr_regeneration_pts.'&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td colspan=&quot;5&quot; class=&quot;empty&quot;&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&quot;armyinfo&quot; title=&quot;до следующего уровня&quot;&gt;Опыт:&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;'.$hr_experience.'%&lt;/td&gt;
&lt;td class=&quot;xp&quot;&gt;&lt;img class=&quot;bar&quot; src=&quot;img/x.gif&quot; style=&quot;width:'.$exp_pb.'px;&quot; title=&quot;&quot; /&gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;'.$hr_points.'&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;';

echo '&lt;br&gt;Ваш герой здоров на &lt;b&gt;'.$hr_health.'&lt;/b&gt;%&lt;br&gt;';

}
} 

</pre>
			Фрагмент 10.3.5<p>Этот фрагмент вначале строит запрос к таблицам <b>
			heroes</b>&nbsp; и <span lang="en-us"><b>spr_army</b> </span>(строки 
			3-9) и получает необходимые данные для отображения затем в виде 
			таблицы, но не просто статичной таблицы, а с управляющими элементами 
			распределения очков. Эта таблица отображается лишь когда герой есть 
			и его статус равен 1, то есть герой находится в активном состоянии. 
			Когда в параметрах героя есть распределенные очки мы показываем эти 
			измененные параметры в виде <span lang="en-us">progress-bar (</span>типа 
			полоски для наглядного представления на сколько этот параметр 
			увеличен и сколько еще его можно увеличивать<span lang="en-us">)</span>. 
			При создании героя 0 уровня ему сразу же дается 5 очков, которые 
			можно вложить в любые доступные характеристики. В нашей табличке, 
			видимой в браузере это можно сделать на ссылки (+) возле 
			соответствующих характеристик. Посмотрите как выглядит результат 
			работы фрагмента 10.3.5:<br>
			<br>
			<img border="0" src="pics/raspr.png" width="553" height="450"><br>
			Рисунок 10.3.2<br>
			<br>
			Вы видите, что нам доступно 5 очков (справа внизу таблицы) для 
			распределения в нападение, защиту, бонусы к защите армии, бонусы к 
			нападению армии или восстановлению героя. Здесь игрок выбирает сам, 
			что ему важнее.<br>Давайте теперь нажмем два раза на
			<font color="#00CC00">(+) </font>&nbsp;напротив характеристики 
			нападения и один раз напротив защиты. Мы увидим следующую картину:<br>
			<br>
			<img border="0" src="pics/raspr2.png" width="538" height="436"><br>.Рисунок 
			10.3.3 <font color="#4775A5"><strong><span lang="en-us"><br>
			<br>
			</span></strong></font>Вы видите, что на против измененных 
			характеристик видны полоски визуализирующие их увеличение, 
			пропорционально числу 5 - то есть 2/5 и 1/5 соответственно (точно 
			сколько очком мы вложили в это увеличение). Такой <span lang="en-us">
			progress-bar </span>рисуется картинкой серого цвета, причем ширина в 
			пикселях этой картинки рассчитывается в строках 34-40 фрагмента 
			10.3.5 (число 168 - это ширина ячейки таблицы, в которой 
			отрисовывается этот <span lang="en-us">progress-bar</span>)<br>
			Еще до распределения очков опыта (рисунок 10.3.2.) мы видим что 
			нападение нашего героя было - 40, а защита 35/50, затем они поменяли 
			свои значения. Как Вы заметили из фрагмента 10.3.5, когда игрок 
			нажимает на <font color="#00CC00">(+) </font>, управление переходит 
			к скрипту <b><span lang="en-us">build.php</span></b>, куда, кроме 
			номера постройки передается еще и параметр <b>&amp;up</b>. Он 
			варьируется от 1 до 5 и определяет, какую характеристику решил 
			поднять игрок. Как же обрабатывается это поднятие характеристики. 
			Смотрите фрагмент шаблона <span lang="en-us">tpl_g37.php</span>, 
			который обрабатывает эту ситуацию ниже:</p>


<pre class="brush: php;">
// задали поднятие характеристик
if( isset( $_GET[&quot;up&quot;] ) ){
  add_skill( $fid, $_GET[&quot;up&quot;] );
}
</pre>
			Фрагмент 10.3.6<p>Вы видите, что поднятием характеристик занимается 
			функция <font color="#3B84D0">add_skill</font>, которая выглядит 
			следующим образом:</p>


<pre class="brush: php;">
////////// задали поднятие характеристики ///////// 
function add_skill( $fid, $up ){
   // что у нас с героем, жив ли он?
   $res = mysql_query("SELECT hr_id, hr_points,
                       sa.sa_attack, sa.sa_inf_defence, sa.sa_cav_defence,
                       sa_attack_pts, sa_defence_pts, hr_attack_bonus_pts, hr_defence_bonus_pts, hr_regeneration_pts
                       from heroes h
                       inner join spr_army sa on sa.sa_id=h.sa_id
                       where fid=$fid and hr_state=1")
                       or die("Query failed : " . mysql_error());
   $num_rows = mysql_num_rows( $res );
   if( $num_rows > 0 ){
       $row = mysql_fetch_array( $res );
       $hr_id = $row["hr_id"];
       $hr_points = $row["hr_points"];

       $sa_attack = $row["sa_attack"];
       $sa_inf_defence = $row["sa_inf_defence"];
       $sa_cav_defence = $row["sa_cav_defence"];

       $sa_attack_pts = $row["sa_attack_pts"];               // очки атаки
       $sa_defence_pts = $row["sa_defence_pts"];             // очки защиты
       $hr_attack_bonus_pts = $row["hr_attack_bonus_pts"];   // очки к бонусу атаки армии
       $hr_defence_bonus_pts = $row["hr_defence_bonus_pts"]; // очки к бонусу защиты армии
       $hr_regeneration_pts = $row["hr_regeneration_pts"];   // очки к восстановлению в сутки

       if( $hr_points > 0 ){  // есть очки распределения?
         if( $up == 1 )  {    /// добавляем очки к атаке
             $att = Round5((2*$sa_attack/3+27.5) * ($sa_attack_pts+1) + 1.25*$sa_attack);
                    $res = mysql_query("UPDATE heroes set sa_attack_pts=sa_attack_pts+1,
                                        sa_attack=$att,
                                        hr_points=hr_points-1 where hr_id=$hr_id")
                       or die("Query failed : " . mysql_error());
         }
         if( $up == 2 )  {    /// добавляем очки к защите
             $def_i = Round5((2*$sa_inf_defence/3 + 27.5)* ($sa_defence_pts+1) + 5*$sa_inf_defence/3);
             $def_c = Round5((2*$sa_cav_defence/3 + 27.5)* ($sa_defence_pts+1) + 5*$sa_cav_defencec/3);
                    $res = mysql_query("UPDATE heroes set sa_defence_pts=sa_defence_pts+1,
                                        sa_inf_defence=$def_i,
                                        sa_cav_defence=$def_c,
                                        hr_points=hr_points-1 where hr_id=$hr_id")
                       or die("Query failed : " . mysql_error());
         }
         if( $up == 3 )  {    /// добавляем очки к бонусу атаки армии
             $att_b = $hr_attack_bonus_pts+1;
                    $res = mysql_query("UPDATE heroes set hr_attack_bonus_pts=hr_attack_bonus_pts+1,
                                        hr_attack_bonus=$att_b,
                                        hr_points=hr_points-1 where hr_id=$hr_id")
                       or die("Query failed : " . mysql_error());
         }
         if( $up == 4 )  {    /// добавляем очки к бонусу защиты армии
             $def_b = $hr_defence_bonus_pts+1;
                    $res = mysql_query("UPDATE heroes set hr_defence_bonus_pts=hr_defence_bonus_pts+1,
                                        hr_defence_bonus=$def_b,
                                        hr_points=hr_points-1 where hr_id=$hr_id")
                       or die("Query failed : " . mysql_error());
         }
         if( $up == 5 )  {    /// добавляем очки к регенерации
             $regen = ($hr_regeneration_pts+1)*5;
                    $res = mysql_query("UPDATE heroes set hr_regeneration_pts=hr_regeneration_pts+1,
                                        hr_regeneration=$regen,
                                        hr_points=hr_points-1 where hr_id=$hr_id")
                       or die("Query failed : " . mysql_error());

         }

       }

   }
}
</pre>
			Фрагмент 10.3.7<p>Здесь мы снова вначале узнаем все параметры из 
			соединения таблиц <b>heroes</b> и <b>spr_army</b> (<span lang="en-us">SQL
			</span>запрос в строках 4-9). Потом, в соответствии с тем, какой 
			номер задан в аргументе $up, мы поднимаем соответствующую 
			характеристику. Если $up=1 - значит поднимаем атаку, если $up=2 - 
			защиту от кавалерии и пехоты и т.д. В большинстве случаев 
			используются свои формулы для повышения этих характеристик. Так, 
			например, для атаки формула такова:<br>
			<br>
			<span lang="en-us">A = </span>Округление(&nbsp; <span lang="en-us">
			(2*</span>sa_attack<span lang="en-us">/3+27.5) + </span>(sa_attack_pts+1) + 
			1.25*sa_attack)<span lang="en-us"> </span>)<span lang="en-us">.</span>
			<span lang="en-us"><br>
			<br>
			</span>А - это сила атаки, которую мы рассчитываем<br>
			sa_attack - это сила атаки того типа войск, из которого сделан герой 
			(для легионера, это, к примеру 40)<br>
			a_attack_pts - очки, которые в данный момент распределены в эту 
			характеристику.<br>
			<br>
			Для защиты формула чуть другая, для бонусов формулы совсем простые, 
			как и для регенерации персонажа. Мы используем эти формула, а Вы 
			можете придумать другие, главное, чтоб выглядело более-менее 
			правдоподобно <br>
			После расчета по формуле, эта рассчитанная характеристика 
			сохраняется в таблицу <b>heroes</b>, а от туда уже визуализируется 
			как на рисунке 10.3.3<br>
			<br>
			В завершении этого пункта мы сделаем простую функцию
			<font color="#3B84D0">get_hero_params</font>, которая будет 
			возвращать в виде массива все характеристики героя:</p>


<pre class="brush: php;">
/////////// Узнаем характеристики героя /////////////////
/////////// и возвратим их в виде массива ///////////////
function get_hero_params( $fid ){
$res = mysql_query(&quot;SELECT hr_id, sa_attack, sa_inf_defence, sa_cav_defence,
hr_attack_bonus, hr_defence_bonus, hr_health, hr_experience
from heroes h
where fid=$fid &quot;)
or die(&quot;Query failed : &quot; . mysql_error());
$row = mysql_fetch_array( $res );
$a_hero[&quot;hrid&quot;] = $row[&quot;hr_id&quot;];
$a_hero[&quot;a&quot;] = $row[&quot;sa_attack&quot;];
$a_hero[&quot;id&quot;] = $row[&quot;sa_inf_defence&quot;];
$a_hero[&quot;cd&quot;] = $row[&quot;sa_cav_defence&quot;];
$a_hero[&quot;ab&quot;] = $row[&quot;hr_attack_bonus&quot;];
$a_hero[&quot;db&quot;] = $row[&quot;hr_defence_bonus&quot;];
$a_hero[&quot;h&quot;] = $row[&quot;hr_health&quot;];
$a_hero[&quot;e&quot;] = $row[&quot;hr_experience&quot;];
$a_hero[&quot;l&quot;] = $row[&quot;hr_level&quot;];
return( $a_hero );
}
</pre>
			Фрагмент 10.3.8<p>Тут все просто - все данные (атаку, защиту, 
			бонусы, здоровье и т.д.) берем из таблицы <b>heroes</b>&nbsp; и 
			помещаем их в массив $a_hero, который возвращает эта функция.<font color="#4775A5"><strong><span lang="en-us"><br>
			<br>
			<br>
			<br></span>10</strong></font><font color="#4775a5"><strong>.4. Оазисы на 
			карте </strong></font><br><br>&nbsp;&nbsp; Что ж, наш герой<span lang="en-us"> </span>
			уже усилен и может приступать к захвату оазисов на карте. Но мы 
			ранее не позаботились об<span lang="en-us"> </span>их создании. 
			Сделаем это сейчас.<span lang="en-us"> </span>Для начала давайте 
			запасемся картинкой оазиса. Допустим она у нас<span lang="en-us"> </span>
			будет такой:<span lang="en-us"><br>
			<br>
			<img border="0" src="www/img/fld500.png" width="73" height="41"><br>
			<br></span>Как Вы помните, в<span lang="en-us"> </span>нашей с Вами 
			базу данных в таблице <span lang="en-us"><b>fields</b> </span>есть 
			поле fid_type<span lang="en-us">,</span> значение в котором влияет 
			на отображение случайной картинки<span lang="en-us"> </span>поля на 
			глобальной карте мира. Мы можем его использовать также для 
			определения типа оазиса. Допустим, для оазисов fid_type будет равен 
			500. Внесем изменения в наш <span lang="en-us">travgame.sql:</span><br>
			</p>
<pre class="brush: sql;">-- назначим оазис!
update fields set usr_id = 1, fid_type = 500, fid_name='Свободный оазис' where fid = 65; /* к примеру 500 - это будет оазис*/
</pre>Фрагмент 10.<span lang="en-us">4</span>.<span lang="en-us">1</span><p>В 
			вышеприведенном фрагменте мы выбрали идентификатор поля fid = 65<span lang="en-us">,</span> 
			чтоб оазис располагался неподалеку от поселков наших игроков
			<span lang="en-us">test </span>и Суперигрок. В фале <b>
			<span lang="en-us">fld.php</span></b>, который мы не трогали очень 
			давно , сейчас мы вставим пару строк, чтоб на карте отображалась 
			картинка оазиса:</p>


<pre class="brush: php;">
...
if( $fid_type == 500 ){ // ОАЗИС 
 echo &quot;&lt;MAP Name='FPMap1$fid'&gt;&quot;;
 echo &quot;&lt;AREA Shape='Polygon' coords = '$x1,$y1,$x2,$y2,$x3,$y3,$x4,$y4' onmouseover=\&quot;say_owner('&quot;.$nick.&quot;')\&quot;&gt;&lt;/MAP&gt;&quot;;
 echo '&lt;div style=&quot;position:absolute;left:'.$x_coord.'px;top:'.$y_coord.'px;width:73px; height:41px; z-index:12;z-index:12&quot;&gt;
&lt;IMG SRC=&quot;img/fld500.png&quot; border=&quot;0&quot; USEMAP=&quot;#FPMap1'.$fid.'&quot; ISMAP&quot;&gt;&lt;/div&gt;';
} else {
...
</pre>
			Фрагмент 10.4.2<br>
			<br>
			Теперь глобальная карта будет выглядеть так:<br>
			<br>
			<img border="0" src="pics/svo.png" width="607" height="381"><br>
			<br>
			<br>
			<br>
			Рисунок 10.4.1<br>
			<br>
			<br>
			Герой у нас уже есть, оазис есть и, теперь, мы можем приступать к 
			захвату оазиса.<br>
			.<span lang="en-us"><br></span><br><br>
			<font color="#4775A5"><b>10.5. 
			Захват оазиса</b></font><br><br>&nbsp;&nbsp;Как Вы помните из 
			прошлой лекции, начало боевых действий начинается с формирования 
			армии в Пункте Сбора, а так как у нас появился герой, то мы также 
			должны добавить возможность присоединять героя к нашей армии. 
			Поэтому нам нужно немного изменить шаблоны <span lang="en-us"><b>
			tpl_g16.php</b> </span>и <b><span lang="en-us">tpl_g16</span>_2<span lang="en-us">.php</span></b>. 
			В первом мы добавим еще один столбик в таблицу отображения армии в 
			поселке и будем заполнять его числом 1, если герой есть или 0, если 
			героя нет в поселке:<br>
			<br>
			<img border="0" src="pics/ah.png" width="536" height="384"><br>
			Рисунок 10.5.1<br>
			<br>
			В шаблоне <b><span lang="en-us">tpl_g16</span>_2<span lang="en-us">.php</span>
			</b>мы добавляем текстовое поле для присоединения героя к армии, 
			которое будет затемненным, если героя нет, и активным, если герой 
			есть в поселке.<br>
			<br>
			<br>
			<img border="0" src="pics/addh.png" width="533" height="462"><br>
			<br>
			Рисунок 10.5.2<br>
			<br>
			При отправке армии, мы также должны не забыть передать данные из 
			поля с героем (<span lang="en-us">и</span>мя которого получит 
			следующий порядковый<span lang="en-us"> </span>номер -
			<span lang="en-us">r11</span>) в функцию <font color="#3B84D0">
			init_send_army</font> в файле <span lang="en-us"><b>tpl_g16.php</b>
			</span>иначе, армия так и отправится в поход без своего героя! <br>
			Давайте для разминки отправим нашего героя вместе с армией в поход 
			на поселок Суперигрока, чтоб посмотреть как после битвы изменится 
			его здоровье в результате гибели части армии. А здоровье героя 
			напрямую зависит от количества воинов, которые остались в его армии 
			после сражения. К примеру, в армии было 10 легионеров, а осталось 6, 
			значит у героя после боя будет 60% здоровья.<br>
			Для начала сделаем функцию <font color="#3B84D0">update_hero_stats</font>, 
			которая посчитает оставшееся здоровье героя после сражения:<pre class="brush: php;">
function update_hero_stats( $fid, $qty1, $qty2, $qty3, $qty4 ){

$h_params = get_hero_params( $fid );
$hr_id = $h_params[&quot;hrid&quot;];
$hr_level = $h_params[&quot;l&quot;];
$health_left = floor($h_params[&quot;h&quot;] - (100-$qty2*100/$qty1));
$hr_state = $health_left &gt; 0 ? 1 : 0;
$exp = ($qty3-$qty4)*2 + $h_params[&quot;e&quot;];
$res = mysql_query(&quot;update heroes set hr_health=$health_left,
hr_state=$hr_state,
hr_experience=hr_experience+$exp 
where hr_id=$hr_id&quot;)
or die(&quot;Query failed : &quot; . mysql_error());
}
</pre>
			Фрагмент 10.5.1<p>Функция <font color="#3B84D0">update_hero_stats
			</font>получает в качестве аргументов - идентификатор поселка, к 
			которому принадлежит герой, а также значения количества своих и 
			чужих войск до сражения и после него. <br>
			Вначале эта функция узнает параметры героя (строка 3). <br>
			Оставшееся здоровье героя мы посчитаем по формуле:<br>
			<br>
			<b>&nbsp;&nbsp; <span lang="en-us">health = health_current - (100 - 
			qty2*100/qty1)</span></b>,<b>&nbsp; </b>где<br>
			<br>
			<span lang="en-us"><b>health</b> </span>- здоровье после боя, 
			которое мы пытаемся рассчитать<br>
			<span lang="en-us"><b>health_current</b> </span>- здоровье героя до 
			боя<br>
			<b><span lang="en-us">qty2</span></b> - число оставшихся в живых 
			солдат армии героя<br>
			<b><span lang="en-us">qty1</span></b> - число солдат в армии героя 
			до боя. <br>
			<br>
			В строке 6 фрагмента 10.5.1 мы как раз применяем эту формулу, и если 
			здоровье героя больше нуля, значит, герой жив и переменную состояния 
			его активности $hr_state устанавливаем в 1, иначе устанавливаем ее в 
			0. Опыт, который получает герой после сражения мы вычисляем в строке 
			8, по формуле, которую описали еще в первом пункте нашей сегодняшней 
			лекции. Все эти данные заносим в таблицу <b>heroes</b> (строки 9-13)<br>
			<br>
			Функцию <font color="#3B84D0">update_hero_stats</font>, которую мы 
			только что сделали мы добавим конечно же в конец функции
			<font color="#3B84D0">generate_battle</font>, расчитывающей 
			результат сражения, которую мы сделали на прошлом занятии. Таким 
			образом, сразу после боя мы увидим, зайдя в таверну как изменяются 
			характеристики героя (опыт и здоровье).<br>
			Так вот, если игрок <b><span lang="en-us">test</span></b> пошлет в
			<b>набег</b> армию вместе с героем на поселок игрока <b>Суперигрок</b> 
			(вы помните, что у обоих в армии по 10 легионеров), то после боя, в 
			Таверне мы увидим следующие изменения для героя игрока
			<span lang="en-us"><b>test</b>.<br>
			<br>
			<br>
			<img border="0" src="pics/aft_bat.png" width="538" height="442"><br>
			</span>Рисунок 10.5.3<span lang="en-us"><br>
			<br>
			<br>
			</span>Вы, наверно сразу обратили внимание на изменившийся 
			показатель здоровья (был 100%, а стал 60% - так как в армии осталось 
			6 легионеров из 10),&nbsp; а также показатель опыта, который стал 
			10% (5 убитых легионеров врага умножить на 2). Конечно же мы во 
			время сражения не учитывали еще параметры героя в атаке, чтоб 
			добавить урон войскам защищающейся стороны. Но Вы сможете сделать 
			это самостоятельною<br>
			<br>
			Что ж, давайте теперь присоединим оазис <span lang="en-us">
			<img border="0" src="www/img/fld500.png" width="73" height="41"></span> 
			к нашему поселку. Когда наша армия пытается напасть на оазис, в 
			числе ее должен быть герой, иначе попытка послать туда войска должны 
			быть безуспешными. Давайте сделаем такую проверку в функции
			<font color="#3B84D0">init_send_army</font>:</p>


<pre class="brush: php;">
$fid_type = get_fid_type( $fid_to ); // что за поле? не оазис ли?
if( ($fid_type == 500) &amp;&amp; ($qty11==0) ) {
 echo '&lt;font color=&quot;#FF0000&quot;&gt;Вы пытаетесь захватить оазис без героя! Это не возможно!&lt;/font&gt;&lt;br&gt;';
return( 0 ) ;
}

</pre>
			Фрагмент 10.5.2<p>
			Вы видите, что если тип поля 500 и в армии нет героя ($qty11==0), 
			значит выдаем сообщении о невозможности этого действия!<br>
			Если же герой в армии есть и мы дошли до оазиса, произошло сражение, 
			если там были войска защитников, то, в том случае, если 
			обороняющихся войск не осталось, то оазис должен стать закрепленным 
			за игроком. Для этого мы добавим в конец той же функции
			<font color="#3B84D0">generate_battle </font>следующие строки:</p>


<pre class="brush: php;">
 if( ($fid_type == 500) &amp;&amp; ($all_def_qty_after==0) ){
// это оазис и атакующая армия его захватила (не осталось защитников!)
$res = mysql_query( &quot;update fields set fid_parent=$fid where fid=$fid_to&quot; )
or die(&quot;Query failed : &quot; . mysql_error());
}
</pre>
			Фрагмент 10.5.3<br>
			<br>
			Как вы догадались, если тип поля 500 (оазис) и количество защитников 
			оставшихся после боя ($all_def_qty_after) равно нулю, значит оазис 
			стал нашим и мы устанавливаем поле fid_parent в таблице <b>fields</b> 
			для этого участка карты равным идентификатору поселка игрока его 
			захватившего.<br>
			Таки образом после захвата оазиса игроком <span lang="en-us">test</span> 
			в таблице <b>fields</b> Вы увидите следующее.<br>
			<br>
			<img border="0" src="pics/oaz.png"><p>
			Рисунок 10.5.4<br>
			<br>
			В поле <span lang="en-us">fid_parent </span>таблицы <b>fields</b>&nbsp; 
			в&nbsp; строке для Свободного оазиса Вы видите число 49, то есть 
			идентификатор <span lang="en-us">(fid) </span>поселка
			<span lang="en-us">testtown</span>, армия которого его захватила. 
			Для тренировки Вы можете на глобальной карте сделать другую картинку 
			оазиса, захваченного каким-нибудь игроком. Можете также устроить 
			сражение между войсками природы (смотрите добавленные типы войск в 
			скрипте <span lang="en-us">travgame.sql</span>) <span lang="en-us">&nbsp;</span>и 
			армией захватывающей оазис. Теперь Вы все это и, надеемся, многое 
			другое можете делать самостоятельно и еще более усовершенствовать 
			нашу учебную стратегическую игру или даже вообще - создать нечто 
			совершенно новое! <br>
			А мы на этом с Вами прощаемся, до следующих встреч на других курсах!<b><br>Благодарим Вас, что были с нами на протяжении курса создания 
			стратегических браузерных игр и желаем Вам успехов на поприще 
			игростроителей с применением веб-технологий</b><span lang="ru">.</span><br>
			<br>
            </p>
            <p></p>
            <p></p></font>
            </td>
            <td background="index_files/m_right_m.gif" width="9"><img height="4" src="index_files/m_right_m.gif" width="9" border="0"></td></tr></tbody></table><table cellpadding="0" cellspacing="0" width="100%">
        <tbody>
          <tr>
            <td background="index_files/m_left_m.gif" width="9"></td>
            <td class="newsbody" bgcolor="#fdfdfd">&nbsp;</td>
            <td class="newsbody" bgcolor="#fdfdfd">
            <div class="nav" align="right">Blitz-School© </div>
            </td>
            <td background="index_files/m_right_m.gif" width="9"><img height="4" src="index_files/m_right_m.gif" width="9" border="0"></td></tr></tbody></table><table cellpadding="0" cellspacing="0" height="7" width="100%">
        <tbody>
          <tr>
            <td background="index_files/m_left_b.gif" width="13"><img height="7" src="index_files/m_left_b.gif" width="13" border="0"></td><td background="index_files/m_center_b.gif"><img height="1" src="index_files/spacer.gif" width="1"></td><td width="13"><img height="7" src="index_files/m_right_b.gif" width="13" border="0"></td></tr></tbody></table></div></td><td background="index_files/right_back.gif" valign="top" width="13">&nbsp;</td>
    </tr>
  </tbody>
</table>
<table cellpadding="0" cellspacing="0" width="100%">
  <tbody>
    <tr>
      <td background="index_files/bottom_left.png" height="51" valign="top" width="254">
      <div class="date" style="MARGIN-TOP: 12px; FONT-SIZE: 10px; MARGIN-LEFT: 45px; COLOR: white"><a style="COLOR: rgb(255,255,255)" href  ="index.phtml">Copyright</a>©
2005-2009.
GameSchool</div></td><td background="index_files/bottom.gif" valign="top">
      <div class="date" style="MARGIN-TOP: 12px; FONT-SIZE: 10px; MARGIN-LEFT: 20px; COLOR: rgb(143,145,147)" 
      ><!-- Bottom menu --><a title="Главная страница" style="COLOR: rgb(143,145,147)" href  ="http://www.blitz-school.info/index.phtml">Главная</a><img height="1" src="index_files/spacer.gif" width="22" align="middle">:<img height="1" src="index_files/spacer.gif" width="22" align="middle"><a href="http://www.blitz-school.info/login.phtml"><span style="COLOR: rgb(143,145,147)"  >Вход</span></a><img height="1" src="index_files/spacer.gif" width="22" align="middle">:<img height="1" src="index_files/spacer.gif" width="22" align="middle"><a href="http://www.blitz-school.info/response.phtml"><span style="COLOR: rgb(143,145,147)" 
      >Отзывы</span></a><img height="1" src="index_files/spacer.gif" width="22" align="middle">:<img height="1" src="index_files/spacer.gif" width="22" align="middle"><a href="http://www.blitz-school.info/contacts.phtml"><span style="COLOR: rgb(143,145,147)" 
      >Контакты</span></a><img height="1" src="index_files/spacer.gif" width="22" align="middle">:<img height="1" src="index_files/spacer.gif" width="22" align="middle"><a href="http://www.blitz-school.info/friends.phtml"><span style="COLOR: rgb(143,145,147)" 
      >Обмен ссылками</span></a> </div>
      </td>
      <td width="19"><img height="51" src="index_files/bottom_right.png" width="19" border="0"></td></tr></tbody></table><div id="menu" onmouseover="showLayer('menu'); Change('products', 'menu2')" onmouseout="hiddenLayer('menu'); Change('products', 'menu1')">
<table border="0" cellpadding="0" cellspacing="0">
  <tbody>
    <tr>
      <td style="WIDTH: 7px; HEIGHT: 7px"><img height="7" alt="" src="index_files/corner1.gif" width="7"></td><td class="top"></td>
      <td style="WIDTH: 7px; HEIGHT: 7px"><img height="7" alt="" src="index_files/corner2.gif" width="7"></td></tr><tr>
      <td class="left"></td>
      <td class="text"><a href="reg.phtml">Курс обучения созданию игр
на Blitz3D</a><br>
      <a href="reg2.phtml">Курс
обучения созданию браузерных онлайновых игр</a> </td>
      <td class="right"></td>
    </tr>
    <tr>
      <td style="BACKGROUND: 0% 50%; WIDTH: 7px; HEIGHT: 7px; -moz-background-clip: initial; -moz-background-origin: initial; -moz-background-inline-policy: initial" 
      ><img height="7" alt="" src="index_files/corner4.gif" width="7"></td><td class="bottom"></td>
      <td style="WIDTH: 7px; HEIGHT: 7px"><img height="7" alt="" src="index_files/corner3.gif" width="7"></td></tr></tbody></table></div></body></html>