<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head>
  
  <meta http-equiv="Content-Language" content="ru">
  
  <title>Центр обучения созданию компьютерных игр</title>
  <meta name="description" content="Blitz-School - Школа создателей компьютерных игр на языке Blitz3D. Если вы хотите быстро научиться делать компьютерные игры или интересуетесь их созданием, то этот сайт будет вам полезен">
  <meta name="keywords" content="программирование, создание игр, курсы создания игр, школа создателей компьютерных игр, blitzbasic, компьютерные игры, как написать игру, как создать игру, программирование компьютерных игр, Blitz3D, программирование игр, разработка игр, создание 3d игр, аудио, графика, дизайн, 3D">
  <link rel="stylesheet" type="text/css" href="main.css">
  <script language="JavaScript" src="index_files/script.js" type="text/javascript"></script>
  <script type="text/javascript" src="scripts/shCore.js"></script>
  <script type="text/javascript" src="scripts/shBrushBash.js"></script>
  <script type="text/javascript" src="scripts/shBrushCpp.js"></script>
  <script type="text/javascript" src="scripts/shBrushCSharp.js"></script>
  <script type="text/javascript" src="scripts/shBrushCss.js"></script>
  <script type="text/javascript" src="scripts/shBrushDelphi.js"></script>
  <script type="text/javascript" src="scripts/shBrushDiff.js"></script>
  <script type="text/javascript" src="scripts/shBrushGroovy.js"></script>
  <script type="text/javascript" src="scripts/shBrushJava.js"></script>
  <script type="text/javascript" src="scripts/shBrushJScript.js"></script>
  <script type="text/javascript" src="scripts/shBrushPhp.js"></script>
  <script type="text/javascript" src="scripts/shBrushPlain.js"></script>
  <script type="text/javascript" src="scripts/shBrushPython.js"></script>
  <script type="text/javascript" src="scripts/shBrushRuby.js"></script>
  <script type="text/javascript" src="scripts/shBrushScala.js"></script>
  <script type="text/javascript" src="scripts/shBrushSql.js"></script>
  <script type="text/javascript" src="scripts/shBrushVb.js"></script>
  <script type="text/javascript" src="scripts/shBrushXml.js"></script>
  <script type="text/javascript" src="scripts/shBrushBlitz3D.js"></script>
  <link type="text/css" rel="stylesheet" href="styles/shCore.css">
  <link type="text/css" rel="stylesheet" href="styles/shThemeDefault.css">
  <script type="text/javascript">
SyntaxHighlighter.config.clipboardSwf = 'scripts/clipboard.swf';
SyntaxHighlighter.all();
  </script>
  <meta content="MSHTML 6.00.6000.20772" name="GENERATOR">
	<style>
<!--
	.SYN_ROW {background:silver;}
	.SYN_TXT {border-left:1px solid;position:relative;left:4.5em;background:white;font-family:monospace;margin-right:4.5em;}
	.HTML_TXT {color:#000000;}
	.HTML_TAG {color:#0000ff;}
	.HTML_ELM {color:#800000;}
	.HTML_ATR {color:#ff0000;}
	.HTML_VAL {color:#0000ff;}
-->
</style>
</head>

<body topmargin="0" leftmargin="0" style="BACKGROUND-COLOR: rgb(255,255,255)" marginheight  ="0" marginwidth="0">
<table cellpadding="0" cellspacing="0" width="100%">
  <tbody>
    <tr>
      <td rowspan="2" height="197" width="21"><img height="197" src="index_files/ltoptable.png" width="21" border="0"></td>
      <td colspan="5" valign="top">
      <table cellpadding="0" cellspacing="0" width="100%">
        <tbody>
          <tr>
            <td height="49" width="231"><img height="49" src="index_files/topmenu.png" width="231" usemap="#ImageMap1" border="0"></td>
            <td background="index_files/mtop.gif"><map name="ImageMap1"><area onclick="this.style.behavior='url(#default#homepage)';this.setHomePage('http://www.blitz-school.info'); return false;" shape="RECT" coords="17,26,71,40" href="index.phtml"><area shape="RECT" coords="91,27,149,39" href="javascript:window.external.AddFavorite('http://www.blitz-school.info', 'GameSchool - Центр обучения созданию компьютерных игр!')"></map>
            <div class="searchform" align="right">
            <form method="post"><input value="search" name="do" type="hidden">&nbsp;</form>
            </div>
            </td>
            <td height="49" width="13"><img height="49" src="index_files/mlefttop.png" width="13" border="0"></td>
          </tr>
        </tbody>
      </table>
      </td>
    </tr>
    <tr>
      <td height="148" valign="top" width="225">
      <table cellpadding="0" cellspacing="0" height="148" width="100%">
        <tbody>
          <tr>
            <td height="119" width="225"><a title="Центр обучения созданию компьютерных игр" href="index.phtml"><img height="119" src="index_files/title.png" width="225" border="0"></a></td>
          </tr>
          <tr>
            <td background="index_files/date_b.png" valign="bottom">
            <div class="date" style="FONT-SIZE: 11px; MARGIN-BOTTOM: 10px; MARGIN-LEFT: 12px">
            <script language="JavaScript1.2">
<!-- Begin
var months=new Array(13);
months[1]="января";
months[2]="февраля";
months[3]="марта";
months[4]="апреля";
months[5]="мая";
months[6]="июня";
months[7]="июля";
months[8]="августа";
months[9]="сентября";
months[10]="октября";
months[11]="ноября";
months[12]="декабря";
var time=new Date();
var lmonth=months[time.getMonth() + 1];
var date=time.getDate();
var year=time.getYear();
var hours=time.getHours();
var minutes=time.getMinutes();
if (eval(hours) <10) {hours="0"+hours}
if (eval(minutes) < 10) {minutes="0"+minutes}
if (year < 2000)
year = year + 1900;
document.write("Сейчас: " + date + " ");
document.write(lmonth + " " + year + ", " + hours + ":" + minutes + " ");

// End -->

           </script>
            </div>
            </td>
          </tr>
        </tbody>
      </table>
      </td>
      <td width="296"><img height="148" src="index_files/mainleft.jpg" width="296" border="0"></td>
      <td width="205"><img height="148" src="index_files/mainright.jpg" width="205" border="0"></td>
      <td background="index_files/mback.png">&nbsp;</td>
      <td height="148" width="58"><img height="148" src="index_files/mltopr.png" width="58" border="0"></td>
    </tr>
  </tbody>
</table>
<table bordercolordark="black" bordercolorlight="black" cellpadding="0" cellspacing="0" width="100%">
  <tbody>
    <tr>
      <td background="index_files/anek_tb.png" height="27" valign="top" width="254">
      <div class="lefttext"><b>Меню:</b></div>
      </td><?php include 'menu_top.php'; ?> <td background="index_files/nav_back.gif">&nbsp;</td>
      <td width="17"><img height="27" src="index_files/nav_end.png" width="17" border="0"></td>
    </tr>
  </tbody>
</table>
<table cellpadding="0" cellspacing="0" width="100%">
  <tbody>
    <tr>
      <td background="index_files/lefttable.gif" valign="top" width="254"><!-- Menu -------->
      <div style="MARGIN-LEFT: 21px">
      <table cellpadding="0" cellspacing="0">
        <tbody>
          <tr>
            <td background="index_files/tb_back.gif">
            <div class="style3"><img src="index_files/home.gif"><a href="http://www.blitz-school.info/index.phtml">Главная</a><br>

        <img src="index_files/pages.gif"> <b>Перечень курсов</b><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/blitzindex.phtml">Создание 3D игр на Blitz3D</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/ogindex.phtml">Создание браузерной РПГ</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/egindex.phtml">Создание экономической браузерки</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/mgindex.phtml">Создание мобильных игр</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/cppindex.phtml">Создание 3D игр на С++</a><br>
        <img src="index_files/group.gif"> <a href="http://www.blitz-school.info/begin_study.phtml">Как стать слушателем</a><br>
        <img src="index_files/recom.gif"> <a href="http://www.blitz-school.info/study_tech.phtml">Технология обучения</a><br>
        <img src="index_files/loyalty_sm.jpg"> <a href="http://www.blitz-school.info/loyalty.phtml">Программа лояльности</a>
        <br>
&nbsp;&nbsp;&nbsp;&nbsp;
    <img border="0" src="index_files/navdiv.gif" width="80" height="4">
        <br><img src="index_files/newuser.gif"> <b>Регистрация</b><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/reg.phtml">Курс 3D игр на Blitz3D</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/reg2.phtml">Курс браузерной RPG</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/reg3.phtml">Экономическая браузерка</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/reg4.phtml">Курс мобильных игр</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <a href="http://www.blitz-school.info/reg5.phtml">3D игры на С++</a><img src="index_files/new.gif"><br>
        <img src="index_files/admin.gif"> <a href="http://www.blitz-school.info/login.phtml">Вход для слушателей</a><br>
        <img src="index_files/study.gif"> <a href="http://www.blitz-school.info/program.phtml">Учебные программы курсов</a><br>
        <img src="index_files/society.gif"> <a href="http://www.blitz-school.info/response.phtml">Отзывы</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;
    <img border="0" src="index_files/navdiv.gif" width="80" height="4">
        
        <br><img src="index_files/media.gif"> <a href="http://www.blitz-school.info/distant.phtml">О дистанционном образовании</a><br>
        <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/articles.phtml">Статьи</a><br>
        <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/less_ex.phtml">Изложение материала</a><br>
        <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/gallery.phtml">Галерея</a><br> 
        <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/links.phtml">Полезные ссылки</a><br>
        <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/contacts.phtml">Контакты</a><br>
       <img src="index_files/media.gif"> <a href="http://www.blitz-school.info/friends.phtml">Обмен ссылками</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;

            </div>
            </td>
          </tr>
          <tr>
            <td width="222"><img height="8" src="index_files/tb_b.gif" width="222" border="0"></td>
          </tr>
        </tbody>
      </table>
      </div><!-- ------------------ end of menu ------------------- --> </td>
      <td class="news" valign="top">
      <script language="javascript" type="text/javascript">
      </script>
      <div style="MARGIN-TOP: 7px">
      <table cellpadding="0" cellspacing="0" width="100%">
        <tbody>
          <tr>
            <td width="13"><img height="24" src="index_files/m_left.gif" width="13" border="0"></td>
            <td class="newstitle" background="index_files/m_center.gif">
            <b>Занятие
			9</b></td>
            <td class="newstitle" align="right" background="index_files/m_center.gif">&nbsp;</td>
            <td width="9"><img height="24" src="index_files/m_right.gif" width="9" border="0"></td>
          </tr>
        </tbody>
      </table>
      <table cellpadding="0" cellspacing="0" width="100%">
        <tbody>
          <tr>
            <td background="index_files/m_left_m.gif" width="4">&nbsp;</td>
            <td class="newsbody" bgcolor="#fdfdfd">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			<p>
            <font size="3"><b>Военные действия<br>
			</b></font>
            <br>
            <span lang="en-us"><font color="#4775A5"><b>9</b></font></span><b><font color="#4775a5">.1. 
			Таблица передвижения войск</font><br>
            <br>
&nbsp;</b><span lang="en-us">&nbsp;</span>Приветствуем Вас, уважаемый коллега. 
			Сегодняшнее наше с Вами занятие мы посвятим военным действиям. Похоже 
			соседние поселки рано поверили в свою безопасность! Пора напомнить 
			им, что наша армия самая непобедимая и нанести им визит. И первым 
			делом, давайте расширим нашу справочную таблицу типов войск <b>
			spr_army</b> до десяти. <br>
			Вот все типы войск, которые доступны в нашей игре:<br>
			</p>
<pre class="brush: sql;">/*для казармы*/
insert into spr_army(sa_id,sa_name,sa_image,sa_attack,sa_inf_defence,sa_cav_defence,sa_wood,sa_clay,sa_ore,sa_grain,sa_speed,sa_capacity,sa_cons,
sa_training_time,bt_id,sa_description,sa_type) 
values (1,'Легионер','img/army/1.gif',40,35,50,120,100,150,30,6,50,1,'0:00:20',5,'Легионеры — простая и универсальная пехота римлян. ',1);
insert into spr_army(sa_id,sa_name,sa_image,sa_attack,sa_inf_defence,sa_cav_defence,sa_wood,sa_clay,sa_ore,sa_grain,sa_speed,sa_capacity,sa_cons,
sa_training_time,bt_id,sa_description,sa_type) 
values (2,'Преторианец','img/army/2.gif',30,65,35,100,130,160,70,5,20,1,'0:29:20',5,'Преторианцы проходят продолжительное обучение ....',1);
insert into spr_army(sa_id,sa_name,sa_image,sa_attack,sa_inf_defence,sa_cav_defence,sa_wood,sa_clay,sa_ore,sa_grain,sa_speed,sa_capacity,sa_cons,
sa_training_time,bt_id,sa_description,sa_type) 
values (3,'Империанец','img/army/3.gif',70,40,25,150,160,210,80,7,50,1,'0:32:00',5,'Империанцы — единица атакующих войск Рима.  ',1);
/*для конюшни*/
insert into spr_army(sa_id,sa_name,sa_image,sa_attack,sa_inf_defence,sa_cav_defence,sa_wood,sa_clay,sa_ore,sa_grain,sa_speed,sa_capacity,sa_cons,
sa_training_time,bt_id,sa_description,sa_type) 
values (4,'Конный разведчик','img/army/4.gif',0,20,10,20,140,160,40,7,0,2,'0:22:40',6,'Конные разведчики — разведывательная единица Рима.',2);
insert into spr_army(sa_id,sa_name,sa_image,sa_attack,sa_inf_defence,sa_cav_defence,sa_wood,sa_clay,sa_ore,sa_grain,sa_speed,sa_capacity,sa_cons,
sa_training_time,bt_id,sa_description,sa_type) 
values (5,'Конница императора','img/army/5.gif',120,65,50,550,440,320,100,14,100,3,'0:44:00',6,'Это стандартная кавалерия римлян...',2);
insert into spr_army(sa_id,sa_name,sa_image,sa_attack,sa_inf_defence,sa_cav_defence,sa_wood,sa_clay,sa_ore,sa_grain,sa_speed,sa_capacity,sa_cons,
sa_training_time,bt_id,sa_description,sa_type) 
values (6,'Конница Цезаря','img/army/6.gif',180,80,105,800,550,640,180,10,70,4,'0:58:40',6,'Конница Цезаря — это элитные войска римлян. ',2);
/**/
insert into spr_army(sa_id,sa_name,sa_image,sa_attack,sa_inf_defence,sa_cav_defence,sa_wood,sa_clay,sa_ore,sa_grain,sa_speed,sa_capacity,sa_cons,
sa_training_time,bt_id,sa_description,sa_type) 
values (7,'Таран','img/army/7.gif',60,30,75,900,360,500,70,4,0,3,'1:16:40',0,'Тараны являются тяжелым орудием поддержки пехоты и кавалерии.',0);
insert into spr_army(sa_id,sa_name,sa_image,sa_attack,sa_inf_defence,sa_cav_defence,sa_wood,sa_clay,sa_ore,sa_grain,sa_speed,sa_capacity,sa_cons,
sa_training_time,bt_id,sa_description,sa_type) 
values (8,'Огненная катапульта','img/army/8.gif',75,60,75,900,360,500,70,4,0,3,'1:16:40',0,'Ккатапульты—замечательные орудия дальнего боя.',0);
insert into spr_army(sa_id,sa_name,sa_image,sa_attack,sa_inf_defence,sa_cav_defence,sa_wood,sa_clay,sa_ore,sa_grain,sa_speed,sa_capacity,sa_cons,
sa_training_time,bt_id,sa_description,sa_type) 
values (9,'Сенатор','img/army/9.gif',50,40,30,30750,27200,45000,37500,4,0,5,'25:11:40',0,'Сенатор — это выбранный предводитель народа. ',0);
insert into spr_army(sa_id,sa_name,sa_image,sa_attack,sa_inf_defence,sa_cav_defence,sa_wood,sa_clay,sa_ore,sa_grain,sa_speed,sa_capacity,sa_cons,
sa_training_time,bt_id,sa_description,sa_type) 
values (10,'Поселенец','img/army/10.gif',0,80,80,5800,5300,7200,5500,5,3000,1,'7:28:20',0,'Поселенцы—смелые и отважные жители вашего города.',0);

</pre>Фрагмент 9.1.1<p>Конечно же мы не будем все типы юнитов использовать в 
			боях, к примеру, поселенцы нам вообще ни к чему при атаке. <br>
			Вероятно Вы заметили новое поле sa_type, которое мы добавили в 
			таблицу <b>spr_army</b>. Вот это поле:<br>
			</p>
<pre class="brush: sql;"> sa_type int default 0, /* 1-пехота, 2-конница, 0-другое*/ 
</pre>Фрагмент 9.1.2<p>Это поле будет определять принадлежность типа войск к 
			пехоте, кавалерии или другому типу. Это поле поможет нам в расчете 
			потерь во время сражений, так как, как Вы помните у войск есть 
			характеристики защиты от пехоты и кавалерии.<br>
			<br>
			Функция добавления войск игроку в поселок <font color="#3B84D0">
			makearmy</font> теперь тоже расширится и примет вид:<br>
			</p>
<pre class="brush: sql;"> /*------- процедура по генерированию войск игрока ----------*/
create procedure makearmy (p_fid int)
BEGIN
insert into army (sa_id,sr_qty,sr_enable,fid) VALUES (1,0,1,p_fid); /*легионеры доступны*/
insert into army (sa_id,sr_qty,sr_enable,fid) VALUES (2,0,0,p_fid); /*преторианцы недоступны*/
insert into army (sa_id,sr_qty,sr_enable,fid) VALUES (3,0,0,p_fid); /*империанцы недоступны*/
insert into army (sa_id,sr_qty,sr_enable,fid) VALUES (4,0,0,p_fid); /*Конный разведчик недоступен*/
insert into army (sa_id,sr_qty,sr_enable,fid) VALUES (5,0,0,p_fid); /*Конница императора недоступна*/
insert into army (sa_id,sr_qty,sr_enable,fid) VALUES (6,0,0,p_fid); /*Конница Цезаря недоступна*/
insert into army (sa_id,sr_qty,sr_enable,fid) VALUES (7,0,0,p_fid); /*Таран недоступен*/
insert into army (sa_id,sr_qty,sr_enable,fid) VALUES (8,0,0,p_fid); /*Катапульта недоступна*/
insert into army (sa_id,sr_qty,sr_enable,fid) VALUES (9,0,0,p_fid); /*Сенатор недоступен*/
insert into army (sa_id,sr_qty,sr_enable,fid) VALUES (10,0,0,p_fid); /*Поселенец недоступен*/
END;
</pre>Фрагмент 9.1.3<p>Давайте сразу же добавим войска двум нашим персонажам:<br>
			</p>
<pre class="brush: sql;">call makearmy( 49 ); /* армия для нашего игрока &quot;test&quot;, т.е. для его поселка с id=49 */
call makearmy( 67 ); /* армия для нашего игрока &quot;Суперигрок&quot;, т.е. для его поселка с id=67 */
</pre>Фрагмент 9.1.4<p>А чтоб количество их было чуть больше, чем ноль, сделаем 
			так:<br>
			</p>
<pre class="brush: sql;"> /*Добавим немного войск*/
update army set sr_qty = 10 where fid = 49 and sa_id = 1; /* легионеры для игрока 1*/
update army set sr_qty = 10 where fid = 67 and sa_id = 1; /* легионеры для игрока 2*/
</pre>Фрагмент 9.1.5<p>Как Вы видите, каждому из игроков добавили по 10 
			легионеров.<br>
			И теперь мы создадим таблицу перемещения войск. В прошлом занятии мы 
			уже делали сходную таблицу для перемещения торговцев. Эта будет 
			отличаться немного, но принципы движения останутся прежними: поход 
			туда (в поселок противника), бой в поселке и возврат обратно. Хотя - 
			есть нюансы! Из похода можно и не вернуться, если все войска погибли 
			во время сражения. К тому же нужно научить наших воинов грабить 
			ресурсы и приносить их обратно в наш поселок. Итак - вот таблица 
			перемещения войск, которую мы назовем <b>job_army_move</b>.<br>
			</p>
<pre class="brush: sql;">/* таблица очереди движения торговцев */
CREATE TABLE `job_army_move` (
jam_id bigint(20) unsigned NOT NULL auto_increment, /*ID*/
fid bigint(20), /*откуда? и принадлежность поселку*/
fid_to bigint(20), /*куда?*/ 
jam_start_time bigint DEFAULT 0, /*начало движения*/ 
jam_end_time1 bigint DEFAULT 0, /*время достижения пункта назначения*/ 
jam_end_time2 bigint DEFAULT 0, /*время возврата в свой поселок*/ 
jam_type int default 1, /* 1-набег, 2-нападение, 3-подкрепление*/ 
jam_direction int default 1, /* 1-туда, 2-обратно, 3-там (если подкрепление!)*/
jam_hash char(50),
jam_wood INT default 0, /* ресурсы, захваченные воинами */
jam_clay INT default 0, /* ... */
jam_ore INT default 0,  /* ... */
jam_grain INT default 0,/* ... */
qty1 int default 0, /* количество войска типа 1 */
qty2 int default 0, /* количество войска типа 2 */
qty3 int default 0, /* ... */
qty4 int default 0, /* ... */
qty5 int default 0, /* ... */
qty6 int default 0, /* ... */
qty7 int default 0, /* ... */
qty8 int default 0, /* ... */
qty9 int default 0, /* ... */
qty10 int default 0, /* ... */
PRIMARY KEY (`jam_id`) 
) ENGINE=MyISAM DEFAULT CHARSET=cp1251;

</pre>Фрагмент 9.1.6<p>Как видите, в таблице <b>job_army_move </b>есть поля под 
			количества всех типов войск. Так поле <font color="#3B84D0">qty1</font> 
			- означает количество легионеров, <font color="#3B84D0">qty2</font> 
			- количество преторианцев участвующих в походе и т.д.<br>
			Как Вы думаете, где собираются войска, чтоб оттуда напасть на 
			поселок противника? Конечно же в <b>Пункте Сбора</b>!<br>
			Что ж, давайте сразу же сделаем Пункт Сбора 1 уровня в
			<span lang="en-us">SQL </span>процедуре <font color="#3B84D0">
			makebuildplaces</font>.<br>
            </p>
<pre class="brush: sql;"> /* отдельно пункт сбора */
insert into `buildings` (bnum,bt_id,b_xcoord,b_ycoord,b_level,fid) VALUES (21,10,326,162,1,p_fid);
</pre>Фрагмент 9.1.7<br>
			<br>
			Теперь нам необходимо сделать шаблоны для Пункта Сбора. Их будет 
			два. Первый - <span lang="en-us"><b>tpl_g16.php</b> </span>будет 
			показывать какие войска находятся у нас в поселке, а также - какие 
			войска перемещаются между нашим поселком и вражескими поселениями. 
			Второй - <b><span lang="en-us">tpl_g16</span>_2<span lang="en-us">.php</span>
			</b>- понадобится нам для формирования нашей армии и отправки ее в 
			нападение или набег на чужие поселки. Наш первый шаблон для Пункта 
			Сбора войск выглядит так:<pre class="brush: php;">
// Пункт сбора
echo &quot;&lt;div id='textmenu'&gt;
&lt;a href='build.php?bnum=$bnum' class='selected '&gt;Обзор&lt;/a&gt;
| &lt;a href='build.php?bnum=$bnum&amp;amp;p=2'&gt;Отправка войск&lt;/a&gt;
&lt;/div&gt;&lt;br&gt;&quot;;

echo '&lt;br&gt;';
echo '&lt;table class=&quot;info&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; id=&quot;build_value&quot;&gt;&lt;tr&gt;
&lt;td class=&quot;tabhead&quot;&gt;Деревня&lt;/td&gt;&lt;td colspan=&quot;10&quot; class=&quot;tabhead&quot;&gt;Собственные войска&lt;/td&gt;
&lt;tr&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;img/army/1.gif&quot;&gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;img/army/2.gif&quot;&gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;img/army/3.gif&quot;&gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;img/army/4.gif&quot;&gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;img/army/5.gif&quot;&gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;img/army/6.gif&quot;&gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;img/army/7.gif&quot;&gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;img/army/8.gif&quot;&gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;img/army/9.gif&quot;&gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;img/army/10.gif&quot;&gt;&lt;/td&gt; 
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&quot;armyinfo&quot;&gt;Войска&lt;/td&gt;';

$res = mysql_query(&quot;SELECT sr_qty, sa_cons 
from army ar
inner join spr_army sa on ar.sa_id = sa.sa_id
where fid = $fid&quot; )
or die(&quot;Query failed : &quot; . mysql_error());

$all_cons = 0;
while ($row = mysql_fetch_array( $res )) {
  $qty = $row[&quot;sr_qty&quot;]; 
  $cons = $row[&quot;sa_cons&quot;]; 
  echo '&lt;td class=&quot;armyinfo&quot;&gt;'.$qty.'&lt;/td&gt;';
  $all_cons += $cons*$qty;
}
echo '&lt;/tr&gt;
&lt;td class=&quot;tabhead&quot;&gt;Содержание&lt;/td&gt;&lt;td class=&quot;tabhead&quot; colspan=&quot;10&quot;&gt;'.$all_cons.' &lt;img src=&quot;img/res/grain.png&quot;&gt; в час&lt;/td&gt;
&lt;/table&gt;'; 
</pre>
			Фрагмент 9.1.<span lang="en-us">8</span><p>Из этого фрагмента видно, 
			что меню в Пункте Сбора состоит из двух пунктов
			<font color="#3B84D0">Обзор</font> и <font color="#3B84D0">Отправка войск</font>. 
			По сути, в <b> <span lang="en-us">tpl_g16.php</span> </b> создается
			<span lang="en-us">HTML </span>таблица, в которую из запроса к 
			таблицам <span lang="en-us"><b>army</b> </span>и <b>spr_army</b> 
			(строки 26-30) записываются данные по типам войск, их количеству и 
			расходам на их содержание. Работа этого шаблона видна на ниже 
			приведенном рисунке:<br>
			<br>
			<img border="0" src="pics/ps1.png" width="542" height="397"><br>
			Рисунок 9.1.1<br>
			<br>
			Вы видите, что у нас доступны 10 легионеров, которых мы добавили во 
			фрагменте 9.1.5 и содержание их обходится в 10 единиц зерна в час.<br>
			Формирование армии для нападений и набегов мы рассмотрим в следующем 
			пункте нашей лекции.<br>
			<br>
			<font color="#4775A5"><b><span lang="en-us"><br>
			9</span></b></font><b><font color="#4775a5">.2. 
			</font></b><font color="#4775A5"><b>Нападение и набег<br>
			<br>
			</b></font>&nbsp;&nbsp; Для формирования нашей армии вторжения мы 
			создадим второй шаблон для Пункта Сбора - <b><span lang="en-us">tpl_g16</span>_2<span lang="en-us">.php</span></b>. 
			В нем мы должны иметь возможность указывать сколько боевых единиц и 
			какого типа мы формируем в нашу армию для отправки в чужой поселок. 
			Также мы должны вписать координаты чужого поселка для отправки 
			войск, точно так же как мы это делали для торговцев. Итак, вот этот 
			шаблон:</p><pre class="brush: php;">
&lt;?
// Пункт сбора
echo &quot;&lt;div id='textmenu'&gt;
&lt;a href='build.php?bnum=$bnum'&gt;Обзор&lt;/a&gt;
| &lt;a href='build.php?bnum=$bnum&amp;amp;p=2' class='selected'&gt;Отправка войск&lt;/a&gt;
&lt;/div&gt;&quot;;

echo '&lt;form name=&quot;sendarmy&quot; method=&quot;POST&quot; action=&quot;build.php?bnum='.$bnum.'&quot;&gt;';
echo '&lt;h1&gt;Послать войска&lt;/h1&gt;';
$a_cnt = 1; 
$res = mysql_query(&quot;SELECT ar.sa_id, sr_qty, sa_name, sa_image
from army ar
inner join spr_army sa on ar.sa_id = sa.sa_id
where fid = $fid&quot; )
or die(&quot;Query failed : &quot; . mysql_error());

echo '&lt;table width=&quot;450&quot; style=&quot;border-collapse: collapse;&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; id=&quot;army&quot;&gt;&lt;tr&gt;';

while ($row = mysql_fetch_array( $res )) {
 $qty = $row[&quot;sr_qty&quot;]; 
 $sa_id = $row[&quot;sa_id&quot;]; 
 $img = $row[&quot;sa_image&quot;]; 
 $name = $row[&quot;sa_name&quot;]; 
 echo '&lt;td class=&quot;armyinfo&quot;&gt;';
 echo '&lt;img src=&quot;'.$img.'&quot; title=&quot;'.$name.'&quot;&gt;';
 if( $qty == 0 ){
  echo ' &lt;input type=&quot;text&quot; size=&quot;2&quot; class=&quot;text disabled&quot; id=&quot;r'.$sa_id.'&quot; name=&quot;r'.$sa_id.'&quot; value=&quot;0&quot; maxlength=&quot;4&quot;&gt;';
  echo ' &lt;font color=&quot;#CCCCCC&quot;&gt;('.$qty.')&lt;/font&gt;';
 } else {
  echo ' &lt;input type=&quot;text&quot; size=&quot;2&quot; class=&quot;text&quot; id=&quot;r'.$sa_id.'&quot; name=&quot;r'.$sa_id.'&quot; value=&quot;0&quot; maxlength=&quot;4&quot;&gt;';
  echo ' &lt;a href=&quot;#&quot; onclick=set_a_qty('.$sa_id.','.$qty.')&gt;('.$qty.')&lt;/a&gt;';
 }
echo '&lt;/td&gt;';
if( ++$a_cnt &gt; 5){ $a_cnt = 0; echo '&lt;/tr&gt;&lt;tr&gt;'; }
}
echo '&lt;/tr&gt;&lt;/table&gt;';
?&gt;

&lt;br&gt;
&lt;table style=&quot;border-collapse: collapse;&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; id=&quot;army&quot;&gt;
&lt;tr&gt;
&lt;td class=&quot;sel&quot;&gt;
&lt;label&gt;&lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;c&quot; value=&quot;1&quot; checked=&quot;checked&quot;&gt;
Атака: набег&lt;/label&gt;
&lt;/td&gt;
&lt;td class=&quot;vil&quot;&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&quot;sel&quot;&gt;
&lt;label&gt;&lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;c&quot; value=&quot;2&quot;&gt;
Атака: обычная&lt;/label&gt;
&lt;/td&gt;
&lt;td class=&quot;or&quot;&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&quot;sel&quot;&gt;
&lt;label&gt;&lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;c&quot; value=&quot;3&quot;&gt;
Подкрепление&lt;/label&gt;
&lt;/td&gt;
&lt;td class=&quot;target&quot;&gt;
&lt;span&gt;X:&lt;/span&gt;&lt;input type=&quot;text&quot; class=&quot;text&quot; name=&quot;x&quot; size=&quot;3&quot; value=&quot;&quot; maxlength=&quot;4&quot;&gt;
&lt;span&gt;Y:&lt;/span&gt;&lt;input type=&quot;text&quot; class=&quot;text&quot; name=&quot;y&quot; size=&quot;3&quot; value=&quot;&quot; maxlength=&quot;4&quot;&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;

&lt;br&gt;&lt;img src=&quot;img/vill/ok.png&quot; onclick=&quot;init_send_army()&quot; style=&quot;cursor:hand&quot;&gt;&lt;/br&gt;
&lt;input type=&quot;hidden&quot; name=&quot;send_army&quot;&gt;
&lt;input type=&quot;hidden&quot; name=&quot;hash&quot; value=&quot;&lt;? echo md5(mktime()) ?&gt;&quot; &gt;
&lt;/form&gt;
</pre>
			Фрагмент 9.<span lang="en-us">2</span>.<span lang="en-us">1</span><p>
			Как можно заметить из вышеприведенного шаблона - он состоит из двух 
			частей. Первая программный код на <span lang="en-us">PHP</span>, 
			формирующий текстовые поля для ввода количества войск отправляемых в 
			поход (если войск этого типа нет $qty == 0 , значит поля не доступны 
			для редактирования) и вторая часть - чистый <span lang="en-us">HTML
			</span>для указания типа нападения - атака, набег или подкрепления 
			(подкрепление мы не будем рассматривать в нашей лекции) и полей для 
			ввода координат вражеского поселка (которые видны на глобальной 
			карте). Вот так выглядит работа этого шаблона (рисунок 9.2.1):<br>
			<br>
			<img border="0" src="pics/ps2.png" width="535" height="447"><br>
			Рисунок 9.2.1<br>
			<br>
			Как вы видите, так как у нас есть только легионеры, то мы можем 
			комплектовать армию только из них, остальные поля закрашены серым 
			цветом и не доступны для редактирования. Из фрагмента 9.2.1 можно 
			увидеть, что при нажатии на количество войск (для легионеров это 
			(10)) приводится в действие <span lang="en-us">JavaScript </span>
			функция <font color="#3B84D0">set_a_qty</font>. Вот она:<br>
            </p>
<pre class="brush: js;">function set_a_qty( elem, qty ){
document.getElementById(&quot;r&quot;+elem).value = qty;
}
</pre>Фрагмент 9.<span lang="en-us">2</span>.2<p>То есть, она помогает вписать 
			сразу все доступное количество войск в соответствующее текстовое 
			поле. Как Вы помните после изучения фрагмента 9.2.1, в нем есть код 
			для кнопки
			<img border="0" src="www/img/vill/ok.png" width="48" height="21">, 
			нажатие на которую приводит к срабатыванию <span lang="en-us">
			JavaScript </span>функции<span lang="en-us"> </span>
			<font color="#3B84D0">init_send_army</font>, которая инициализирует 
			отправку выбранного количества войск в пункт назначения. Вот как 
			выглядит эта функция:<br>
            </p>
<pre class="brush: js;">function init_send_army(){
sendarmy.submit();
}
</pre>Фрагмент 9.<span lang="en-us">2</span>.3<p>Ничего сложного - простая 
			отправка данных формы с именем <font color="#339966">sendarmy</font>. 
			Шаблон <b> <span lang="en-us">tpl_g16.php</span></b> рассматриваемый 
			во фрагменте 9.1.8, в который мы добавим пару строк, принимает 
			данные от формы отправки войск следующим образом:</p>


<pre class="brush: php;">
// задали отправку войск
if( isset( $_POST[&quot;send_army&quot;] ) ){
$qty1 = $_POST[&quot;r1&quot;];
$qty2 = $_POST[&quot;r2&quot;];
$qty3 = $_POST[&quot;r3&quot;];
$qty4 = $_POST[&quot;r4&quot;];
$qty5 = $_POST[&quot;r5&quot;];
$qty6 = $_POST[&quot;r6&quot;];
$qty7 = $_POST[&quot;r7&quot;];
$qty8 = $_POST[&quot;r8&quot;];
$qty9 = $_POST[&quot;r9&quot;];
$qty10 = $_POST[&quot;r10&quot;];
$type = $_POST[&quot;c&quot;];
$p_x = ( $_POST[&quot;x&quot;] == '' ? 0 : $_POST[&quot;x&quot;] );
$p_y = ( $_POST[&quot;y&quot;] == '' ? 0 : $_POST[&quot;y&quot;] );
$hash = $_POST[&quot;hash&quot;];

init_send_army( $fid,$qty1,$qty2,$qty3,$qty4,$qty5,$qty6,$qty7,$qty8,$qty9,$qty10,$type,$p_x,$p_y,$hash );
}
</pre>
			Фрагмент 9.2.<span lang="en-us">4</span><p>Из вышеприведенного 
			листинга видно, что все количества по типам войск, а также тип 
			атаки, координаты поселка назначения и служебный хэш (для 
			предотвращения повторной отправки одной и той же армии при помощи 
			обновления страницы) передается в функцию <font color="#3B84D0">
			init_send_army</font>, которая выглядит у нас так:</p>


<pre class="brush: php;">
//////////////////// Отправляем нашу армию в поход ////////////////////
function init_send_army( $fid,$qty1,$qty2,$qty3,$qty4,$qty5,$qty6,$qty7,$qty8,$qty9,$qty10,$type,$p_x,$p_y,$hash ){
if( !is_army_hash( $fid, $hash ) ){
 // проверим существование поселка, куда отправляются войска!
 $res = mysql_query(&quot;SELECT fid, usr_id, fid_name from fields where xcoord=$p_x and ycoord=$p_y and usr_id&lt;&gt;0&quot; ) 
 or die(&quot;Query failed : &quot; . mysql_error());
 if (mysql_num_rows( $res ) &gt; 0){
   $row = mysql_fetch_array( $res );
   $fid_to = $row[&quot;fid&quot;];

   $distance = distance_btw_villages( $fid, $p_x, $p_y );
   $speed = max_army_speed( $fid )/3600; 
   $sec = floor( $distance / $speed );

   $start_time = time();
   $end_time1 = $start_time + $sec; 
   $end_time2 = $end_time1 + $sec; 

   // уменьшим армию в поселке
   $res = mysql_query(&quot;SELECT sa_id from army where fid=$fid&quot; ) 
   or die(&quot;Query failed : &quot; . mysql_error());
   while( $row = mysql_fetch_array( $res ) ){
     $sa_id = $row[&quot;sa_id&quot;];

     $sa_id_var = &quot;qty&quot;.$sa_id; // динамически создаем переменную
     $qty = $$sa_id_var; // и узнаем ее значение

     $result = mysql_query(&quot;UPDATE army set sr_qty=sr_qty-$qty where sa_id=$sa_id and fid=$fid&quot; ) 
     or die(&quot;Query failed : &quot; . mysql_error());
   }

   $res = mysql_query(&quot;insert into job_army_move(fid,fid_to,jam_start_time,jam_end_time1,jam_end_time2,jam_direction,jam_hash,qty1,qty2,qty3,qty4,
qty5,qty6,qty7,qty8,qty9,qty10,jam_type)
   values ($fid,$fid_to,$start_time,$end_time1,$end_time2,1,'$hash',$qty1,$qty2,$qty3,$qty4,$qty5,$qty6,$qty7,$qty8,$qty9,$qty10,$type)&quot;) 
or die(&quot;Query failed : &quot; . mysql_error());

 } else echo 'Поселка с такими координатами не существует!';
}
}
</pre>
			Фрагмент 9.2.5<p>В этом фрагменте мы проверяем на наличие поселка с 
			указанными координатами и если его нет - выдаем соответствующее 
			сообщение. Если поселок существует, мы узнаем расстояние до него и 
			время перемещения (здесь мы используем функцию <font color="#3B84D0">max_army_speed</font>, 
			которая возвращает прописанную в ней величину. По идее, скорость 
			армии должна быть равной скорости самого медленного типа войск в ее 
			составе, но нам в учебных целях хватит и указанного в
			<font color="#3B84D0">max_army_speed </font>значения, тем более, что 
			мы будем его менять, чтоб в реальном времени видеть нападение и 
			возврат войск с награбленной добычей, а не ждать по пол часа, пока 
			войска будет перемещаться по карте). Далее в строках 15-17 мы 
			вычисляем время достижения поселка и время возврата из него. Потом в 
			строках 20-30 мы должны уменьшить количество войск в нашем поселке 
			на величину отправляемого в поход войска каждого типа. И в 
			завершении функции, мы вставляем рассчитанные параметры в таблицу
			<font color="#3B84D0">job_army_move</font> (строки 32-35).<br>
			<br>
			Итак, поскольку мы научились отправлять армию в поход, мы должны 
			отображать эту информацию для сведения игроков, который напал и 
			подвергся нападению. Поэтому, сейчас мы сделаем функцию с именем
			<font color="#3B84D0">show_enemy_army_moving</font> для достижения 
			этих целей. Здесь мы покажем фрагмент этой функции для движения 
			наших войск к поселку противника:</p>


<pre class="brush: php;">
/////////////// Показываем перемещения армии //////////////////
function show_enemy_army_moving( $fid ){
$cnt = 0;
Global $bnum;

// Это наша армия идет на чужой поселок!
$result = mysql_query(&quot;SELECT f.fid_name,jam_start_time,jam_end_time1,jam_end_time2,jam_direction,
qty1,qty2,qty3,qty4,qty5,qty6,qty7,qty8,qty9,qty10
from job_army_move jam
inner join fields f on f.fid = jam.fid_to
where jam.fid=$fid&quot; ) 
or die(&quot;Query failed : &quot; . mysql_error());
$num_rows = mysql_num_rows( $result );
if( $num_rows &gt; 0 ){
$script = &quot;&quot;;
while( $row = mysql_fetch_array( $result )){
$time_s = $row[&quot;jam_start_time&quot;];
$time_e1 = $row[&quot;jam_end_time1&quot;];
$time_e2 = $row[&quot;jam_end_time2&quot;];
$fid_name = $row[&quot;fid_name&quot;];
$direction = $row[&quot;jam_direction&quot;];

// туда или обратно?
$time_e = ($direction==1 ? $time_e1 : $time_e2 );

echo '&lt;table class=&quot;info&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; id=&quot;build_value&quot;&gt;&lt;tr&gt;
&lt;td class=&quot;tabhead&quot;&gt;'.($direction==1 ? 'в' : 'из' ). ' '.$fid_name.'&lt;/td&gt;&lt;td colspan=&quot;10&quot; class=&quot;tabhead&quot;&gt;Поход наших войск&lt;/td&gt;
&lt;tr&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;img/army/1.gif&quot;&gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;img/army/2.gif&quot;&gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;img/army/3.gif&quot;&gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;img/army/4.gif&quot;&gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;img/army/5.gif&quot;&gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;img/army/6.gif&quot;&gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;img/army/7.gif&quot;&gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;img/army/8.gif&quot;&gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;img/army/9.gif&quot;&gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;&lt;img src=&quot;img/army/10.gif&quot;&gt;&lt;/td&gt; 
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&quot;armyinfo&quot;&gt;Войска&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;'.$row[&quot;qty1&quot;].'&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;'.$row[&quot;qty2&quot;].'&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;'.$row[&quot;qty3&quot;].'&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;'.$row[&quot;qty4&quot;].'&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;'.$row[&quot;qty5&quot;].'&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;'.$row[&quot;qty6&quot;].'&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;'.$row[&quot;qty7&quot;].'&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;'.$row[&quot;qty8&quot;].'&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;'.$row[&quot;qty9&quot;].'&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot;&gt;'.$row[&quot;qty10&quot;].'&lt;/td&gt; 
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&quot;armyinfo&quot;&gt;Прибытие&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot; colspan=&quot;7&quot;&gt;&lt;span id=&quot;restimer'.$cnt.'&quot;&gt;&lt;/span&gt;&lt;/td&gt;
&lt;td class=&quot;armyinfo&quot; colspan=&quot;3&quot;&gt; '.date('H:i',$time_e).'&lt;/td&gt;
&lt;/tr&gt;';

$rest = s2h($time_e-time());
$hms = explode(':', $rest); 
$script .= &quot;atimers[$cnt] = [ $hms[0], $hms[1], $hms[2] ]; &quot;; 
$cnt ++;

echo '&lt;/table&gt;';
}
echo '&lt;script&gt;';
echo $script;
echo 'url_reload = &quot;?bnum='.$bnum.'&quot;;';
echo 'updateClock(); setInterval(&quot;updateClock()&quot;, 1000 );';
echo '&lt;/script&gt;';
}
}
</pre>
			Фрагмент 9.2.<span lang="en-us">6</span><p>В этом фрагменте запрос 
			(строки 7-11) соединяет таблицы <b>job_army_move</b> и <b>fields</b>, 
			чтоб получить все необходимые данные для визуализации
			<span lang="en-us">HTML </span>таблички<span lang="en-us"> c </span>
			информацией о перемещениях посланных войск из нашего поселка. Данные 
			эти - количество войск каждого типа, название поселка назанчения, 
			направление движения и времена прибытия и возвращения. Результат 
			работы этого скрипта выглядит так:<br>
			<br>
			<img border="0" src="pics/a_otpr.png" width="539" height="481"><br>
			<br>
			Рисунок 9.2.2<br>
			<br>
			Здесь Вы видите, как 10 легионеров покинули расположение поселка 
			игрока и вместе с армией, которая собственно, только из них и 
			состоит отправилась в <span lang="en-us">supertown</span>, куда 
			прибудет через 26 секунд в 12:51 (скорость движения армии тут 
			конечно очень сильно завышена, чтоб не ждать подолгу результата 
			атаки)<br>
			<br>
			Последнее, что мы рассмотрим в этом пункте - это функцию, которая 
			будет обрабатывать перемещения армий. Назовем эту функцию
			<font color="#3B84D0">update_army_moving</font> и представим ее 
			фрагмент, только для обработки прибытия и возвращения нашей армии:</p>


<pre class="brush: php;">
////////////////////////////////////////////////////////////////////
/////////  проверка перемещения армий к нам и от нас  //////////////
////////////////////////////////////////////////////////////////////
function update_army_moving( $fid ){
      // что у нас в очереди перемещений армий к нам и от нас? 
      $res = mysql_query("SELECT jam_id, fid_to,jam_start_time,jam_end_time1,jam_end_time2, 
                             jam_direction, jam_type
                             from job_army_move jam
	                             where jam.fid=$fid OR jam.fid_to=$fid"  )
                             or die("Query failed : " . mysql_error());
      $num_rows = mysql_num_rows( $res );
      if( $num_rows > 0 ){

          $cur_time = time();

          while ($row = mysql_fetch_array( $res )) {
             $jam_id = $row["jam_id"];
             $fid_to = $row["fid_to"];
             $time_s = $row["jam_start_time"];
             $time_e1 = $row["jam_end_time1"];
             $time_e2 = $row["jam_end_time2"];
             $direction = $row["jam_direction"];  // 1-туда, 2-обратно, 3-там (если подкрепление!)
             $type      = $row["jam_type"];       // 1-набег, 2-нападение, 3-подкрепление (не рассматриваем)

             
             if( $fid_to <> $fid ){  // ЭТО НАША АРМИЯ!

                 if( $time_e2 <= $cur_time ){  // уже прибыли и вернулись!
                     if( $direction == 1 ){    // еще не обработали прибытие
                        if( $type == 3 ){      // это было подкрепление
                             $result = mysql_query("update job_army_move set jam_direction=3
                                                              where jam_id = $jam_id" ) 
                                            or die("Query failed : " . mysql_error());
                           
                        }  else {              // нападение или набег
                           $result = mysql_query("update job_army_move set jam_direction=2
                                                  where jam_id = $jam_id" ) 
                                          or die("Query failed : " . mysql_error());                         

                           if( generate_battle( $jam_id ) <> 0 ){ // армия атаки выжила
                             farming( $jam_id );
                             army_return_home( $jam_id );
                             $result = mysql_query("delete from job_army_move 
                                                    where jam_id = $jam_id" ) 
                                            or die("Query failed : " . mysql_error());                         
                           }  
                        }  
                     } else {
                           army_return_home( $jam_id );
                           $result = mysql_query("delete from job_army_move 
                                                  where jam_id = $jam_id" ) 
                                          or die("Query failed : " . mysql_error());                         
                     }
                 } else {
                     if( $time_e1 <= $cur_time ){  // уже напали но не вернулись
                        if( $direction == 1 ){     // еще не обработали прибытие
                            if( $type == 3 ){      // это было подкрепление
                                  $result = mysql_query("update job_army_move set jam_direction=3
                                                         where jam_id = $jam_id" ) 
                                            or die("Query failed : " . mysql_error());                         
                            }  else {              // нападение или набег
                                  $result = mysql_query("update job_army_move set jam_direction=2
                                                         where jam_id = $jam_id" ) 
                                            or die("Query failed : " . mysql_error());                         
                               if( generate_battle( $jam_id ) <> 0 ){  // армия выжила
                                   farming( $jam_id );
                               } 
                            }  
                        }
                     }
                 }
          }
      }
}

</pre>
			Фрагмент 9.2.<span lang="en-us">6</span><p>
			Итак, из запроса к таблице <b>job_army_move</b> (строки 6-10) мы 
			получаем необходимые данные, такие как время прибытия и время 
			возвращения армии, направление перемещения и т.д. Здесь мы 
			обрабатываем движения нашей армии, т.е. условие ($fid_to <> $fid - 
			т.е. пункт назначения не наш поселок). В строках 28-53 
			рассматривается условие, когда обновление страницы произошло уже 
			после возврата наших войск, значит нужно обработать ситуаци. 
			сражения (функция <font color="#3B84D0">generate_battle</font>), 
			захвата ресурсов (функция <font color="#3B84D0">farming</font>) и 
			возвращения в поселок с захваченными ресурсами (функция
			<font color="#3B84D0">army_return_home</font>). Все эти функции мы 
			будем рассматривать в следующих пунктах сегодняшней лекции. Если 
			армия уже вернулась - значит удаляем строку очереди движения армии 
			из таблицы <b>job_army_move</b>&nbsp; (строки 43 и 50). Возврат в 
			поселок, конечно же происходит при условии, что в атакующей армии 
			выжил хоть один солдат.<br>
			<br>
            <br><span lang="en-us"><font color="#4775A5"><b>9</b></font></span><font color="#4775a5"><font ><b>.3. 
			Расчет потерь при нападении
     </b></font><br></font>
            <br>
&nbsp;&nbsp; Предположим, что наша армия достигла вражеского поселка и 
			происходит сражение между атакующими и обороняющимися войсками. В 
			этом пункте нашего занятия мы должны сделать формулы потерь 
			атакующих и обороняющихся войск во время битвы. А пока, давайте, для 
			разминки сделаем функцию, которая будет нам возвращать параметры 
			указанного типа войск: то есть - сам тип войска, 
			<img border="0" src="pics/att_all.gif" width="16" height="16"> атаку, 
			<img border="0" src="pics/def_i.gif" width="16" height="16"> защиту от 
			пехоты, <img border="0" src="pics/def_c.gif" width="16" height="16"> защиту от кавалерии и грузоподъемность одного солдата. Вот 
			эта функция:</p>


<pre class="brush: php;">
////// Узнаем параметры определенного типа войск /////////
function get_army_params( $atype ){
$res = mysql_query(&quot;SELECT sa_attack, sa_inf_defence, sa_cav_defence, sa_capacity, sa_type
from spr_army
where sa_id=$atype&quot; )
or die(&quot;Query failed : &quot; . mysql_error());
$row = mysql_fetch_array( $res );
$a_params['t'] = $row[&quot;sa_type&quot;];
$a_params['a'] = $row[&quot;sa_attack&quot;];
$a_params['d1'] = $row[&quot;sa_inf_defence&quot;];
$a_params['d2'] = $row[&quot;sa_cav_defence&quot;];
$a_params['c'] = $row[&quot;sa_capacity&quot;];

return ( $a_params ); 
}
</pre>
			Фрагмент 9.3.1<p>
			Эта функция принимает на входе параметр $atype , то есть тип войска 
			и обратившись к таблице <b>spr_army</b>, возвращает в виде массива 
			все вышеописанные параметры. Это нам пригодится для подсчета урона 
			атакующих и обороняющихся войск.<br>
			В игре <span lang="en-us">Travian </span>- существует два вида атаки 
			- нападение и набег. В первом случае битва идет до полного 
			истребления одной из сторон. Во втором случае больше преследуются 
			цели захвата ресурсов, поэтому происходит небольшое столкновение, 
			обычно выживают обе стороны и остатки атакующих войск уносят то, что 
			успели награбить. В этом пункте лекции мы изучаем процесс нападения. 
			Формулы расчета урона тут проще<span lang="en-us"> </span>чем при 
			набеге и сейчас мы их рассмотрим на следующем примере.<br>
			<br>
			Например, у нас есть две стороны игроки <b><span lang="en-us">test</span></b> 
			и<span lang="en-us"> </span><b>Суперигрок</b>. Игрок
			<span lang="en-us"><b>test</b> </span>нападает на <b>Суперигрока</b>.&nbsp; 
			У <span lang="en-us">и</span>грока <span lang="en-us"><b>test</b>
			</span>есть: 10 легионеров и 10 империанцев<br>
			У <b>Суперигрока</b>: 20 преторианцев. <br>
			У легионеров - такие параметры :
			<img border="0" src="pics/att_all.gif" width="16" height="16"> 40
			<img border="0" src="pics/def_i.gif" width="16" height="16"> 35
			<img border="0" src="pics/def_c.gif" width="16" height="16"> 50. У 
			преторианцев:&nbsp;
			<img border="0" src="pics/att_all.gif" width="16" height="16"> 30
			<img border="0" src="pics/def_i.gif" width="16" height="16"> 65
			<img border="0" src="pics/def_c.gif" width="16" height="16"> 35. У 
			империанцев:
			<img border="0" src="pics/att_all.gif" width="16" height="16"> 70
			<img border="0" src="pics/def_i.gif" width="16" height="16"> 40
			<img border="0" src="pics/def_c.gif" width="16" height="16"> 25.<br>
			<br>
			Тогда суммарная атака игрока <span lang="en-us"><b>test</b> </span>
			<br>
			10*40 + 10*70 = 1100 (назовем эту сумму win_sum)<br>
			Суммарная атака на защите <b>Суперигрока</b><br>
			10*65 = 650 (назовем эту сумму looser_sum)<br>
			<br>
			Т.к. 1100&gt; 650 победит игрок <span lang="en-us"><b>test</b></span>.<br>
			Если было Нападение, а не Набег, то тогда все войска <b>Суперигрока
			</b>умрут <br>
			<br>
			Формула для подсчета количества убитых солдат у нас будет следующая:<br>
&nbsp;&nbsp;&nbsp; <b>100 * (looser_sum/win_sum)^1,5&nbsp; </b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
			<span name="form1" id="form1"> (^1,5 - это возведение в степень 1,5)</span><br>
			где win_sum - суммарная атака победившего сражение,<br>
			а looser_sum - суммарная атака проигравшего. <br>
			<br>
			Попробуем воспользоваться этой формулой, для приведенного выше 
			примера. <br>
&nbsp;&nbsp;&nbsp; <b>100 * (650/1100)^1.5 = 45.31 % <br>
			</b>Таким образом, у игрока <span lang="en-us"><b>test</b> </span>&nbsp;умрет 
			10*0.4531 = 4 империанцев и 10*0.4531 = 4 легионеров. <br>
			<br>
			Теперь рассмотрим пример, когда происходит комбинированная атака 
			пехоты и кавалерии:<br>
			<br>
			У нападающего игрока&nbsp; <span lang="en-us"><b>test</b> </span>&nbsp;10 
			Конницы императора и 10 легионеров. <br>
			У Конницы императора - такие параметры :
			<img border="0" src="pics/att_all.gif" width="16" height="16"> 120
			<img border="0" src="pics/def_i.gif" width="16" height="16"> 65
			<img border="0" src="pics/def_c.gif" width="16" height="16"> 50.<br>
			<br>
			10 * 120 + 10 * 40 = 1200 + 400 = 1600<br>
			Процентное отношение атаки конных войск ко всей атаке <br>
			1200/1600 = 0.75 <br>
			Отношение атаки пеших воинов равно <br>
			400/1600 = 0.25<br>
			<br>
			У защищающегося игрока <b>Суперигрок</b> 20 преторианцев.<br>
			Суммарная оборона от пеших войск <br>
			20 * 65 = 1300 <br>
			Суммарная оборона от конных войск <br>
			20 * 35 = 700 <br>
			<br>
			А вот суммарная защита у них будет зависеть от атакующего. В данном 
			случае:<br>
			1300 * 0.75 + 700 * 0.25 = 975+175 = 1150<br>
			<br>
			Таки образом у преторианцев <b>Суперигрока </b>&nbsp;будет 1150 
			очков защиты. <br>
			<br>
			Остаток сражения рассчитывается как и раньше: 1600 больше 1150, 
			значит защищающаяся сторона теряет всех своих солдат:<br>
			<br>
			<b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
			100 * (1150/1600)^1.5 = 60.93 % </b><br>
			<br>
			Атакующий игрок <span lang="en-us"><b>test</b> </span>теряет <b>
			60.93 % </b>своих войск, то есть 10*0.6093 =&nbsp; 6 единиц Конницы 
			императора и 10*0.6093 = 6 легионеров.<br>
			Конечно же в реальном бою могут учитываться еще дополнительные 
			параметра, уровни зданий, количество жителей в поселке и т.д., но мы 
			это рассматривать не будем. Давайте теперь создадим функцию
			<font color="#3B84D0">generate_battle</font>, в которой попытаемся 
			все это запрограммировать на языке <span lang="en-us">PHP.<br>
			</span>Вот как выглядит фрагмент этой функции:</p>


<pre class="brush: php;">
function generate_battle( $jam_id ){

$retv = 1;   //возвр.параметр, если он 0 - значит армия атакующего вся погибла!

$sac = 0;  // атака конных войск
$sai = 0;  // атака пехоты
 $sa = 0;  // суммарная атака

$sdc = 0;  // защита от кавалерии
$sdi = 0;  // защита от пехоты
 $sd = 0;  // суммарная защита

// узнаем войска нападения и поселок, куда они пришли
$res = mysql_query("SELECT fid, fid_to, jam_type,
                    qty1,qty2,qty3,qty4,qty5,qty6,qty7,qty8,qty9,qty10
                    from job_army_move
                    where jam_id=$jam_id"  )
            or die("Query 1 failed : " . mysql_error());
$row = mysql_fetch_array( $res );
$fid_to = $row["fid_to"];     // куда пришли войска
$a = array();                 // пустой массив для войска нападения
$cnt = 0;
for($i=0; $i<10; $i++){
   $a_params = get_army_params( $i+1 );
   if( $row["qty".($i+1)] > 0 ){  // есть войска этого типа?
       // тип, кол-во, атака, защита_пехоты, защита_кавалерии, id
       $a[$cnt++] = array($a_params["t"],$row["qty".($i+1)],$a_params["a"],$a_params["d1"],$a_params["d2"],$i+1);
   }
}

// теперь перейдем к войскам защищающейся стороны
$res = mysql_query("SELECT ar.sa_id, sr_qty, 
                           sa_attack, sa_inf_defence, sa_cav_defence, 
                           sa_capacity, sa_type
                           from army ar
                           inner join spr_army sa on ar.sa_id = sa.sa_id
                           where fid = $fid_to" )
            or die("Query 2 failed : " . mysql_error());

$cnt = 0;
$b = array(); // пустой массив для войска защиты
     while ($row = mysql_fetch_array( $res )) {
         $sa_id  = $row["sa_id"];       
         $qty    = $row["sr_qty"];       
         $type   = $row["sa_type"];       
         if( $qty > 0 ) {
            $b[$cnt] = array($type,$qty,$row["sa_attack"],$row["sa_inf_defence"],$row["sa_cav_defence"],$sa_id);
         }
     }

// Считаем атаку
$acount = sizeof($a);
for($i=0;$i<$acount;$i++){
   if( $a[$i][0] == 1 ){ 
           $sai += $a[$i][1] * $a[$i][2]; // тип 1 - пехота
   }
   if( $a[$i][0] == 2 ){ 
           $sac += $a[$i][1] * $a[$i][2]; // тип 2 - кавалерия 
   }
}
$sa = $sai+$sac;     // суммарная атака

// Считаем защиту
$bcount = sizeof($b);
for($i=0;$i<$bcount;$i++){
   $sdi += $b[$i][1] * $b[$i][3];
   $sdc += $b[$i][1] * $b[$i][4];
}

$sd = floor($sdi*($sai/$sa) + $sdc*($sac/$sa));   // суммарная защита

// Если нападение:

if ( $type == 1 ){    /////// Нападение

  if( $sa > $sd ){         // оборона меньше атаки
      $koeff = pow(($sd/$sa),1.5);
      // у обороняющихся не осталось войск
      for($i=0;$i<$bcount;$i++) $b[$i][1] = 0; // обнуляем все войска обороны
      // у атакующих расчитываем так:
      for($i=0;$i<$acount;$i++){ $a[$i][1] = $a[$i][1] - floor($a[$i][1]*$koeff); }
  } else { 
      $koeff = pow(($sa/$sd),1.5);
      // у атакующих не осталось войск
      // теперь удалим из очереди   
      $retv = 0;
      $result = mysql_query("delete from job_army_move 
                             where jam_id = $jam_id" ) 
                     or die("Query failed : " . mysql_error());                         

      for($i=0;$i<=$acount;$i++) $a[$i][1] = 0;     // обнуляем все войска обороны
      // у обороняющихся расчитываем так:
      for($i=0;$i<=$bcount;$i++) $b[$i][1] = $b[$i][1] - floor($b[$i][1]*$koeff);
  }
}  else   {      ////// Набег

  /// Набег рассмотрим в следующем пункте 9.4

}

//  Теперь нужно изменить количество войск в таблицах перемещения job_army_move
//  и армии army

// Для атакующей стороны:
    $sql = "update job_army_move set ";
    for($i=0;$i<$acount;$i++){
       $num = $a[$i][5];    // номер типа войска
       $qty = $a[$i][1];
       $sql .= 'qty'.$num.'='.$qty.',';
    }
    $sql = substr($sql, 0, strlen($sql)-1 );  // уберем последнюю запятую
    $sql .= ' where jam_id='.$jam_id;
    $res = mysql_query( $sql )                // выполняем наш динамически сделанный запрос
            or die("Query 2 failed : " . mysql_error());


    // Для защищающейся стороны:
    for($i=0;$i<$bcount;$i++){ 
           $num = $b[$i][5];
           $qty = $b[$i][1];
           $res = mysql_query( "update army set sr_qty = $qty where sa_id=$num and fid=$fid_to" )   
                or die("Query 2 failed : " . mysql_error());
    }
return ( $retv );
}
</pre>
			Фрагмент 9.3.2<p>
			Итак, вначале мы в строках 3-11 объявляем нужные нам в дальнейшем 
			переменные. Затем, из <span lang="en-us">SQL-</span>запроса (строки 
			14-18) мы получаем данные о количествах и типах войск, которые 
			участвуют в атаке на поселок. В строках 21-29 мы создаем пустой 
			массив и начинаем затем его заполнять таким образом, что для каждого 
			типа войска в нем находится информация по виду(пехота или 
			кавалерия), количеству солдат этого типа, силе атаки, защите от 
			пехоты и защиты от кавалерии. Таким образом мы заполняем массив $a 
			всеми этими данными. <br>
&nbsp;&nbsp; Далее в строках 32-49 мы делаем то же самой, но теперь для 
			защищающейся стороны. Как результат - у нас будет заполненный массив $b 
			со всеми типами войск и их параметрами. Теперь нам нужно посчитать 
			атаку кавалерии и пехоты отдельно и ее суммарную величину, как мы 
			рассматривали в наших примерах в начале этого пункта текущего 
			занятия. Делаем мы это в строках 52-61. Вы видите, что мы считаем в 
			зависимости от вида (пехота-1,кавалерия-2) отдельно, а потом 
			складываем, чтоб получить общую сумму. В строках 64-68 мы 
			подсчитываем защиту от пехоты и кавалерии для обороняющейся стороны, 
			а затем в строке 70 мы считаем общую защиту, по формуле, зависящей 
			от атаки нападающих. Таким образом у нас уже есть две определенные 
			величины - суммарная атака и суммарная защита. Если оборона меньше 
			атаки (строки 76-81) , значит все обороняющиеся войска погибают и мы 
			обнуляем количество в массиве <span lang="en-us">$b. </span>Для 
			войск нападения, рассчитываем остатки всех войск по известной Вам 
			формуле.<br>
			Если же оборона больше атаки (строки 82-93), то мы тогда убираем из 
			таблицы <b>job_army_move</b> - строку для армии нападения (так как 
			все погибли - возвращаться в родной поселок некому), обнуляем все 
			количества в массиве <span lang="en-us">$a</span>, а остатки армии 
			обороняющихся опять же вычисляем по приведенной нами ранее формуле. 
			Затем в строках 105-123 мы переносим остатки войск из массивов в 
			соответствующий таблицы. Для войск атаки мы заносим остатки из 
			массива <span lang="en-us">$a</span> в таблицу <b>job_army_move</b> 
			для возвращения этой кучки солдат обратно в поселок (если все 
			погибли и этой строки уже нет в <b>job_army_move</b> то и остатки 
			соответственно никуда не запишутся, т.к. такого значения в поле jam_id 
			уже не существует). Интересно, что мы создаем запрос динамически, из 
			кусочков количества для каждого типа войск. Для войск обороны мы 
			просто переносим данные по оставшемуся количеству из массива
			<span lang="en-us">$b </span>обратно в таблицу <b>army</b>. <br>
			Вот так выглядит нападение! А что же происходит в результате набега? 
			Смотрите следующий пункт.<br>
			<font color="#4775A5"><strong><span lang="en-us"><br>
			<br>
			<br>
			9</span></strong></font><font color="#4775a5"><strong>.4. Расчет 
			потерь при набеге </strong></font><br>
			<br>
			&nbsp;&nbsp; <span lang="en-us">В</span>о время<span lang="en-us">
			</span>
			набега обычно выживают обе стороны. обычно набег устраивается в 
			целях - ограбить игрока противника <span lang="en-us">и</span>
			понести минимальные потери. При набеге, потери победителя 
			определяются по формуле:<br>
			<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <b>100% · x / (100% + x)</b>, где x определяется 
			по той формуле, которую мы приводили <a href="#form1">выше</a>.<br>
			<br>
			Эта Формула даст процент потерь атакующего 
			при набеге. Полученный показатель позволит определить и потери со 
			стороны защиты: 100% минус процент потерь атакующего.<br>
			<br>
&nbsp;Например, в набеге со стороны игрока <span lang="en-us"><b>test</b> </span>
			участвуют 100 империанцев, а в защите<span lang="en-us"> </span>у <b>
			Суперигрока</b> — 100 преторианцев. Очки атаки <i><b>
			<font color="#3B84D0">7000</font></b></i> больше очков защиты <i><b>
			<font color="#3B84D0">6500</font></b></i>, следовательно набег был 
			успешным.<br>
			<br>
			Считаем нашу формулу:<br>
			<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <b>x = 
			100% · (6500 / 7000)<sup>1,5</sup> &#8776; 89,479%<br>
			</b><br>
			и далее<br>
			<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <b>100% 
			· 89,479% / 189,479% &#8776; 47,22%<br>
			</b><br>
			Следовательно, 47,22% из 100 империанцев погибло, что составляет 47 
			солдат. Со стороны защищающегося <b>Суперигрока</b> потери 
			составляют 100% – 47,22% = 52,78% своей армии, это 53 солдата.<br>
			<br>
			<br>
			Давайте переведем все это на язык <span lang="en-us">PHP </span>и 
			дополним нашу функцию
			<font color="#3B84D0">generate_battle</font>. Выглядит это так:</p>


<pre class="brush: php;">
}  else   {      ////// Набег

  if( $sa > $sd ){   // атака сильнее
      $koeff = pow(($sd/$sa),1.5);
      $koeff2 = (100*$koeff)/(100+$koeff*100);
      $koeff3=1-$koeff2;

      // атака
      for($i=0;$i<$acount;$i++) $a[$i][1] = $a[$i][1] - floor($a[$i][1]*$koeff2); 
      // оборона
      for($i=0;$i<$bcount;$i++) $b[$i][1] = $b[$i][1] - floor($b[$i][1]*$koeff3); 
  } else {        // оборона сильнее

      $koeff = pow(($sa/$sd),1.5);
      $koeff2 = (100*$koeff)/(100+$koeff*100);
      $koeff3=1-$koeff2;

      // атака
      for($i=0;$i<=$acount;$i++) $a[$i][1] = $a[$i][1] - floor($a[$i][1]*$koeff3);
      // оборона
      for($i=0;$i<=$bcount;$i++) $b[$i][1] = $b[$i][1] - floor($b[$i][1]*$koeff2);
  }
}
</pre>
			Фрагмент 9.4.1<p>
			Как Вы догадались - это тот кусочек, который мы пропустили во 
			фрагменте 9.3.2. Здесь мы применяем обе формулы, вначале рассчитывая 
			коэффициенты потерь, а потом для каждого типа войск вычисляя остатки 
			солдат после сражения. Целиком функцию
			<font color="#3B84D0">generate_battle </font>Вы, как обычно можете 
			увидеть в расширенном на сегодняшнем занятии файле
			<span lang="en-us"><b>functions.inc.php</b></span>, который по 
			традиции находится <a href="www">здесь</a>.<span lang="en-us"><br>
			</span>
			<br>
<br><span lang="en-us"><font color="#4775A5"><b>9</b></font></span><font color="#4775A5"><b>.5. 
			Захват вражеских ресурсов</b></font><br>
            <br>
            &nbsp;&nbsp;Конечно же приятно во время атаки на чужой поселок побить войска 
			противника, но еще приятнее утащить его ресурсы. Как Вы помните, 
			каждый тип солдат имеет свой показатель грузоподъемности, то есть ту 
			величину ресурсов, которую он может поднять и унести после набега 
			или нападения. И в нашем завершающем пункте сегодняшней лекции мы с 
			Вами научимся забирать ресурсы из чужих поселков. Из каких 
			предпосылок мы будем исходить? Конечно же, после нападения на 
			поселок, сперва происходит сражение и уже остатки войск нападавшего 
			уносят столько ресурсов, сколько смогут поднять (здесь мы не будет 
			рассматривать тайники, как средство защиты излишек ресурсов, а 
			предположим, что нападающий может забрать столько, сколько способен 
			унести). Вы помните<span lang="en-us"> </span>из фрагмента 9.2.6 
			функцию <font color="#3B84D0">farming</font><span lang="en-us">,
			</span>которая задумывалась нами для разграбления ресурсов 
			противника. И сейчас настало время ее реализовать. Но для начала мы 
			сделаем небольшую функцию, которая определит, а сколько ресурсов 
			может захватить конкретная армия. Назовем мы эту функцию
			<font color="#3B84D0">get_army_capacity</font>.</p>


<pre class="brush: php;">
//////// Узнаем, сколько может нести захваченных ресов армия //////////
function get_army_capacity( $jam_id ){
$capacity = 0;
$res = mysql_query("SELECT qty1,qty2,qty3,qty4,qty5,qty6,qty7,qty8,qty9,qty10
                    from job_army_move
                    where jam_id=$jam_id"  )
            or die("Query failed : " . mysql_error());
$row = mysql_fetch_array( $res );
for($i=0; $i<10; $i++){
   $a_params = get_army_params( $i+1 );
   if( $row["qty".($i+1)] > 0 ){  // есть войска этого типа?
       $capacity += ($row["qty".($i+1)] * $a_params["c"]);
   }
}
return ($capacity);
}

</pre>
			Фрагмент 9.5.1<p>
			Эта функция получает в качестве аргумента<span lang="en-us"> </span>
			идентификатор из таблицы job_army_move и собственно говоря из этой 
			же таблицы извлекает данные по количество всех типов войск, 
			участвующих в нападении на поселок. Затем используется знакомая нам 
			по фрагменту 9.3.1 функция <font color="#3B84D0">get_army_params</font> 
			, которая сейчас нам нужна для того, чтоб узнать грузоподъемность 
			солдата определенного типа войск. Все параметры эта функция 
			возвращает в виде массива&nbsp; $a_params , а элемент массива $a_params["c&quot;] 
			- это как раз грузоподъемность, которая умножается на количество и 
			суммируется со всеми такими же значениями для остальных типов войск, 
			если они присутствуют в армии (т.е. их количество больше нуля). <br>
			Вооружившись функцией <font color="#3B84D0">get_army_capacity</font>, 
			мы можем перейти к разграблению поселка. Вот наша функция <font color="#3B84D0">farming</font>.</p>


<pre class="brush: php;">
////////////////////////////////////////////////////////////////
//////////////// РАСЧЕТ ЗАХВАТА РЕСУРСОВ ///////////////////////
////////////////////////////////////////////////////////////////
function farming( $jam_id ){

// узнаем поселок, ресурсы которого будем захватывать
$res = mysql_query("SELECT fid, fid_to
                    from job_army_move
                    where jam_id=$jam_id"  )
            or die("Query failed : " . mysql_error());
        $row = mysql_fetch_array( $res );
        $fid_to = $row["fid_to"];     // куда пришли войска

// Узнаем сколько ресов в атакуемом поселке
$res = mysql_query("SELECT f_wood, f_clay, f_ore, f_grain from fields where fid = $fid_to" )
            or die("Query failed : " . mysql_error());
        $row = mysql_fetch_array( $res );
// Заполним массив ресурсов!
$ares = array($row["f_wood"],$row["f_clay"],$row["f_ore"],$row["f_grain"]);
$farm = array(0,0,0,0);              // сюда засунем - все что захватили!               
$rest = array(0,0,0,0);              // временный массив расчета остатков
$resall = $ares[0]+$ares[1]+$ares[2]+$ares[3];  // всего ресов

$capacity = get_army_capacity( $jam_id );

if( $capacity >= $resall ){
   // забираем все!
  for($i=0;$i<4;$i++){
      $farm[$i] = $ares[$i]; 
  }
} else {
  $average = floor($capacity/4);  // среднее число захвата ресурсов
  $dif = $capacity - $average*4;  // если есть еще остаток грузоподъемности
  $cnt = 0;
  $raspr = 0;
  for($i=0;$i<4;$i++){
      $rest[$i] = $ares[$i] - $average;
      if( $rest[$i] < 0 ){ 
          $raspr += abs( $rest[$i] );  // запомним разницу
          $cnt ++;                     // счетчик недобора
      }
  }  

  // пытаемся компенсировать недобор
  for($i=0;$i<4;$i++){
     if( $ares[$i] > $average ){
       if( $ares[$i] >= ($average+$raspr+$dif) ) {
           $farm[$i] = $average+$raspr+$dif; 
           $raspr = 0;
           $dif = 0;
       } else {
           $raspr = $average+$raspr-$ares[$i]; // остаток распределения
           $farm[$i] = $ares[$i];
       }
     } else {
       $farm[$i] = $ares[$i];  // забираем все
     }
  }

  // выведем, что забрали:
  $wood  = $farm[0];
  $clay  = $farm[1];
  $ore   = $farm[2];
  $grain = $farm[3];
     // Засунем ресы в мешки атакующей армии :)
     $res = mysql_query("UPDATE job_army_move 
                    set jam_wood=$wood, jam_clay=$clay, 
                        jam_ore=$ore, jam_grain=$grain
                    where jam_id=$jam_id"  )
            or die("Query 1 failed : " . mysql_error());
     // уменьшим ресы у защищающейся стороны:
     $res = mysql_query("UPDATE fields 
                    set f_wood=f_wood-$wood, f_clay=f_clay-$clay, 
                        f_ore=f_ore-$ore, f_grain=f_grain-$grain
                    where fid=$fid_to"  )
            or die("Query failed : " . mysql_error());

}

}
</pre>
			Фрагмент 9.5.2<p>
			Что же у нас происходит во фрагменте 9.5.2? А вот что. Из запроса 
			(стоки 7-10) к таблице <b>job_army_move</b> мы узнаем идентификатор 
			поселка, куда пришли атакующий войска. Далее в запросе (строки 
			15-17) к таблице <b>fields</b> по найденному идентификатору поселка 
			мы находим количество всех ресурсов, которые имеются в данном 
			поселке. Все эти ресурсы мы помещаем в массив $ares. Также мы 
			запасемся массивом $farm, в котором накопятся количества всех типов 
			ресурсов, которые смогут забрать атакующие войска.&nbsp; Далее в 
			строках 22 и 24 мы узнаем общее количество ресурсов, которое есть в 
			поселке и максимальную грузоподъемность всей армии с помощью ранее 
			сделанной функции <font color="#3B84D0">get_army_capacity</font>. 
			Теперь у нас есть два варианта:<br>
			<br>
			1. Количество ресурсов в поселке меньше или равно грузоподъемности 
			атакующей армии (строки 26-30). Тут все просто - мы забираем все 
			ресурсы! Все типы ресурсов размещаются в массив $farm.<br>
			2. Количество ресурсов в поселке больше, чем грузоподъемность армии. 
			Вот тут начинается интересное. Нам нужно забрать какую-то часть этих 
			ресурсов. Для начала мы определим среднее значение каждого ресурса, 
			которое можно захватить по формуле из строки 32. Наверняка есть 
			остаток от деления и мы его узнаем в строке 33. Во временный массив 
			остатков мы засовываем разницу между имеющимся в поселке ресурсом 
			каждого типа и средним значением этого ресурса, который армия может 
			забрать. В переменной $raspr мы накапливаем количество ресурсов, 
			которое будет необходимо распределить, забрав из других видов 
			ресурсов. Это нужно понимать так. Допустим первой мы пытаемся 
			забрать древесину. Среднее количество (<code class="php variable">$average, 
			например 500</code>), которое мы пытаемся забрать превосходит общее 
			количество этого ресурса в наличии в этом поселке, например 200. 
			Значит 500-200=300 - это число пойдет в <code class="php variable">$raspr</code>, 
			чтоб попытаться взять следующий ресурс ( к примеру глину, которой 
			1200) на эту величину больше и так далее. В общем таким образом мы 
			пытаемся более равномерно распределить захват ресурсов. И в конце - 
			в строках 61-77 мы уменьшаем запас ресурсов на величины 
			разграбленного (из массива <code class="php variable">$farm</code>) 
			у защищающегося поселка, а все это награбленное помещаем в таблицу
			<b>job_army_move</b> для атакующей армии. Вы ведь помните, что в ней 
			есть поля jam_wood, jam_clay, jam_ore, jam_grain, как раз для этих 
			целей!<br>
			<br>
			Итак, предположим грабеж удался и в таблице <b>job_army_move</b>&nbsp; 
			для атакующей армии есть награбленные ресурсы (таблица на рисунке 
			9.5.1), чтоб отнести в свой поселок (из <span lang="en-us">fid=67
			</span>обратно в <span lang="en-us">fid=49</span>). Что дальше? А 
			дальше мы вспоминаем фрагмент<span lang="en-us"> </span>&nbsp;9.2.<span lang="en-us">6 </span>
			и вызов функции<span lang="en-us"> </span><font color="#3B84D0">
			army_return_home</font>. <br>
			<br>
			<img border="0" src="pics/reth.png" width="897" height="93"><br>
			<br>
			Рисунок 9.5.1<br>
			<br>
			<br>
			Вы видите на рисунке 9.5.1, как 6 оставшихся в живых легионера тащат 
			домой по 75 единиц каждого ресурса.<br>
			Эта функция вызывается тогда, когда текущее время сервера больше или 
			рано времени возврата армии из похода. Что ж, вот эта функция:</p>


<pre class="brush: php;">
//////////////////////////////////////////////////////////////
////////////// Возвращаемся домой, с добычей или без /////////
//////////////////////////////////////////////////////////////
function army_return_home( $jam_id ){
  // узнаем войска нападения и поселок куда они вернулись
  $res = mysql_query("SELECT fid, fid_to, jam_type,
                      qty1,qty2,qty3,qty4,qty5,qty6,qty7,qty8,qty9,qty10,
                      jam_wood, jam_clay, jam_ore, jam_grain
                      from job_army_move
                      where jam_id=$jam_id"  )
              or die("Query 1 failed : " . mysql_error());
  $row = mysql_fetch_array( $res );
  $fid = $row["fid"];        // поселок атакующей стороны (возврат)
  $wood  =  $row["jam_wood"];
  $clay  =  $row["jam_clay"] ;
  $ore   =  $row["jam_ore"] ;
  $grain =  $row["jam_grain"] ;
  for( $i=1; $i<=10; $i++ ){    // пробежимся по всем 10 типам войск
      $qty  = $row["qty".$i] ;
      // добавляем вернувшиеся войска к тем, что в поселке
      $result = mysql_query( "update army set sr_qty=sr_qty+$qty where sa_id=$i and fid=$fid"  )
              or die("Query failed : " . mysql_error());
  }
  // добавляем ресурсов захватчику
  $res = mysql_query("UPDATE fields 
                      set f_wood=f_wood+$wood, f_clay=f_clay+$clay, 
                     f_ore=f_ore+$ore, f_grain=f_grain+$grain
                     where fid=$fid"  )
              or die("Query failed : " . mysql_error());
}
</pre>
			Фрагмент 9.5.3<p>
			В этой функции мы в запросе к таблице <b>job_army_move</b> 
			определяем количество всех типов захваченных ресурсов и солдат 
			которые вернулись живыми из трудного похода. Ресурсы присоединяем к 
			нашим, хранящимся в таблице <b>fields</b> для нашего поселка (fid), 
			а остатки солдат помещаем в таблицу <b>army</b>, чтоб они отдыхали и 
			собирали силы для новых военных действий.<br>
			<br>
			На этом мы говорим Вам - до свидания, до следующего нашего занятия! А 
			все файлы, которые мы создали или поменяли в течении сегодняшнего 
			занятия Вы можете обнаружить <a href="www">здесь</a>. Скрипт 
			актуальной базы <span lang="en-us">travgame </span>из этого урока 
			номер 9 находится <a href="sql">здесь</a>.<br>
			<b>
			<br>
			<br>
			В следующем уроке</b> мы <span lang="ru">с Вами научимся тренировать 
			героя, повышать его характеристики в таверне и с его помощью 
			захватывать соседние оазисы.</span></p>
            <p><br>
            <br>
            </p>
            <p></p>
            <p></p></font>
            </td>
            <td background="index_files/m_right_m.gif" width="9"><img height="4" src="index_files/m_right_m.gif" width="9" border="0"></td>
          </tr>
        </tbody>
      </table>
      <table cellpadding="0" cellspacing="0" width="100%">
        <tbody>
          <tr>
            <td background="index_files/m_left_m.gif" width="9"></td>
            <td class="newsbody" bgcolor="#fdfdfd">&nbsp;</td>
            <td class="newsbody" bgcolor="#fdfdfd">
            <div class="nav" align="right">Blitz-School© </div>
            </td>
            <td background="index_files/m_right_m.gif" width="9"><img height="4" src="index_files/m_right_m.gif" width="9" border="0"></td>
          </tr>
        </tbody>
      </table>
      <table cellpadding="0" cellspacing="0" height="7" width="100%">
        <tbody>
          <tr>
            <td background="index_files/m_left_b.gif" width="13"><img height="7" src="index_files/m_left_b.gif" width="13" border="0"></td>
            <td background="index_files/m_center_b.gif"><img height="1" src="index_files/spacer.gif" width="1"></td>
            <td width="13"><img height="7" src="index_files/m_right_b.gif" width="13" border="0"></td>
          </tr>
        </tbody>
      </table>
      </div>
      </td>
      <td background="index_files/right_back.gif" valign="top" width="13">&nbsp;</td>
    </tr>
  </tbody>
</table>
<table cellpadding="0" cellspacing="0" width="100%">
  <tbody>
    <tr>
      <td background="index_files/bottom_left.png" height="51" valign="top" width="254">
      <div class="date" style="MARGIN-TOP: 12px; FONT-SIZE: 10px; MARGIN-LEFT: 45px; COLOR: white"><a style="COLOR: rgb(255,255,255)" href  ="index.phtml">Copyright</a>©
2005-2009.
GameSchool</div>
      </td>
      <td background="index_files/bottom.gif" valign="top">
      <div class="date" style="MARGIN-TOP: 12px; FONT-SIZE: 10px; MARGIN-LEFT: 20px; COLOR: rgb(143,145,147)" 
      ><!-- Bottom menu --><a title="Главная страница" style="COLOR: rgb(143,145,147)" href  ="http://www.blitz-school.info/index.phtml">Главная</a><img height="1" src="index_files/spacer.gif" width="22" align="middle">:<img height="1" src="index_files/spacer.gif" width="22" align="middle"><a href="http://www.blitz-school.info/login.phtml"><span style="COLOR: rgb(143,145,147)"  >Вход</span></a><img height="1" src="index_files/spacer.gif" width="22" align="middle">:<img height="1" src="index_files/spacer.gif" width="22" align="middle"><a href="http://www.blitz-school.info/response.phtml"><span style="COLOR: rgb(143,145,147)" 
      >Отзывы</span></a><img height="1" src="index_files/spacer.gif" width="22" align="middle">:<img height="1" src="index_files/spacer.gif" width="22" align="middle"><a href="http://www.blitz-school.info/contacts.phtml"><span style="COLOR: rgb(143,145,147)" 
      >Контакты</span></a><img height="1" src="index_files/spacer.gif" width="22" align="middle">:<img height="1" src="index_files/spacer.gif" width="22" align="middle"><a href="http://www.blitz-school.info/friends.phtml"><span style="COLOR: rgb(143,145,147)" 
      >Обмен ссылками</span></a> </div>
      </td>
      <td width="19"><img height="51" src="index_files/bottom_right.png" width="19" border="0"></td>
    </tr>
  </tbody>
</table>
<div id="menu" onmouseover="showLayer('menu'); Change('products', 'menu2')" onmouseout="hiddenLayer('menu'); Change('products', 'menu1')">
<table border="0" cellpadding="0" cellspacing="0">
  <tbody>
    <tr>
      <td style="WIDTH: 7px; HEIGHT: 7px"><img height="7" alt="" src="index_files/corner1.gif" width="7"></td>
      <td class="top"></td>
      <td style="WIDTH: 7px; HEIGHT: 7px"><img height="7" alt="" src="index_files/corner2.gif" width="7"></td>
    </tr>
    <tr>
      <td class="left"></td>
      <td class="text"><a href="reg.phtml">Курс обучения созданию игр
на Blitz3D</a><br>
      <a href="reg2.phtml">Курс
обучения созданию браузерных онлайновых игр</a> </td>
      <td class="right"></td>
    </tr>
    <tr>
      <td style="BACKGROUND: 0% 50%; WIDTH: 7px; HEIGHT: 7px; -moz-background-clip: initial; -moz-background-origin: initial; -moz-background-inline-policy: initial" 
      ><img height="7" alt="" src="index_files/corner4.gif" width="7"></td>
      <td class="bottom"></td>
      <td style="WIDTH: 7px; HEIGHT: 7px"><img height="7" alt="" src="index_files/corner3.gif" width="7"></td>
    </tr>
  </tbody>
</table>
</div>

</body></html>
